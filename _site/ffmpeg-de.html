<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>FFmpeg auf Android portieren</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FFmpeg auf Android portieren | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="FFmpeg auf Android portieren" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="de" />
<meta name="description" content="Originalartikellink (CSDN)" />
<meta property="og:description" content="Originalartikellink (CSDN)" />
<link rel="canonical" href="https://lzwjava.github.io/ffmpeg-de" />
<meta property="og:url" content="https://lzwjava.github.io/ffmpeg-de" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="FFmpeg auf Android portieren" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2014-03-10T00:00:00+08:00","datePublished":"2014-03-10T00:00:00+08:00","description":"Originalartikellink (CSDN)","headline":"FFmpeg auf Android portieren","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/ffmpeg-de"},"url":"https://lzwjava.github.io/ffmpeg-de"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=411a58a6c51db09b4abd45fcb687a30946164543">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=411a58a6c51db09b4abd45fcb687a30946164543" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       FFmpeg auf Android portieren | Original, von KI übersetzt
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/de/2014-03-10-ffmpeg-de.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsde2014-03-10-ffmpeg-de.md</span> -->
      

      <!-- <span>2014-03-10-ffmpeg-de.md</span> -->

      
        

        
          
          <a href="#" class="button">2014.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/ffmpeg-en" >English</option>
        <option value="/ffmpeg-zh" >中文</option>
        <option value="/ffmpeg-ja" >日本語</option>
        <option value="/ffmpeg-es" >Español</option>
        <option value="/ffmpeg-hi" >हिंदी</option>
        <option value="/ffmpeg-fr" >Français</option>
        <option value="/ffmpeg-de" selected>Deutsch</option>
        <option value="/ffmpeg-ar" >العربية</option>
        <option value="/ffmpeg-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p><a href="https://blog.csdn.net/lzw_java/article/details/21564091">Originalartikellink (CSDN)</a></p>

<hr />

<h2 id="der-ursprung">Der Ursprung</h2>

<p>Für diejenigen, die FFmpeg noch nicht kennen, können Sie sich zunächst <a href="https://ffmpeg.org/ffmpeg.html">FFmpeg Common Basic Commands</a> ansehen und dessen Funktionen genau studieren – wie z.B. die Kombination von Audio und Video, das Abspielen verschiedener Codecs, das Schneiden von Videos, das Zusammenfügen mehrerer Bilder zu einem Video und das Mischen von Audio, sowie die Konvertierung von Formaten. Es kann viele Anwendungsszenarien mit leistungsstarken und interessanten Funktionen bereichern.</p>

<p>Am Beispiel von Apps wie “配音秀” (Voice Dubbing Show) zeigt sich, dass das Synchronisieren von Stimmen nicht nur äußerst unterhaltsam ist, sondern oft auch die Attraktivität eines Produkts steigern kann. Wir planten die Entwicklung eines Dubbing-Moduls und wurden dabei auf FFmpeg aufmerksam, das wir auf die Android-Plattform portieren wollten. Nach etwa 3 bis 4 Tagen und mehreren Versuchen mit verschiedenen Versionen, bei denen viele Online-Artikel keinen Erfolg brachten, stießen wir schließlich auf ein Tutorial mit dem Titel “android 使用ffmpeg 并调用接口” (Verwendung von FFmpeg in Android und Aufruf der Schnittstellen), das uns zum Ziel führte. Praktische Tests zeigten, dass nur die Kombination aus FFmpeg 1.2 und ndk-r9 erfolgreich portiert werden konnte.</p>

<hr />

<h2 id="ansatz">Ansatz</h2>

<p>FFmpeg ist ein in C geschriebenes Projekt, das eine <code class="language-plaintext highlighter-rouge">main()</code>-Funktion enthält. Unser Ziel ist:</p>

<ol>
  <li>Verwenden Sie das Android NDK, um <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> zu kompilieren.</li>
  <li>Nutzen Sie diese Bibliothek, um die <code class="language-plaintext highlighter-rouge">ffmpeg.c</code> Datei zu kompilieren und zu modifizieren. Ändern Sie die ursprüngliche <code class="language-plaintext highlighter-rouge">main()</code> Funktion in <code class="language-plaintext highlighter-rouge">video_merge(int argc, char **argv)</code> um, damit sie direkt über JNI aufgerufen werden kann, um Aufgaben wie das Zusammenführen von Videos durchzuführen.</li>
</ol>

<p>Zum Beispiel kann die Videosynthese auf folgende Weise implementiert werden (entspricht dem Befehlszeilenbefehl <code class="language-plaintext highlighter-rouge">ffmpeg -i src1 -i src2 -y output</code>):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video_merge</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span> <span class="c1">// wobei argv die Befehlszeilenparameter simuliert</span>
</code></pre></div></div>

<hr />

<h2 id="umgebung">Umgebung</h2>

<ul>
  <li>Betriebssystem: Ubuntu 12.04</li>
  <li>FFmpeg-Version: 1.2</li>
  <li>NDK-Version: ndk-r9</li>
</ul>

<p>Bevor Sie mit der Arbeit beginnen, wird empfohlen, einige relevante Tutorials zu konsultieren. Wenn Sie auf Probleme stoßen, können Sie zurückkommen und diesen Artikel vergleichen, um zu vermeiden, zu viele Umwege zu machen.</p>

<hr />

<h2 id="ändern-der-schnittstelle-und-der-androidmk">Ändern der Schnittstelle und der Android.mk</h2>

<p>Beim Schreiben von JNI-Schnittstellen für FFmpeg muss eine <code class="language-plaintext highlighter-rouge">Android.mk</code>-Datei erstellt werden, um Bibliotheken zu verlinken und somit eine nutzbare <code class="language-plaintext highlighter-rouge">.so</code>-Datei zu generieren. Einige Beispiel-<code class="language-plaintext highlighter-rouge">Android.mk</code>-Dateien können in verschiedenen Umgebungen möglicherweise nicht direkt erfolgreich ausgeführt werden. Ihre Aufgabe besteht darin, dem NDK mitzuteilen, welche Quelldateien kompiliert und mit welcher Bibliothek verlinkt werden sollen.</p>

<p>Ich habe eine Methode des “zweimaligen Kompilierens und anschließenden Linkens” verwendet:</p>

<ol>
  <li>Zuerst wird eine Shared Library namens <code class="language-plaintext highlighter-rouge">myffmpeg</code> kompiliert.</li>
  <li>In einem anderen Modul <code class="language-plaintext highlighter-rouge">ffmpeg-jni</code> wird dann <code class="language-plaintext highlighter-rouge">myffmpeg</code> eingebunden, um schließlich das gewünschte <code class="language-plaintext highlighter-rouge">.so</code>-File zu generieren.</li>
</ol>

<p>Außerdem muss die kompilierte Datei <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> im <code class="language-plaintext highlighter-rouge">jni</code>-Verzeichnis abgelegt werden, um sicherzustellen, dass sie während des Linkens gefunden werden kann.</p>

<hr />

<h2 id="debugging-von-ffmpeg">Debugging von FFmpeg</h2>

<p>Nach der Portierung von FFmpeg ist es oft notwendig, Funktionen über JNI aufzurufen und auf der C-Ebene zu debuggen. Wenn man detaillierte Logausgaben wie in der Befehlszeile sehen könnte, wäre es viel einfacher, Probleme zu lokalisieren.</p>

<p>In Eclipse können Sie durch Drücken von <kbd>Strg</kbd> und Klicken auf eine Aufrufstelle wie <code class="language-plaintext highlighter-rouge">av_log</code> zur Implementierung der Funktion <code class="language-plaintext highlighter-rouge">av_log_default_callback</code> in <code class="language-plaintext highlighter-rouge">ffmpeg/libavutil/log.c</code> gelangen. Diese Funktion ruft <code class="language-plaintext highlighter-rouge">__android_log_print</code> von Android auf, um die Ausgabe in Logcat zu drucken. Durch die Betrachtung dieser Ausgaben können Sie den internen Zustand von FFmpeg ermitteln, was bei der Fehlerbehebung von Problemen wie fehlgeschlagenen Synthesen oder der Nichtunterstützung bestimmter Codecs hilfreich ist.</p>

<p>Manchmal kann FFmpeg eine Ausnahme auslösen, die zum Absturz der App führt. Um dies zu lokalisieren, können Sie den folgenden Befehl verwenden:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell logcat | ndk-stack <span class="nt">-sym</span> obj/local/armeabi
</code></pre></div></div>

<p><em>Hinweis: Der obige Befehl bleibt auf Englisch, da es sich um einen spezifischen technischen Befehl handelt, der in der Regel nicht übersetzt wird.</em></p>

<p>Wenn die ursprüngliche <code class="language-plaintext highlighter-rouge">main()</code>-Funktion von FFmpeg am Ende ein <code class="language-plaintext highlighter-rouge">exit(0)</code> enthält, denken Sie daran, dies auszukommentieren, da dies sonst zum Beenden der Anwendung führen würde.</p>

<h3 id="speicherlecks-und-service-lösungen">Speicherlecks und Service-Lösungen</h3>

<p>Nach Abschluss der Synthese kann es bei erneutem Aufruf zu einem Fehler wie <code class="language-plaintext highlighter-rouge">"INVALID HEAP ADDRESS IN dlfree ffmpeg"</code> kommen, was meist auf eine unvollständige Speicherfreigabe durch FFmpeg zurückzuführen ist. Ein möglicher Workaround besteht darin, den Syntheseprozess in einem separaten <code class="language-plaintext highlighter-rouge">Service</code> auszuführen und diesen Service nach Abschluss der Synthese zu beenden, um die Ressourcen freizugeben.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- AndroidManifest.xml --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">".FFmpegService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Durch die Registrierung von <code class="language-plaintext highlighter-rouge">Receiver</code> und ähnlichen Methoden kann der Service nach Abschluss der Synthese selbstständig beendet werden, wodurch Speicherprobleme bei wiederholten Aufrufen vermieden werden können.</p>

<hr />

<h2 id="mögliche-probleme">Mögliche Probleme</h2>

<ul>
  <li><strong>AAC-Dateiabspielprobleme</strong><br />
Einige Gerätemodelle (z. B. Xiaomi 2s) können möglicherweise AAC-codierte Audiodateien nicht mit dem standardmäßigen <code class="language-plaintext highlighter-rouge">MediaPlayer</code> abspielen.</li>
  <li><strong>Unzureichende Encoder-Unterstützung</strong><br />
Um Formate wie AMR-NB und MP3 zu unterstützen, müssen die entsprechenden Optionen beim Kompilieren von FFmpeg manuell aktiviert werden. Wenn das Kompilierungsskript die erforderlichen Bibliotheken oder Header-Dateien nicht findet, wird es mit einer Fehlermeldung beendet.</li>
  <li><strong>Synthesizer-Geschwindigkeit</strong><br />
Die Synthese eines 10-Sekunden-Videos mit einer Auflösung von 1280×720 und gemischtem Audio kann zwischen einigen Dutzend Sekunden und einer Minute dauern. Aus Benutzersicht könnte es besser sein, den Benutzern zunächst eine Vorschau zu ermöglichen, bevor sie sich für die endgültige Synthese entscheiden.</li>
</ul>

<p>In der konkreten Implementierung von Dubbing-Apps ist es üblich, wie folgt vorzugehen:</p>
<ol>
  <li>Laden Sie das Originalvideo, die Untertitel und die Audiodatei, aus der die zu synchronisierenden Abschnitte entfernt wurden, im Voraus herunter.</li>
  <li>Nehmen Sie die Stimme des Benutzers auf. Bei der Synthese müssen Sie lediglich die Aufnahme mit den stummen Abschnitten zusammenführen.</li>
  <li>Wenn Sie mit der lokalen Synthesezeit nicht zufrieden sind, können Sie die Audio- und Videodaten auf den Server hochladen, wo die Synthese serverseitig durchgeführt wird. Anschließend können Sie das fertige Ergebnis herunterladen.</li>
</ol>

<hr />

<h2 id="verwendung-des-ndk-in-eclipse">Verwendung des NDK in Eclipse</h2>

<p>Es ist nicht notwendig, <code class="language-plaintext highlighter-rouge">ndk-build</code> in der Befehlszeile einzugeben. Klicken Sie einfach mit der rechten Maustaste auf das Projekt in Eclipse und wählen Sie <strong>Android Tools → Add Native Support</strong>. Danach wird <code class="language-plaintext highlighter-rouge">ndk-build</code> automatisch jedes Mal ausgeführt, wenn Sie auf “Run” klicken.</p>

<h3 id="jni-headerdatei-mit-einem-klick-generieren">JNI-Headerdatei mit einem Klick generieren</h3>

<p>Das Schreiben von JNI-Funktionsheaderdateien kann mühsam sein, aber es kann automatisch mit dem <code class="language-plaintext highlighter-rouge">javah</code>-Befehl generiert werden.<br />
In Eclipse kann dies als externes Tool konfiguriert werden, um die Headerdateien mit einem ähnlichen Befehl wie folgt zu generieren:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javah <span class="nt">-jni</span> <span class="nt">-classpath</span> bin/classes <span class="nt">-d</span> jni com.example.ffmpeg.MyFFmpeg
</code></pre></div></div>

<p><em>Hinweis: Der obige Befehl ist ein Java Native Interface (JNI)-Befehl und wird in der Regel nicht übersetzt, da er spezifisch für die Entwicklungsumgebung und die Programmiersprache ist. Der Befehl generiert Header-Dateien für native Methoden in der angegebenen Java-Klasse.</em></p>

<p>Nach der Ausführung wird im <code class="language-plaintext highlighter-rouge">jni</code>-Verzeichnis eine Datei ähnlich wie <code class="language-plaintext highlighter-rouge">com_example_ffmpeg_MyFFmpeg.h</code> erzeugt. Anschließend müssen Sie diese Datei in Ihrem C-Code mit <code class="language-plaintext highlighter-rouge">#include</code> einbinden und die entsprechenden Funktionen implementieren.</p>

<hr />

<h2 id="zusammenfassung">Zusammenfassung</h2>

<p>Die Portierung von FFmpeg auf Android umfasst verschiedene Wissensbereiche, darunter die Konfiguration der NDK-Umgebung, die Kompilierung und Verknüpfung von C/C++-Code, JNI-Aufrufe sowie die Audio- und Videocodierung und -decodierung. Wenn Probleme wie fehlgeschlagene Synthese, nicht unterstützte Formate oder Linker-Fehler auftreten, ist eine sorgfältige Überprüfung der Konfiguration und der Log-Ausgaben erforderlich. Ich hoffe, dass dieser Artikel Ihnen helfen kann, einige Fallstricke zu vermeiden. Wenn Sie ebenfalls FFmpeg verwenden, teilen Sie gerne Ihre Erfahrungen oder Probleme in den Kommentaren, um sich gegenseitig auszutauschen und voneinander zu lernen.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-de" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
