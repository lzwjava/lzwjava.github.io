<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Portar FFmpeg a Android</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Portar FFmpeg a Android | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Portar FFmpeg a Android" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="es" />
<meta name="description" content="Enlace al artículo original (CSDN)" />
<meta property="og:description" content="Enlace al artículo original (CSDN)" />
<link rel="canonical" href="https://lzwjava.github.io/ffmpeg-es" />
<meta property="og:url" content="https://lzwjava.github.io/ffmpeg-es" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Portar FFmpeg a Android" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2014-03-10T00:00:00+08:00","datePublished":"2014-03-10T00:00:00+08:00","description":"Enlace al artículo original (CSDN)","headline":"Portar FFmpeg a Android","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/ffmpeg-es"},"url":"https://lzwjava.github.io/ffmpeg-es"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=deebc3ecf833318071e5648dfb184c622800e1cb">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=deebc3ecf833318071e5648dfb184c622800e1cb" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Portar FFmpeg a Android | Original, traducido por IA
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/es/2014-03-10-ffmpeg-es.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postses2014-03-10-ffmpeg-es.md</span> -->
      

      <!-- <span>2014-03-10-ffmpeg-es.md</span> -->

      
        

        
          
          <a href="#" class="button">2014.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/ffmpeg-en" >English</option>
        <option value="/ffmpeg-zh" >中文</option>
        <option value="/ffmpeg-ja" >日本語</option>
        <option value="/ffmpeg-es" selected>Español</option>
        <option value="/ffmpeg-hi" >हिंदी</option>
        <option value="/ffmpeg-fr" >Français</option>
        <option value="/ffmpeg-de" >Deutsch</option>
        <option value="/ffmpeg-ar" >العربية</option>
        <option value="/ffmpeg-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p><a href="https://blog.csdn.net/lzw_java/article/details/21564091">Enlace al artículo original (CSDN)</a></p>

<hr />

<h2 id="origen">Origen</h2>

<p>Para aquellos que aún no están familiarizados con FFmpeg, pueden comenzar por revisar los <a href="https://ffmpeg.org/ffmpeg.html">Comandos básicos comunes de FFmpeg</a> y estudiar detenidamente sus funciones, como la combinación de audio y video, la reproducción de varios tipos de codificación, la captura de video, la combinación de múltiples imágenes en un video y la mezcla de audio, la conversión de formatos, entre otros. FFmpeg puede ofrecer funcionalidades potentes e interesantes para una variedad de escenarios de aplicación.</p>

<p>Tomando como ejemplo aplicaciones del tipo “Dubbing Show”, el doblaje no solo es extremadamente divertido, sino que también suele hacer que el producto sea más atractivo. Planeamos desarrollar un módulo de doblaje y, por lo tanto, nos interesamos en FFmpeg, intentando portarlo a la plataforma Android. Nos tomó entre 3 y 4 días, probamos varias versiones, y muchos artículos en línea no lograron ayudarnos, hasta que encontramos un tutorial titulado “Uso de FFmpeg en Android y llamada a interfaces”, que finalmente nos permitió resolver el problema. Las pruebas prácticas mostraron que solo la combinación de FFmpeg 1.2 con ndk-r9 logró una portabilidad exitosa.</p>

<hr />

<h2 id="ideas">Ideas</h2>

<p>FFmpeg es un proyecto escrito en lenguaje C que contiene una función <code class="language-plaintext highlighter-rouge">main()</code>. Nuestro objetivo es:</p>

<ol>
  <li>Compilar <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> utilizando Android NDK.</li>
  <li>Utilizar esta biblioteca para compilar y modificar el archivo <code class="language-plaintext highlighter-rouge">ffmpeg.c</code>, cambiando la función original <code class="language-plaintext highlighter-rouge">main()</code> a <code class="language-plaintext highlighter-rouge">video_merge(int argc, char **argv)</code>, lo que permitirá llamarla directamente desde JNI para realizar operaciones como la combinación de videos.</li>
</ol>

<p>Por ejemplo, se puede lograr la composición de videos de manera similar a la siguiente (correspondiente al comando <code class="language-plaintext highlighter-rouge">ffmpeg -i src1 -i src2 -y output</code>):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video_merge</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span> <span class="c1">// donde argv simula los parámetros de la línea de comandos</span>
</code></pre></div></div>

<hr />

<h2 id="entorno">Entorno</h2>

<ul>
  <li>Sistema operativo: Ubuntu 12.04</li>
  <li>Versión de FFmpeg: 1.2</li>
  <li>Versión de NDK: ndk-r9</li>
</ul>

<p>Antes de comenzar, te recomiendo consultar algunos tutoriales relacionados. Si encuentras algún problema, puedes volver a este artículo para comparar y evitar perder demasiado tiempo en el camino.</p>

<hr />

<h2 id="modificación-de-la-interfaz-y-androidmk">Modificación de la Interfaz y Android.mk</h2>

<p>Al escribir una interfaz JNI para FFmpeg, es necesario crear un archivo <code class="language-plaintext highlighter-rouge">Android.mk</code> para enlazar las bibliotecas y generar un archivo <code class="language-plaintext highlighter-rouge">.so</code> utilizable. Algunos ejemplos de <code class="language-plaintext highlighter-rouge">Android.mk</code> pueden no funcionar directamente en diferentes entornos. Su propósito es indicar al NDK qué archivos fuente deben compilarse y a qué bibliotecas deben enlazarse, entre otra información.</p>

<p>Adopté un enfoque de “compilar dos veces y luego enlazar”:</p>

<ol>
  <li>Primero, compila para obtener una biblioteca compartida llamada <code class="language-plaintext highlighter-rouge">myffmpeg</code>.</li>
  <li>Luego, en otro módulo llamado <code class="language-plaintext highlighter-rouge">ffmpeg-jni</code>, enlaza <code class="language-plaintext highlighter-rouge">myffmpeg</code> para finalmente generar el archivo <code class="language-plaintext highlighter-rouge">.so</code> requerido.</li>
</ol>

<p>Además, es necesario colocar el archivo compilado <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> en el directorio <code class="language-plaintext highlighter-rouge">jni</code> para asegurarse de que pueda ser encontrado durante el proceso de enlace.</p>

<hr />

<h2 id="depuración-de-ffmpeg">Depuración de FFmpeg</h2>

<p>Después de portar FFmpeg, para invocar funciones a través de JNI, a menudo es necesario depurar en la capa de C. Si pudieras ver registros detallados como en la línea de comandos, sería mucho más fácil identificar problemas.</p>

<p>En Eclipse, mantén presionada la tecla <kbd>Ctrl</kbd> y haz clic en una llamada como <code class="language-plaintext highlighter-rouge">av_log</code> para rastrear la implementación de la función <code class="language-plaintext highlighter-rouge">av_log_default_callback</code> en <code class="language-plaintext highlighter-rouge">ffmpeg/libavutil/log.c</code>. Esta función llama a <code class="language-plaintext highlighter-rouge">__android_log_print</code> de Android para imprimir en Logcat. Al revisar estas salidas, puedes obtener información sobre el estado interno de FFmpeg, lo cual es útil para diagnosticar problemas como fallos en la síntesis o la falta de soporte para ciertos códecs.</p>

<p>A veces, FFmpeg puede lanzar excepciones que hacen que la aplicación se bloquee. Puedes utilizar el siguiente comando para identificar el problema:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell logcat | ndk-stack <span class="nt">-sym</span> obj/local/armeabi
</code></pre></div></div>

<p><em>Nota: El comando anterior no necesita traducción, ya que es una instrucción técnica en el entorno de desarrollo de Android. Sin embargo, si necesitas una explicación en español, aquí está:</em></p>

<p>Este comando se utiliza para capturar los registros de <code class="language-plaintext highlighter-rouge">logcat</code> en un dispositivo Android y luego pasarlos a través de <code class="language-plaintext highlighter-rouge">ndk-stack</code> para convertir las direcciones de memoria en símbolos legibles, utilizando los archivos de símbolos ubicados en <code class="language-plaintext highlighter-rouge">obj/local/armeabi</code>. Esto es útil para depurar aplicaciones nativas en Android.</p>

<p>Si el <code class="language-plaintext highlighter-rouge">main()</code> original de FFmpeg tiene un <code class="language-plaintext highlighter-rouge">exit(0)</code> al final, asegúrate de comentarlo, de lo contrario, hará que la aplicación se cierre.</p>

<h3 id="fugas-de-memoria-y-soluciones-con-service">Fugas de Memoria y Soluciones con Service</h3>

<p>Después de completar la síntesis, si aparece el error <code class="language-plaintext highlighter-rouge">"INVALID HEAP ADDRESS IN dlfree ffmpeg"</code> al llamar nuevamente, es probable que se deba a una liberación incompleta de la memoria de FFmpeg. Una solución intermedia es colocar el proceso de síntesis en un <code class="language-plaintext highlighter-rouge">Service</code> separado y, una vez finalizada la síntesis, eliminar dicho Service para liberar los recursos.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- AndroidManifest.xml --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">".FFmpegService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Al registrar un <code class="language-plaintext highlighter-rouge">Receiver</code> y finalizar el Service manualmente después de completar la síntesis, se pueden evitar problemas de memoria en llamadas repetidas.</p>

<hr />

<h2 id="posibles-problemas">Posibles problemas</h2>

<ul>
  <li><strong>Problemas de reproducción de archivos AAC</strong><br />
Algunos modelos de dispositivos (como el Xiaomi 2s) pueden no ser capaces de reproducir audio codificado en AAC a través del <code class="language-plaintext highlighter-rouge">MediaPlayer</code> predeterminado.</li>
  <li><strong>Soporte insuficiente de codificadores</strong><br />
Si se desea admitir formatos como AMR-NB, MP3, etc., es necesario habilitar manualmente las opciones correspondientes al compilar FFmpeg. Si el script de compilación no puede encontrar las bibliotecas o archivos de cabecera necesarios, se detendrá y mostrará un error.</li>
  <li><strong>Velocidad de síntesis</strong><br />
La síntesis de un video de 10 segundos en 1280×720 con mezcla de audio puede tardar desde varias decenas de segundos hasta un minuto. Desde la perspectiva de la experiencia del usuario, podría ser mejor permitir que el usuario escuche una vista previa antes de decidir si realizar la síntesis final.</li>
</ul>

<p>En la implementación específica de una aplicación de doblaje, las prácticas comunes incluyen:</p>

<ol>
  <li>Descargar previamente el video original, los subtítulos y el archivo de audio con “los fragmentos que requieren doblaje eliminados”.</li>
  <li>Grabar la voz del usuario, y durante la síntesis, simplemente combinar la grabación con los fragmentos de silencio.</li>
  <li>Si no estás satisfecho con el tiempo de síntesis local, puedes optar por subir los datos de audio y video al servidor, donde se realizará la síntesis en el servidor, y luego descargar el resultado final.</li>
</ol>

<hr />

<h2 id="usar-ndk-en-eclipse">Usar NDK en Eclipse</h2>

<p>No es necesario ingresar <code class="language-plaintext highlighter-rouge">ndk-build</code> en la línea de comandos. Simplemente haz clic derecho en el proyecto en Eclipse, selecciona <strong>Android Tools → Add Native Support</strong>, y cada vez que hagas clic en “Run”, se ejecutará automáticamente <code class="language-plaintext highlighter-rouge">ndk-build</code>.</p>

<h3 id="generación-automática-de-archivos-de-cabecera-jni-con-un-solo-clic">Generación automática de archivos de cabecera JNI con un solo clic</h3>

<p>Escribir archivos de cabecera de funciones JNI puede ser tedioso, pero se puede automatizar utilizando el comando <code class="language-plaintext highlighter-rouge">javah</code>.<br />
En Eclipse, puedes configurarlo como una herramienta externa y usar un comando similar al siguiente para generar el archivo de cabecera:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javah <span class="nt">-jni</span> <span class="nt">-classpath</span> bin/classes <span class="nt">-d</span> jni com.example.ffmpeg.MyFFmpeg
</code></pre></div></div>

<p><em>Nota: El comando no se traduce ya que es un comando específico de la línea de comandos y debe mantenerse en su forma original para su correcto funcionamiento.</em></p>

<p>Después de la ejecución, se generará un archivo similar a <code class="language-plaintext highlighter-rouge">com_example_ffmpeg_MyFFmpeg.h</code> en el directorio <code class="language-plaintext highlighter-rouge">jni</code>. Luego, solo necesitas incluir (<code class="language-plaintext highlighter-rouge">#include</code>) este archivo en tu código C e implementar las funciones correspondientes.</p>

<hr />

<h2 id="resumen">Resumen</h2>

<p>La portabilidad de FFmpeg en Android involucra múltiples áreas de conocimiento, incluyendo la configuración del entorno NDK, la compilación y enlace de C/C++, la invocación de JNI, y la codificación y decodificación de audio y video. Si te encuentras con problemas como la imposibilidad de sintetizar, la falta de soporte para ciertos formatos o errores de enlace, es necesario revisar cuidadosamente la configuración y los registros de salida. Espero que este artículo te ayude a evitar algunos obstáculos. Si también estás utilizando FFmpeg, no dudes en compartir tus experiencias o problemas en la sección de comentarios, para que podamos intercambiar conocimientos y aprender juntos.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-es" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
