<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>A FormData polyfill for the browser …and a module for NodeJS (New!)</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>A FormData polyfill for the browser …and a module for NodeJS (New!) | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="A FormData polyfill for the browser …and a module for NodeJS (New!)" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/node_modules/formdata-polyfill/" />
<meta property="og:url" content="https://lzwjava.github.io/node_modules/formdata-polyfill/" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="A FormData polyfill for the browser …and a module for NodeJS (New!)" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"A FormData polyfill for the browser …and a module for NodeJS (New!)","url":"https://lzwjava.github.io/node_modules/formdata-polyfill/"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=5ed887fe3ef5334418d51fd3c91878d0831fcb62">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=5ed887fe3ef5334418d51fd3c91878d0831fcb62" defer></script> -->
</head>

<body>
  <header class="page-header" role="banner">
  <!-- Part 1: Avatar -->
  <div class="row compact-row">
    <div class="circular-image">
      <img id="avatarImg" src="/assets/images/avatar.jpg" alt="">
    </div>
    <div class="text-container">
      <h3 class="project-name">A FormData polyfill for the browser …and a module for NodeJS (New!)</h3>
      <h3 class="project-tagline">李智维</h3>
    </div>

    <button id="themeToggleHeader" class="icon-button" aria-label="Toggle Theme">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>

    <button id="devinHeader" class="icon-button" aria-label="Devin"
      onclick="window.location.href='https://deepwiki.com/lzwjava/lzwjava.github.io'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <polygon points="12,2 14.5,3.5 14.5,7.5 12,9 9.5,7.5 9.5,3.5" />
    <polygon points="18,9.5 20.5,11 20.5,15 18,16.5 15.5,15 15.5,11" />
    <polygon points="6,9.5 8.5,11 8.5,15 6,16.5 3.5,15 3.5,11" />
    <polygon points="12,17 14.5,18.5 14.5,22.5 12,24 9.5,22.5 9.5,18.5" />
</svg>
    </button>

    <!-- <button id="searchHeader" class="icon-button" aria-label="Search" onclick="window.location.href='/search-en'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

    </button> -->

    <button id="githubHeader" class="icon-button" aria-label="GitHub"
      onclick="window.location.href='https://github.com/lzwjava/lzwjava.github.io'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
</svg>



    </button>

    <!-- <button id="statusHeader" class="icon-button" aria-label="Check Status"
      onclick="window.location.href='/status-page-en'">
    </button> -->

  </div>

  <div class="row">
    <!-- Information-related buttons -->
    <a href="/resume-en" class="btn">📄 <br>Résumé</a>
    <a href="/portfolio-en" class="btn">✨<br> أعمال</a>
    <a href="/notes-en" class="btn">📎 <br>メモ</a>
    <a href="/papers-en" class="btn">🔍 <br>논문</a>
  </div>

  <div class="row">
    <!-- Action-related buttons -->
    <a href="/contact-en" class="btn">👋 <br>哈囉</a>
    <a href="/subscribe-en" class="btn">🔔<br> s'abonner</a>
    <a href="/donate-en" class="btn">💰 <br>Moneta</a>
    <a href="/disclaimer-en" class="btn">📝 <br>नोट्स</a>
  </div>
</header>

<script src="/assets/js/dark-mode.js"></script>


<main id="content" class="main-content" role="main">
  <h3 id="a-formdata-polyfill-for-the-browser-and-a-module-for-nodejs-new">A <code class="language-plaintext highlighter-rouge">FormData</code> polyfill for the browser …and a module for NodeJS (<code class="language-plaintext highlighter-rouge">New!</code>)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>formdata-polyfill
</code></pre></div></div>

<p>The browser polyfill will likely have done its part already, and i hope you stop supporting old browsers c”,)<br />
But NodeJS still laks a proper FormData<br />The good old form-data package is a very old and isn’t spec compatible and dose some abnormal stuff to construct and read FormData instances that other http libraries are not happy about when it comes to follow the spec.</p>

<h3 id="the-nodejs--esm-version">The NodeJS / ESM version</h3>
<ul>
  <li>The modular (~2.3 KiB minified uncompressed) version of this package is independent of any browser stuff and don’t patch anything</li>
  <li>It’s as pure/spec compatible as it possible gets the test are run by WPT.</li>
  <li>It’s compatible with <a href="https://github.com/node-fetch/node-fetch">node-fetch</a>.</li>
  <li>It have higher platform dependencies as it uses classes, symbols, ESM &amp; private fields</li>
  <li>Only dependency it has is <a href="https://github.com/node-fetch/fetch-blob">fetch-blob</a></li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Node example</span>
<span class="k">import</span> <span class="nx">fetch</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">node-fetch</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">File</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">fetch-blob/file.js</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">fileFromSync</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">fetch-blob/from.js</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormData</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">formdata-polyfill/esm.min.js</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">fileFromSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">./README.md</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">()</span>

<span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">file-upload</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">File</span><span class="p">([</span><span class="dl">'</span><span class="s1">abc</span><span class="dl">'</span><span class="p">],</span> <span class="dl">'</span><span class="s1">hello-world.txt</span><span class="dl">'</span><span class="p">))</span>
<span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">file-upload</span><span class="dl">'</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>

<span class="c1">// it's also possible to append file/blob look-a-like items</span>
<span class="c1">// if you have streams coming from other destinations</span>
<span class="nx">fd</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">file-upload</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">size</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">cat-video.mp4</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">stream</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">stream</span> <span class="p">},</span>
  <span class="p">[</span><span class="nb">Symbol</span><span class="p">.</span><span class="nx">toStringTag</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">File</span><span class="dl">'</span>
<span class="p">})</span>

<span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://httpbin.org/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">fd</span> <span class="p">})</span>
</code></pre></div></div>

<hr />

<p>It also comes with way to convert FormData into Blobs - it’s not something that every developer should have to deal with.
It’s mainly for <a href="https://github.com/node-fetch/node-fetch">node-fetch</a> and other http library to ease the process of serializing a FormData into a blob and just wish to deal with Blobs instead (Both Deno and Undici adapted a version of this <a href="https://github.com/jimmywarting/FormData/blob/5ddea9e0de2fc5e246ab1b2f9d404dee0c319c02/formdata-to-blob.js">formDataToBlob</a> to the core and passes all WPT tests run by the browser itself)</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Readable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">node:stream</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormData</span><span class="p">,</span> <span class="nx">formDataToBlob</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">formdata-polyfill/esm.min.js</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="nx">formDataToBlob</span><span class="p">(</span><span class="k">new</span> <span class="nx">FormData</span><span class="p">())</span>
<span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://httpbin.org/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="na">body</span><span class="p">:</span> <span class="nx">blob</span> <span class="p">})</span>

<span class="c1">// node built in http and other similar http library have to do:</span>
<span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Readable</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">blob</span><span class="p">.</span><span class="nx">stream</span><span class="p">())</span>
<span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://httpbin.org/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Content-Length</span><span class="dl">'</span><span class="p">:</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">type</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="nx">stream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</code></pre></div></div>

<p>PS: blob &amp; file that are appended to the FormData will not be read until any of the serialized blob read-methods gets called
…so uploading very large files is no biggie</p>

<h3 id="browser-polyfill">Browser polyfill</h3>

<p>usage:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">'</span><span class="s1">formdata-polyfill</span><span class="dl">'</span> <span class="c1">// that's it</span>
</code></pre></div></div>

<p>The browser polyfill conditionally replaces the native implementation rather than fixing the missing functions,
since otherwise there is no way to get or delete existing values in the FormData object.
Therefore this also patches <code class="language-plaintext highlighter-rouge">XMLHttpRequest.prototype.send</code> and <code class="language-plaintext highlighter-rouge">fetch</code> to send the <code class="language-plaintext highlighter-rouge">FormData</code> as a blob,
and <code class="language-plaintext highlighter-rouge">navigator.sendBeacon</code> to send native <code class="language-plaintext highlighter-rouge">FormData</code>.</p>

<p>I was unable to patch the Response/Request constructor
so if you are constructing them with FormData then you need to call <code class="language-plaintext highlighter-rouge">fd._blob()</code> manually.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">fd</span><span class="p">.</span><span class="nx">_blob</span> <span class="p">?</span> <span class="nx">fd</span><span class="p">.</span><span class="nx">_blob</span><span class="p">()</span> <span class="p">:</span> <span class="nx">fd</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="dependencies">Dependencies</h2>

<p>If you need to support IE &lt;= 9 then I recommend you to include eligrey’s <a href="https://github.com/eligrey/Blob.js">blob.js</a>
(which i hope you don’t - since IE is now dead)</p>

<details>
    <summary>Updating from 2.x to 3.x</summary>

Previously you had to import the polyfill and use that,
since it didn't replace the global (existing) FormData implementation.
But now it transparently calls `_blob()` for you when you are sending something with fetch or XHR,
by way of monkey-patching the `XMLHttpRequest.prototype.send` and `fetch` functions.

So you maybe had something like this:

```javascript
var FormData = require('formdata-polyfill')
var fd = new FormData(form)
xhr.send(fd._blob())
```

There is no longer anything exported from the module
(though you of course still need to import it to install the polyfill),
so you can now use the FormData object as normal:

```javascript
require('formdata-polyfill')
var fd = new FormData(form)
xhr.send(fd)
```

</details>

<h2 id="native-browser-compatibility-as-of-2021-05-08">Native Browser compatibility (as of 2021-05-08)</h2>
<p>Based on this you can decide for yourself if you need this polyfill.</p>

<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_compatibility"><img src="https://user-images.githubusercontent.com/1148376/117550329-0993aa80-b040-11eb-976c-14e31f1a3ba4.png" alt="screenshot" /></a></p>

<p>This normalizes support for the FormData API:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">append</code> with filename</li>
  <li><code class="language-plaintext highlighter-rouge">delete()</code>, <code class="language-plaintext highlighter-rouge">get()</code>, <code class="language-plaintext highlighter-rouge">getAll()</code>, <code class="language-plaintext highlighter-rouge">has()</code>, <code class="language-plaintext highlighter-rouge">set()</code></li>
  <li><code class="language-plaintext highlighter-rouge">entries()</code>, <code class="language-plaintext highlighter-rouge">keys()</code>, <code class="language-plaintext highlighter-rouge">values()</code>, and support for <code class="language-plaintext highlighter-rouge">for...of</code></li>
  <li>Available in web workers (just include the polyfill)</li>
</ul>



</main>


</body>

</html>
