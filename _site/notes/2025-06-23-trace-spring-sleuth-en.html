<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Mastering Spring Cloud Sleuth in Spring Boot</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mastering Spring Cloud Sleuth in Spring Boot | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Mastering Spring Cloud Sleuth in Spring Boot" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-06-23-trace-spring-sleuth-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-06-23-trace-spring-sleuth-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mastering Spring Cloud Sleuth in Spring Boot" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Mastering Spring Cloud Sleuth in Spring Boot","url":"https://lzwjava.github.io/notes/2025-06-23-trace-spring-sleuth-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=2e78a122e1c45dc3db43fd309f04a381c6cf74c8">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=2e78a122e1c45dc3db43fd309f04a381c6cf74c8" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Mastering Spring Cloud Sleuth in Spring Boot | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-06-23-trace-spring-sleuth-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-06-23-trace-spring-sleuth-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.09</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/trace-spring-sleuth-en" selected>English</option>
        <option value="/trace-spring-sleuth-zh" >中文</option>
        <option value="/trace-spring-sleuth-ja" >日本語</option>
        <option value="/trace-spring-sleuth-es" >Español</option>
        <option value="/trace-spring-sleuth-hi" >हिंदी</option>
        <option value="/trace-spring-sleuth-fr" >Français</option>
        <option value="/trace-spring-sleuth-de" >Deutsch</option>
        <option value="/trace-spring-sleuth-ar" >العربية</option>
        <option value="/trace-spring-sleuth-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>Spring Cloud Sleuth is a powerful tool for adding distributed tracing capabilities to Spring applications. While it’s particularly useful in microservice architectures to track requests across multiple services, it also provides significant benefits for single (monolith) applications by enhancing log correlation and debugging.</p>

<p>This guide will provide a comprehensive overview of using Spring Cloud Sleuth within a single Spring Boot application, drawing insights from Baeldung’s approach.</p>

<h2 id="1-what-is-spring-cloud-sleuth">1. What is Spring Cloud Sleuth?</h2>

<p>At its core, Spring Cloud Sleuth instruments Spring applications to automatically add tracing information to logs and propagate it across different components and even threads within a single application. It leverages OpenZipkin’s Brave library for this functionality.</p>

<p><strong>Key Terminology:</strong></p>

<ul>
  <li><strong>Trace:</strong> Represents a single request or job that flows through the application. Each trace has a unique <code class="language-plaintext highlighter-rouge">traceId</code>. Think of it as the end-to-end journey of a request.</li>
  <li><strong>Span:</strong> Represents a logical unit of work within a trace. A trace is composed of multiple spans, forming a tree-like structure. Each span has a unique <code class="language-plaintext highlighter-rouge">spanId</code>. For example, an incoming HTTP request might be one span, and a method call within that request could be another (child) span.</li>
  <li><strong>MDC (Mapped Diagnostic Context):</strong> Sleuth integrates with Slf4J’s MDC to inject <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> into your log messages, making it easy to filter and correlate logs for a specific request.</li>
</ul>

<h2 id="2-why-use-sleuth-in-a-single-application">2. Why use Sleuth in a Single Application?</h2>

<p>Even in a monolith, requests often involve multiple layers, asynchronous operations, and different threads. Manually correlating log messages for a single request can be tedious and error-prone. Sleuth automates this by:</p>

<ul>
  <li><strong>Simplifying Debugging:</strong> By adding <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> to every log entry, you can easily filter logs to see everything related to a specific user request, even if it traverses multiple methods, services, or threads within your single application.</li>
  <li><strong>Improved Observability:</strong> Provides a clearer picture of how a request flows and where potential bottlenecks or issues might occur.</li>
  <li><strong>Consistency:</strong> Ensures a consistent approach to logging correlation without requiring manual effort in every part of your codebase.</li>
</ul>

<h2 id="3-getting-started-setup-and-configuration">3. Getting Started: Setup and Configuration</h2>

<h3 id="31-project-setup-maven">3.1. Project Setup (Maven)</h3>

<p>To get started, create a new Spring Boot project (you can use Spring Initializr) and add the <code class="language-plaintext highlighter-rouge">spring-cloud-starter-sleuth</code> dependency to your <code class="language-plaintext highlighter-rouge">pom.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-sleuth<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p><strong>Important:</strong> Ensure you are using a compatible Spring Boot and Spring Cloud version. Spring Cloud dependencies are typically managed using a Bill of Materials (BOM).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/dependencyManagement&gt;</span>
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">${spring-cloud.version}</code> with the appropriate release train version (e.g., <code class="language-plaintext highlighter-rouge">2021.0.1</code>, <code class="language-plaintext highlighter-rouge">2022.0.0</code>).</p>

<h3 id="32-application-name">3.2. Application Name</h3>

<p>It’s highly recommended to set an application name in your <code class="language-plaintext highlighter-rouge">application.properties</code> or <code class="language-plaintext highlighter-rouge">application.yml</code> file. This name will appear in your logs, which is helpful for identifying the source of logs, especially if you later move to a distributed system.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># application.properties
</span><span class="py">spring.application.name</span><span class="p">=</span><span class="s">my-single-app</span>
</code></pre></div></div>

<h3 id="33-logging-pattern">3.3. Logging Pattern</h3>

<p>Spring Cloud Sleuth automatically modifies the default logging pattern to include <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code>. A typical log output with Sleuth might look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:30:00.123 INFO [my-single-app,a1b2c3d4e5f6a7b8,a1b2c3d4e5f6a7b8,false] 12345 --- [nio-8080-exec-1] c.e.m.MyController : This is a log message.
</code></pre></div></div>

<p>Here:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">my-single-app</code>: Is the <code class="language-plaintext highlighter-rouge">spring.application.name</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">a1b2c3d4e5f6a7b8</code>: Is the <code class="language-plaintext highlighter-rouge">traceId</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">a1b2c3d4e5f6a7b8</code> (second one): Is the <code class="language-plaintext highlighter-rouge">spanId</code> (for the root span, traceId and spanId are often the same).</li>
  <li><code class="language-plaintext highlighter-rouge">false</code>: Indicates if the span is exportable (true means it will be sent to a tracing collector like Zipkin).</li>
</ul>

<p>If you have a custom logging pattern, you’ll need to explicitly add the <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> to it using <code class="language-plaintext highlighter-rouge">%X{traceId}</code> and <code class="language-plaintext highlighter-rouge">%X{spanId}</code> (for Logback).</p>

<p>Example custom Logback pattern in <code class="language-plaintext highlighter-rouge">logback-spring.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"CONSOLE"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;encoder&gt;</span>
        <span class="nt">&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [${spring.application.name:-},%X{traceId:-},%X{spanId:-}] %thread %logger{36} - %msg%n<span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>
</code></pre></div></div>

<h2 id="4-how-sleuth-works-in-a-single-application">4. How Sleuth Works in a Single Application</h2>

<p>Once the <code class="language-plaintext highlighter-rouge">spring-cloud-starter-sleuth</code> dependency is on the classpath, Spring Boot’s auto-configuration takes over.</p>

<h3 id="41-automatic-instrumentation">4.1. Automatic Instrumentation</h3>

<p>Sleuth automatically instruments common Spring components and communication channels:</p>

<ul>
  <li><strong>Servlet Filter:</strong> For incoming HTTP requests to your controllers.</li>
  <li><strong>RestTemplate:</strong> For outgoing HTTP calls made using <code class="language-plaintext highlighter-rouge">RestTemplate</code> (ensure you’re using a bean-managed <code class="language-plaintext highlighter-rouge">RestTemplate</code> for Sleuth to auto-instrument it).</li>
  <li><strong>Scheduled Actions:</strong> For <code class="language-plaintext highlighter-rouge">@Scheduled</code> methods.</li>
  <li><strong>Message Channels:</strong> For Spring Integration and Spring Cloud Stream.</li>
  <li><strong>Asynchronous Methods:</strong> For <code class="language-plaintext highlighter-rouge">@Async</code> methods (ensures trace/span context is propagated across threads).</li>
</ul>

<h3 id="42-simple-web-request-example">4.2. Simple Web Request Example</h3>

<p>Consider a simple Spring Boot application with a REST controller:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">helloSleuth</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Hello from MyController"</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When you access <code class="language-plaintext highlighter-rouge">http://localhost:8080/</code>, you’ll see log messages like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:35:00.123 INFO [my-single-app,c9d0e1f2a3b4c5d6,c9d0e1f2a3b4c5d6,false] 7890 --- [nio-8080-exec-1] c.e.m.MyController : Hello from MyController
</code></pre></div></div>

<p>Notice the <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> automatically added.</p>

<h3 id="43-propagating-context-across-methods-same-span">4.3. Propagating Context Across Methods (Same Span)</h3>

<p>If your request flows through multiple methods within the same application and you want these methods to be part of the <em>same span</em>, Sleuth handles this automatically.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">MyService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomeWork</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// Simulate some work</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Doing some work in MyService"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MyService</span> <span class="n">myService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/same-span-example"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">sameSpanExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Entering same-span-example endpoint"</span><span class="o">);</span>
        <span class="n">myService</span><span class="o">.</span><span class="na">doSomeWork</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exiting same-span-example endpoint"</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Logs for <code class="language-plaintext highlighter-rouge">/same-span-example</code> will show the same <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> for both the controller and service methods:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:40:00.100 INFO [my-single-app,e4f5g6h7i8j9k0l1,e4f5g6h7i8j9k0l1,false] 1234 --- [nio-8080-exec-2] c.e.m.MyController : Entering same-span-example endpoint
2025-06-23 23:40:00.200 INFO [my-single-app,e4f5g6h7i8j9k0l1,e4f5g6h7i8j9k0l1,false] 1234 --- [nio-8080-exec-2] c.e.m.MyService : Doing some work in MyService
2025-06-23 23:40:00.205 INFO [my-single-app,e4f5g6h7i8j9k0l1,e4f5g6h7i8j9k0l1,false] 1234 --- [nio-8080-exec-2] c.e.m.MyController : Exiting same-span-example endpoint
</code></pre></div></div>

<h3 id="44-creating-new-spans-manually">4.4. Creating New Spans Manually</h3>

<p>You might want to create a new span for a distinct unit of work within your application, even if it’s part of the same overall trace. This allows for finer-grained tracking and timing. Spring Cloud Sleuth provides the <code class="language-plaintext highlighter-rouge">Tracer</code> API for this.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">brave.Tracer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">brave.Span</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">class</span> <span class="nc">MyService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Tracer</span> <span class="n">tracer</span><span class="o">;</span> <span class="c1">// Inject the Brave Tracer</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomeWorkNewSpan</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"I'm in the original span before new span"</span><span class="o">);</span>

        <span class="c1">// Create a new span with a descriptive name</span>
        <span class="nc">Span</span> <span class="n">newSpan</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="na">nextSpan</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"custom-internal-work"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Tracer</span><span class="o">.</span><span class="na">SpanInScope</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="na">withSpanInScope</span><span class="o">(</span><span class="n">newSpan</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span> <span class="c1">// Simulate some work in the new span</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"I'm in the new custom span doing some cool work"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">newSpan</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span> <span class="c1">// Always finish the span</span>
        <span class="o">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"I'm back in the original span"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MyService</span> <span class="n">myService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/new-span-example"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">newSpanExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Entering new-span-example endpoint"</span><span class="o">);</span>
        <span class="n">myService</span><span class="o">.</span><span class="na">doSomeWorkNewSpan</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exiting new-span-example endpoint"</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Logs for <code class="language-plaintext highlighter-rouge">/new-span-example</code> will show the trace ID staying the same, but a new <code class="language-plaintext highlighter-rouge">spanId</code> will appear for the “custom-internal-work”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:45:00.100 INFO [my-single-app,f0e1d2c3b4a5f6e7,f0e1d2c3b4a5f6e7,false] 1234 --- [nio-8080-exec-3] c.e.m.MyController : Entering new-span-example endpoint
2025-06-23 23:45:00.105 INFO [my-single-app,f0e1d2c3b4a5f6e7,f0e1d2c3b4a5f6e7,false] 1234 --- [nio-8080-exec-3] c.e.m.MyService : I'm in the original span before new span
2025-06-23 23:45:00.300 INFO [my-single-app,f0e1d2c3b4a5f6e7,8a9b0c1d2e3f4a5b,false] 1234 --- [nio-8080-exec-3] c.e.m.MyService : I'm in the new custom span doing some cool work
2025-06-23 23:45:00.305 INFO [my-single-app,f0e1d2c3b4a5f6e7,f0e1d2c3b4a5f6e7,false] 1234 --- [nio-8080-exec-3] c.e.m.MyService : I'm back in the original span
2025-06-23 23:45:00.310 INFO [my-single-app,f0e1d2c3b4a5f6e7,f0e1d2c3b4a5f6e7,false] 1234 --- [nio-8080-exec-3] c.e.m.MyController : Exiting new-span-example endpoint
</code></pre></div></div>

<p>Notice how the <code class="language-plaintext highlighter-rouge">spanId</code> changes to <code class="language-plaintext highlighter-rouge">8a9b0c1d2e3f4a5b</code> within the <code class="language-plaintext highlighter-rouge">custom-internal-work</code> section and then reverts.</p>

<h3 id="45-asynchronous-processing">4.5. Asynchronous Processing</h3>

<p>Sleuth seamlessly integrates with Spring’s <code class="language-plaintext highlighter-rouge">@Async</code> annotation to propagate the trace context across thread boundaries.</p>

<p>First, enable asynchronous processing in your main application class:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableAsync</span> <span class="c1">// Enable async execution</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">MyApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Then, create an async service:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.scheduling.annotation.Async</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">AsyncService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Async</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">performAsyncTask</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Starting async task"</span><span class="o">);</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span> <span class="c1">// Simulate some long-running task</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Finished async task"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MyController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">AsyncService</span> <span class="n">asyncService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/async-example"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asyncExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Calling async task"</span><span class="o">);</span>
        <span class="n">asyncService</span><span class="o">.</span><span class="na">performAsyncTask</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Async task initiated, returning from controller"</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The logs will show the same <code class="language-plaintext highlighter-rouge">traceId</code> but a different <code class="language-plaintext highlighter-rouge">spanId</code> for the asynchronous method, as it runs in a new thread and represents a new unit of work:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:50:00.100 INFO [my-single-app,1a2b3c4d5e6f7a8b,1a2b3c4d5e6f7a8b,false] 1234 --- [nio-8080-exec-4] c.e.m.MyController : Calling async task
2025-06-23 23:50:00.105 INFO [my-single-app,1a2b3c4d5e6f7a8b,9c0d1e2f3a4b5c6d,false] 1234 --- [           task-1] c.e.m.AsyncService : Starting async task
2025-06-23 23:50:00.110 INFO [my-single-app,1a2b3c4d5e6f7a8b,1a2b3c4d5e6f7a8b,false] 1234 --- [nio-8080-exec-4] c.e.m.MyController : Async task initiated, returning from controller
// ... some time later ...
2025-06-23 23:50:00.605 INFO [my-single-app,1a2b3c4d5e6f7a8b,9c0d1e2f3a4b5c6d,false] 1234 --- [           task-1] c.e.m.AsyncService : Finished async task
</code></pre></div></div>

<p>Notice the <code class="language-plaintext highlighter-rouge">traceId</code> remains the same, but the <code class="language-plaintext highlighter-rouge">spanId</code> changes for the async method, and the thread name also reflects the async executor.</p>

<h3 id="46-customizing-span-names-with-spanname">4.6. Customizing Span Names with <code class="language-plaintext highlighter-rouge">@SpanName</code></h3>

<p>You can use the <code class="language-plaintext highlighter-rouge">@SpanName</code> annotation to provide more meaningful names for your automatically generated spans.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.cloud.sleuth.annotation.SpanName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotatedService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">AnnotatedService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@SpanName</span><span class="o">(</span><span class="s">"Annotated_Service_Method"</span><span class="o">)</span> <span class="c1">// Custom span name</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">annotatedMethod</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Inside annotated method"</span><span class="o">);</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// ... in your controller or another service ...</span>
<span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">AnnotatedService</span> <span class="n">annotatedService</span><span class="o">;</span>

<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/annotated-span"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">annotatedSpanExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Calling annotated method"</span><span class="o">);</span>
    <span class="n">annotatedService</span><span class="o">.</span><span class="na">annotatedMethod</span><span class="o">();</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Finished calling annotated method"</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"success"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The logs will reflect the custom span name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-06-23 23:55:00.100 INFO [my-single-app,g1h2i3j4k5l6m7n8,g1h2i3j4k5l6m7n8,false] 1234 --- [nio-8080-exec-5] c.e.m.MyController : Calling annotated method
2025-06-23 23:55:00.150 INFO [my-single-app,g1h2i3j4k5l6m7n8,g1h2i3j4k5l6m7n8,false] 1234 --- [nio-8080-exec-5] c.e.m.AnnotatedService : Inside annotated method (span name: Annotated_Service_Method)
2025-06-23 23:55:00.155 INFO [my-single-app,g1h2i3j4k5l6m7n8,g1h2i3j4k5l6m7n8,false] 1234 --- [nio-8080-exec-5] c.e.m.MyController : Finished calling annotated method
</code></pre></div></div>

<h2 id="5-integration-with-zipkin-optional-but-recommended">5. Integration with Zipkin (Optional but Recommended)</h2>

<p>While this guide focuses on single applications, the real power of Sleuth comes when integrated with a distributed tracing system like Zipkin. Zipkin collects the trace and span data exported by Sleuth and provides a UI to visualize the flow and timing of requests.</p>

<p>To integrate with Zipkin, add the <code class="language-plaintext highlighter-rouge">spring-cloud-starter-zipkin</code> dependency:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>By default, Sleuth will attempt to send traces to a Zipkin collector running at <code class="language-plaintext highlighter-rouge">http://localhost:9411</code>. You can configure this in <code class="language-plaintext highlighter-rouge">application.properties</code>:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.zipkin.base-url</span><span class="p">=</span><span class="s">http://localhost:9411</span>
</code></pre></div></div>

<p>You can run a Zipkin server easily with Docker:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">-p</span> 9411:9411 openzipkin/zipkin
</code></pre></div></div>

<p>Once Zipkin is running, your single Spring Boot application will automatically send its trace data, and you can view the traces at <code class="language-plaintext highlighter-rouge">http://localhost:9411/</code>.</p>

<h2 id="6-sampling">6. Sampling</h2>

<p>By default, Sleuth applies a sampling strategy to avoid overwhelming the tracing system with data. It typically samples a percentage of requests. You can configure the sampling rate in <code class="language-plaintext highlighter-rouge">application.properties</code>:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Samples 100% of requests
</span><span class="py">spring.sleuth.sampler.probability</span><span class="p">=</span><span class="s">1.0</span>
</code></pre></div></div>

<p>A value of <code class="language-plaintext highlighter-rouge">1.0</code> means all requests will be traced, while <code class="language-plaintext highlighter-rouge">0.1</code> means 10% will be traced.</p>

<h2 id="7-conclusion">7. Conclusion</h2>

<p>Spring Cloud Sleuth, even in a single application, significantly enhances logging and debugging by automatically injecting <code class="language-plaintext highlighter-rouge">traceId</code> and <code class="language-plaintext highlighter-rouge">spanId</code> into your log messages. This allows you to easily follow the execution flow of a single request, even as it traverses different methods and threads. By understanding the core concepts of traces and spans and utilizing Sleuth’s automatic instrumentation or manual span creation, you can gain much better observability into your monolithic applications. Integrating with Zipkin further unlocks the potential for visualization and analysis of your application’s behavior.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
