<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Muon Optimizer with Orthogonalization for PyTorch</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Muon Optimizer with Orthogonalization for PyTorch | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Muon Optimizer with Orthogonalization for PyTorch" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-09-05-muon-ortho-optimizer-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-09-05-muon-ortho-optimizer-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Muon Optimizer with Orthogonalization for PyTorch" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Muon Optimizer with Orthogonalization for PyTorch","url":"https://lzwjava.github.io/notes/2025-09-05-muon-ortho-optimizer-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=091eb0f28e05039d5bccc16f85a6f837841dfc28">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=091eb0f28e05039d5bccc16f85a6f837841dfc28" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Muon Optimizer with Orthogonalization for PyTorch | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-09-05-muon-ortho-optimizer-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-09-05-muon-ortho-optimizer-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/muon-ortho-optimizer-en" selected>English</option>
        <option value="/muon-ortho-optimizer-zh" >中文</option>
        <option value="/muon-ortho-optimizer-ja" >日本語</option>
        <option value="/muon-ortho-optimizer-es" >Español</option>
        <option value="/muon-ortho-optimizer-hi" >हिंदी</option>
        <option value="/muon-ortho-optimizer-fr" >Français</option>
        <option value="/muon-ortho-optimizer-de" >Deutsch</option>
        <option value="/muon-ortho-optimizer-ar" >العربية</option>
        <option value="/muon-ortho-optimizer-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>Got it—here’s a clean PyTorch reference implementation you can drop into a project. It includes:</p>

<ul>
  <li>A tiny Newton–Schulz inverse–square-root to orthogonalize 2-D updates</li>
  <li>A <code class="language-plaintext highlighter-rouge">Muon</code> optimizer (AdamW-style weight decay, momentum, optional RMS scaling)</li>
  <li>A fallback for 1-D tensors (bias, LayerNorm weights)</li>
  <li>A minimal training example</li>
</ul>

<hr />

<h3 id="1-matrix-orthogonalization-helpers">1) Matrix orthogonalization helpers</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># muon_utils.py
</span><span class="kn">import</span> <span class="nn">torch</span>

<span class="o">@</span><span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">orthogonalize_by_svd</span><span class="p">(</span><span class="n">G</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="s">"""
    Nearest orthogonal (Procrustes): Q = U @ Vh, where G = U S Vh.
    Exact but can be slower on large mats.
    """</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Vh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">svd</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">U</span> <span class="o">@</span> <span class="n">Vh</span>

<span class="o">@</span><span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">inv_sqrt_newton_schulz</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="s">"""
    Compute A^{-1/2} for SPD A using Newton–Schulz.
    Assumes A is symmetric positive definite (e.g., G^T G + eps I).
    """</span>
    <span class="c1"># Normalize for better convergence
</span>    <span class="n">trace</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim2</span><span class="o">=-</span><span class="mi">1</span><span class="p">).</span><span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (...,1,1)
</span>    <span class="n">A_norm</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="p">(</span><span class="n">trace</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">A</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">A</span><span class="p">.</span><span class="n">dtype</span><span class="p">).</span><span class="n">expand_as</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">A_norm</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">I</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">I</span> <span class="o">-</span> <span class="n">Z</span> <span class="o">@</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">@</span> <span class="n">T</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">Z</span>

    <span class="c1"># A^{-1/2} ≈ Z / sqrt(trace)
</span>    <span class="k">return</span> <span class="n">Z</span> <span class="o">/</span> <span class="n">torch</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">trace</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>

<span class="o">@</span><span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">orthogonalize_by_newton_schulz</span><span class="p">(</span><span class="n">G</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="s">"""
    Q ≈ G (G^T G)^{-1/2}, using Newton–Schulz for the inverse square root.
    """</span>
    <span class="c1"># Make SPD; add eps*I for numerical stability
</span>    <span class="n">S</span> <span class="o">=</span> <span class="n">G</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">G</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">S</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">S</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">S</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">S_inv_sqrt</span> <span class="o">=</span> <span class="n">inv_sqrt_newton_schulz</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">iters</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span> <span class="o">@</span> <span class="n">S_inv_sqrt</span>
</code></pre></div></div>

<hr />

<h3 id="2-muon-optimizer">2) Muon optimizer</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># muon.py
</span><span class="kn">from</span> <span class="nn">torch.optim.optimizer</span> <span class="kn">import</span> <span class="n">Optimizer</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">muon_utils</span> <span class="kn">import</span> <span class="n">orthogonalize_by_newton_schulz</span><span class="p">,</span> <span class="n">orthogonalize_by_svd</span>

<span class="k">class</span> <span class="nc">Muon</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>
    <span class="sa">r</span><span class="s">"""
    Muon: structure-aware, matrix-orthogonalizing optimizer.
    - Momentum on grads
    - Decoupled weight decay (AdamW-style)
    - For 2D params: orthogonalize the momentum-avg update (Newton–Schulz or SVD)
    - For 1D/other shapes: RMS scaling on momentum like Adam (no orthogonalization)

    Args:
        params: iterable of parameters
        lr (float): learning rate
        beta (float): momentum factor (default 0.9)
        weight_decay (float): decoupled weight decay (default 0.01)
        eps (float): numerical eps (default 1e-8)
        ns_iters (int): Newton–Schulz iterations for orthogonalization (default 5)
        method (str): 'ns' for Newton–Schulz (default), or 'svd'
        rms_scale (bool): apply per-tensor RMS normalization to momentum for non-2D tensors (default True)
        clip_grad_norm (float|None): if set, clip momentum update by L2 norm before applying (default None)
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-8</span><span class="p">,</span>
        <span class="n">ns_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s">"ns"</span><span class="p">,</span>
        <span class="n">rms_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">clip_grad_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">lr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Invalid learning rate"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">beta</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Invalid beta"</span><span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">,</span>
            <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
            <span class="n">ns_iters</span><span class="o">=</span><span class="n">ns_iters</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">rms_scale</span><span class="o">=</span><span class="n">rms_scale</span><span class="p">,</span>
            <span class="n">clip_grad_norm</span><span class="o">=</span><span class="n">clip_grad_norm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>

    <span class="o">@</span><span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closure</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">closure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">enable_grad</span><span class="p">():</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"lr"</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"beta"</span><span class="p">]</span>
            <span class="n">wd</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"weight_decay"</span><span class="p">]</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"eps"</span><span class="p">]</span>
            <span class="n">ns_iters</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"ns_iters"</span><span class="p">]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"method"</span><span class="p">]</span>
            <span class="n">rms_scale</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"rms_scale"</span><span class="p">]</span>
            <span class="n">clip_gn</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s">"clip_grad_norm"</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s">"params"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">grad</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">grad</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="c1"># Momentum buffer
</span>                <span class="k">if</span> <span class="s">"momentum"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="s">"momentum"</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">preserve_format</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">"momentum"</span><span class="p">]</span>

                <span class="c1"># m_t = beta*m_{t-1} + (1-beta)*g_t
</span>                <span class="n">m</span><span class="p">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">beta</span><span class="p">).</span><span class="n">add_</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta</span><span class="p">))</span>

                <span class="c1"># Optional global clip on the update direction (momentum)
</span>                <span class="k">if</span> <span class="n">clip_gn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">gnorm</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">norm</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">gnorm</span> <span class="o">&gt;</span> <span class="n">clip_gn</span><span class="p">:</span>
                        <span class="n">m</span><span class="p">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">clip_gn</span> <span class="o">/</span> <span class="p">(</span><span class="n">gnorm</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">))</span>

                <span class="c1"># Decoupled weight decay on parameters
</span>                <span class="k">if</span> <span class="n">wd</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">.</span><span class="n">mul_</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">wd</span><span class="p">)</span>

                <span class="c1"># Compute update direction U
</span>                <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Orthogonalize the matrix update
</span>                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"svd"</span><span class="p">:</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">orthogonalize_by_svd</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">orthogonalize_by_newton_schulz</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">ns_iters</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Non-matrix tensors: RMS scaling (Adam-like) to keep step sizes balanced
</span>                    <span class="k">if</span> <span class="n">rms_scale</span><span class="p">:</span>
                        <span class="n">rms</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="n">rms</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">U</span> <span class="o">=</span> <span class="n">m</span>

                <span class="c1"># Parameter update
</span>                <span class="n">p</span><span class="p">.</span><span class="n">add_</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=-</span><span class="n">lr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></div>

<hr />

<h3 id="3-minimal-usage-example">3) Minimal usage example</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># demo_muon.py
</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">muon</span> <span class="kn">import</span> <span class="n">Muon</span>

<span class="c1"># Toy model
</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
    <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>

<span class="c1"># Try Newton–Schulz orthogonalization (fast &amp; scalable). Use method='svd' for exact.
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Muon</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">ns_iters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">"ns"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"step </span><span class="si">{</span><span class="n">step</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s"> | loss = </span><span class="si">{</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h3 id="notes--tips">Notes &amp; tips</h3>

<ul>
  <li>For very large weight matrices, <code class="language-plaintext highlighter-rouge">method="ns"</code> avoids SVD and is typically much faster. If you’re validating correctness on small layers, compare with <code class="language-plaintext highlighter-rouge">method="svd"</code> to sanity-check.</li>
  <li><code class="language-plaintext highlighter-rouge">ns_iters=3..6</code> is a good practical range. Fewer iterations = faster but slightly less precise orthogonalization.</li>
  <li>Keep a small <code class="language-plaintext highlighter-rouge">weight_decay</code> (decoupled) and a moderate <code class="language-plaintext highlighter-rouge">beta</code> (e.g., 0.9). Learning rate around <code class="language-plaintext highlighter-rouge">1e-3</code> to <code class="language-plaintext highlighter-rouge">3e-4</code> is a reasonable starting point for transformers/MLPs.</li>
  <li>If training gets spiky, enable <code class="language-plaintext highlighter-rouge">clip_grad_norm</code> (e.g., <code class="language-plaintext highlighter-rouge">1.0–5.0</code>) in the constructor.</li>
</ul>

<p>If you want, I can adapt this to your exact model setup (e.g., torch.compile, FSDP/ZeRO, MoE layers, custom per-param configs).</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
