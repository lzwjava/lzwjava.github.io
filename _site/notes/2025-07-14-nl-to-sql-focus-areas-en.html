<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Building Accurate and Secure NL-to-SQL Systems</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Building Accurate and Secure NL-to-SQL Systems | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Building Accurate and Secure NL-to-SQL Systems" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-07-14-nl-to-sql-focus-areas-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-07-14-nl-to-sql-focus-areas-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Building Accurate and Secure NL-to-SQL Systems" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Building Accurate and Secure NL-to-SQL Systems","url":"https://lzwjava.github.io/notes/2025-07-14-nl-to-sql-focus-areas-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=06a779b644a1993f93220b95ba8d93ff00cb1e62">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=06a779b644a1993f93220b95ba8d93ff00cb1e62" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Building Accurate and Secure NL-to-SQL Systems | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-07-14-nl-to-sql-focus-areas-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-07-14-nl-to-sql-focus-areas-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/nl-to-sql-focus-areas-en" selected>English</option>
        <option value="/nl-to-sql-focus-areas-zh" >中文</option>
        <option value="/nl-to-sql-focus-areas-ja" >日本語</option>
        <option value="/nl-to-sql-focus-areas-es" >Español</option>
        <option value="/nl-to-sql-focus-areas-hi" >हिंदी</option>
        <option value="/nl-to-sql-focus-areas-fr" >Français</option>
        <option value="/nl-to-sql-focus-areas-de" >Deutsch</option>
        <option value="/nl-to-sql-focus-areas-ar" >العربية</option>
        <option value="/nl-to-sql-focus-areas-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <h3 id="key-focus-areas-when-building-an-nl-to-sql-system">Key Focus Areas When Building an NL-to-SQL System</h3>

<p>Building a natural language to SQL (NL-to-SQL) system involves translating user queries in everyday language into executable SQL statements, often using AI models like LLMs (e.g., GPT variants or specialized models like those from Hugging Face). Based on your PostgreSQL schema and example query, here are the main areas to focus on:</p>

<h4 id="1-accuracy-and-understanding-of-the-schema">1. <strong>Accuracy and Understanding of the Schema</strong></h4>
<ul>
  <li><strong>Schema Awareness</strong>: Always provide the full database schema (tables, columns, data types, relationships) in the AI prompt. This helps the model generate correct SQL. In your case, emphasize columns like <code class="language-plaintext highlighter-rouge">first_name</code>, <code class="language-plaintext highlighter-rouge">created_at</code>, <code class="language-plaintext highlighter-rouge">date_of_birth</code>, and <code class="language-plaintext highlighter-rouge">last_login</code> to avoid hallucinations (e.g., inventing non-existent fields).</li>
  <li><strong>Handling Ambiguity</strong>: Natural language is vague—e.g., “around the day last month” could mean ±1 day, but clarify via prompts to interpret fuzzy terms (e.g., “recent week” as 7 days). Use examples in prompts to guide interpretations.</li>
  <li><strong>Data Types and Functions</strong>: Focus on PostgreSQL-specific syntax, like using <code class="language-plaintext highlighter-rouge">AGE()</code> for dates, <code class="language-plaintext highlighter-rouge">ILIKE</code> for case-insensitive strings, and proper casting (e.g., <code class="language-plaintext highlighter-rouge">CAST(created_at AS DATE)</code> in your example). Train or fine-tune the model on SQL dialect differences.</li>
  <li><strong>Edge Cases</strong>: Handle complex queries like joins (if multiple tables), aggregations (e.g., COUNT, SUM), or subqueries. Test for queries involving sensitive fields like <code class="language-plaintext highlighter-rouge">password_hash</code> or <code class="language-plaintext highlighter-rouge">account_balance</code>.</li>
</ul>

<h4 id="2-performance-and-optimization">2. <strong>Performance and Optimization</strong></h4>
<ul>
  <li>Generate efficient SQL: Encourage the model to use indexes (e.g., on <code class="language-plaintext highlighter-rouge">created_at</code> or <code class="language-plaintext highlighter-rouge">first_name</code>), limit results (add <code class="language-plaintext highlighter-rouge">LIMIT</code> by default), and avoid full-table scans.</li>
  <li>Scalability: For large datasets, integrate query optimization tools or validate generated SQL against an explain plan.</li>
</ul>

<h4 id="3-error-handling-and-validation">3. <strong>Error Handling and Validation</strong></h4>
<ul>
  <li>Parse and validate generated SQL before execution (e.g., using a SQL parser library like <code class="language-plaintext highlighter-rouge">sqlparse</code> in Python).</li>
  <li>Provide fallback responses: If the query is unclear, prompt the user for clarification instead of generating invalid SQL.</li>
</ul>

<h4 id="4-security-and-safety">4. <strong>Security and Safety</strong></h4>
<ul>
  <li><strong>Preventing SQL Injection</strong>: The risk comes from executing the generated SQL. Never concatenate user input directly into SQL strings. Instead:
    <ul>
      <li>Use <strong>parameterized queries</strong> or prepared statements when executing (e.g., in Python with <code class="language-plaintext highlighter-rouge">psycopg2</code>: <code class="language-plaintext highlighter-rouge">cursor.execute("SELECT * FROM users WHERE first_name = %s", (name,))</code>).</li>
      <li>Instruct the AI to generate SQL with placeholders (e.g., <code class="language-plaintext highlighter-rouge">WHERE first_name ILIKE %s</code>) and bind values separately.</li>
      <li>Sanitize NL inputs: Pre-process user queries to remove malicious patterns (e.g., using regex to detect SQL keywords like “DROP” or “;”).</li>
      <li>Limit to read-only: Restrict the AI to generating SELECT queries only—block DDL (e.g., CREATE/DROP) or DML (e.g., INSERT/UPDATE) via prompt instructions like “Only generate SELECT statements; do not modify data.”</li>
    </ul>
  </li>
  <li><strong>Controlling Data Access</strong>:
    <ul>
      <li><strong>Row-Level Security (RLS)</strong>: In PostgreSQL, enable RLS policies on tables (e.g., <code class="language-plaintext highlighter-rouge">ALTER TABLE users ENABLE ROW LEVEL SECURITY; CREATE POLICY user_policy ON users USING (role = current_user);</code>). This ensures queries only return rows the user has access to.</li>
      <li><strong>Views and Roles</strong>: Create restricted views (e.g., <code class="language-plaintext highlighter-rouge">CREATE VIEW safe_users AS SELECT id, username, first_name FROM users;</code>) and grant access via database roles. The AI should query views instead of base tables.</li>
      <li><strong>API Layer</strong>: Wrap the system in an API (e.g., using FastAPI) that authenticates users and applies access controls (e.g., JWT tokens to determine user roles).</li>
      <li><strong>Sandbox Execution</strong>: Run queries in a read-only replica database or a containerized environment (e.g., Docker) to isolate from production data.</li>
      <li><strong>Audit Logging</strong>: Log all generated SQL and executions for monitoring.</li>
    </ul>
  </li>
  <li><strong>Data Privacy</strong>: Avoid exposing sensitive columns (e.g., <code class="language-plaintext highlighter-rouge">password_hash</code>, <code class="language-plaintext highlighter-rouge">email</code>) by blacklisting them in prompts: “Do not select sensitive fields like password_hash, email unless explicitly needed and authorized.”</li>
  <li><strong>Rate Limiting and Quotas</strong>: Prevent abuse by limiting queries per user/session.</li>
</ul>

<h4 id="5-prompt-engineering-for-controlled-conversion">5. <strong>Prompt Engineering for Controlled Conversion</strong></h4>
<ul>
  <li>The quality of NL-to-SQL depends heavily on how you instruct the AI. Use structured prompts with these elements:
    <ul>
      <li><strong>System Prompt Template</strong>:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You are an expert SQL generator for PostgreSQL. Given the schema below and a natural language query, generate a safe, accurate SELECT query. 

Schema:
[Insert full schema here, e.g., CREATE TABLE users (...)]

Rules:
- Only generate SELECT statements. No INSERT, UPDATE, DELETE, or DDL.
- Use parameterized placeholders (e.g., %s) for user-provided values to prevent injection.
- Handle dates with PostgreSQL functions like AGE(), CURRENT_DATE, INTERVAL.
- For ambiguous terms (e.g., "around last month"), interpret as [specific rule, e.g., ±1 day from the same day last month].
- Limit results to 100 rows unless specified.
- If the query involves age, calculate as of the current year or specified year (e.g., EXTRACT(YEAR FROM AGE(CURRENT_DATE, date_of_birth)) = 20).
- Do not select sensitive columns like password_hash, email.
- If unclear, respond with "Clarify: [question]".

User Query: [NL query]
</code></pre></div>        </div>
      </li>
      <li><strong>Examples in Prompts</strong>: Include 2-3 shot examples, like your provided query and generated SQL, to guide the model.</li>
      <li><strong>Chain of Thought</strong>: Instruct the model to reason step-by-step: “First, identify key filters. Second, map to columns. Third, build WHERE clause.”</li>
      <li><strong>Fine-Tuning</strong>: If using a custom model, fine-tune on datasets like Spider or WikiSQL, augmented with your schema-specific examples.</li>
      <li><strong>Testing</strong>: Evaluate with metrics like execution accuracy (does it run without errors?) and semantic match (does it return expected results?).</li>
    </ul>
  </li>
</ul>

<h4 id="potential-improvements-to-your-example-query">Potential Improvements to Your Example Query</h4>
<p>While not the main question, your generated SQL has some good elements but could be safer/more precise:</p>
<ul>
  <li>Use parameters: Change to <code class="language-plaintext highlighter-rouge">WHERE first_name ILIKE %s</code> and bind ‘andy’.</li>
  <li>Age “as of 2025”: Use <code class="language-plaintext highlighter-rouge">EXTRACT(YEAR FROM AGE('2025-12-31'::date, date_of_birth)) = 20</code> to fix to a specific year-end.</li>
  <li>Add <code class="language-plaintext highlighter-rouge">ORDER BY last_login DESC LIMIT 10;</code> for safety.</li>
</ul>

<p>Implementing this safely requires a backend layer (e.g., not executing SQL directly from the AI output). Start small with a script using an LLM library (e.g., LangChain for NL-to-SQL chains).</p>

<p>If you need code examples or help with specific parts (e.g., a Python implementation), provide more details!</p>

<p><strong>References</strong><br />
<a href="https://www.postgresql.org/docs/current/ddl-rowsecurity.html">PostgreSQL Documentation: Row-Level Security</a><br />
<a href="https://python.langchain.com/docs/tutorials/sql_qa/">LangChain NL-to-SQL Tutorial</a><br />
<a href="https://realpython.com/prevent-python-sql-injection/">Preventing SQL Injection in Python</a></p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
