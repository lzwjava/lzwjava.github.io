<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Preventing Event Loss During AKS Scaling</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Preventing Event Loss During AKS Scaling | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Preventing Event Loss During AKS Scaling" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-10-22-aks-scaling-event-loss-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-10-22-aks-scaling-event-loss-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Preventing Event Loss During AKS Scaling" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Preventing Event Loss During AKS Scaling","url":"https://lzwjava.github.io/notes/2025-10-22-aks-scaling-event-loss-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=2fde584d40acbc02fd538575043702ef5ed3917d">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=2fde584d40acbc02fd538575043702ef5ed3917d" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Preventing Event Loss During AKS Scaling | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-10-22-aks-scaling-event-loss-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-10-22-aks-scaling-event-loss-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/aks-scaling-event-loss-en" selected>English</option>
        <option value="/aks-scaling-event-loss-zh" >中文</option>
        <option value="/aks-scaling-event-loss-ja" >日本語</option>
        <option value="/aks-scaling-event-loss-es" >Español</option>
        <option value="/aks-scaling-event-loss-hi" >हिंदी</option>
        <option value="/aks-scaling-event-loss-fr" >Français</option>
        <option value="/aks-scaling-event-loss-de" >Deutsch</option>
        <option value="/aks-scaling-event-loss-ar" >العربية</option>
        <option value="/aks-scaling-event-loss-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <h3 id="likely-cause-of-event-loss">Likely Cause of Event Loss</h3>
<p>When your service auto-scales from 1 to 2 pods in Azure Kubernetes Service (AKS), the initial pod handles the increasing load alone until the new pod is ready (typically 1-2 minutes, depending on your Horizontal Pod Autoscaler (HPA) config). If event volume spikes during this window, your Event Hubs namespace may throttle ingress (e.g., due to insufficient throughput units), leading to ~1% loss (ServerBusy errors). Event Hubs provides at-least-once delivery, but without proper retries, throttled sends fail silently or drop events.</p>

<p>Scaling up itself doesn’t disrupt the existing pod’s connection—loss stems from transient overload, not pod termination.</p>

<h3 id="how-to-fix-and-configure">How to Fix and Configure</h3>
<p>To handle this reliably:</p>

<ol>
  <li><strong>Enable Auto-Inflate on Event Hubs Namespace</strong><br />
This automatically scales throughput units (TUs) when ingress exceeds your baseline (e.g., from 1 to 20 TUs), preventing throttling during load spikes like scaling events.
    <ul>
      <li>In Azure Portal: Go to your Event Hubs namespace &gt; <strong>Settings</strong> &gt; <strong>Scale</strong> &gt; Check <strong>Enable auto-inflate</strong> &gt; Set max TUs (e.g., 20) &gt; Save.</li>
      <li>CLI: <code class="language-plaintext highlighter-rouge">az eventhubs namespace update --resource-group &lt;rg&gt; --name &lt;namespace&gt; --enable-auto-inflate true --maximum-throughput-units 20</code></li>
      <li>Cost: Billed per hour for the max reached; start with 5-10 TUs baseline.<br />
This ensures capacity grows proactively without manual intervention.</li>
    </ul>
  </li>
  <li><strong>Configure Producer Client for Retries and Reliability</strong><br />
Use the Azure Event Hubs SDK in your app code to implement exponential backoff retries on transient errors (throttling, timeouts). Defaults are often 3 retries with 60s timeout—tune for your needs. Batch events (e.g., 100-500 per send) to reduce API calls and improve resilience.
    <ul>
      <li><strong>General Best Practices</strong>:
        <ul>
          <li>Set max retries: 5-10.</li>
          <li>Exponential backoff: Start at 1s, max delay 30s.</li>
          <li>Connection timeout: 30-60s.</li>
          <li>Use idempotent keys (e.g., UUID per event) if duplicates are tolerable (Event Hubs supports this in Premium/Dedicated tiers).</li>
          <li>Monitor via Azure Monitor: Track <code class="language-plaintext highlighter-rouge">IncomingMessages</code> vs. <code class="language-plaintext highlighter-rouge">ThrottledRequests</code> metrics.</li>
        </ul>
      </li>
      <li><strong>Example: .NET (Azure.Messaging.EventHubs)</strong>
        <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Azure.Messaging.EventHubs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Azure.Messaging.EventHubs.Producer</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">connectionString</span> <span class="p">=</span> <span class="s">"&lt;your-connection-string&gt;"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">eventHubName</span> <span class="p">=</span> <span class="s">"&lt;your-eventhub-name&gt;"</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">clientOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventHubProducerClientOptions</span>
<span class="p">{</span>
    <span class="n">Retry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventHubsRetryOptions</span>
    <span class="p">{</span>
        <span class="n">TryTimeout</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">60</span><span class="p">),</span>  <span class="c1">// Per-operation timeout</span>
        <span class="n">MaximumTries</span> <span class="p">=</span> <span class="m">7</span><span class="p">,</span>  <span class="c1">// Max retries</span>
        <span class="n">Delay</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">),</span>  <span class="c1">// Initial backoff</span>
        <span class="n">MaximumDelay</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">30</span><span class="p">),</span>  <span class="c1">// Max backoff</span>
        <span class="n">Mode</span> <span class="p">=</span> <span class="n">RetryMode</span><span class="p">.</span><span class="n">Exponential</span>  <span class="c1">// Backoff strategy</span>
    <span class="p">},</span>
    <span class="n">ConnectionOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventHubConnectionOptions</span>
    <span class="p">{</span>
        <span class="n">TransportType</span> <span class="p">=</span> <span class="n">EventHubsTransportType</span><span class="p">.</span><span class="n">AmqpWebSockets</span>  <span class="c1">// For AKS networking</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">await</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">producer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventHubProducerClient</span><span class="p">(</span><span class="n">connectionString</span><span class="p">,</span> <span class="n">eventHubName</span><span class="p">,</span> <span class="n">clientOptions</span><span class="p">);</span>

<span class="c1">// Send batch</span>
<span class="k">using</span> <span class="nn">var</span> <span class="n">batch</span> <span class="p">=</span> <span class="k">await</span> <span class="n">producer</span><span class="p">.</span><span class="nf">CreateBatchAsync</span><span class="p">(</span><span class="k">new</span> <span class="n">CreateBatchOptions</span> <span class="p">{</span> <span class="n">PartitionKey</span> <span class="p">=</span> <span class="s">"your-key"</span> <span class="p">});</span>
<span class="n">batch</span><span class="p">.</span><span class="nf">TryAdd</span><span class="p">(</span><span class="k">new</span> <span class="nf">EventData</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"event-data"</span><span class="p">)));</span>
<span class="k">await</span> <span class="n">producer</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">batch</span><span class="p">);</span>
</code></pre></div>        </div>
        <p>This retries on ServerBusy, ensuring events land post-scale.</p>
      </li>
      <li><strong>Example: Java (Azure Event Hubs Client)</strong>
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.azure.messaging.eventhubs.EventHubProducerAsyncClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.azure.messaging.eventhubs.EventHubProducerClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.azure.messaging.eventhubs.models.CreateBatchOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.azure.messaging.eventhubs.models.EventHubProducerAsyncClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.azure.core.amqp.AmqpRetryOptions</span><span class="o">;</span>

<span class="nc">String</span> <span class="n">connectionString</span> <span class="o">=</span> <span class="s">"&lt;your-connection-string&gt;"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">eventHubName</span> <span class="o">=</span> <span class="s">"&lt;your-eventhub-name&gt;"</span><span class="o">;</span>

<span class="nc">AmqpRetryOptions</span> <span class="n">retryOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AmqpRetryOptions</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setMaxRetries</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setInitialDelay</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
    <span class="o">.</span><span class="na">setMaxDelay</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">30</span><span class="o">))</span>
    <span class="o">.</span><span class="na">setTryTimeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">));</span>

<span class="nc">EventHubProducerAsyncClient</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventHubProducerClientBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">connectionString</span><span class="o">(</span><span class="n">connectionString</span><span class="o">,</span> <span class="n">eventHubName</span><span class="o">)</span>
    <span class="o">.</span><span class="na">retryOptions</span><span class="o">(</span><span class="n">retryOptions</span><span class="o">)</span>
    <span class="o">.</span><span class="na">transportType</span><span class="o">(</span><span class="nc">TransportType</span><span class="o">.</span><span class="na">AMQP_WEB_SOCKETS</span><span class="o">)</span>  <span class="c1">// For AKS</span>
    <span class="o">.</span><span class="na">buildAsyncClient</span><span class="o">();</span>

<span class="c1">// Send batch</span>
<span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">PartitionInformation</span><span class="o">&gt;</span> <span class="n">partitions</span> <span class="o">=</span> <span class="n">producer</span><span class="o">.</span><span class="na">getPartitionPropertiesFlux</span><span class="o">();</span>
<span class="c1">// ... logic to send batch with retries built-in</span>
</code></pre></div>        </div>
        <p>The SDK handles retries transparently on errors.</p>
      </li>
      <li><strong>Other Languages</strong>: Similar patterns in Python (azure-eventhub), Node.js (use retry options in EventHubProducerClient). See SDK docs for your stack.</li>
    </ul>
  </li>
  <li><strong>AKS-Specific Handling for Scaling</strong>
    <ul>
      <li><strong>Proactive Scaling</strong>: Tune HPA to scale earlier (e.g., target CPU 60% vs. 80%) to reduce overload window:<br />
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: your-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: your-app
  minReplicas: 1
  maxReplicas: 10
  metrics:
        <ul>
          <li>type: Resource
resource:
  name: cpu
  target:
    type: Utilization
    averageUtilization: 60  # Scale at 60% CPU
```<br />
Apply with <code class="language-plaintext highlighter-rouge">kubectl apply -f hpa.yaml</code>.</li>
        </ul>
      </li>
      <li><strong>Graceful Pod Behavior</strong>: Set <code class="language-plaintext highlighter-rouge">terminationGracePeriodSeconds: 30</code> in your Deployment YAML to allow buffered events to flush on future scale-downs (not directly for up, but good practice).</li>
      <li><strong>Networking</strong>: Use WebSockets (AMQP over WebSockets) in client options for better AKS egress handling.</li>
      <li><strong>Monitoring</strong>: Enable AKS diagnostics to Log Analytics; query for pod events during scale (e.g., <code class="language-plaintext highlighter-rouge">KubePodInventory | where TimeGenerated &gt; ago(1h)</code>).</li>
    </ul>
  </li>
  <li><strong>Additional Safeguards</strong>
    <ul>
      <li><strong>Zone-Redundant Namespace</strong>: Enable in namespace creation (default in supported regions) for 99.99% SLA and no loss during zone failures.</li>
      <li><strong>Partitions</strong>: Use 4-32 partitions based on load (e.g., match expected parallel producers); assign partition keys for ordered grouping.</li>
      <li><strong>Capture Feature</strong>: Enable Event Hubs Capture to Blob Storage as a backup for any rare losses (Premium tier).</li>
      <li><strong>Test</strong>: Simulate load with tools like Apache JMeter; monitor for zero throttling post-config.</li>
    </ul>
  </li>
</ol>

<p>This setup should drop loss to near-zero. Start with auto-inflate + client retries for quick wins.</p>

<h3 id="references">References</h3>
<ul>
  <li><a href="https://learn.microsoft.com/en-us/azure/reliability/reliability-event-hubs">Reliability in Azure Event Hubs</a></li>
  <li><a href="https://learn.microsoft.com/en-us/azure/event-hubs/event-hubs-scalability">Scaling with Event Hubs</a></li>
  <li><a href="https://learn.microsoft.com/en-us/dotnet/api/azure.messaging.eventhubs.producer.eventhubproducerclientoptions.retryoptions">Event Hubs .NET SDK Retry Options</a></li>
  <li><a href="https://learn.microsoft.com/en-us/azure/aks/concepts-scale">AKS Scaling Concepts</a></li>
</ul>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    
      <p class="model">x-ai/grok-4-fast</p>
    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
