<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Spring Boot Log4j Request Tracing</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Spring Boot Log4j Request Tracing | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Spring Boot Log4j Request Tracing" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-03-24-spring-traceid-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-03-24-spring-traceid-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spring Boot Log4j Request Tracing" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Spring Boot Log4j Request Tracing","url":"https://lzwjava.github.io/notes/2025-03-24-spring-traceid-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=51821244f31e7e64dc693bd01d54fef4babbf6be">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=51821244f31e7e64dc693bd01d54fef4babbf6be" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Spring Boot Log4j Request Tracing | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-03-24-spring-traceid-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-03-24-spring-traceid-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/spring-traceid-en" selected>English</option>
        <option value="/spring-traceid-zh" >中文</option>
        <option value="/spring-traceid-ja" >日本語</option>
        <option value="/spring-traceid-es" >Español</option>
        <option value="/spring-traceid-hi" >हिंदी</option>
        <option value="/spring-traceid-fr" >Français</option>
        <option value="/spring-traceid-de" >Deutsch</option>
        <option value="/spring-traceid-ar" >العربية</option>
        <option value="/spring-traceid-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>In a Java Spring Boot application using Log4j without a built-in trace ID design, tracking a specific log entry back to a frontend-initiated request can indeed be challenging. You’re correct that <code class="language-plaintext highlighter-rouge">%t</code> (thread name) in Log4j can help identify logs tied to a specific thread, but as you noted, this becomes less reliable when requests span multiple threads (e.g., due to async processing, thread pools, or downstream calls). Using a time range to search logs is a workaround, but it’s imprecise and cumbersome, especially in high-traffic systems. Let’s explore some practical advice to improve this situation without overhauling your entire setup.</p>

<h3 id="quick-and-practical-suggestions">Quick and Practical Suggestions</h3>
<ol>
  <li><strong>Leverage MDC (Mapped Diagnostic Context) with Log4j</strong>
    <ul>
      <li>Log4j supports MDC, which allows you to attach contextual key-value pairs to logs within a thread (and even propagate them across thread boundaries with some care).</li>
      <li>Generate a unique request ID when the frontend request hits your Spring Boot application (e.g., a UUID), and store it in the MDC. Then, include this ID in your log pattern.</li>
      <li><strong>How to implement:</strong>
        <ul>
          <li>In a Spring Boot filter or interceptor (e.g., <code class="language-plaintext highlighter-rouge">OncePerRequestFilter</code>), generate the ID:
            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.slf4j.MDC</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestTracingFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">traceId</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
            <span class="no">MDC</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"traceId"</span><span class="o">,</span> <span class="n">traceId</span><span class="o">);</span>
            <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="no">MDC</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="c1">// Clean up after request</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>            </div>
          </li>
          <li>Register the filter in your Spring Boot config:
            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">FilterRegistrationBean</span><span class="o">&lt;</span><span class="nc">RequestTracingFilter</span><span class="o">&gt;</span> <span class="nf">tracingFilter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">FilterRegistrationBean</span><span class="o">&lt;</span><span class="nc">RequestTracingFilter</span><span class="o">&gt;</span> <span class="n">registrationBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterRegistrationBean</span><span class="o">&lt;&gt;();</span>
    <span class="n">registrationBean</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestTracingFilter</span><span class="o">());</span>
    <span class="n">registrationBean</span><span class="o">.</span><span class="na">addUrlPatterns</span><span class="o">(</span><span class="s">"/*"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">registrationBean</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>            </div>
          </li>
          <li>Update your Log4j pattern in <code class="language-plaintext highlighter-rouge">log4j.properties</code> or <code class="language-plaintext highlighter-rouge">log4j.xml</code> to include the <code class="language-plaintext highlighter-rouge">traceId</code>:
            <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">log4j.appender.console.layout.ConversionPattern</span><span class="p">=</span><span class="s">%d{yyyy-MM-dd HH:mm:ss} [%t] %-5p %c{1} - %m [traceId=%X{traceId}]%n</span>
</code></pre></div>            </div>
          </li>
          <li>Now, every log line tied to that request will include the <code class="language-plaintext highlighter-rouge">traceId</code>, making it easy to trace back to the frontend button click.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Propagate the Trace ID Across Threads</strong>
    <ul>
      <li>If your app uses thread pools or async calls (e.g., <code class="language-plaintext highlighter-rouge">@Async</code>), the MDC context may not propagate automatically. To handle this:
        <ul>
          <li>Wrap async tasks with a custom executor that copies the MDC context:
            <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsyncConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"taskExecutor"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Executor</span> <span class="nf">taskExecutor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setTaskDecorator</span><span class="o">(</span><span class="n">task</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="no">MDC</span><span class="o">.</span><span class="na">getCopyOfContextMap</span><span class="o">();</span>
            <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="no">MDC</span><span class="o">.</span><span class="na">setContextMap</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                    <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="no">MDC</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">};</span>
        <span class="o">});</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>            </div>
          </li>
          <li>This ensures the <code class="language-plaintext highlighter-rouge">traceId</code> sticks with the request even across thread boundaries.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Add Frontend Correlation</strong>
    <ul>
      <li>If possible, have the frontend send a custom header (e.g., <code class="language-plaintext highlighter-rouge">X-Request-ID</code>) with a unique ID when the button is clicked. Your backend can pick this up instead of generating its own UUID. This ties the log directly to the frontend action without extra guesswork.</li>
    </ul>
  </li>
  <li><strong>Fallback: Enhance Logging with Contextual Data</strong>
    <ul>
      <li>If MDC feels like too much overhead right now, enrich your logs with more context at key points (e.g., user ID, session ID, or endpoint name). For example:
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Button clicked, endpoint=/api/example, user={}"</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
</code></pre></div>        </div>
      </li>
      <li>Combine this with <code class="language-plaintext highlighter-rouge">%t</code> (thread name) and a tight time range to narrow down logs manually. It’s not ideal but works in a pinch.</li>
    </ul>
  </li>
</ol>

<h3 id="why-not-just-time-range">Why Not Just Time Range?</h3>
<p>Relying solely on timestamps is fragile because:</p>
<ul>
  <li>Logs from concurrent requests overlap, especially in a busy system.</li>
  <li>Time precision (e.g., milliseconds) might not be enough to isolate a single request.</li>
  <li>It’s tedious to correlate logs across services or deep call stacks.</li>
</ul>

<h3 id="long-term-recommendation">Long-Term Recommendation</h3>
<p>If this tracing need grows, consider adopting Spring Boot’s built-in support for distributed tracing (e.g., via Sleuth or Micrometer with Zipkin). Sleuth auto-generates trace and span IDs and integrates seamlessly with Log4j, but it’s more involved to set up. For now, MDC is a lightweight, effective middle ground.</p>

<h3 id="final-advice">Final Advice</h3>
<p>Start with the MDC approach—it’s simple, leverages Log4j’s native capabilities, and gives you a clear way to tie logs to a frontend-initiated request. You’ll see something like <code class="language-plaintext highlighter-rouge">[traceId=123e4567-e89b-12d3-a456-426614174000]</code> in every log line for that request, making it trivial to search and trace. Let me know if you need help tweaking this further!</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
