<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>End-to-End Trace to LLM Agent Pipeline</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>End-to-End Trace to LLM Agent Pipeline | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="End-to-End Trace to LLM Agent Pipeline" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-03-13-llm-agent-trace-pipeline-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-03-13-llm-agent-trace-pipeline-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="End-to-End Trace to LLM Agent Pipeline" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"End-to-End Trace to LLM Agent Pipeline","url":"https://lzwjava.github.io/notes/2025-03-13-llm-agent-trace-pipeline-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=4078a2582799c9fd02a1981696d374189b201186">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=4078a2582799c9fd02a1981696d374189b201186" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       End-to-End Trace to LLM Agent Pipeline | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-03-13-llm-agent-trace-pipeline-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-03-13-llm-agent-trace-pipeline-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.09</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/llm-agent-trace-pipeline-en" selected>English</option>
        <option value="/llm-agent-trace-pipeline-zh" >中文</option>
        <option value="/llm-agent-trace-pipeline-ja" >日本語</option>
        <option value="/llm-agent-trace-pipeline-es" >Español</option>
        <option value="/llm-agent-trace-pipeline-hi" >हिंदी</option>
        <option value="/llm-agent-trace-pipeline-fr" >Français</option>
        <option value="/llm-agent-trace-pipeline-de" >Deutsch</option>
        <option value="/llm-agent-trace-pipeline-ar" >العربية</option>
        <option value="/llm-agent-trace-pipeline-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>You’re on a solid track: AOP (AspectJ), servlet filters, and Log4j2 each shine at different layers. Here’s a compact, end-to-end way to use them together—first to <strong>harvest execution traces and HTTP I/O</strong> (so you can auto-mint Python tests), then to <strong>feed rich context to an LLM “agent” endpoint in Spring</strong>.</p>

<hr />

<h2 id="1-capture-what-you-need-aop--filter--log4j2">1) Capture what you need (AOP + Filter + Log4j2)</h2>

<p><strong>a) Method interception with AOP (timings, args, return/throwables).</strong></p>

<p>Use <code class="language-plaintext highlighter-rouge">@Around</code> advice to wrap service methods; store a <code class="language-plaintext highlighter-rouge">traceId</code> in MDC so logs from all layers join up.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceAspect</span> <span class="o">{</span>
  <span class="nd">@Around</span><span class="o">(</span><span class="s">"execution(* com.example.service..*(..))"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log4j</span><span class="o">.</span><span class="na">ThreadContext</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"traceId"</span><span class="o">,</span> <span class="n">traceId</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">out</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
      <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log4j</span><span class="o">.</span><span class="na">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getTarget</span><span class="o">().</span><span class="na">getClass</span><span class="o">())</span>
        <span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"AOP"</span><span class="o">,</span> <span class="s">"method={},args={},ret={},ms={},traceId={}"</span><span class="o">,</span>
              <span class="n">pjp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">toShortString</span><span class="o">(),</span>
              <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">()),</span> <span class="n">out</span><span class="o">,</span>
              <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()-</span><span class="n">t0</span><span class="o">)/</span><span class="mf">1_000_000.0</span><span class="o">,</span> <span class="n">traceId</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">out</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log4j</span><span class="o">.</span><span class="na">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getTarget</span><span class="o">().</span><span class="na">getClass</span><span class="o">())</span>
        <span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"AOP_ERR"</span><span class="o">,</span> <span class="s">"method={},args={},err={},traceId={}"</span><span class="o">,</span>
               <span class="n">pjp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">toShortString</span><span class="o">(),</span>
               <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getArgs</span><span class="o">()),</span>
               <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">traceId</span><span class="o">);</span>
      <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log4j</span><span class="o">.</span><span class="na">ThreadContext</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"traceId"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>(“Around advice” is the right tool when you need pre/post logic and control of the call. (<a href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/advice.html?utm_source=chatgpt.com" title="Declaring Advice :: Spring Framework">Home</a>, <a href="https://www.digitalocean.com/community/tutorials/spring-aop-example-tutorial-aspect-advice-pointcut-joinpoint-annotations?utm_source=chatgpt.com" title="Spring AOP Example Tutorial - Aspect, Advice, Pointcut, ...">DigitalOcean</a>))</p>

<p><strong>b) HTTP logging with a Filter (request/response body + status).</strong></p>

<p>Wrap the request/response once per call; attach the same <code class="language-plaintext highlighter-rouge">traceId</code> (from header or generate). Spring’s <code class="language-plaintext highlighter-rouge">OncePerRequestFilter</code> pattern is standard. Good guides show how to buffer body safely and avoid double-consumption. (<a href="https://www.baeldung.com/spring-http-logging?utm_source=chatgpt.com" title="Log Incoming Requests - Spring">Baeldung on Kotlin</a>, <a href="https://signoz.io/guides/spring-boot-how-to-log-all-requests-and-responses-with-exceptions-in-single-place/?utm_source=chatgpt.com" title="How to Log All Spring Boot Requests and Responses">SigNoz</a>)</p>

<p><strong>c) Route logs per user/tenant/test using Log4j2 RoutingAppender.</strong></p>

<p>This lets you send matched logs (e.g., by <code class="language-plaintext highlighter-rouge">traceId</code> or <code class="language-plaintext highlighter-rouge">tenantId</code> in MDC) into <strong>separate files</strong> you’ll later convert into tests.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Appenders&gt;</span>
  <span class="nt">&lt;Routing</span> <span class="na">name=</span><span class="s">"ByTrace"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Routes</span> <span class="na">pattern=</span><span class="s">"${ctx:traceId}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Route</span> <span class="na">ref=</span><span class="s">"RollingTemplate"</span> <span class="na">key=</span><span class="s">"${ctx:traceId}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/Routes&gt;</span>
  <span class="nt">&lt;/Routing&gt;</span>

  <span class="nt">&lt;RollingFile</span> <span class="na">name=</span><span class="s">"RollingTemplate"</span>
               <span class="na">fileName=</span><span class="s">"logs/${ctx:traceId}.log"</span>
               <span class="na">filePattern=</span><span class="s">"logs/${ctx:traceId}-%d{yyyy-MM-dd}.gz"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">"%d %p %c %X{traceId} - %m%n"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Policies&gt;&lt;TimeBasedTriggeringPolicy/&gt;&lt;/Policies&gt;</span>
  <span class="nt">&lt;/RollingFile&gt;</span>
<span class="nt">&lt;/Appenders&gt;</span>
<span class="nt">&lt;Loggers&gt;</span>
  <span class="nt">&lt;Root</span> <span class="na">level=</span><span class="s">"info"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">"ByTrace"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/Root&gt;</span>
<span class="nt">&lt;/Loggers&gt;</span>
</code></pre></div></div>

<p>(Log4j2’s RoutingAppender + MDC pattern is the canonical way to split logs by key. (<a href="https://logging.apache.org/log4j/2.12.x/manual/configuration.html?utm_source=chatgpt.com" title="Configuring Log4j 2 - Apache Logging Services">Apache Logging</a>, <a href="https://roytuts.com/how-to-create-separate-log-file-for-each-module-using-routingappender-and-mdc-mapped-diagnostic-context-in-log4j2-slf4j/?utm_source=chatgpt.com" title="How to create separate log file for each module using ...">Roy Tutorials</a>, <a href="https://stackoverflow.com/questions/18279656/wildcard-pattern-for-routingappender-of-log4j2?utm_source=chatgpt.com" title="Wildcard pattern for RoutingAppender of Log4j2 - java">Stack Overflow</a>))</p>

<hr />

<h2 id="2-turn-those-logs-into-python-tests-pytest--requests">2) Turn those logs into <strong>Python tests</strong> (pytest + requests)</h2>

<p>Once logs are JSON-ish or parseable lines, a tiny generator can emit deterministic tests:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gen_tests_from_logs.py
</span><span class="kn">import</span> <span class="nn">json</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">pathlib</span>

<span class="k">def</span> <span class="nf">extract_calls</span><span class="p">(</span><span class="n">log_text</span><span class="p">):</span>
    <span class="n">calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">log_text</span><span class="p">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="s">'"HTTP_IN"'</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s">'HTTP_IN'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">'({.*})'</span><span class="p">,</span> <span class="n">line</span><span class="p">).</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">calls</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
              <span class="s">"method"</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">"method"</span><span class="p">],</span>
              <span class="s">"url"</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">"path"</span><span class="p">],</span>
              <span class="s">"headers"</span><span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"headers"</span><span class="p">,</span> <span class="p">{}),</span>
              <span class="s">"body"</span><span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"body"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
              <span class="s">"expect_status"</span><span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"status"</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="n">calls</span>

<span class="k">def</span> <span class="nf">emit_pytest</span><span class="p">(</span><span class="n">calls</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s">"import requests"</span><span class="p">,</span>
      <span class="s">"import pytest"</span><span class="p">,</span>
      <span class="s">""</span><span class="p">,</span>
      <span class="s">"@pytest.mark.parametrize('call', ["</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
      <span class="n">lines</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s">,"</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s">"])"</span><span class="p">,</span>
      <span class="s">"def test_replay(call):"</span><span class="p">,</span>
      <span class="s">"    resp = requests.request(call['method'], 'http://localhost:8080'+call['url'],"</span><span class="p">,</span>
      <span class="s">"                             headers=call.get('headers'),"</span><span class="p">,</span>
      <span class="s">"                             json=call.get('body'))"</span><span class="p">,</span>
      <span class="s">"    assert resp.status_code == call['expect_status']"</span><span class="p">,</span>
      <span class="s">"    # optionally assert on structured fields from response JSON"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">all_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="s">'logs'</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">'*.log'</span><span class="p">):</span>
      <span class="n">all_calls</span> <span class="o">+=</span> <span class="n">extract_calls</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">))</span>
    <span class="n">pathlib</span><span class="p">.</span><span class="n">Path</span><span class="p">(</span><span class="s">'tests/test_replay_generated.py'</span><span class="p">).</span><span class="n">write_text</span><span class="p">(</span><span class="n">emit_pytest</span><span class="p">(</span><span class="n">all_calls</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Tips:</p>

<ul>
  <li>Prefer <strong>JSON logs</strong> for requests/responses; it makes test generation trivial.</li>
  <li>Keep sensitive headers out (e.g., Authorization).</li>
  <li>If bodies are large, store a hash in logs and assert hash equality rather than full string.</li>
</ul>

<hr />

<h2 id="3-use-spring-to-provide-context-to-llm-agents">3) Use Spring to <strong>provide context</strong> to LLM “agents”</h2>

<p>If you’re on Spring Boot today, the shortest path is <strong>Spring AI</strong>:</p>

<p><strong>a) Set up a <code class="language-plaintext highlighter-rouge">ChatClient</code> and prompt templates.</strong>
Spring AI gives you <code class="language-plaintext highlighter-rouge">ChatClient</code>/<code class="language-plaintext highlighter-rouge">PromptTemplate</code> abstractions and tool-calling so the model can ask your app to fetch data. (<a href="https://spring.io/projects/spring-ai?utm_source=chatgpt.com" title="Spring AI">Home</a>, <a href="https://docs.spring.io/spring-ai/reference/api/tools.html?utm_source=chatgpt.com" title="Tool Calling :: Spring AI Reference">Home</a>)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AiConfig</span> <span class="o">{</span>
  <span class="nd">@Bean</span> <span class="nc">ChatClient</span> <span class="nf">chatClient</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">ai</span><span class="o">.</span><span class="na">chat</span><span class="o">.</span><span class="na">ChatModel</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">ChatClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">model</span><span class="o">).</span><span class="na">defaultSystem</span><span class="o">(</span><span class="s">"You are a helpful banking agent."</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>b) Provide context via Spring beans (services) and “tools.”</strong>
Expose domain lookups as <strong>tools</strong> so the model can call them during a chat turn. (Spring AI supports tool calling—model decides when to invoke; result flows back as extra context.) (<a href="https://docs.spring.io/spring-ai/reference/api/tools.html?utm_source=chatgpt.com" title="Tool Calling :: Spring AI Reference">Home</a>)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountTools</span> <span class="o">{</span>
  <span class="nd">@org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">ai</span><span class="o">.</span><span class="na">tool</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Tool</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">fetchBalance</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">){</span>
    <span class="c1">// query DB or downstream service</span>
    <span class="k">return</span> <span class="s">"{\"balance\": 1234.56, \"currency\": \"HKD\"}"</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>c) Add retrieval (RAG) for documents/code.</strong>
Wire a <code class="language-plaintext highlighter-rouge">VectorStore</code> (PGVector, etc.) and stuff it with embeddings of your knowledge. At runtime, retrieve top-k chunks and attach them to the prompt. There’s a current, practical tutorial building a full RAG stack with Spring Boot + PGVector. (<a href="https://sohamkamani.com/java/spring-ai-rag-application?utm_source=chatgpt.com" title="Build a RAG-Powered Chat App with Spring AI and PGVector">sohamkamani.com</a>)</p>

<p><strong>d) Thread user/session context through Interceptors.</strong>
Use a <code class="language-plaintext highlighter-rouge">HandlerInterceptor</code> (or your Filter) to resolve <code class="language-plaintext highlighter-rouge">userId</code>, <code class="language-plaintext highlighter-rouge">tenantId</code>, roles, locale, last-N actions—put them into:</p>

<ul>
  <li>request attributes,</li>
  <li>a scoped bean, or</li>
  <li>the <strong>system</strong> and <strong>user</strong> parts of your prompt.</li>
</ul>

<p><strong>e) One HTTP endpoint to rule them all.</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/agent"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AgentController</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ChatClient</span> <span class="n">chat</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserContextProvider</span> <span class="n">ctx</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Retriever</span> <span class="n">retriever</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">AgentController</span><span class="o">(</span><span class="nc">ChatClient</span> <span class="n">chat</span><span class="o">,</span> <span class="nc">UserContextProvider</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Retriever</span> <span class="n">retriever</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">chat</span> <span class="o">=</span> <span class="n">chat</span><span class="o">;</span> <span class="k">this</span><span class="o">.</span><span class="na">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span> <span class="k">this</span><span class="o">.</span><span class="na">retriever</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@PostMapping</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">chat</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">req</span><span class="o">,</span> <span class="nc">Principal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">userCtx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">fromPrincipal</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>          <span class="c1">// ids, roles, preferences</span>
    <span class="kt">var</span> <span class="n">docs</span>   <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="na">findRelevant</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span><span class="n">req</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"message"</span><span class="o">));</span> <span class="c1">// RAG</span>
    <span class="k">return</span> <span class="n">chat</span><span class="o">.</span><span class="na">prompt</span><span class="o">()</span>
      <span class="o">.</span><span class="na">system</span><span class="o">(</span><span class="s">"Use tools if needed. Respect tenant="</span><span class="o">+</span><span class="n">userCtx</span><span class="o">.</span><span class="na">tenant</span><span class="o">()+</span><span class="s">" and role="</span><span class="o">+</span><span class="n">userCtx</span><span class="o">.</span><span class="na">role</span><span class="o">()+</span><span class="s">"."</span><span class="o">)</span>
      <span class="o">.</span><span class="na">user</span><span class="o">(</span><span class="s">"Context:\n"</span><span class="o">+</span><span class="n">docs</span><span class="o">+</span><span class="s">"\n\nUser says: "</span><span class="o">+</span><span class="n">req</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"message"</span><span class="o">))</span>
      <span class="o">.</span><span class="na">call</span><span class="o">().</span><span class="na">content</span><span class="o">();</span>                                  <span class="c1">// tool calls happen implicitly</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>f) Optional: Deploy “skills” with Spring Cloud Function.</strong>
If you want each agent skill as a single function (great for serverless and routing by headers), <strong>Spring Cloud Function</strong> lets you write pure <code class="language-plaintext highlighter-rouge">Function&lt;T,R&gt;</code> and route dynamically—nice for plugging into AWS Lambda/Azure and for internal “agent tool” endpoints. (<a href="https://cloud.spring.io/spring-cloud-function/reference/html/spring-cloud-function.html?utm_source=chatgpt.com" title="Spring Cloud Function">cloud.spring.io</a>, <a href="https://docs.spring.io/spring-cloud-function/docs/current/reference/html/spring-cloud-function.html?utm_source=chatgpt.com" title="Spring Cloud Function">Home</a>, <a href="https://www.baeldung.com/spring-cloud-function-microsoft-azure?utm_source=chatgpt.com" title="Spring Cloud Function for Azure Function">Baeldung on Kotlin</a>)</p>

<hr />

<h2 id="4-putting-it-all-together-flow">4) Putting it all together (flow)</h2>

<ol>
  <li><strong>Filter</strong> adds <code class="language-plaintext highlighter-rouge">traceId</code>, logs HTTP I/O.</li>
  <li><strong>AOP</strong> wraps service methods and emits structured events.</li>
  <li><strong>Log4j2 RoutingAppender</strong> writes per-trace files.</li>
  <li><strong>Python generator</strong> reads those files → emits <strong>pytest</strong> that replays real calls.</li>
  <li>
    <p><strong>Spring AI</strong> endpoint uses:</p>

    <ul>
      <li>request/tenant/user context from Interceptor/Filter,</li>
      <li>domain “tools” for live data,</li>
      <li>vector store (RAG) for doc/code context,</li>
      <li><code class="language-plaintext highlighter-rouge">ChatClient</code> for chat orchestration.</li>
    </ul>
  </li>
</ol>

<p>That gives you reproducible tests and a robust, contextual agent interface—both driven by the same telemetry.</p>

<p>If you want, I can sketch a minimal repo structure with the Spring Boot pieces, a Log4j2 config, and the Python generator script wired into a <code class="language-plaintext highlighter-rouge">make testgen &amp;&amp; pytest</code> workflow.</p>



  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
