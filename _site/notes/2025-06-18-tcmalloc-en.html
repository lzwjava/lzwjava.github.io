<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Fix the TCMalloc Error</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Fix the TCMalloc Error | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Fix the TCMalloc Error" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-06-18-tcmalloc-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-06-18-tcmalloc-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fix the TCMalloc Error" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Fix the TCMalloc Error","url":"https://lzwjava.github.io/notes/2025-06-18-tcmalloc-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=6abe6a018eea3cef89c772d1cb9ad7fd80a750ed">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=6abe6a018eea3cef89c772d1cb9ad7fd80a750ed" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Fix the TCMalloc Error | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-06-18-tcmalloc-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-06-18-tcmalloc-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/tcmalloc-en" selected>English</option>
        <option value="/tcmalloc-zh" >中文</option>
        <option value="/tcmalloc-ja" >日本語</option>
        <option value="/tcmalloc-es" >Español</option>
        <option value="/tcmalloc-hi" >हिंदी</option>
        <option value="/tcmalloc-fr" >Français</option>
        <option value="/tcmalloc-de" >Deutsch</option>
        <option value="/tcmalloc-ar" >العربية</option>
        <option value="/tcmalloc-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>The error “Cannot locate TCMalloc. Do you have tcmalloc or google-perftool installed on your system? (improves CPU memory usage)” indicates that the TCMalloc library, part of Google’s gperftools, is not installed or not properly configured on your Linux system. TCMalloc is a memory allocator that can improve performance and reduce memory usage, particularly in applications like Stable Diffusion. Here’s how to fix this issue:</p>

<h3 id="steps-to-fix-the-tcmalloc-error">Steps to Fix the TCMalloc Error</h3>

<ol>
  <li>
    <p><strong>Install TCMalloc and Google Perftools</strong>
Depending on your Linux distribution, use the appropriate package manager to install the required libraries.</p>

    <ul>
      <li><strong>For Ubuntu/Debian-based systems</strong>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>libgoogle-perftools-dev libtcmalloc-minimal4 <span class="nt">-y</span>
</code></pre></div>        </div>
        <p>This installs both the full <code class="language-plaintext highlighter-rouge">libgoogle-perftools-dev</code> (includes TCMalloc) and <code class="language-plaintext highlighter-rouge">libtcmalloc-minimal4</code> (a lightweight version).<a href="https://blog.csdn.net/yang553566463/article/details/132167437"></a><a href="https://sakari.niittymaa.com/blog_install-automatic1111-using-wsl"></a></p>
      </li>
      <li><strong>For Fedora-based systems</strong>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>dnf <span class="nb">install </span>gperftools-libs <span class="nt">-y</span>
</code></pre></div>        </div>
        <p>This installs the necessary TCMalloc libraries.<a href="https://docs.suricata.io/en/latest/performance/tcmalloc.html"></a></p>
      </li>
      <li><strong>For CentOS/RHEL-based systems</strong>:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install </span>gperftools-libs <span class="nt">-y</span>
</code></pre></div>        </div>
        <p>If the package is not available in the default repositories, you may need to enable the EPEL repository first:</p>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install </span>epel-release
<span class="nb">sudo </span>yum <span class="nb">install </span>gperftools-libs <span class="nt">-y</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>Verify Installation</strong>
After installation, check if TCMalloc is installed:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpkg <span class="nt">-l</span> | <span class="nb">grep </span>tcmalloc
</code></pre></div>    </div>
    <p>You should see <code class="language-plaintext highlighter-rouge">libtcmalloc-minimal4</code> or similar packages listed. Alternatively, check the library path:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpkg <span class="nt">-L</span> libgoogle-perftools-dev | <span class="nb">grep </span>libtcmalloc.so
</code></pre></div>    </div>
    <p>This will show the path to the TCMalloc library (e.g., <code class="language-plaintext highlighter-rouge">/usr/lib/libtcmalloc.so.4</code>).<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a></p>
  </li>
  <li>
    <p><strong>Set the LD_PRELOAD Environment Variable</strong>
To ensure your application uses TCMalloc, set the <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> environment variable to point to the TCMalloc library. This can be done temporarily or permanently.</p>

    <ul>
      <li><strong>Temporarily (for the current session)</strong>:
Run your application with <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> set:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/lib/libtcmalloc.so.4
./launch.py
</code></pre></div>        </div>
        <p>Replace <code class="language-plaintext highlighter-rouge">/usr/lib/libtcmalloc.so.4</code> with the actual path found in step 2 if different.<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a></p>
      </li>
      <li><strong>Permanently (for Stable Diffusion or similar)</strong>:
If you’re using a script like <code class="language-plaintext highlighter-rouge">webui.sh</code> (common with Stable Diffusion), edit the script (e.g., <code class="language-plaintext highlighter-rouge">webui-user.sh</code>) to include:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>libtcmalloc.so.4
</code></pre></div>        </div>
        <p>Save the file and rerun the script:</p>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./webui.sh
</code></pre></div>        </div>
        <p>Alternatively, add it to your shell configuration (e.g., <code class="language-plaintext highlighter-rouge">~/.bashrc</code> or <code class="language-plaintext highlighter-rouge">~/.zshrc</code>):</p>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'export LD_PRELOAD=/usr/lib/libtcmalloc.so.4'</span> <span class="o">&gt;&gt;</span> ~/.bashrc
<span class="nb">source</span> ~/.bashrc
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><strong>Re-run the Application</strong>
After installing TCMalloc and setting <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code>, restart your application:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./launch.py
</code></pre></div>    </div>
    <p>The error should no longer appear, and you may notice improved memory usage or performance.<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a></p>
  </li>
  <li><strong>Troubleshooting</strong>
    <ul>
      <li><strong>If the library path is incorrect</strong>: If <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> fails (e.g., “cannot open shared object file”), verify the exact library name and path:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find /usr/lib <span class="nt">-name</span> <span class="s2">"libtcmalloc*.so*"</span>
</code></pre></div>        </div>
        <p>Update <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> with the correct path (e.g., <code class="language-plaintext highlighter-rouge">libtcmalloc_minimal.so.4</code> if using the minimal version).</p>
      </li>
      <li><strong>If the error persists</strong>: Ensure the installed TCMalloc version is compatible with your system (glibc 2.35 and GCC 11.4.0 in your case). If issues continue, try installing from source:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/google/tcmalloc.git
<span class="nb">cd </span>tcmalloc
bazel build //tcmalloc:hello_main
bazel run //tcmalloc:hello_main
</code></pre></div>        </div>
        <p>Follow the TCMalloc Quickstart guide for detailed instructions.<a href="https://google.github.io/tcmalloc/quickstart.html"></a></p>
      </li>
      <li><strong>Memory issues</strong>: If you encounter allocation failures or crashes, ensure your system has sufficient memory and that TCMalloc is not conflicting with other allocators.<a href="https://stackoverflow.com/questions/tagged/tcmalloc"></a></li>
    </ul>
  </li>
  <li><strong>Optional: Verify TCMalloc Usage</strong>
To confirm TCMalloc is working, you can run a simple test program or check memory usage with tools like <code class="language-plaintext highlighter-rouge">top</code> or <code class="language-plaintext highlighter-rouge">htop</code> while your application runs. TCMalloc typically reduces memory fragmentation and may provide a slight performance boost.<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a></li>
</ol>

<h3 id="additional-notes">Additional Notes</h3>
<ul>
  <li><strong>Why TCMalloc?</strong> TCMalloc is a high-performance memory allocator that reduces CPU memory usage and fragmentation, especially in threaded applications like Stable Diffusion. It’s not strictly required but can improve performance.<a href="https://docs.suricata.io/en/latest/performance/tcmalloc.html"></a><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a></li>
  <li><strong>Compatibility</strong>: Your system (glibc 2.35, Python 3.10.12, GCC 11.4.0) is compatible with the latest TCMalloc versions, so the above steps should work. If you’re using a custom-built application, ensure it’s compiled with TCMalloc support.<a href="https://stackoverflow.com/questions/29205141/how-to-use-tcmalloc"></a></li>
  <li><strong>Stable Diffusion Context</strong>: This error often appears with AUTOMATIC1111’s Stable Diffusion WebUI. The above steps, particularly installing <code class="language-plaintext highlighter-rouge">libgoogle-perftools-dev</code> and setting <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code>, are known to resolve it.<a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/issues/10117"></a><a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/discussions/6722"></a><a href="https://blog.csdn.net/yang553566463/article/details/132167437"></a></li>
</ul>

<p>If you encounter specific errors or need help with a particular Linux distribution, let me know, and I can tailor the instructions further!</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
