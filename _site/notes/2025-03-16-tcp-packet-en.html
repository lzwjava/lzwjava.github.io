<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>C Program to Decode a TCP Packet</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>C Program to Decode a TCP Packet | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="C Program to Decode a TCP Packet" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-03-16-tcp-packet-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-03-16-tcp-packet-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="C Program to Decode a TCP Packet" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"C Program to Decode a TCP Packet","url":"https://lzwjava.github.io/notes/2025-03-16-tcp-packet-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=deebc3ecf833318071e5648dfb184c622800e1cb">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=deebc3ecf833318071e5648dfb184c622800e1cb" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       C Program to Decode a TCP Packet | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-03-16-tcp-packet-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-03-16-tcp-packet-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/tcp-packet-en" selected>English</option>
        <option value="/tcp-packet-zh" >中文</option>
        <option value="/tcp-packet-ja" >日本語</option>
        <option value="/tcp-packet-es" >Español</option>
        <option value="/tcp-packet-hi" >हिंदी</option>
        <option value="/tcp-packet-fr" >Français</option>
        <option value="/tcp-packet-de" >Deutsch</option>
        <option value="/tcp-packet-ar" >العربية</option>
        <option value="/tcp-packet-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>Decoding a TCP packet in C involves capturing raw network data (typically using raw sockets or a packet capture mechanism) and then parsing the headers step-by-step: the Ethernet header (if present), the IP header, and finally the TCP header. Since TCP runs over IP, you’ll need to extract the IP header first to locate the TCP segment within the packet. For simplicity, I’ll assume we’re working with IPv4 and a raw socket capturing IP packets (no Ethernet layer).</p>

<p>Here’s a C program that captures a TCP packet using a raw socket, decodes the IP header, and then decodes the TCP header to display key fields like source/destination ports, sequence number, acknowledgment number, flags, and window size.</p>

<hr />

<h3 id="c-program-to-decode-a-tcp-packet">C Program to Decode a TCP Packet</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/ip.h&gt;</span><span class="c1">   // For struct iphdr</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/tcp.h&gt;</span><span class="c1">  // For struct tcphdr</span><span class="cp">
</span>
<span class="c1">// Print TCP flags in human-readable form</span>
<span class="kt">void</span> <span class="nf">print_tcp_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Flags: "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">syn</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"SYN "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"ACK "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">fin</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"FIN "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">rst</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"RST "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">psh</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"PSH "</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">urg</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">"URG "</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sock_fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">65535</span><span class="p">];</span> <span class="c1">// Max IP packet size</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">source_addr</span><span class="p">,</span> <span class="n">dest_addr</span><span class="p">;</span>

    <span class="c1">// Create raw socket to capture TCP packets</span>
    <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Socket creation failed (run as root?)"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Listening for TCP packets...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Receive raw packet</span>
        <span class="kt">ssize_t</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"Receive failed"</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// IP header (struct iphdr) is at the start of the packet</span>
        <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ip_header_len</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// ihl is in 32-bit words, convert to bytes</span>

        <span class="c1">// Check if it's an IPv4 packet with TCP protocol</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TCP header follows IP header</span>
            <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">ip_header_len</span><span class="p">);</span>

            <span class="c1">// Extract source and destination IP addresses</span>
            <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">source_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">source_addr</span><span class="p">));</span>
            <span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dest_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest_addr</span><span class="p">));</span>

            <span class="c1">// Decode and print TCP packet details</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- TCP Packet ---</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Source IP: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Dest IP: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Source Port: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Dest Port: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Sequence Number: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Acknowledgment Number: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Data Offset: %d bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// TCP header length</span>
            <span class="n">print_tcp_flags</span><span class="p">(</span><span class="n">tcp</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Window Size: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Checksum: 0x%04x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">));</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Urgent Pointer: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">urg_ptr</span><span class="p">));</span>

            <span class="c1">// Payload (data after TCP header)</span>
            <span class="kt">int</span> <span class="n">tcp_header_len</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="n">bytes_received</span> <span class="o">-</span> <span class="n">ip_header_len</span> <span class="o">-</span> <span class="n">tcp_header_len</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Payload Length: %d bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Payload (first 16 bytes): "</span><span class="p">);</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">ip_header_len</span> <span class="o">+</span> <span class="n">tcp_header_len</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">payload_len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"%02x "</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"No payload</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">);</span> <span class="c1">// Unreachable in this loop, but good practice</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="how-it-works">How It Works</h3>

<ol>
  <li><strong>Socket Setup</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">socket(AF_INET, SOCK_RAW, IPPROTO_TCP)</code> creates a raw socket that captures all TCP packets destined for the host. This requires root privileges (<code class="language-plaintext highlighter-rouge">sudo</code>).</li>
    </ul>
  </li>
  <li><strong>Packet Capture</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">recvfrom()</code> grabs the raw IP packet, which includes the IP header, TCP header, and payload.</li>
    </ul>
  </li>
  <li><strong>IP Header Parsing</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">struct iphdr</code> defines the IPv4 header (from <code class="language-plaintext highlighter-rouge">&lt;netinet/ip.h&gt;</code>).</li>
      <li><code class="language-plaintext highlighter-rouge">ihl</code> (IP header length) is multiplied by 4 to get the byte offset, since it’s measured in 32-bit words.</li>
      <li>Check <code class="language-plaintext highlighter-rouge">version == 4</code> and <code class="language-plaintext highlighter-rouge">protocol == IPPROTO_TCP</code> to ensure it’s an IPv4 TCP packet.</li>
    </ul>
  </li>
  <li><strong>TCP Header Parsing</strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">struct tcphdr</code> (from <code class="language-plaintext highlighter-rouge">&lt;netinet/tcp.h&gt;</code>) defines the TCP header, starting right after the IP header.</li>
      <li>Key fields:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">source</code> and <code class="language-plaintext highlighter-rouge">dest</code>: Source and destination ports (converted from network to host byte order with <code class="language-plaintext highlighter-rouge">ntohs</code>).</li>
          <li><code class="language-plaintext highlighter-rouge">seq</code> and <code class="language-plaintext highlighter-rouge">ack_seq</code>: Sequence and acknowledgment numbers (<code class="language-plaintext highlighter-rouge">ntohl</code> for 32-bit conversion).</li>
          <li><code class="language-plaintext highlighter-rouge">doff</code>: Data offset (TCP header length in bytes, also multiplied by 4).</li>
          <li><code class="language-plaintext highlighter-rouge">syn</code>, <code class="language-plaintext highlighter-rouge">ack</code>, <code class="language-plaintext highlighter-rouge">fin</code>, etc.: Flags indicating packet type.</li>
          <li><code class="language-plaintext highlighter-rouge">window</code>: Receiver’s window size.</li>
          <li><code class="language-plaintext highlighter-rouge">check</code>: Checksum (not validated here for simplicity).</li>
          <li><code class="language-plaintext highlighter-rouge">urg_ptr</code>: Urgent pointer (used with URG flag).</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Payload Extraction</strong>:
    <ul>
      <li>The payload starts after the TCP header. Its length is calculated as: <code class="language-plaintext highlighter-rouge">total bytes - IP header length - TCP header length</code>.</li>
      <li>A snippet of the payload is printed in hex.</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="compilation-and-usage">Compilation and Usage</h3>
<ul>
  <li>Compile: <code class="language-plaintext highlighter-rouge">gcc tcp_decode.c -o tcp_decode</code></li>
  <li>Run (as root): <code class="language-plaintext highlighter-rouge">sudo ./tcp_decode</code></li>
  <li>Example output (when TCP traffic is present, e.g., browsing the web):
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Listening for TCP packets...

--- TCP Packet ---
Source IP: 192.168.1.100
Dest IP: 93.184.216.34
Source Port: 54321
Dest Port: 80
Sequence Number: 123456789
Acknowledgment Number: 987654321
Data Offset: 20 bytes
Flags: SYN
Window Size: 64240
Checksum: 0x1a2b
Urgent Pointer: 0
No payload
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h3 id="key-structures">Key Structures</h3>
<ul>
  <li><strong>IP Header (<code class="language-plaintext highlighter-rouge">struct iphdr</code>)</strong>:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">iphdr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ihl</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>    <span class="c1">// Header length (in 32-bit words)</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">version</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span><span class="c1">// IP version (4 for IPv4)</span>
    <span class="kt">uint8_t</span> <span class="n">tos</span><span class="p">;</span>           <span class="c1">// Type of service</span>
    <span class="kt">uint16_t</span> <span class="n">tot_len</span><span class="p">;</span>      <span class="c1">// Total length</span>
    <span class="kt">uint16_t</span> <span class="n">id</span><span class="p">;</span>           <span class="c1">// Identification</span>
    <span class="kt">uint16_t</span> <span class="n">frag_off</span><span class="p">;</span>     <span class="c1">// Fragment offset</span>
    <span class="kt">uint8_t</span> <span class="n">ttl</span><span class="p">;</span>           <span class="c1">// Time to live</span>
    <span class="kt">uint8_t</span> <span class="n">protocol</span><span class="p">;</span>      <span class="c1">// Protocol (6 for TCP)</span>
    <span class="kt">uint16_t</span> <span class="n">check</span><span class="p">;</span>        <span class="c1">// Checksum</span>
    <span class="kt">uint32_t</span> <span class="n">saddr</span><span class="p">;</span>        <span class="c1">// Source address</span>
    <span class="kt">uint32_t</span> <span class="n">daddr</span><span class="p">;</span>        <span class="c1">// Destination address</span>
<span class="p">};</span>
</code></pre></div>    </div>
  </li>
  <li><strong>TCP Header (<code class="language-plaintext highlighter-rouge">struct tcphdr</code>)</strong>:
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">tcphdr</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">source</span><span class="p">;</span>       <span class="c1">// Source port</span>
    <span class="kt">uint16_t</span> <span class="n">dest</span><span class="p">;</span>         <span class="c1">// Destination port</span>
    <span class="kt">uint32_t</span> <span class="n">seq</span><span class="p">;</span>          <span class="c1">// Sequence number</span>
    <span class="kt">uint32_t</span> <span class="n">ack_seq</span><span class="p">;</span>      <span class="c1">// Acknowledgment number</span>
    <span class="kt">uint16_t</span> <span class="n">doff</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>       <span class="c1">// Data offset (header length in 32-bit words)</span>
    <span class="kt">uint16_t</span> <span class="n">res1</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>       <span class="c1">// Reserved</span>
    <span class="kt">uint16_t</span> <span class="n">res2</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>       <span class="c1">// Reserved</span>
    <span class="kt">uint16_t</span> <span class="n">urg</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Urgent flag</span>
    <span class="kt">uint16_t</span> <span class="n">ack</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Acknowledgment flag</span>
    <span class="kt">uint16_t</span> <span class="n">psh</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Push flag</span>
    <span class="kt">uint16_t</span> <span class="n">rst</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Reset flag</span>
    <span class="kt">uint16_t</span> <span class="n">syn</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Synchronize flag</span>
    <span class="kt">uint16_t</span> <span class="n">fin</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>        <span class="c1">// Finish flag</span>
    <span class="kt">uint16_t</span> <span class="n">window</span><span class="p">;</span>       <span class="c1">// Window size</span>
    <span class="kt">uint16_t</span> <span class="n">check</span><span class="p">;</span>        <span class="c1">// Checksum</span>
    <span class="kt">uint16_t</span> <span class="n">urg_ptr</span><span class="p">;</span>      <span class="c1">// Urgent pointer</span>
<span class="p">};</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h3 id="notes">Notes</h3>
<ul>
  <li><strong>Root Privileges</strong>: Raw sockets require <code class="language-plaintext highlighter-rouge">sudo</code> because they access the network stack directly.</li>
  <li><strong>Promiscuous Mode</strong>: This captures only packets destined for the host. For all traffic (like Wireshark), you’d need <code class="language-plaintext highlighter-rouge">libpcap</code> or a different approach (e.g., <code class="language-plaintext highlighter-rouge">PF_PACKET</code> sockets with promiscuous mode).</li>
  <li><strong>Byte Order</strong>: Network byte order (big-endian) is converted to host byte order using <code class="language-plaintext highlighter-rouge">ntohs</code> (16-bit) and <code class="language-plaintext highlighter-rouge">ntohl</code> (32-bit).</li>
  <li><strong>Limitations</strong>: This doesn’t validate the checksum or handle fragmented packets.</li>
</ul>

<p>Let me know if you want to refine this further (e.g., add checksum validation or filter specific ports)!</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
