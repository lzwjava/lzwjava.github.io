<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Fix DeepSeek Claude Code Schema Mismatch</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Fix DeepSeek Claude Code Schema Mismatch | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Fix DeepSeek Claude Code Schema Mismatch" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="李智维" />
<meta property="og:description" content="李智维" />
<link rel="canonical" href="https://lzwjava.github.io/notes/2025-08-24-fix-deepseek-claude-schema-en" />
<meta property="og:url" content="https://lzwjava.github.io/notes/2025-08-24-fix-deepseek-claude-schema-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fix DeepSeek Claude Code Schema Mismatch" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Zhiwei Li"},"description":"李智维","headline":"Fix DeepSeek Claude Code Schema Mismatch","url":"https://lzwjava.github.io/notes/2025-08-24-fix-deepseek-claude-schema-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=b06a4552b6e4e838cc94f0f9fabe3ebd8f430840">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=b06a4552b6e4e838cc94f0f9fabe3ebd8f430840" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Fix DeepSeek Claude Code Schema Mismatch | Generated by AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="notes/2025-08-24-fix-deepseek-claude-schema-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>notes2025-08-24-fix-deepseek-claude-schema-en.md</span> -->
      

      <!-- <span></span> -->

      
        <a href="#" class="button">2025.10</a>
      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/fix-deepseek-claude-schema-en" selected>English</option>
        <option value="/fix-deepseek-claude-schema-zh" >中文</option>
        <option value="/fix-deepseek-claude-schema-ja" >日本語</option>
        <option value="/fix-deepseek-claude-schema-es" >Español</option>
        <option value="/fix-deepseek-claude-schema-hi" >हिंदी</option>
        <option value="/fix-deepseek-claude-schema-fr" >Français</option>
        <option value="/fix-deepseek-claude-schema-de" >Deutsch</option>
        <option value="/fix-deepseek-claude-schema-ar" >العربية</option>
        <option value="/fix-deepseek-claude-schema-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>Short answer: schema mismatch.</p>

<p>Claude Code “speaks Anthropic” (it expects Anthropic-Messages style tool use like <code class="language-plaintext highlighter-rouge">tool_use</code> / <code class="language-plaintext highlighter-rouge">tool_result</code> blocks). DeepSeek V3.1 on OpenRouter “speaks OpenAI” (it emits OpenAI-style <code class="language-plaintext highlighter-rouge">tool_calls</code> / function calling). If your Claude Code router forwards a task to DeepSeek V3.1 without transforming the request/response, the assistant’s tool-calling messages won’t parse—and you’ll see errors right when the agent tries to plan/run tools or stream output. (<a href="https://www.anthropic.com/engineering/claude-code-best-practices?utm_source=chatgpt.com" title="Claude Code: Best practices for agentic coding">Anthropic</a>, <a href="https://openrouter.ai/docs/features/tool-calling?utm_source=chatgpt.com" title="Tool &amp; Function Calling">OpenRouter</a>, <a href="https://api-docs.deepseek.com/guides/function_calling?utm_source=chatgpt.com" title="Function Calling">DeepSeek API Docs</a>)</p>

<p>What to do (quick fixes):</p>

<ol>
  <li>
    <p>Use the router’s transformers
Enable the OpenRouter↔︎Anthropic request/response transformers in your Claude Code router so <code class="language-plaintext highlighter-rouge">tool_calls</code> ⇄ <code class="language-plaintext highlighter-rouge">tool_use</code> are mapped both ways. The popular community router supports this explicitly; check its “Request/Response Transformation” section and example configs. (<a href="https://github.com/musistudio/claude-code-router?utm_source=chatgpt.com" title="musistudio/claude-code-router">GitHub</a>, <a href="https://claudelog.com/claude-code-mcps/claude-code-router/?utm_source=chatgpt.com" title="Claude Code Router">ClaudeLog</a>)</p>
  </li>
  <li>
    <p>Pick the correct model slug
DeepSeek V3.1 has specific OpenRouter slugs (e.g., the V3.1/V3 family entries). A wrong or old slug can also throw errors during streaming or tool phases. Verify the exact model id shown on OpenRouter’s DeepSeek page and use that in your router mapping. (<a href="https://openrouter.ai/models?q=deepseek&amp;utm_source=chatgpt.com" title="Models: 'deepseek'">OpenRouter</a>)</p>
  </li>
  <li>
    <p>Stay in “chat” (not “reasoner”) unless you’ve mapped its fields
If you try a reasoning variant that streams special reasoning fields, your router must translate them—or Claude Code will choke. Prefer the standard chat model or disable extra “thinking” output until your transformer handles it. (DeepSeek’s docs emphasize OpenAI-style function calling; that’s what you should map.) (<a href="https://api-docs.deepseek.com/guides/function_calling?utm_source=chatgpt.com" title="Function Calling">DeepSeek API Docs</a>)</p>
  </li>
  <li>
    <p>Update to latest router build
Recent community builds added compatibility tweaks for non-Anthropic providers; upgrade before testing. (<a href="https://github.com/musistudio/claude-code-router?utm_source=chatgpt.com" title="musistudio/claude-code-router">GitHub</a>)</p>
  </li>
</ol>

<p>Why this only happens with V3.1
V3.1 added stronger agent/tool-calling by default. That increases the chance your Claude Code flow hits the un-translated tool messages, which is exactly where the schema mismatch bites. (<a href="https://api-docs.deepseek.com/news/news250821?utm_source=chatgpt.com" title="DeepSeek-V3.1 Release">DeepSeek API Docs</a>)</p>

<p>If you share the exact error text, I can point to the precise transformer snippet to drop into your config.</p>



  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
