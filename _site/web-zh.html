<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Web 编程入门</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Web 编程入门 | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Web 编程入门" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="zh" />
<meta name="description" content="上期讲到我们把斐波那契数列功能，改写成了面向对象的版本，实现了一个终端接口。" />
<meta property="og:description" content="上期讲到我们把斐波那契数列功能，改写成了面向对象的版本，实现了一个终端接口。" />
<link rel="canonical" href="https://lzwjava.github.io/web-zh" />
<meta property="og:url" content="https://lzwjava.github.io/web-zh" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-07T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Web 编程入门" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2021-03-07T00:00:00+08:00","datePublished":"2021-03-07T00:00:00+08:00","description":"上期讲到我们把斐波那契数列功能，改写成了面向对象的版本，实现了一个终端接口。","headline":"Web 编程入门","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/web-zh"},"url":"https://lzwjava.github.io/web-zh"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=b723421028b8526c972158efc52ea9e8c5663d17">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=b723421028b8526c972158efc52ea9e8c5663d17" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Web 编程入门 | 原创
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/zh/2021-03-07-web-zh.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postszh2021-03-07-web-zh.md</span> -->
      

      <!-- <span>2021-03-07-web-zh.md</span> -->

      
        

        
          
          <a href="#" class="button">2021.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/web-en" >English</option>
        <option value="/web-zh" selected>中文</option>
        <option value="/web-ja" >日本語</option>
        <option value="/web-es" >Español</option>
        <option value="/web-hi" >हिंदी</option>
        <option value="/web-fr" >Français</option>
        <option value="/web-de" >Deutsch</option>
        <option value="/web-ar" >العربية</option>
        <option value="/web-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>上期讲到我们把斐波那契数列功能，改写成了面向对象的版本，实现了一个终端接口。</p>

<p><code class="language-plaintext highlighter-rouge">server.py</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Server</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlerClass</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">handlerClass</span> <span class="o">=</span> <span class="n">handlerClass</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">request</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">handlerClass</span><span class="p">().</span><span class="n">handle</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fib_handle.py</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">BaseHandler</span><span class="p">,</span> <span class="n">Server</span>

<span class="k">class</span> <span class="nc">FibHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'f(n)='</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">pass</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">FibHandler</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>  
</code></pre></div></div>
<h2 id="简单-web-服务器">简单 Web 服务器</h2>

<p>那如何改成<code class="language-plaintext highlighter-rouge">Web</code>接口呢。</p>

<p>我们把上面的<code class="language-plaintext highlighter-rouge">Server</code>换成<code class="language-plaintext highlighter-rouge">HTTP协议</code>的<code class="language-plaintext highlighter-rouge">Server</code>就行了。先来看看Python中的<code class="language-plaintext highlighter-rouge">HTTP服务器</code>是怎么样的。</p>

<p>Python 的标准库中提供了一个网页服务器。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python -m http.server
</code></pre></div></div>

<p>在终端中运行它。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-m</span> http.server
Serving HTTP on :: port 8000 <span class="o">(</span>http://[::]:8000/<span class="o">)</span> ...
</code></pre></div></div>

<p>在浏览器中打开便可以看到效果。</p>

<p><img src="/assets/images/web/webserver.png" alt="webserver" style="zoom:50%;" /></p>

<p>这把当前目录列举出来了。接着当浏览这个网页时，再回去看终端。这会，很有意思。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-m</span> http.server
Serving HTTP on :: port 8000 <span class="o">(</span>http://[::]:8000/<span class="o">)</span> ...
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET / HTTP/1.1"</span> 200 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] code 404, message File not found
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /favicon.ico HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] code 404, message File not found
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /apple-touch-icon-precomposed.png HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] code 404, message File not found
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /apple-touch-icon.png HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:38] <span class="s2">"GET / HTTP/1.1"</span> 200 -
</code></pre></div></div>

<p>这是网页访问日志。其中<code class="language-plaintext highlighter-rouge">GET</code>表示网页服务的一种数据访问操作。<code class="language-plaintext highlighter-rouge">HTTP/1.1</code>表示使用了 <code class="language-plaintext highlighter-rouge">HTTP</code>的<code class="language-plaintext highlighter-rouge">1.1</code>版本的协议。</p>

<p>如何用它来打造我们的斐波那契数列服务。先网上找找样例代码，稍微改改，写一个最简单的Web服务器：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s">"hi"</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>

<span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>这些是不是很眼熟。几乎跟上面我们使用<code class="language-plaintext highlighter-rouge">Server</code>是一样的。注意到<code class="language-plaintext highlighter-rouge">SimpleHTTPRequestHandler</code>不是基础类，还有一个叫<code class="language-plaintext highlighter-rouge">BaseHTTPRequestHandler</code>。<code class="language-plaintext highlighter-rouge">SimpleHTTPRequestHandler</code>相对于多处理了一些内容。这些加上斐波那契数列处理功能是容易的。</p>

<p>这里的<code class="language-plaintext highlighter-rouge">127.0.0.1</code>表示本机的地址，<code class="language-plaintext highlighter-rouge">8000</code>表示本机的端口。端口怎么理解呢。就好像家里的一个窗户一样，是家里跟外界沟通的一个端口。<code class="language-plaintext highlighter-rouge">bytes</code>表示把字符串变成字节。<code class="language-plaintext highlighter-rouge">utf-8</code>是一种字符串编码方式。<code class="language-plaintext highlighter-rouge">send_response</code>、<code class="language-plaintext highlighter-rouge">send_header</code>和<code class="language-plaintext highlighter-rouge">end_headers</code>都是在输出一些内容，来输出<code class="language-plaintext highlighter-rouge">HTTP</code>协议所规定的内容，好能被浏览器所理解。这样我们在网页里就看到了<code class="language-plaintext highlighter-rouge">hi</code>。</p>

<p><img src="/assets/images/web/hi.png" alt="hi" style="zoom:50%;" /></p>

<p>接着试试再从请求从得到参数。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span><span class="n">parse_qs</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>      
      <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
      <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
      <span class="n">qs</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>      
      <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>          
          <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
          <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>

<span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/web/n10.png" alt="n10" style="zoom:50%;" /></p>

<p>有点复杂吧。这里就是在解析一些参数。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self.path<span class="o">=</span>/?n<span class="o">=</span>3
<span class="nv">parsed</span><span class="o">=</span>ParseResult<span class="o">(</span><span class="nv">scheme</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">netloc</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">path</span><span class="o">=</span><span class="s1">'/'</span>, <span class="nv">params</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">query</span><span class="o">=</span><span class="s1">'n=3'</span>, <span class="nv">fragment</span><span class="o">=</span><span class="s1">''</span><span class="o">)</span>
<span class="nv">qs</span><span class="o">={</span><span class="s1">'n'</span>: <span class="o">[</span><span class="s1">'3'</span><span class="o">]}</span>
<span class="nv">ns</span><span class="o">=[</span><span class="s1">'3'</span><span class="o">]</span>
<span class="nv">n</span><span class="o">=</span>3
</code></pre></div></div>

<h2 id="递归进阶">递归进阶</h2>

<p>让我们稍稍重构一下代码。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span><span class="n">parse_qs</span>

<span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">parse_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
      <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">qs</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="s">'n'</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="k">return</span> <span class="n">n</span>
      <span class="k">return</span> <span class="bp">None</span>
      
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>

      <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
      <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_n</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
              
      <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>

<span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>引入 <code class="language-plaintext highlighter-rouge">parse_n</code>的函数来把从请求路径中解析得到<code class="language-plaintext highlighter-rouge">n</code>封装在一块。</p>

<p>现在程序有这样的问题。小王请求了斐波那契数列的第10000位，过了一些天，小明又请求了斐波那契数列的第10000位。两次，小王和小明都等待了半天，才得到结果。我们该如何提高这个<code class="language-plaintext highlighter-rouge">Web服务的</code>效率呢。</p>

<p>注意到如果<code class="language-plaintext highlighter-rouge">n</code>相同，<code class="language-plaintext highlighter-rouge">f(n)</code>的值总是一样的。我们进行了一番实验。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 - - <span class="o">[</span>10/Mar/2021 00:33:01] <span class="s2">"GET /?n=1000 HTTP/1.1"</span> 200 -
<span class="nt">----------------------------------------</span>
Exception occurred during processing of request from <span class="o">(</span><span class="s1">'127.0.0.1'</span>, 50783<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
    ...
    <span class="k">if </span>v[n] <span class="o">!=</span> <span class="nt">-1</span>:
IndexError: list index out of range
</code></pre></div></div>

<p>原来数组不够大，那就把v数组改成10000吧。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>然而当n为<code class="language-plaintext highlighter-rouge">2000</code>时，出现了递归深度溢出错误：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 - - <span class="o">[</span>10/Mar/2021 00:34:00] <span class="s2">"GET /?n=2000 HTTP/1.1"</span> 200 -
<span class="nt">----------------------------------------</span>
Exception occurred during processing of request from <span class="o">(</span><span class="s1">'127.0.0.1'</span>, 50821<span class="o">)</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
    ...
    <span class="k">if </span>v[n] <span class="o">!=</span> <span class="nt">-1</span>:
RecursionError: maximum recursion depth exceeded <span class="k">in </span>comparison
</code></pre></div></div>

<p>然而这一切都还挺快的。</p>

<p>为什么。因为<code class="language-plaintext highlighter-rouge">f(1)</code>到<code class="language-plaintext highlighter-rouge">f(1000)</code>，都只需要算一次。这意味着当在算<code class="language-plaintext highlighter-rouge">f(1000)</code>的时候，<code class="language-plaintext highlighter-rouge">+</code>运算也许只被执行了1000次左右。我们知道<code class="language-plaintext highlighter-rouge">Python</code>的递归深度大约在1000左右。这意味着我们可以这样优化程序，如果要算<code class="language-plaintext highlighter-rouge">2000</code>，那我先算<code class="language-plaintext highlighter-rouge">1000</code>的。不，这样还是可能会出现<code class="language-plaintext highlighter-rouge">递归深度溢出错误</code>。如果要算2000，先算1200吧。如果要算1200，先算400吧。</p>

<p>这样算完400和1200之后，再算2000，递归深度大概在800左右，就不会出现递归深度溢出错误了。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<p>增加了<code class="language-plaintext highlighter-rouge">fplus</code>函数。</p>

<p>然而不禁让人想，<code class="language-plaintext highlighter-rouge">fplus</code>被递归调用<code class="language-plaintext highlighter-rouge">1000</code>次怎么样。1000 * 800 = 800000。当我把n设为80万之后，又出现递归深度错误了。继续试探了一下，发现事情更复杂。然而这样优化之后，算2000是非常轻松的了。</p>

<h2 id="文件读写">文件读写</h2>

<p>似乎把话题岔开了。回到Web开发的话题上。第一次请求<code class="language-plaintext highlighter-rouge">f(400)</code>，第二次请求<code class="language-plaintext highlighter-rouge">f(600)</code>。那么第二次请求时，第一次请求所产生的<code class="language-plaintext highlighter-rouge">v</code>数组的值，我们是能用上的。然而当我们把程序退出。再启动就用不上了。按我们的方法，斐波那契数列计算是很快的。然而设想，如果很慢怎么办。尤其就如当我们没有引入v数组的时候，有着大量重复的计算。这时我们希望能把好不容易得到的结果保存起来。</p>

<p>这时，就引入<code class="language-plaintext highlighter-rouge">缓存</code>的概念了。<code class="language-plaintext highlighter-rouge">v</code>数组这里就是一个缓存。不过它只存在于程序生命周期里。程序关闭后，它就没了。怎么办呢。很自然，我们会想到存到文件里去。</p>

<p>如何把v数组保存到文件呢。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0
1 1
2 1
3 2
4 3
...
</code></pre></div></div>

<p>我们的<code class="language-plaintext highlighter-rouge">v</code>数组可以这样保存。每一行保存为<code class="language-plaintext highlighter-rouge">n f(n)</code>。既然<code class="language-plaintext highlighter-rouge">n</code>是自然增长的。或许我们可以只保存<code class="language-plaintext highlighter-rouge">f(n)</code>值。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
...
</code></pre></div></div>

<p>来试试吧。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"demofile2.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Now the file has more content!"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#open and read the file after the appending:
</span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"demofile2.txt"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">open</code>的第二个参数可以是<code class="language-plaintext highlighter-rouge">a</code>，表示会加在文件末尾；或者是<code class="language-plaintext highlighter-rouge">w</code>，表示会覆盖掉文件。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'hi'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>运行一下，果然有文件<code class="language-plaintext highlighter-rouge">fib_v</code>。</p>

<p><code class="language-plaintext highlighter-rouge">fib_v</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hi
</code></pre></div></div>

<p>当我们再运行一次的时候，变成了这样。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hihi
</code></pre></div></div>

<p>如何换行呢。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'hi</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>这会打印一次，出现了<code class="language-plaintext highlighter-rouge">hihihi</code>，没看见换行呢。然而再打印一次，换行了。可见第一次已经打印了换行符，只是在末尾，看不见。</p>

<p>如何读取呢。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python fib.py
hihihi
hi
</code></pre></div></div>

<p>接下来，改改我们的斐波那契程序。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
   <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
   <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
           <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>   

<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
   <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
   <span class="n">s</span> <span class="o">=</span> <span class="s">''</span>
   <span class="n">start</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">vv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
         <span class="k">break</span>      
      <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
      <span class="n">start</span> <span class="o">=</span> <span class="bp">False</span>   
      <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
   <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
   <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fcache</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="n">save</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

<span class="n">read</span><span class="p">()</span>
<span class="n">fcache</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>终于我们写好程序了。程序运行后，<code class="language-plaintext highlighter-rouge">fib_v</code>文件是这样的。</p>

<p><code class="language-plaintext highlighter-rouge">fib_v</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
55
</code></pre></div></div>

<p>看到上面的解析有点麻烦。<code class="language-plaintext highlighter-rouge">\n</code>是换行符。有没有更简单统一的解析方式。人们发明了<code class="language-plaintext highlighter-rouge">JSON</code>这件数据格式。</p>

<h2 id="json">JSON</h2>

<p>JSON的全名是<code class="language-plaintext highlighter-rouge">JavaScript Object Notation</code>。以下是<code class="language-plaintext highlighter-rouge">JSON</code>的例子。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"John"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="nl">"city"</span><span class="p">:</span><span class="s2">"New York"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>以上这样来表示一种映射。</p>

<p>JSON有这样基本元素：</p>

<ol>
  <li>数字或字符串</li>
  <li>列表</li>
  <li>映射</li>
</ol>

<p>而这些基本元素又可以任意嵌套。就是列表里可以有列表。映射里也可以有列表。等等</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"John"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cars"</span><span class="p">:[</span><span class="w"> </span><span class="s2">"Ford"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BMW"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Fiat"</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>写成一行，和这样写得好看点是意义上的差别的。或许我们可以想象它们的计算图。空格不会影响他们的计算图。</p>

<p>接着我们要把v数组变成<code class="language-plaintext highlighter-rouge">json</code>格式的字符串。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>

<span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

<span class="n">fplus</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>当我们这么写的时候。报错了。<code class="language-plaintext highlighter-rouge">TypeError: dump() missing 1 required positional argument: 'fp'</code>。在<code class="language-plaintext highlighter-rouge">vscode</code>上可以这样来看到函数定义。</p>

<p><img src="assets/images/web/json.png" alt="json" /></p>

<p>可以用鼠标移动到<code class="language-plaintext highlighter-rouge">dump</code>上就行。很方便吧。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fplus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>计算到100显示的数有点多，这里改为10。原来dump的第二个参数传如<code class="language-plaintext highlighter-rouge">file</code>对象就行。</p>

<p>这样可以看到文件：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>注意后面省略了很多<code class="language-plaintext highlighter-rouge">-1</code>。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sv</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">read</span><span class="p">()</span>

<span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">vv</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
</code></pre></div></div>

<p>当这样时，可见打印出了：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
55
</code></pre></div></div>

<p>这几个函数一起检查一下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sv</span><span class="p">)):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            

<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sv</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>        
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">read</span><span class="p">()</span>
<span class="n">fplus</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>然后到文件查看，果然保存了正确的值，而且很整齐。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">377</span><span class="p">,</span><span class="w"> </span><span class="mi">610</span><span class="p">,</span><span class="w"> </span><span class="mi">987</span><span class="p">,</span><span class="w"> </span><span class="mi">1597</span><span class="p">,</span><span class="w"> </span><span class="mi">2584</span><span class="p">,</span><span class="w"> </span><span class="mi">4181</span><span class="p">,</span><span class="w"> </span><span class="mi">6765</span><span class="p">,</span><span class="w"> </span><span class="mi">10946</span><span class="p">,</span><span class="w"> </span><span class="mi">17711</span><span class="p">,</span><span class="w"> </span><span class="mi">28657</span><span class="p">,</span><span class="w"> </span><span class="mi">46368</span><span class="p">,</span><span class="w"> </span><span class="mi">75025</span><span class="p">,</span><span class="w"> </span><span class="mi">121393</span><span class="p">,</span><span class="w"> </span><span class="mi">196418</span><span class="p">,</span><span class="w"> </span><span class="mi">317811</span><span class="p">,</span><span class="w"> </span><span class="mi">514229</span><span class="p">,</span><span class="w"> </span><span class="mi">832040</span><span class="p">,</span><span class="w"> </span><span class="mi">1346269</span><span class="p">,</span><span class="w"> </span><span class="mi">2178309</span><span class="p">,</span><span class="w"> </span><span class="mi">3524578</span><span class="p">,</span><span class="w"> </span><span class="mi">5702887</span><span class="p">,</span><span class="w"> </span><span class="mi">9227465</span><span class="p">,</span><span class="w"> </span><span class="mi">14930352</span><span class="p">,</span><span class="w"> </span><span class="mi">24157817</span><span class="p">,</span><span class="w"> </span><span class="mi">39088169</span><span class="p">,</span><span class="w"> </span><span class="mi">63245986</span><span class="p">,</span><span class="w"> </span><span class="mi">102334155</span><span class="p">,</span><span class="w"> </span><span class="mi">165580141</span><span class="p">,</span><span class="w"> </span><span class="mi">267914296</span><span class="p">,</span><span class="w"> </span><span class="mi">433494437</span><span class="p">,</span><span class="w"> </span><span class="mi">701408733</span><span class="p">,</span><span class="w"> </span><span class="mi">1134903170</span><span class="p">,</span><span class="w"> </span><span class="mi">1836311903</span><span class="p">,</span><span class="w"> </span><span class="mi">2971215073</span><span class="p">,</span><span class="w"> </span><span class="mi">4807526976</span><span class="p">,</span><span class="w"> </span><span class="mi">7778742049</span><span class="p">,</span><span class="w"> </span><span class="mi">12586269025</span><span class="p">,</span><span class="w"> </span><span class="mi">20365011074</span><span class="p">,</span><span class="w"> </span><span class="mi">32951280099</span><span class="p">,</span><span class="w"> </span><span class="mi">53316291173</span><span class="p">,</span><span class="w"> </span><span class="mi">86267571272</span><span class="p">,</span><span class="w"> </span><span class="mi">139583862445</span><span class="p">,</span><span class="w"> </span><span class="mi">225851433717</span><span class="p">,</span><span class="w"> </span><span class="mi">365435296162</span><span class="p">,</span><span class="w"> </span><span class="mi">591286729879</span><span class="p">,</span><span class="w"> </span><span class="mi">956722026041</span><span class="p">,</span><span class="w"> </span><span class="mi">1548008755920</span><span class="p">,</span><span class="w"> </span><span class="mi">2504730781961</span><span class="p">,</span><span class="w"> </span><span class="mi">4052739537881</span><span class="p">,</span><span class="w"> </span><span class="mi">6557470319842</span><span class="p">,</span><span class="w"> </span><span class="mi">10610209857723</span><span class="p">,</span><span class="w"> </span><span class="mi">17167680177565</span><span class="p">,</span><span class="w"> </span><span class="mi">27777890035288</span><span class="p">,</span><span class="w"> </span><span class="mi">44945570212853</span><span class="p">,</span><span class="w"> </span><span class="mi">72723460248141</span><span class="p">,</span><span class="w"> </span><span class="mi">117669030460994</span><span class="p">,</span><span class="w"> </span><span class="mi">190392490709135</span><span class="p">,</span><span class="w"> </span><span class="mi">308061521170129</span><span class="p">,</span><span class="w"> </span><span class="mi">498454011879264</span><span class="p">,</span><span class="w"> </span><span class="mi">806515533049393</span><span class="p">,</span><span class="w"> </span><span class="mi">1304969544928657</span><span class="p">,</span><span class="w"> </span><span class="mi">2111485077978050</span><span class="p">,</span><span class="w"> </span><span class="mi">3416454622906707</span><span class="p">,</span><span class="w"> </span><span class="mi">5527939700884757</span><span class="p">,</span><span class="w"> </span><span class="mi">8944394323791464</span><span class="p">,</span><span class="w"> </span><span class="mi">14472334024676221</span><span class="p">,</span><span class="w"> </span><span class="mi">23416728348467685</span><span class="p">,</span><span class="w"> </span><span class="mi">37889062373143906</span><span class="p">,</span><span class="w"> </span><span class="mi">61305790721611591</span><span class="p">,</span><span class="w"> </span><span class="mi">99194853094755497</span><span class="p">,</span><span class="w"> </span><span class="mi">160500643816367088</span><span class="p">,</span><span class="w"> </span><span class="mi">259695496911122585</span><span class="p">,</span><span class="w"> </span><span class="mi">420196140727489673</span><span class="p">,</span><span class="w"> </span><span class="mi">679891637638612258</span><span class="p">,</span><span class="w"> </span><span class="mi">1100087778366101931</span><span class="p">,</span><span class="w"> </span><span class="mi">1779979416004714189</span><span class="p">,</span><span class="w"> </span><span class="mi">2880067194370816120</span><span class="p">,</span><span class="w"> </span><span class="mi">4660046610375530309</span><span class="p">,</span><span class="w"> </span><span class="mi">7540113804746346429</span><span class="p">,</span><span class="w"> </span><span class="mi">12200160415121876738</span><span class="p">,</span><span class="w"> </span><span class="mi">19740274219868223167</span><span class="p">,</span><span class="w"> </span><span class="mi">31940434634990099905</span><span class="p">,</span><span class="w"> </span><span class="mi">51680708854858323072</span><span class="p">,</span><span class="w"> </span><span class="mi">83621143489848422977</span><span class="p">,</span><span class="w"> </span><span class="mi">135301852344706746049</span><span class="p">,</span><span class="w"> </span><span class="mi">218922995834555169026</span><span class="p">,</span><span class="w"> </span><span class="mi">354224848179261915075</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h2 id="数据库">数据库</h2>

<p>如果数据很大结构很复杂怎么办。用文件保存的方式会变得很慢很繁琐。这会引入了<code class="language-plaintext highlighter-rouge">数据库</code>。也就相当于可编程的<code class="language-plaintext highlighter-rouge">Excel</code>表。可以很方便用代码进行增删改查的<code class="language-plaintext highlighter-rouge">Excel</code>表。</p>

<p>在官网文档找到例子。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'example.db'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="c1"># Create table
</span><span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'''CREATE TABLE stocks
               (date text, trans text, symbol text, qty real, price real)'''</span><span class="p">)</span>

<span class="c1"># Insert a row of data
</span><span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO stocks VALUES ('2006-01-05','BUY','RHAT',100,35.14)"</span><span class="p">)</span>

<span class="c1"># Save (commit) the changes
</span><span class="n">con</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># We can also close the connection if we are done with it.
# Just be sure any changes have been committed or they will be lost.
</span><span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * FROM stocks ORDER BY price'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cursor</code>表示游标，也就像光标一样。上面是连接数据库、建表、插入数据、提交更改、关闭连接的意思。最后面的例子则是查询数据的一个示例。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO vs VALUES('</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">con</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">fplus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>写好了。试试看。</p>

<p>我电脑上已经有了<code class="language-plaintext highlighter-rouge">sqlite3</code>。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sqlite3
SQLite version 3.32.3 2020-06-18 14:16:19
Enter <span class="s2">".help"</span> <span class="k">for </span>usage hints.
Connected to a transient <span class="k">in</span><span class="nt">-memory</span> database.
Use <span class="s2">".open FILENAME"</span> to reopen on a persistent database.
</code></pre></div></div>

<pre><code class="language-sqlite">sqlite&gt; .help
.auth ON|OFF             Show authorizer callbacks
.backup ?DB? FILE        Backup DB (default "main") to FILE
.bail on|off             Stop after hitting an error.  Default OFF
.binary on|off           Turn binary output on or off.  Default OFF
.cd DIRECTORY            Change the working directory to DIRECTORY
.changes on|off          Show number of rows changed by SQL
.check GLOB              Fail if output since .testcase does not match
.clone NEWDB             Clone data into NEWDB from the existing database
.databases               List names and files of attached databases
.dbconfig ?op? ?val?     List or change sqlite3_db_config() options
.dbinfo ?DB?             Show status information about the database
.dump ?TABLE?            Render database content as SQL
.echo on|off             Turn command echo on or off
.eqp on|off|full|...     Enable or disable automatic EXPLAIN QUERY PLAN
.excel                   Display the output of next command in spreadsheet
.exit ?CODE?             Exit this program with return-code CODE
.expert                  EXPERIMENTAL. Suggest indexes for queries
.explain ?on|off|auto?   Change the EXPLAIN formatting mode.  Default: auto
.filectrl CMD ...        Run various sqlite3_file_control() operations
.fullschema ?--indent?   Show schema and the content of sqlite_stat tables
.headers on|off          Turn display of headers on or off
.help ?-all? ?PATTERN?   Show help text for PATTERN
.import FILE TABLE       Import data from FILE into TABLE
.imposter INDEX TABLE    Create imposter table TABLE on index INDEX
.indexes ?TABLE?         Show names of indexes
.limit ?LIMIT? ?VAL?     Display or change the value of an SQLITE_LIMIT
.lint OPTIONS            Report potential schema issues.
.log FILE|off            Turn logging on or off.  FILE can be stderr/stdout
.mode MODE ?TABLE?       Set output mode
.nullvalue STRING        Use STRING in place of NULL values
.once ?OPTIONS? ?FILE?   Output for the next SQL command only to FILE
.open ?OPTIONS? ?FILE?   Close existing database and reopen FILE
.output ?FILE?           Send output to FILE or stdout if FILE is omitted
.parameter CMD ...       Manage SQL parameter bindings
.print STRING...         Print literal STRING
.progress N              Invoke progress handler after every N opcodes
.prompt MAIN CONTINUE    Replace the standard prompts
.quit                    Exit this program
.read FILE               Read input from FILE
.recover                 Recover as much data as possible from corrupt db.
.restore ?DB? FILE       Restore content of DB (default "main") from FILE
.save FILE               Write in-memory database into FILE
.scanstats on|off        Turn sqlite3_stmt_scanstatus() metrics on or off
.schema ?PATTERN?        Show the CREATE statements matching PATTERN
.selftest ?OPTIONS?      Run tests defined in the SELFTEST table
.separator COL ?ROW?     Change the column and row separators
.session ?NAME? CMD ...  Create or control sessions
.sha3sum ...             Compute a SHA3 hash of database content
.shell CMD ARGS...       Run CMD ARGS... in a system shell
.show                    Show the current values for various settings
.stats ?on|off?          Show stats or turn stats on or off
.system CMD ARGS...      Run CMD ARGS... in a system shell
.tables ?TABLE?          List names of tables matching LIKE pattern TABLE
.testcase NAME           Begin redirecting output to 'testcase-out.txt'
.testctrl CMD ...        Run various sqlite3_test_control() operations
.timeout MS              Try opening locked tables for MS milliseconds
.timer on|off            Turn SQL timer on or off
.trace ?OPTIONS?         Output each SQL statement as it is run
.vfsinfo ?AUX?           Information about the top-level VFS
.vfslist                 List all available VFSes
.vfsname ?AUX?           Print the name of the VFS stack
.width NUM1 NUM2 ...     Set column widths for "column" mode
</code></pre>

<p>可以看到有很多的命令。其中<code class="language-plaintext highlighter-rouge">.quit</code>表示退出。</p>

<p>没有的话可以到官网下载，或者运行<code class="language-plaintext highlighter-rouge">brew install sqlite</code>来安装。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sqlite3 fib.db
</code></pre></div></div>

<pre><code class="language-sqlite">sqlite&gt; show tables
   ...&gt; ;
Error: near "show": syntax error
sqlite&gt; tables;
Error: near "tables": syntax error
sqlite&gt; .schema
CREATE TABLE vs(v text);
</code></pre>

<p>一开始我以为像<code class="language-plaintext highlighter-rouge">MySQL</code>一样。可以用<code class="language-plaintext highlighter-rouge">show tables</code>来看看有哪些表。后来发现在<code class="language-plaintext highlighter-rouge">SQLite</code>是这样。<code class="language-plaintext highlighter-rouge">MySQL</code>是另外一种数据库，也是未来我们要学的。</p>

<pre><code class="language-sqlite">sqlite&gt; select * from vs;
0
1
1
2
3
5
8
13
21
34
55
</code></pre>

<p>果然，我们正确写入了数据。注意我们用的是<code class="language-plaintext highlighter-rouge">text</code>，因为我们数字很大，可能数据库的整数类型保存不了。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>    
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
         <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO vs VALUES('</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">con</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">read</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<p>我们继续加上<code class="language-plaintext highlighter-rouge">read</code>函数。然而运行后，出现了错误。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python</span> <span class="n">fib_db</span><span class="p">.</span><span class="n">py</span>
  <span class="p">...</span>
  <span class="n">File</span> <span class="s">"fib_db.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">27</span><span class="p">,</span> <span class="ow">in</span> <span class="n">create_table</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>
<span class="n">sqlite3</span><span class="p">.</span><span class="n">OperationalError</span><span class="p">:</span> <span class="n">table</span> <span class="n">vs</span> <span class="n">already</span> <span class="n">exists</span>
</code></pre></div></div>

<p>我们无法再创建表，表已经存在了。将语法稍稍改下。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE IF NOT EXISTS vs(v text)'</span><span class="p">)</span>
</code></pre></div></div>

<p>然而出现了错误。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    v[i] <span class="o">=</span> int<span class="o">(</span>row<span class="o">)</span>
TypeError: int<span class="o">()</span> argument must be a string, a bytes-like object or a number, not <span class="s1">'tuple'</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">tuple</code>是什么。意思是row返回了<code class="language-plaintext highlighter-rouge">tuple</code>。让我们打印一下。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p>结果为：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="s1">'0'</span>,<span class="o">)</span>
</code></pre></div></div>

<p>其实<code class="language-plaintext highlighter-rouge">tuple</code>和数组差不多。只不过它的元素可以是彼此不一样的，不像数组里的元素都得是同一类型。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>    
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>这么改。然而很奇怪。输出是这样：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>55
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
</code></pre></div></div>

<p>原来是我们的<code class="language-plaintext highlighter-rouge">i</code>没有自增。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>这样就对了。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
</code></pre></div></div>

<p>然而我们注意到，当数字很大的时候，在数据库里保存的样子是这样的：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4660046610375530309
7540113804746346429
1.22001604151219e+19
1.97402742198682e+19
3.19404346349901e+19
</code></pre></div></div>

<p>再运行一下是这样的。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python fib_db.py
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"fib_db.py"</span>, line 35, <span class="k">in </span><span class="nb">read
    </span>v[i] <span class="o">=</span> int<span class="o">(</span>row[0]<span class="o">)</span>
ValueError: invalid literal <span class="k">for </span>int<span class="o">()</span> with base 10: <span class="s1">'1.22001604151219e+19'</span>
</code></pre></div></div>

<p>改一改：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO vs VALUES('"</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">"')"</span><span class="p">)</span>
</code></pre></div></div>

<p>原来注意到这里我们把<code class="language-plaintext highlighter-rouge">INSERT</code>语句两边的单引号改成了双引号，同时给我们的数字字符串加了引号。如果之前这样写，数据库把我们的字符串当成了数字，而如今，这样用引号括起来，则表示是字符串。</p>

<p>然后就正确了。然而如何把之前的错误数据清空掉。</p>

<pre><code class="language-sqlite">$ sqlite3 fib.db
SQLite version 3.32.3 2020-06-18 14:16:19
Enter ".help" for usage hints.
sqlite&gt; delete * from vs;
</code></pre>

<p>接下来可以试试其他语句。<code class="language-plaintext highlighter-rouge">增删改查</code>。我们这里举了<code class="language-plaintext highlighter-rouge">增删查</code>的例子。</p>

<h2 id="练习">练习</h2>

<ul>
  <li>学生像上面这样类似探索一遍。</li>
</ul>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-zh" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
