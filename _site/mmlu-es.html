<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Benchmark de MMLU</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Benchmark de MMLU | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Benchmark de MMLU" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="es" />
<meta name="description" content="Prólogo" />
<meta property="og:description" content="Prólogo" />
<link rel="canonical" href="https://lzwjava.github.io/mmlu-es" />
<meta property="og:url" content="https://lzwjava.github.io/mmlu-es" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-25T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Benchmark de MMLU" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2025-01-25T00:00:00+08:00","datePublished":"2025-01-25T00:00:00+08:00","description":"Prólogo","headline":"Benchmark de MMLU","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/mmlu-es"},"url":"https://lzwjava.github.io/mmlu-es"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=14043099952524e763c1e5f4ef6c2245832fd05d">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=14043099952524e763c1e5f4ef6c2245832fd05d" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Benchmark de MMLU | Original, traducido por IA
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/es/2025-01-25-mmlu-es.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postses2025-01-25-mmlu-es.md</span> -->
      

      <!-- <span>2025-01-25-mmlu-es.md</span> -->

      
        

        
          
          <a href="#" class="button">2025.01</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/mmlu-en" >English</option>
        <option value="/mmlu-zh" >中文</option>
        <option value="/mmlu-ja" >日本語</option>
        <option value="/mmlu-es" selected>Español</option>
        <option value="/mmlu-hi" >हिंदी</option>
        <option value="/mmlu-fr" >Français</option>
        <option value="/mmlu-de" >Deutsch</option>
        <option value="/mmlu-ar" >العربية</option>
        <option value="/mmlu-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <h2 id="prólogo">Prólogo</h2>

<p>Esta publicación evalúa un modelo de lenguaje utilizando la prueba MMLU (Massive Multitask Language Understanding).</p>

<p>La prueba MMLU es un examen exhaustivo de la capacidad de un modelo para realizar diversas tareas en una amplia gama de temas. Consiste en preguntas de opción múltiple que abarcan áreas diversas como matemáticas, historia, derecho y medicina.</p>

<p><strong>Enlaces al Conjunto de Datos:</strong></p>

<ul>
  <li><a href="https://paperswithcode.com/dataset/mmlu">Papers with Code</a></li>
  <li><a href="https://huggingface.co/datasets/cais/mmlu">Hugging Face Datasets</a></li>
</ul>

<h2 id="llama-server">llama-server</h2>

<p>Para ejecutar el servidor llama:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build/bin/llama-server <span class="nt">-m</span> models/7B/mistral-7b-instruct-v0.2.Q4_K_M.gguf <span class="nt">--port</span> 8080
</code></pre></div></div>

<h2 id="prueba-mmlu">Prueba MMLU</h2>

<p>Este script evalúa la prueba MMLU utilizando tres backends diferentes: <code class="language-plaintext highlighter-rouge">ollama</code>, <code class="language-plaintext highlighter-rouge">llama-server</code> y <code class="language-plaintext highlighter-rouge">deepseek</code>.</p>

<p>Para ejecutar el código de la prueba MMLU:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Configurar el análisis de argumentos
</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Evaluar el conjunto de datos MMLU con diferentes backends."</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--type"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"ollama"</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">"ollama"</span><span class="p">,</span> <span class="s">"llama"</span><span class="p">,</span> <span class="s">"deepseek"</span><span class="p">,</span> <span class="s">"gemini"</span><span class="p">,</span> <span class="s">"mistral"</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s">"Tipo de backend: ollama, llama, deepseek, gemini o mistral"</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--model"</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Nombre del modelo"</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># Cargar el conjunto de datos MMLU
</span><span class="n">subject</span> <span class="o">=</span> <span class="s">"college_computer_science"</span>  <span class="c1"># Elige tu tema
</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s">"cais/mmlu"</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s">"test"</span><span class="p">)</span>

<span class="c1"># Formatear el prompt con un ejemplo de un solo disparo
</span><span class="k">def</span> <span class="nf">format_mmlu_prompt</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"Pregunta: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'question'</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">prompt</span> <span class="o">+=</span> <span class="s">"Opciones:</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s">'choices'</span><span class="p">]):</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">'A'</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">prompt</span> <span class="o">+=</span> <span class="s">"Da tu respuesta. Solo da la opción.</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">prompt</span>

<span class="c1"># Inicializar el cliente DeepSeek si es necesario
</span><span class="k">def</span> <span class="nf">initialize_deepseek_client</span><span class="p">():</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"DEEPSEEK_API_KEY"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error: La variable de entorno DEEPSEEK_API_KEY no está definida."</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s">"https://api.deepseek.com"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">call_gemini_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">gemini_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"GEMINI_API_KEY"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gemini_api_key</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error: La variable de entorno GEMINI_API_KEY no está definida."</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">"key"</span><span class="p">:</span> <span class="n">gemini_api_key</span><span class="p">}</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">"contents"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"parts"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"text"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]}]}</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Entrada a la API de Gemini: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_json</span>
        <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span>  <span class="c1"># Retroceso exponencial
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error de la API de Gemini: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">call_mistral_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s">"mistral-small-2501"</span><span class="p">,</span> <span class="n">process_response</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"MISTRAL_API_KEY"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error: La variable de entorno MISTRAL_API_KEY no está definida."</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.mistral.ai/v1/chat/completions"</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
        <span class="s">"Accept"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s">"</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"model"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s">"messages"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span>
                <span class="s">"content"</span><span class="p">:</span> <span class="n">prompt</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Entrada a la API de Mistral: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"URL de la API de Mistral: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Encabezados de la API de Mistral: </span><span class="si">{</span><span class="n">headers</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response_json</span> <span class="ow">and</span> <span class="n">response_json</span><span class="p">[</span><span class="s">'choices'</span><span class="p">]:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s">'choices'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'message'</span><span class="p">][</span><span class="s">'content'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">process_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">process_mistral_response</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error de la API de Mistral: Formato de respuesta no válido: </span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error de la API de Mistral: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">stre</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span>
        <span class="k">if</span> <span class="s">'429'</span> <span class="ow">in</span>  <span class="n">stre</span><span class="p">:</span>
            <span class="c1"># print(f"Código de estado de la respuesta: {e.response.status_code}")
</span>            <span class="c1"># print(f"Contenido de la respuesta: {e.response.text}")
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"Demasiadas solicitudes, durmiendo por 10 segundos y volviendo a intentar"</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_mistral_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">process_response</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">e</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">process_ollama_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Salida de la API: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">output_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">"choices"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"message"</span><span class="p">][</span><span class="s">"content"</span><span class="p">]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"Answer:\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"\*\*Answer\*\*:\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The correct answer is\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The correct choice is\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The correct choice would be\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The answer is\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The answer appears to be\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The correct answer should be\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">"The correct answer would be\s*([A-D])"</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stripped_output</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">first_word</span> <span class="o">=</span> <span class="n">stripped_output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_word</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">first_word</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">first_word_comma</span> <span class="o">=</span> <span class="n">stripped_output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">","</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_word_comma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">first_word_comma</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">first_word_period</span> <span class="o">=</span> <span class="n">stripped_output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_word_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">first_word_period</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"No se pudo extraer una respuesta de un solo carácter de la salida: </span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s">, devolviendo respuesta aleatoria"</span><span class="p">)</span>
                            <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">([</span><span class="s">"A"</span><span class="p">,</span> <span class="s">"B"</span><span class="p">,</span> <span class="s">"C"</span><span class="p">,</span> <span class="s">"D"</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted_answer</span> <span class="o">=</span> <span class="s">""</span>

        <span class="k">return</span> <span class="n">predicted_answer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">process_llama_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">output_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">"choices"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"message"</span><span class="p">][</span><span class="s">"content"</span><span class="p">]</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">""</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Salida de la API: </span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predicted_answer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">process_deepseek_response</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s">"deepseek-chat"</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Entrada a la API de Deepseek: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="n">max_tokens</span><span class="o">=</span><span class="mi">100</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">choices</span><span class="p">:</span>
                <span class="n">output_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">message</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">""</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Salida de la API: </span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">predicted_answer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Error: No hay respuesta de la API."</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">""</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">"502"</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error de la puerta de enlace (502) durante la llamada a la API, volviendo a intentar en </span><span class="si">{</span><span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span><span class="si">}</span><span class="s"> segundos..."</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error durante la llamada a la API: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">""</span>
    <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">process_mistral_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">output_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">""</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Salida de la API: </span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predicted_answer</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error: No hay respuesta de la API de Mistral"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">process_gemini_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="n">call_gemini_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_response</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"No hay respuesta de la API de Gemini después de los reintentos."</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="k">if</span> <span class="s">'candidates'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_response</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">json_response</span><span class="p">[</span><span class="s">'candidates'</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"No se encontraron candidatos en la respuesta, volviendo a intentar..."</span><span class="p">)</span>
        <span class="n">json_response</span> <span class="o">=</span> <span class="n">call_gemini_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">json_response</span> <span class="ow">or</span> <span class="s">'candidates'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_response</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">json_response</span><span class="p">[</span><span class="s">'candidates'</span><span class="p">]:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"No se encontraron candidatos en la respuesta después del reintento."</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">""</span>

    <span class="n">first_candidate</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s">'candidates'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">'content'</span> <span class="ow">in</span> <span class="n">first_candidate</span> <span class="ow">and</span> <span class="s">'parts'</span> <span class="ow">in</span> <span class="n">first_candidate</span><span class="p">[</span><span class="s">'content'</span><span class="p">]:</span>
        <span class="n">first_part</span> <span class="o">=</span> <span class="n">first_candidate</span><span class="p">[</span><span class="s">'content'</span><span class="p">][</span><span class="s">'parts'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">'text'</span> <span class="ow">in</span> <span class="n">first_part</span><span class="p">:</span>
            <span class="n">output_text</span> <span class="o">=</span> <span class="n">first_part</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span>
            <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_text</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">""</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Salida de la API: </span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">predicted_answer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"No se encontró texto en la respuesta"</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Formato de respuesta inesperado: falta contenido o partes"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">_call_ollama_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:11434/v1/chat/completions"</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"messages"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
        <span class="s">"model"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s">"max_tokens"</span><span class="p">:</span> <span class="mi">300</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Entrada a la API: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">process_ollama_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_call_llama_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8080/v1/chat/completions"</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"messages"</span><span class="p">:</span> <span class="p">[{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Entrada a la API: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">process_llama_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_predicted_answer</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="n">predicted_answer</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"ollama"</span><span class="p">:</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">_call_ollama_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"llama"</span><span class="p">:</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">_call_llama_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"deepseek"</span><span class="p">:</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">process_deepseek_response</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"gemini"</span><span class="p">:</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">process_gemini_response</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"mistral"</span><span class="p">:</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">call_mistral_api</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Tipo de backend no válido"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predicted_answer</span>

<span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">client</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"deepseek"</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">initialize_deepseek_client</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"ollama"</span><span class="p">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">"mistral:7b"</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"deepseek"</span><span class="p">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">"deepseek-chat"</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="s">"mistral"</span><span class="p">:</span>
            <span class="n">args</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">"mistral-small-latest"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s">"Evaluando"</span><span class="p">):</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">format_mmlu_prompt</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
        <span class="n">predicted_answer</span> <span class="o">=</span> <span class="n">_get_predicted_answer</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>

        <span class="n">answer_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s">"A"</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">"B"</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s">"C"</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s">"D"</span><span class="p">}</span>
        <span class="n">ground_truth_answer</span> <span class="o">=</span> <span class="n">answer_map</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s">"answer"</span><span class="p">],</span> <span class="s">""</span><span class="p">)</span>
        <span class="n">is_correct</span> <span class="o">=</span> <span class="n">predicted_answer</span><span class="p">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">ground_truth_answer</span>
        <span class="k">if</span> <span class="n">is_correct</span><span class="p">:</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Pregunta: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'question'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Opciones: A. </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'choices'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">, B. </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'choices'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">, C. </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'choices'</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s">, D. </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s">'choices'</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Respuesta Predicha: </span><span class="si">{</span><span class="n">predicted_answer</span><span class="si">}</span><span class="s">, Verdadera: </span><span class="si">{</span><span class="n">ground_truth_answer</span><span class="si">}</span><span class="s">, Correcta: </span><span class="si">{</span><span class="n">is_correct</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Procesado </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s">. Exactitud actual: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">correct</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">correct</span><span class="p">,</span> <span class="n">total</span>

<span class="c1"># Bucle de evaluación
</span><span class="n">correct</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>

<span class="c1"># Calcular la exactitud
</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Tema: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Exactitud: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">correct</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="resultados">Resultados</h2>

<h3 id="evaluación-de-zero-shot">Evaluación de Zero-Shot</h3>

<table>
  <thead>
    <tr>
      <th>Modelo</th>
      <th>Forma</th>
      <th>Tema</th>
      <th>Exactitud</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>mistral-7b-instruct-v0.2, Q4_K_M</td>
      <td>macOS m2, 16GB, llama-server</td>
      <td>MMLU college_computer_science</td>
      <td>40.00% (40/100)</td>
    </tr>
    <tr>
      <td>Mistral-7B-Instruct-v0.3, Q4_0</td>
      <td>macOS m2, 16GB, ollama</td>
      <td>MMLU college_computer_science</td>
      <td>40.00% (40/100)</td>
    </tr>
    <tr>
      <td>deepseek v3 (API)</td>
      <td>API, 2025.1.25</td>
      <td>MMLU college_computer_science</td>
      <td>78.00% (78/100)</td>
    </tr>
    <tr>
      <td>gemini-1.5-flash (API)</td>
      <td>API, 2025.1.25</td>
      <td>MMLU college_computer_science</td>
      <td>72.00% (72/100)</td>
    </tr>
    <tr>
      <td>deepseek r1 (API)</td>
      <td>API, 2025.1.26</td>
      <td>MMLU college_computer_science</td>
      <td>87.14% (61/70)</td>
    </tr>
    <tr>
      <td>Mistral Small Latest (API)</td>
      <td>API, 2025.01.31</td>
      <td>MMLU college_computer_science</td>
      <td>65.00% (65/100)</td>
    </tr>
    <tr>
      <td>Mistral Large Latest (API)</td>
      <td>API, 2025.01.31</td>
      <td>MMLU college_computer_science</td>
      <td>73.00% (73/100)</td>
    </tr>
    <tr>
      <td>Mistral Small 2501 (API)</td>
      <td>API, 2025.01.31</td>
      <td>MMLU college_computer_science</td>
      <td>66.00% (66/100)</td>
    </tr>
    <tr>
      <td>Grok 2 Latest</td>
      <td>API, 2025.02.02</td>
      <td>MMLU college_computer_science</td>
      <td>72.00% (72/100)</td>
    </tr>
  </tbody>
</table>

<h3 id="figura">Figura</h3>

<p>Vamos a crear una figura basada en la tabla anterior.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Datos de ejemplo (reemplaza con tus datos reales)
</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mistral-7b-instruct-v0.2 (llama.cpp)'</span><span class="p">,</span> <span class="s">'Mistral-7B-Instruct-v0.3 (ollama)'</span><span class="p">,</span> <span class="s">'deepseek v3 (API)'</span><span class="p">,</span> <span class="s">'gemini-1.5-flash (API)'</span><span class="p">,</span> <span class="s">'deepseek r1 (API)'</span><span class="p">]</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">40.00</span><span class="p">,</span> <span class="mf">40.00</span><span class="p">,</span> <span class="mf">78.00</span><span class="p">,</span> <span class="mf">72.00</span><span class="p">,</span> <span class="mf">87.14</span><span class="p">]</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s">"college_computer_science"</span>

<span class="c1"># Crear el gráfico de barras
</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s">'skyblue'</span><span class="p">,</span> <span class="s">'lightcoral'</span><span class="p">,</span> <span class="s">'lightgreen'</span><span class="p">,</span> <span class="s">'gold'</span><span class="p">,</span> <span class="s">'lightcoral'</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Modelo'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Exactitud (%)'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s">'Exactitud en la Prueba MMLU para </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Establecer el límite del eje y a 0-100 para el porcentaje
</span><span class="n">plt</span><span class="p">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">"right"</span><span class="p">)</span>  <span class="c1"># Rotar las etiquetas del eje x para una mejor legibilidad
</span><span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Añadir valores de exactitud encima de las barras
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracy</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">'bottom'</span><span class="p">)</span>

<span class="c1"># Guardar el gráfico como un archivo JPG en el directorio actual
</span><span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sa">f</span><span class="s">'mmlu_accuracy_chart.jpg'</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>

<p class="centered"><img src="assets/images/mmlu/mmlu_accuracy_chart.jpg" alt="" />
<em class="caption">Exactitud en la Prueba MMLU</em></p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-es" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
