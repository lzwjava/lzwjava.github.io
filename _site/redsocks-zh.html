<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Redsocks 实践</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Redsocks 实践 | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Redsocks 实践" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="zh" />
<meta name="description" content="当然！我将指导您如何使用您的 Mac 电脑设置 Shadowsocks 代理，并配置您的 OpenWRT 路由器，通过此代理将所有连接设备的流量路由。此设置主要包括以下几个步骤：" />
<meta property="og:description" content="当然！我将指导您如何使用您的 Mac 电脑设置 Shadowsocks 代理，并配置您的 OpenWRT 路由器，通过此代理将所有连接设备的流量路由。此设置主要包括以下几个步骤：" />
<link rel="canonical" href="https://lzwjava.github.io/redsocks-zh" />
<meta property="og:url" content="https://lzwjava.github.io/redsocks-zh" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-18T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Redsocks 实践" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2024-12-18T00:00:00+08:00","datePublished":"2024-12-18T00:00:00+08:00","description":"当然！我将指导您如何使用您的 Mac 电脑设置 Shadowsocks 代理，并配置您的 OpenWRT 路由器，通过此代理将所有连接设备的流量路由。此设置主要包括以下几个步骤：","headline":"Redsocks 实践","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/redsocks-zh"},"url":"https://lzwjava.github.io/redsocks-zh"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=76b40bfa7192cc0312edc08722bf580f86b3b80a">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=76b40bfa7192cc0312edc08722bf580f86b3b80a" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Redsocks 实践 | 原创，AI翻译
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/zh/2024-12-18-redsocks-zh.md">PDF</a> -->

    <!-- Audio Button -->



    <!-- 
    <a href="#" id="playAudioButton" class="button audio-button" data-file-path="_posts/zh/2024-12-18-redsocks-zh.md">Audio</a>
     -->

        <!-- Date Button -->
    
      
      <!-- <span>_postszh2024-12-18-redsocks-zh.md</span> -->
      

      <!-- <span>2024-12-18-redsocks-zh.md</span> -->

      
        

        
          
          <a href="#" class="button">2024.12</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/redsocks-en" >English</option>
        <option value="/redsocks-zh" selected>中文</option>
        <option value="/redsocks-ja" >日本語</option>
        <option value="/redsocks-es" >Español</option>
        <option value="/redsocks-hi" >हिंदी</option>
        <option value="/redsocks-fr" >Français</option>
        <option value="/redsocks-de" >Deutsch</option>
        <option value="/redsocks-ar" >العربية</option>
        <option value="/redsocks-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>当然！我将指导您如何使用您的 Mac 电脑设置 Shadowsocks 代理，并配置您的 OpenWRT 路由器，通过此代理将所有连接设备的流量路由。此设置主要包括以下几个步骤：</p>

<ol>
  <li>在 macOS 上设置 Shadowsocks 客户端（使用 Shadowsocks-NG 或 Clash）</li>
  <li>配置 macOS 以允许外部代理连接</li>
  <li>为您的 Mac 分配静态 IP</li>
  <li>在 OpenWRT 上安装和配置 Redsocks</li>
  <li>通过 macOS 代理重定向 OpenWRT 的流量</li>
  <li>测试代理设置</li>
</ol>

<p>让我们详细了解每个步骤。</p>

<hr />

<h2 id="1-在-macos-上设置-shadowsocks-客户端">1. 在 macOS 上设置 Shadowsocks 客户端</h2>

<p>您可以使用 Shadowsocks-NG 或 Clash 作为您的 Shadowsocks 客户端。以下是两者的使用说明。</p>

<h3 id="选项-a使用-shadowsocks-ng">选项 A：使用 Shadowsocks-NG</h3>

<p>Shadowsocks-NG 是一个流行且用户友好的 macOS Shadowsocks 客户端。</p>

<h4 id="步骤-1下载并安装-shadowsocks-ng">步骤 1：下载并安装 Shadowsocks-NG</h4>

<ol>
  <li>下载 Shadowsocks-NG：
    <ul>
      <li>访问 <a href="https://github.com/shadowsocks/ShadowsocksX-NG/releases">Shadowsocks-NG GitHub 发布页面</a>。</li>
      <li>下载最新的 <code class="language-plaintext highlighter-rouge">.dmg</code> 文件。</li>
    </ul>
  </li>
  <li>安装应用程序：
    <ul>
      <li>打开下载的 <code class="language-plaintext highlighter-rouge">.dmg</code> 文件。</li>
      <li>将 ShadowsocksX-NG 应用拖到您的 应用程序 文件夹中。</li>
    </ul>
  </li>
  <li>启动 Shadowsocks-NG：
    <ul>
      <li>从 应用程序 文件夹中打开 ShadowsocksX-NG。</li>
      <li>您可能需要在 系统偏好设置 中授予应用必要的权限。</li>
    </ul>
  </li>
</ol>

<h4 id="步骤-2配置-shadowsocks-ng">步骤 2：配置 Shadowsocks-NG</h4>

<ol>
  <li>打开偏好设置：
    <ul>
      <li>点击菜单栏中的 ShadowsocksX-NG 图标。</li>
      <li>选择 “Open ShadowsocksX-NG” &gt; “Preferences”。</li>
    </ul>
  </li>
  <li>添加新服务器：
    <ul>
      <li>转到 “Servers” 标签。</li>
      <li>点击 “+” 按钮添加新服务器。</li>
    </ul>
  </li>
  <li>导入 Shadowsocks URL：
    <ul>
      <li>复制您的 Shadowsocks URL：
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ss://[ENCRYPTED_PASSWORD]@xxx.xxx.xxx.xxx:xxxxx/?outline=1
</code></pre></div>        </div>
      </li>
      <li>导入方法：
        <ul>
          <li>点击 “Import”。</li>
          <li>粘贴您的 Shadowsocks URL。</li>
          <li>Shadowsocks-NG 应该会自动解析并填写服务器详情。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>设置本地代理：
    <ul>
      <li>确保勾选 “Enable SOCKS5 Proxy”。</li>
      <li>注意 本地端口（默认通常为 <code class="language-plaintext highlighter-rouge">1080</code>）。</li>
    </ul>
  </li>
  <li>保存并激活：
    <ul>
      <li>点击 “OK” 保存服务器。</li>
      <li>切换 “Enable Shadowsocks” 开关至 ON。</li>
    </ul>
  </li>
</ol>

<h3 id="选项-b使用-clash">选项 B：使用 Clash</h3>

<p>Clash 是一个多功能的代理客户端，支持包括 Shadowsocks 在内的多种协议。</p>

<h4 id="步骤-1下载并安装-clash">步骤 1：下载并安装 Clash</h4>

<ol>
  <li>下载适用于 macOS 的 Clash：
    <ul>
      <li>访问 <a href="https://github.com/Dreamacro/clash/releases">Clash GitHub 发布页面</a>。</li>
      <li>下载最新的 Clash for macOS 二进制文件。</li>
    </ul>
  </li>
  <li>安装应用程序：
    <ul>
      <li>将下载的 Clash 应用移动到您的 应用程序 文件夹中。</li>
    </ul>
  </li>
  <li>启动 Clash：
    <ul>
      <li>从 应用程序 文件夹中打开 Clash。</li>
      <li>您可能需要在 系统偏好设置 中授予必要的权限。</li>
    </ul>
  </li>
</ol>

<h4 id="步骤-2配置-clash">步骤 2：配置 Clash</h4>

<ol>
  <li>访问配置文件：
    <ul>
      <li>Clash 使用 YAML 配置文件。您可以使用 TextEdit 或 Visual Studio Code 等文本编辑器创建或编辑它。</li>
    </ul>
  </li>
  <li>添加您的 Shadowsocks 服务器：
    <ul>
      <li>
        <p>创建一个配置文件（例如 <code class="language-plaintext highlighter-rouge">config.yaml</code>），内容如下：</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">port</span><span class="pi">:</span> <span class="m">7890</span>
<span class="na">socks-port</span><span class="pi">:</span> <span class="m">7891</span>
<span class="na">allow-lan</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">Rule</span>
<span class="na">log-level</span><span class="pi">:</span> <span class="s">info</span>

<span class="na">proxies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyShadowsocks"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ss</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">xxx.xxx.xxx.xxx</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">xxxxx</span>
    <span class="na">cipher</span><span class="pi">:</span> <span class="s">chacha20-ietf-poly1305</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xxxxxx"</span>

<span class="na">proxy-groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Default"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">select</span>
    <span class="na">proxies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">MyShadowsocks"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">DIRECT"</span>

<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">MATCH,Default</span>
</code></pre></div>        </div>

        <p>注意事项：</p>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">port</code> 和 <code class="language-plaintext highlighter-rouge">socks-port</code> 定义了 Clash 监听的 HTTP 和 SOCKS5 代理端口。</li>
          <li><code class="language-plaintext highlighter-rouge">allow-lan: true</code> 允许局域网设备使用代理。</li>
          <li><code class="language-plaintext highlighter-rouge">proxies</code> 部分包括您的 Shadowsocks 服务器详情。</li>
          <li><code class="language-plaintext highlighter-rouge">proxy-groups</code> 和 <code class="language-plaintext highlighter-rouge">rules</code> 决定了流量的路由方式。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>使用配置文件启动 Clash：
    <ul>
      <li>启动 Clash 并确保它使用您的 <code class="language-plaintext highlighter-rouge">config.yaml</code> 文件。</li>
      <li>您可能需要在启动 Clash 时指定配置路径。</li>
    </ul>
  </li>
  <li>验证代理是否运行：
    <ul>
      <li>确保 Clash 正在连接到您的 Shadowsocks 服务器。</li>
      <li>检查菜单栏图标的状态。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="2-配置-macos-以允许外部代理连接">2. 配置 macOS 以允许外部代理连接</h2>

<p>默认情况下，Shadowsocks 客户端将代理绑定到 <code class="language-plaintext highlighter-rouge">localhost</code> (<code class="language-plaintext highlighter-rouge">127.0.0.1</code>)，这意味着只有 Mac 可以使用该代理。要允许您的 OpenWRT 路由器使用此代理，您需要将代理绑定到 Mac 的局域网 IP。</p>

<h3 id="对于-shadowsocks-ng">对于 Shadowsocks-NG：</h3>

<ol>
  <li>打开偏好设置：
    <ul>
      <li>点击菜单栏中的 ShadowsocksX-NG 图标。</li>
      <li>选择 “Open ShadowsocksX-NG” &gt; “Preferences”。</li>
    </ul>
  </li>
  <li>转到高级选项卡：
    <ul>
      <li>导航到 “Advanced” 标签。</li>
    </ul>
  </li>
  <li>设置监听地址：
    <ul>
      <li>将 “Listen Address” 从 <code class="language-plaintext highlighter-rouge">127.0.0.1</code> 更改为 <code class="language-plaintext highlighter-rouge">0.0.0.0</code> 以允许来自任何接口的连接。</li>
      <li>或者，指定 Mac 的局域网 IP（例如 <code class="language-plaintext highlighter-rouge">192.168.1.xxx</code>）。</li>
    </ul>
  </li>
  <li>保存并重启 Shadowsocks-NG：
    <ul>
      <li>点击 “OK” 保存更改。</li>
      <li>重启 Shadowsocks-NG 客户端以应用新设置。</li>
    </ul>
  </li>
</ol>

<h3 id="对于-clash">对于 Clash：</h3>

<ol>
  <li>编辑配置文件：
    <ul>
      <li>确保在您的 <code class="language-plaintext highlighter-rouge">config.yaml</code> 中启用了 <code class="language-plaintext highlighter-rouge">allow-lan: true</code> 设置。</li>
    </ul>
  </li>
  <li>绑定到所有接口：
    <ul>
      <li>在配置中，设置 <code class="language-plaintext highlighter-rouge">allow-lan: true</code> 通常会将代理绑定到所有可用接口，包括局域网。</li>
    </ul>
  </li>
  <li>重启 Clash：
    <ul>
      <li>重启 Clash 客户端以应用更改。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="3-为您的-mac-分配静态-ip">3. 为您的 Mac 分配静态 IP</h2>

<p>为了确保 OpenWRT 路由器与 Mac 之间的连接稳定，请在您的本地网络中为 Mac 分配一个静态 IP。</p>

<h3 id="在-macos-上分配静态-ip-的步骤">在 macOS 上分配静态 IP 的步骤：</h3>

<ol>
  <li>打开系统偏好设置：
    <ul>
      <li>点击 Apple 菜单，选择 “系统偏好设置”。</li>
    </ul>
  </li>
  <li>导航到网络设置：
    <ul>
      <li>点击 “网络”。</li>
    </ul>
  </li>
  <li>选择您的活动连接：
    <ul>
      <li>从左侧栏中选择 “Wi-Fi” 或 “以太网”，具体取决于您的 Mac 如何连接到路由器。</li>
    </ul>
  </li>
  <li>配置 IPv4 设置：
    <ul>
      <li>点击 “高级…“。</li>
      <li>转到 “TCP/IP” 标签。</li>
      <li>将 “配置 IPv4” 从 “使用 DHCP” 更改为 “手动”。</li>
    </ul>
  </li>
  <li>设置静态 IP 地址：
    <ul>
      <li>IP 地址： 选择一个路由器 DHCP 范围之外的 IP 以防止冲突（例如 <code class="language-plaintext highlighter-rouge">192.168.1.xxx</code>）。</li>
      <li>子网掩码： 通常为 <code class="language-plaintext highlighter-rouge">255.255.255.0</code>。</li>
      <li>路由器： 您路由器的 IP 地址（例如 <code class="language-plaintext highlighter-rouge">192.168.1.1</code>）。</li>
      <li>DNS 服务器： 您可以使用路由器的 IP 或其他 DNS 服务，如 <code class="language-plaintext highlighter-rouge">8.8.8.8</code>。</li>
    </ul>
  </li>
  <li>应用设置：
    <ul>
      <li>点击 “OK”，然后点击 “应用” 保存更改。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-在-openwrt-上安装和配置-redsocks">4. 在 OpenWRT 上安装和配置 Redsocks</h2>

<p>Redsocks 是一个透明的 SOCKS 重定向器，允许您通过 SOCKS5 代理路由网络流量。我们将使用 Redsocks 将 OpenWRT 的流量重定向到在 Mac 上运行的 Shadowsocks 代理。</p>

<h3 id="步骤-1安装-redsocks">步骤 1：安装 Redsocks</h3>

<ol>
  <li>
    <p>更新软件包列表：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@&lt;router_ip&gt;
opkg update
</code></pre></div>    </div>
  </li>
  <li>
    <p>安装 Redsocks：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg <span class="nb">install </span>redsocks
</code></pre></div>    </div>

    <p><em>如果 Redsocks 在您的 OpenWRT 仓库中不可用，您可能需要手动编译或使用替代软件包。</em></p>
  </li>
</ol>

<h3 id="步骤-2配置-redsocks">步骤 2：配置 Redsocks</h3>

<ol>
  <li>
    <p>创建或编辑 Redsocks 配置文件：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/redsocks.conf
</code></pre></div>    </div>
  </li>
  <li>
    <p>添加以下配置：</p>

    <div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">base</span> {
    <span class="n">log_debug</span> = <span class="n">on</span>;
    <span class="n">log_info</span> = <span class="n">on</span>;
    <span class="n">log</span> = <span class="s2">"file:/var/log/redsocks.log"</span>;
    <span class="n">daemon</span> = <span class="n">on</span>;
    <span class="n">redirector</span> = <span class="n">iptables</span>;
}

<span class="n">redsocks</span> {
    <span class="n">local_ip</span> = <span class="m">0</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">0</span>;
    <span class="n">local_port</span> = <span class="m">12345</span>;  <span class="c"># Redsocks 监听的本地端口
</span>    <span class="n">ip</span> = <span class="n">xxx</span>.<span class="n">xxx</span>.<span class="n">xxx</span>.<span class="n">xxx</span>;  <span class="c"># Mac 的静态 IP
</span>    <span class="n">port</span> = <span class="n">xxxxx</span>;          <span class="c"># Shadowsocks-NG 的本地 SOCKS5 代理端口
</span>    <span class="n">type</span> = <span class="n">socks5</span>;
    <span class="n">login</span> = <span class="s2">""</span>;           <span class="c"># 如果您的代理需要认证
</span>    <span class="n">password</span> = <span class="s2">""</span>;
}
</code></pre></div>    </div>

    <p>注意事项：</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">local_port</code>：Redsocks 用于监听来自 iptables 重定向的连接的端口。</li>
      <li><code class="language-plaintext highlighter-rouge">ip</code> 和 <code class="language-plaintext highlighter-rouge">port</code>：指向您的 Mac 上的 Shadowsocks SOCKS5 代理（基于前面的步骤为 <code class="language-plaintext highlighter-rouge">xxx.xxx.xxx.xxx:xxxxx</code>）。</li>
      <li><code class="language-plaintext highlighter-rouge">type</code>：设置为 <code class="language-plaintext highlighter-rouge">socks5</code>，因为 Shadowsocks 提供 SOCKS5 代理。</li>
    </ul>
  </li>
  <li>保存并退出：
    <ul>
      <li>按 <code class="language-plaintext highlighter-rouge">ESC</code>，输入 <code class="language-plaintext highlighter-rouge">:wq</code>，然后按 <code class="language-plaintext highlighter-rouge">Enter</code>。</li>
    </ul>
  </li>
  <li>
    <p>创建日志文件：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch</span> /var/log/redsocks.log
<span class="nb">chmod </span>644 /var/log/redsocks.log
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="步骤-3启动-redsocks-服务">步骤 3：启动 Redsocks 服务</h3>

<ol>
  <li>
    <p>启用 Redsocks 开机启动：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/redsocks <span class="nb">enable</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动 Redsocks：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/redsocks start
</code></pre></div>    </div>
  </li>
  <li>
    <p>验证 Redsocks 是否在运行：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps | <span class="nb">grep </span>redsocks
</code></pre></div>    </div>

    <p>您应该会看到 Redsocks 进程正在运行。</p>
  </li>
</ol>

<hr />

<h2 id="5-通过-macos-代理重定向-openwrt-的流量">5. 通过 macOS 代理重定向 OpenWRT 的流量</h2>

<p>现在，Redsocks 已在 OpenWRT 上设置完毕，接下来配置 iptables，将所有出站的 TCP 流量通过 Redsocks 重定向，而 Redsocks 再通过您的 Mac 的 Shadowsocks 代理路由流量。</p>

<h3 id="步骤-1配置-iptables-规则">步骤 1：配置 iptables 规则</h3>

<ol>
  <li>
    <p>添加 iptables 规则以重定向流量：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 将所有 TCP 流量重定向到 Redsocks（除了流向代理本身的流量）</span>
iptables <span class="nt">-t</span> nat <span class="nt">-N</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-d</span> xxx.xxx.xxx.xxx <span class="nt">-p</span> tcp <span class="nt">--dport</span> xxxxx <span class="nt">-j</span> RETURN
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-p</span> tcp <span class="nt">-j</span> REDIRECT <span class="nt">--to-ports</span> 12345

<span class="c"># 将 REDSOCKS 链应用于所有出站流量</span>
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> OUTPUT <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
</code></pre></div>    </div>

    <p>解释：</p>
    <ul>
      <li>创建新链： <code class="language-plaintext highlighter-rouge">REDSOCKS</code></li>
      <li>排除代理流量： 确保目的地为代理本身的流量不被重定向。</li>
      <li>重定向其他 TCP 流量： 将其他 TCP 流量转发到 Redsocks 的监听端口（<code class="language-plaintext highlighter-rouge">12345</code>）。</li>
    </ul>
  </li>
  <li>
    <p>保存 iptables 规则：</p>

    <p>为了使这些规则在重启后依然有效，将它们添加到防火墙配置中。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/firewall.user
</code></pre></div>    </div>

    <p>添加 iptables 规则：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 将所有 TCP 流量重定向到 Redsocks（除了代理）</span>
iptables <span class="nt">-t</span> nat <span class="nt">-N</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-d</span> xxx.xxx.xxx.xxx <span class="nt">-p</span> tcp <span class="nt">--dport</span> xxxxx <span class="nt">-j</span> RETURN
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-p</span> tcp <span class="nt">-j</span> REDIRECT <span class="nt">--to-ports</span> 12345

<span class="c"># 应用 REDSOCKS 链</span>
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> OUTPUT <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
</code></pre></div>    </div>

    <p>保存并退出：</p>
    <ul>
      <li>按 <code class="language-plaintext highlighter-rouge">ESC</code>，输入 <code class="language-plaintext highlighter-rouge">:wq</code>，然后按 <code class="language-plaintext highlighter-rouge">Enter</code>。</li>
    </ul>
  </li>
  <li>
    <p>重启防火墙以应用更改：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/firewall restart
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="步骤-2验证流量是否被重定向">步骤 2：验证流量是否被重定向</h3>

<ol>
  <li>
    <p>检查 Redsocks 日志：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /var/log/redsocks.log
</code></pre></div>    </div>

    <p>您应该会看到日志显示流量正在通过 Redsocks 处理。</p>
  </li>
  <li>
    <p>从客户端设备进行测试：</p>
    <ul>
      <li>连接设备到您的 OpenWRT 路由器。</li>
      <li>访问一个网站或执行一个使用互联网的操作。</li>
      <li>通过检查外部 IP 地址（例如通过 <a href="https://www.whatismyip.com/">WhatIsMyIP.com</a>）验证流量是否通过代理路由。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="6-测试代理设置">6. 测试代理设置</h2>

<p>通过执行以下测试，确保整个设置按预期工作。</p>

<h3 id="步骤-1验证-mac-上的-shadowsocks-连接">步骤 1：验证 Mac 上的 Shadowsocks 连接</h3>

<ol>
  <li>检查 Shadowsocks 客户端状态：
    <ul>
      <li>确保 Shadowsocks-NG 或 Clash 正在连接到 Shadowsocks 服务器。</li>
      <li>验证本地代理（例如 <code class="language-plaintext highlighter-rouge">xxx.xxx.xxx.xxx:xxxxx</code>）是否可访问。</li>
    </ul>
  </li>
  <li>在本地测试代理：
    <ul>
      <li>在您的 Mac 上，打开浏览器并将其配置为使用 <code class="language-plaintext highlighter-rouge">localhost:1080</code> 作为 SOCKS5 代理。</li>
      <li>访问 <a href="https://www.whatismyip.com/">WhatIsMyIP.com</a> 以确认 IP 是否与 Shadowsocks 服务器匹配。</li>
    </ul>
  </li>
</ol>

<h3 id="步骤-2验证-openwrt-的流量是否通过代理路由">步骤 2：验证 OpenWRT 的流量是否通过代理路由</h3>

<ol>
  <li>检查 OpenWRT 的外部 IP：
    <ul>
      <li>从连接到 OpenWRT 的设备访问 <a href="https://www.whatismyip.com/">WhatIsMyIP.com</a>，查看 IP 是否反映 Shadowsocks 服务器的 IP。</li>
    </ul>
  </li>
  <li>监控 Redsocks 日志：
    <ul>
      <li>在 OpenWRT 上，监控 Redsocks 日志以确保流量被重定向。</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tail</span> <span class="nt">-f</span> /var/log/redsocks.log
</code></pre></div>    </div>
  </li>
  <li>必要时进行故障排除：
    <ul>
      <li>如果流量未正确路由：
        <ul>
          <li>确保 Mac 上的 Shadowsocks 客户端正在运行并可访问。</li>
          <li>验证 iptables 规则是否正确设置。</li>
          <li>检查 Mac 和 OpenWRT 上的防火墙设置。</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="附加考虑事项">附加考虑事项</h2>

<h3 id="1-安全性">1. 安全性</h3>

<ul>
  <li>保护您的代理：
    <ul>
      <li>确保只有可信设备可以访问代理。由于您正在通过 Redsocks 重定向所有流量，请确保 Mac 的防火墙仅允许来自 OpenWRT 路由器的连接。</li>
    </ul>

    <p>在 macOS 上：</p>

    <ul>
      <li>进入 系统偏好设置 &gt; 安全性与隐私 &gt; 防火墙。</li>
      <li>配置防火墙，仅允许来自 OpenWRT 路由器 IP 的代理端口 (<code class="language-plaintext highlighter-rouge">xxxxx</code>) 的传入连接。</li>
    </ul>
  </li>
  <li>认证：
    <ul>
      <li>Shadowsocks 已通过加密提供了一定程度的安全性。确保使用强密码和加密方法。</li>
    </ul>
  </li>
</ul>

<h3 id="2-性能">2. 性能</h3>

<ul>
  <li>路由器资源：
    <ul>
      <li>运行像 Redsocks 这样的代理服务可能会消耗 OpenWRT 路由器的额外 CPU 和内存。确保您的路由器有足够的资源。</li>
    </ul>
  </li>
  <li>Mac 性能：
    <ul>
      <li>确保您的 Mac 保持开启并连接到网络，以维持代理的可用性。</li>
    </ul>
  </li>
</ul>

<h3 id="3-维护">3. 维护</h3>

<ul>
  <li>监控日志：
    <ul>
      <li>定期检查 Redsocks 和 Shadowsocks 的日志，以发现任何异常活动或错误。</li>
    </ul>
  </li>
  <li>更新软件：
    <ul>
      <li>保持 OpenWRT、Redsocks 以及您的 Shadowsocks 客户端更新，以受益于安全补丁和性能改进。</li>
    </ul>
  </li>
</ul>

<h3 id="4-替代方法">4. 替代方法</h3>

<p>虽然使用 Mac 作为中介代理服务器是可行的，但考虑以下替代方案可能会简化设置：</p>

<ul>
  <li>直接将 OpenWRT 配置为 Shadowsocks 客户端：
    <ul>
      <li>OpenWRT 通过 <code class="language-plaintext highlighter-rouge">shadowsocks-libev</code> 等软件包直接支持 Shadowsocks。这种方法无需 Mac 作为中介。</li>
    </ul>
  </li>
  <li>使用专用的代理/VPN 设备：
    <ul>
      <li>如 Raspberry Pi 等设备可以运行代理服务，作为专用网关使用。</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="结论">结论</h2>

<p>通过遵循上述步骤，您已将 Mac 设置为 Shadowsocks 代理服务器，并配置了 OpenWRT 路由器，通过此代理将所有连接设备的流量路由。此设置通过利用 Shadowsocks 协议，增强了您网络的隐私和控制。</p>

<p>关键点回顾：</p>

<ol>
  <li>Mac 上的 Shadowsocks 客户端：
    <ul>
      <li>使用您提供的 Shadowsocks URL 安装并配置了 Shadowsocks-NG 或 Clash。</li>
      <li>配置客户端监听 Mac 的局域网 IP。</li>
    </ul>
  </li>
  <li>代理可访问性：
    <ul>
      <li>为 Mac 分配了静态 IP，以确保代理访问的一致性。</li>
      <li>配置了 macOS 防火墙以允许传入的代理连接。</li>
    </ul>
  </li>
  <li>OpenWRT 配置：
    <ul>
      <li>安装并配置了 Redsocks，通过 Shadowsocks 代理重定向所有出站 TCP 流量。</li>
      <li>应用了必要的 iptables 规则以强制流量重定向。</li>
    </ul>
  </li>
  <li>测试：
    <ul>
      <li>通过检查外部 IP 地址验证了连接设备的流量通过 Shadowsocks 代理路由。</li>
    </ul>
  </li>
</ol>

<p>建议：</p>

<ul>
  <li>确保稳定性： 保持 Mac 开启并连接，以维持代理的可用性。</li>
  <li>安全优先： 定期更新所有组件并监控日志，以防止未经授权的访问。</li>
  <li>考虑直接路由器配置： 为了更简化的设置，探索直接在 OpenWRT 路由器上配置 Shadowsocks。</li>
</ul>

<p>如果您在配置过程中遇到任何问题或需要进一步的帮助，请随时联系我们！</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>base {
    log_debug = on;
    log_info = on;
    log = "file:/var/log/redsocks.log";
    daemon = on;
    redirector = generic;
}

redsocks {
    local_ip = 0.0.0.0;
    local_port = 7891;
    ip = xxx.xxx.xxx.xxx;
    port = xxxxx;
    type = http-connect;
    login = "";
    password = "";
}
</code></pre></div></div>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-zh" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
