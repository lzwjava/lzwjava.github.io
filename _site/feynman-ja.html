<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>mathjax2mobi：MathJax HTMLを電子書籍に変換</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>mathjax2mobi：MathJax HTMLを電子書籍に変換 | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="mathjax2mobi：MathJax HTMLを電子書籍に変換" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="ja" />
<meta name="description" content="プロジェクト概要" />
<meta property="og:description" content="プロジェクト概要" />
<link rel="canonical" href="https://lzwjava.github.io/feynman-ja" />
<meta property="og:url" content="https://lzwjava.github.io/feynman-ja" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-15T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="mathjax2mobi：MathJax HTMLを電子書籍に変換" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2021-03-15T00:00:00+08:00","datePublished":"2021-03-15T00:00:00+08:00","description":"プロジェクト概要","headline":"mathjax2mobi：MathJax HTMLを電子書籍に変換","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/feynman-ja"},"url":"https://lzwjava.github.io/feynman-ja"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=6d9a2842eb1f0ffa4c1100d6eb6f3b4d644d159b">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=6d9a2842eb1f0ffa4c1100d6eb6f3b4d644d159b" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       mathjax2mobi：MathJax HTMLを電子書籍に変換 | オリジナル、AI翻訳
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/ja/2021-03-15-feynman-ja.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsja2021-03-15-feynman-ja.md</span> -->
      

      <!-- <span>2021-03-15-feynman-ja.md</span> -->

      
        

        
          
          <a href="#" class="button">2021.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/feynman-en" >English</option>
        <option value="/feynman-zh" >中文</option>
        <option value="/feynman-ja" selected>日本語</option>
        <option value="/feynman-es" >Español</option>
        <option value="/feynman-hi" >हिंदी</option>
        <option value="/feynman-fr" >Français</option>
        <option value="/feynman-de" >Deutsch</option>
        <option value="/feynman-ar" >العربية</option>
        <option value="/feynman-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <h3 id="プロジェクト概要">プロジェクト概要</h3>

<p>まず、プロジェクトの概要について簡単に説明します。</p>

<p><img src="assets/images/feynman/feynman_online.jpg" alt="feynman_online" /></p>

<p><img src="/assets/images/feynman/change.JPG" alt="変化" style="zoom:50%;" /></p>

<p><img src="assets/images/feynman/latex.JPG" alt="latex" /></p>

<p><img src="assets/images/feynman/epub_black.JPG" alt="epub_black" /></p>

<p><img src="assets/images/feynman/epub_beautiful.JPG" alt="epub_beautiful" /></p>

<p>プロジェクトを終えて、少し嬉しい気持ちになりました。こんな言葉を書き留めました。</p>

<p>一日中コードを書いて、ついに美しいファインマン物理学講義の電子書籍を手に入れました！ファインマン物理学講義はオンラインで公開されており、<code class="language-plaintext highlighter-rouge">latex</code>でレンダリングされています。<code class="language-plaintext highlighter-rouge">latex</code>は論文を書くのによく使われ、数学の数式を美しくレンダリングします。オンラインで公開する際には、<code class="language-plaintext highlighter-rouge">mathjax</code>というライブラリが使われています。これは<code class="language-plaintext highlighter-rouge">latex</code>のソースコードを<code class="language-plaintext highlighter-rouge">html</code>コードに変換し、多くの<code class="language-plaintext highlighter-rouge">div</code>や<code class="language-plaintext highlighter-rouge">span</code>タグを生成します。しかし、電子書籍ではこの方法がサポートされていません。そこで、ウェブページをスクレイピングし、<code class="language-plaintext highlighter-rouge">mathjax</code>のレンダリングを逆にして、それを<code class="language-plaintext highlighter-rouge">svg</code>画像に置き換えるというアイデアを思いつきました。いくつかの問題が発生しました。一つは、ソースコードに多くの<code class="language-plaintext highlighter-rouge">latex</code>カスタムマクロがあり、それを追加する必要があったことです。もう一つは、多くの<code class="language-plaintext highlighter-rouge">svg</code>を埋め込むと問題が発生することです。単一の<code class="language-plaintext highlighter-rouge">svg</code>であれば問題ありませんが、多数の場合には問題が発生します。これはおそらくブラウザと<code class="language-plaintext highlighter-rouge">svg</code>の奇妙なバグによるものです。この場合、<code class="language-plaintext highlighter-rouge">svg</code>をファイルとして保存し、<code class="language-plaintext highlighter-rouge">img</code>タグで読み込むことで解決できます。数式には2種類あり、一つはテキスト中の数式、もう一つは単独の行の数式です。こうして、最終的に美しい電子書籍が完成しました！</p>

<h3 id="調査した資料">調査した資料</h3>

<p>ここでは、プロジェクトの過程でアクセスした資料を記録しています。これはチュートリアルであるため、学生にプロジェクトを進める際の体験を大まかに示しています。</p>

<p><img src="assets/images/feynman/s1.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s2.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s3.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s4.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s5.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s6.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s7.PNG" alt="" /></p>

<p><img src="assets/images/feynman/s8.PNG" alt="" /></p>

<h3 id="プロジェクトの開始">プロジェクトの開始</h3>

<p>ファインマン物理学講義は、すでにオンラインで公開されており、誰でも読むことができます。私はそれを<code class="language-plaintext highlighter-rouge">Kindle</code>で読みたいと思っています。しかし、多くの数学式が含まれているため、元の原稿はおそらく<code class="language-plaintext highlighter-rouge">latex</code>で作成されたものでしょう。ウェブページ上で<code class="language-plaintext highlighter-rouge">latex</code>形式の内容を表示するために、<code class="language-plaintext highlighter-rouge">mathjax</code>というライブラリが使用されています。</p>

<p>例えば、以下のような例を考えてみましょう。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax_Preview"</span> <span class="na">style=</span><span class="s">"color: inherit; display: none;"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"MathJax_Display"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax MathJax_FullWidth"</span> <span class="na">id=</span><span class="s">"MathJax-Element-10-Frame"</span> <span class="na">tabindex=</span><span class="s">"0"</span> <span class="na">style=</span><span class="s">""</span><span class="nt">&gt;</span>
              <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"mi"</span> <span class="na">id=</span><span class="s">"MathJax-Span-159"</span> <span class="na">style=</span><span class="s">"font-family: MathJax_Math-italic;"</span><span class="nt">&gt;</span>d<span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/span&gt;</span>  
    <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"math/tex; mode=display"</span> <span class="na">id=</span><span class="s">"MathJax-Element-10"</span><span class="nt">&gt;</span><span class="err">\</span><span class="nx">begin</span><span class="p">{</span><span class="nx">equation</span><span class="p">}</span>
<span class="err">\</span><span class="nx">label</span><span class="p">{</span><span class="nl">Eq</span><span class="p">:</span><span class="nl">I</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
<span class="nx">dT</span><span class="o">/</span><span class="nx">dt</span> <span class="o">=</span> <span class="nx">Fv</span><span class="p">.</span>
<span class="err">\</span><span class="nx">end</span><span class="p">{</span><span class="nx">equation</span><span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>上記のコードは、MathJaxを使用して数式を表示するためのHTMLとLaTeXの組み合わせです。数式は以下のように表示されます：</p>

<p>[
\begin{equation}
\label{Eq:I:13:3}
\frac{dT}{dt} = Fv.
\end{equation}
]</p>

<p>この数式は、時間に対する温度の変化率（( \frac{dT}{dt} )）が力（( F )）と速度（( v )）の積に等しいことを表しています。</p>

<p>以下は抜粋した<code class="language-plaintext highlighter-rouge">html</code>コードの一部です。この<code class="language-plaintext highlighter-rouge">html</code>コードのブロック内では、<code class="language-plaintext highlighter-rouge">script</code>タグの下に<code class="language-plaintext highlighter-rouge">latex</code>のテキストがそのまま記述されています。<code class="language-plaintext highlighter-rouge">mathjax</code>はこれを多くの<code class="language-plaintext highlighter-rouge">span</code>に変換して表示します。</p>

<p>現在、私たちには一つのアイデアがあります。それは、<code class="language-plaintext highlighter-rouge">mathjax</code>の表示方法を<code class="language-plaintext highlighter-rouge">svg</code>画像に変更することです。</p>

<p>GitHub で <code class="language-plaintext highlighter-rouge">tuxu/latex2svg</code> というプロジェクトを見つけました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">latex2svg</span> <span class="kn">import</span> <span class="n">latex2svg</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="sa">r</span><span class="s">'\( e^{i \pi} + 1 = 0 \)'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'depth'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
</code></pre></div></div>

<p>実行してみましたが、エラーが発生しました。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    raise RuntimeError<span class="o">(</span><span class="s1">'latexが見つかりません'</span><span class="o">)</span>
RuntimeError: latexが見つかりません
</code></pre></div></div>

<p>コードを見てみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># LaTeXを実行してDVIファイルを作成
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">'latex_cmd'</span><span class="p">]</span><span class="o">+</span><span class="s">' code.tex'</span><span class="p">),</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">working_directory</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">check_returncode</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'latexが見つかりません'</span><span class="p">)</span>
</code></pre></div></div>

<p>これも<code class="language-plaintext highlighter-rouge">latex</code>コマンドに依存していることがわかりました。</p>

<p>インストールしてみましょう。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install</span> <span class="nt">--cask</span> mactex
<span class="o">==&gt;</span> 注意事項
MacTex CLIツールのインストールを有効にするには、ターミナルウィンドウを再起動する必要があります。
または、BashおよびZshユーザーは次のコマンドを実行できます:
  <span class="nb">eval</span> <span class="s2">"</span><span class="si">$(</span>/usr/libexec/path_helper<span class="si">)</span><span class="s2">"</span>
<span class="o">==&gt;</span> http://mirror.ctan.org/systems/mac/mactex/mactex-20200407.pkg をダウンロード中
<span class="o">==&gt;</span> https://mirrors.aliyun.com/CTAN/systems/mac/mactex/mactex-20200407.pkg からダウンロード中
<span class="c">######################################################################## 100.0%</span>
すべての依存関係が満たされています。
<span class="o">==&gt;</span> Cask mactex をインストール中
<span class="o">==&gt;</span> mactex のインストーラーを実行中<span class="p">;</span> パスワードが必要な場合があります。
installer: パッケージ名は MacTeX です
installer: 選択変更ファイル <span class="s1">'/private/tmp/choices20210315-4643-5884ro.xml'</span> が適用されました
installer: ベースパス / にインストール中
installer: インストールは成功しました。
🍺  mactex は正常にインストールされました！
</code></pre></div></div>

<p>インストールが成功しました。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% latex
This is pdfTeX, Version 3.14159265-2.6-1.40.21 <span class="o">(</span>TeX Live 2020<span class="o">)</span> <span class="o">(</span>preloaded <span class="nv">format</span><span class="o">=</span>latex<span class="o">)</span>
 restricted <span class="se">\w</span>rite18 enabled.
<span class="k">**</span>
</code></pre></div></div>

<p>この出力は、LaTeXが使用しているpdfTeXエンジンのバージョン情報を示しています。具体的には、TeX Live 2020に含まれるpdfTeXのバージョン3.14159265-2.6-1.40.21が使用されており、<code class="language-plaintext highlighter-rouge">\write18</code>が制限付きで有効になっていることがわかります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="sa">r</span><span class="s">'\( e^{i \pi} + 1 = 0 \)'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'depth'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
</code></pre></div></div>

<p>このコードは、LaTeX形式の数式 <code class="language-plaintext highlighter-rouge">\( e^{i \pi} + 1 = 0 \)</code> をSVG画像に変換し、その結果の深さ（<code class="language-plaintext highlighter-rouge">depth</code>）とSVGデータ（<code class="language-plaintext highlighter-rouge">svg</code>）を出力します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">svg</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'1.svg'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">svg</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
<span class="n">svg</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">svg</code>を生成できるようになりました。</p>

<p>そこで、<code class="language-plaintext highlighter-rouge">mathjax</code>から得られる<code class="language-plaintext highlighter-rouge">latex</code>テキストをすべて生成してみることにしました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">latex2svg</span> <span class="kn">import</span> <span class="n">latex2svg</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html'</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex'</span><span class="p">})</span>
<span class="k">for</span> <span class="n">mathjax</span> <span class="ow">in</span> <span class="n">mathjaxs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
</code></pre></div></div>

<p>残念ながらエラーが発生しました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">raise</span> <span class="n">CalledProcessError</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span>
<span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span><span class="p">:</span> <span class="n">コマンド</span> <span class="s">'['</span><span class="n">latex</span><span class="s">', '</span><span class="o">-</span><span class="n">interaction</span><span class="s">', '</span><span class="n">nonstopmode</span><span class="s">', '</span><span class="o">-</span><span class="n">halt</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">error</span><span class="s">', '</span><span class="n">code</span><span class="p">.</span><span class="n">tex</span><span class="s">']'</span> <span class="n">がゼロ以外の終了ステータス</span> <span class="mi">1</span> <span class="n">を返しました</span><span class="err">。</span>
</code></pre></div></div>

<p>具体的にどの式が間違っているのでしょうか。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\tfrac</span><span class="p">{</span>1<span class="p">}{</span>2<span class="p">}</span>mv<span class="p">^</span>2
</code></pre></div></div>

<p>このLaTeXコードは、運動エネルギーを表す式を分数形式で表示するものです。<code class="language-plaintext highlighter-rouge">\tfrac</code>は、分数を小さなサイズで表示するためのコマンドです。この式は、質量(m)と速度(v)の2乗に比例する運動エネルギーを表しています。</p>

<h2 id="latex">LaTeX</h2>

<p>LaTeX（ラテック、レイテック、ラテフ）は、文書作成システムの一つで、特に数式や学術論文の作成に適しています。LaTeXは、プレーンテキスト形式で文書を作成し、それをコンパイルすることで高品質のPDFやその他の形式の文書を生成します。以下は、LaTeXの基本的な使用例です。</p>

<h3 id="基本的なlatex文書の例">基本的なLaTeX文書の例</h3>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="p">{</span>article<span class="p">}</span>
<span class="k">\usepackage</span><span class="na">[utf8]</span><span class="p">{</span>inputenc<span class="p">}</span>

<span class="k">\title</span><span class="p">{</span>LaTeXの基本<span class="p">}</span>
<span class="k">\author</span><span class="p">{</span>著者名<span class="p">}</span>
<span class="k">\date</span><span class="p">{</span><span class="k">\today</span><span class="p">}</span>

<span class="nt">\begin{document}</span>

<span class="k">\maketitle</span>

<span class="k">\section</span><span class="p">{</span>はじめに<span class="p">}</span>
これはLaTeXの基本的な文書です。LaTeXを使うと、数式や表、図を簡単に挿入できます。

<span class="k">\section</span><span class="p">{</span>数式の例<span class="p">}</span>
LaTeXでは、数式を美しく表示できます。例えば、二次方程式の解は次のように表されます。

<span class="p">\[</span><span class="nb">
x </span><span class="o">=</span><span class="nb"> </span><span class="nv">\frac</span><span class="p">{</span><span class="o">-</span><span class="nb">b </span><span class="nv">\pm</span><span class="nb"> </span><span class="nv">\sqrt</span><span class="p">{</span><span class="nb">b</span><span class="p">^</span><span class="m">2</span><span class="nb"> </span><span class="o">-</span><span class="nb"> </span><span class="m">4</span><span class="nb">ac</span><span class="p">}}{</span><span class="m">2</span><span class="nb">a</span><span class="p">}</span><span class="nb">
</span><span class="p">\]</span>

<span class="k">\section</span><span class="p">{</span>おわりに<span class="p">}</span>
LaTeXは、学術文書や技術文書の作成に非常に強力なツールです。ぜひ活用してみてください。

<span class="nt">\end{document}</span>
</code></pre></div></div>

<h3 id="コンパイル方法">コンパイル方法</h3>

<p>上記のLaTeX文書をコンパイルするには、以下の手順を実行します。</p>

<ol>
  <li>テキストエディタで<code class="language-plaintext highlighter-rouge">.tex</code>ファイルを作成し、上記のコードを保存します。</li>
  <li>
    <p>ターミナルまたはコマンドプロンプトで、以下のコマンドを実行します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdflatex example.tex
</code></pre></div>    </div>
  </li>
  <li>これにより、<code class="language-plaintext highlighter-rouge">example.pdf</code>という名前のPDFファイルが生成されます。</li>
</ol>

<h3 id="参考資料">参考資料</h3>

<ul>
  <li><a href="https://www.latex-project.org/">LaTeXプロジェクト</a></li>
  <li><a href="https://www.overleaf.com/">Overleaf</a> - オンラインLaTeXエディタ</li>
</ul>

<p>LaTeXは、初めて使う人には少し難しいかもしれませんが、一度慣れるとその強力な機能を活用できるようになります。ぜひ挑戦してみてください！</p>

<p><code class="language-plaintext highlighter-rouge">latex</code>を学びましょう。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="na">[12pt]</span><span class="p">{</span>article<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>lingmacros<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>tree-dvips<span class="p">}</span>
<span class="nt">\begin{document}</span>
</code></pre></div></div>

<p>\section*{私の論文に関するメモ}</p>

<p>トピック化の例を含めることを忘れないでください。
以下のようになります：</p>

<p>{\small
\enumsentence{文主語からの主題化：\ 
\shortex{7}{a John$_i$ [a &amp; kltukl &amp; [el &amp; 
  {\bf l-}oltoir &amp; er &amp; ngii$_i$ &amp; a Mary]]}
{ &amp; {\bf R-}clear &amp; {\sc comp} &amp; 
  {\bf IR}.{\sc 3s}-愛する   &amp; P &amp; 彼を &amp; }
{John, (それは) Maryが(彼を)愛していることが明らかだ。}}
}</p>

<p>\subsection*{トピック化の扱い方}</p>

<p>私は以下のような木構造（\ex{1}）を仮定します。</p>

<p>{\small
\enumsentence{A$’$ 投射の構造:\ [2ex]
\begin{tabular}[t]{cccc}
    &amp; \node{i}{CP}\ [2ex]
    \node{ii}{Spec} &amp;   &amp;\node{iii}{C$’$}\ [2ex]
        &amp;\node{iv}{C} &amp; &amp; \node{v}{SAgrP}
\end{tabular}
\nodeconnect{i}{ii}
\nodeconnect{i}{iii}
\nodeconnect{iii}{iv}
\nodeconnect{iii}{v}
}
}</p>

<p>\subsection*{ムード}</p>

<p>話題がある場合やWH移動がある場合に、ムードが変化します。非主語の話題やComp内のWH句があるときのムードは\emph{非現実形}（Irrealis）です。主語の話題やWH句があるときのムードは\emph{現実形}（Realis）です。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\end{document}</span>
</code></pre></div></div>

<p>オンラインで見つけた<code class="language-plaintext highlighter-rouge">latex</code>のサンプルソースコードです。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% latex code.tex
This is pdfTeX, Version 3.14159265-2.6-1.40.21 <span class="o">(</span>TeX Live 2020<span class="o">)</span> <span class="o">(</span>preloaded <span class="nv">format</span><span class="o">=</span>latex<span class="o">)</span>
 restricted <span class="se">\w</span>rite18 enabled.
entering extended mode
<span class="o">(</span>./code.tex
LaTeX2e &lt;2020-02-02&gt; patch level 5
L3 programming layer &lt;2020-03-06&gt;
<span class="o">(</span>/usr/local/texlive/2020/texmf-dist/tex/latex/base/article.cls
Document Class: article 2019/12/20 v1.4l Standard LaTeX document class
<span class="o">(</span>/usr/local/texlive/2020/texmf-dist/tex/latex/base/size12.clo<span class="o">))</span>
<span class="o">(</span>/usr/local/texlive/2020/texmf-dist/tex/latex/tree-dvips/lingmacros.sty<span class="o">)</span>
<span class="o">(</span>/usr/local/texlive/2020/texmf-dist/tex/latex/tree-dvips/tree-dvips.sty
tree-dvips version .91 of May 16, 1995
<span class="o">)</span> <span class="o">(</span>/usr/local/texlive/2020/texmf-dist/tex/latex/l3backend/l3backend-dvips.def<span class="o">)</span>
<span class="o">(</span>./code.aux<span class="o">)</span> <span class="o">[</span>1] <span class="o">(</span>./code.aux<span class="o">)</span> <span class="o">)</span>
Output written on code.dvi <span class="o">(</span>1 page, 3416 bytes<span class="o">)</span><span class="nb">.</span>
Transcript written on code.log.
</code></pre></div></div>

<p><img src="assets/images/feynman/latex.png" alt="latex" /></p>

<p>ソースコードとレンダリング後の結果を見比べて、何が学べるか見てみましょう。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<p>このようにしてドキュメントをラップします。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\section*</span><span class="p">{</span>私の論文のためのメモ<span class="p">}</span>
</code></pre></div></div>

<p>これは<code class="language-plaintext highlighter-rouge">section</code>の見出しの始まりを示しています。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\subsection*</span><span class="p">{</span>トピック化の扱い方<span class="p">}</span>
</code></pre></div></div>

<p>これはサブタイトルを表します。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\shortex</span><span class="p">{</span>7<span class="p">}{</span>a John<span class="p">$_</span><span class="nb">i</span><span class="p">$</span> [a <span class="p">&amp;</span> kltukl <span class="p">&amp;</span> [el <span class="p">&amp;</span> 
  <span class="p">{</span><span class="k">\bf</span> l-<span class="p">}</span>oltoir <span class="p">&amp;</span> er <span class="p">&amp;</span> ngii<span class="p">$_</span><span class="nb">i</span><span class="p">$</span> <span class="p">&amp;</span> a Mary]]<span class="p">}</span>
</code></pre></div></div>

<p>このコードは、構文解析や言語学の研究で使用される例文を示しています。具体的には、JohnとMaryの関係を表す構造を表しています。コード内の記号やラベルは、特定の文法規則や関係を示すために使用されています。</p>

<p><img src="assets/images/feynman/shortex.png" alt="shortex" /></p>

<p><code class="language-plaintext highlighter-rouge">$_i$</code> は下付き文字を表すために使用されます。<code class="language-plaintext highlighter-rouge">{\bf l-}</code> は太字を表すために使用されます。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\enumsentence</span><span class="p">{</span>A<span class="p">$</span><span class="nb">'</span><span class="p">$</span> 投射の構造:<span class="k">\\</span> [2ex]
<span class="nt">\begin{tabular}</span>[t]<span class="p">{</span>cccc<span class="p">}</span>
    <span class="p">&amp;</span> <span class="k">\node</span><span class="p">{</span>i<span class="p">}{</span>CP<span class="p">}</span><span class="k">\\</span> [2ex]
    <span class="k">\node</span><span class="p">{</span>ii<span class="p">}{</span>Spec<span class="p">}</span> <span class="p">&amp;</span>   <span class="p">&amp;</span><span class="k">\node</span><span class="p">{</span>iii<span class="p">}{</span>C<span class="p">$</span><span class="nb">'</span><span class="p">$}</span><span class="k">\\</span> [2ex]
        <span class="p">&amp;</span><span class="k">\node</span><span class="p">{</span>iv<span class="p">}{</span>C<span class="p">}</span> <span class="p">&amp;</span> <span class="p">&amp;</span> <span class="k">\node</span><span class="p">{</span>v<span class="p">}{</span>SAgrP<span class="p">}</span>
<span class="nt">\end{tabular}</span>
<span class="k">\nodeconnect</span><span class="p">{</span>i<span class="p">}{</span>ii<span class="p">}</span>
<span class="k">\nodeconnect</span><span class="p">{</span>i<span class="p">}{</span>iii<span class="p">}</span>
<span class="k">\nodeconnect</span><span class="p">{</span>iii<span class="p">}{</span>iv<span class="p">}</span>
<span class="k">\nodeconnect</span><span class="p">{</span>iii<span class="p">}{</span>v<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/images/feynman/node.png" alt="node" style="zoom:50%;" /></p>

<p><code class="language-plaintext highlighter-rouge">nodeconnect</code> が接続を表すことに注意してください。</p>

<h3 id="latex-を-svg-に変換する">LaTeX を SVG に変換する</h3>

<p>プロジェクトを続けます。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="na">[16pt]</span><span class="p">{</span>article<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsmath<span class="p">}</span>
<span class="nt">\begin{document}</span>
</code></pre></div></div>

<p>[\tfrac{1}{2}mv^2]</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\end{document}</span>
</code></pre></div></div>

<p><img src="/assets/images/feynman/frac.png" alt="frac" style="zoom:50%;" /></p>

<p>これにより、正しくレンダリングされます。コード内でレンダリングされないのは、<code class="language-plaintext highlighter-rouge">\usepackage{amsmath}</code>が追加されていないためかもしれません。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="na">[12pt,preview]</span><span class="p">{</span>standalone<span class="p">}</span>
</code></pre></div></div>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\usepackage</span><span class="na">[utf8x]</span><span class="p">{</span>inputenc<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsmath<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsfonts<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amssymb<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>newtxtext<span class="p">}</span>
<span class="k">\usepackage</span><span class="na">[libertine]</span><span class="p">{</span>newtxmath<span class="p">}</span>
</code></pre></div></div>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\begin{preview}</span>
<span class="k">\tfrac</span><span class="p">{</span>1<span class="p">}{</span>2<span class="p">}</span>mv<span class="p">^</span>2
<span class="nt">\end{preview}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span> <span class="nv">$ </span>が不足しています。
&lt;挿入されたテキスト&gt;
                <span class="err">$</span>
l.12 <span class="se">\t</span>frac<span class="o">{</span>1<span class="o">}{</span>2<span class="o">}</span>
                 <span class="nb">mv</span>^2
</code></pre></div></div>

<p>このようにするとエラーが発生します。以下のように変更すればうまくいきます。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">\[</span><span class="nv">\tfrac</span><span class="p">{</span><span class="m">1</span><span class="p">}{</span><span class="m">2</span><span class="p">}</span><span class="nb">mv</span><span class="p">^</span><span class="m">2</span><span class="p">\]</span>
</code></pre></div></div>

<p>このLaTeXコードは、運動エネルギーを表す数式を表示するものです。具体的には、質量 ( m ) と速度 ( v ) の物体の運動エネルギーを計算する式です。数式は以下のように表示されます：</p>

<p>[
\tfrac{1}{2}mv^2
]</p>

<p>この式は、物体の運動エネルギーが質量と速度の二乗に比例することを示しています。</p>

<p>さまざまな試行錯誤を行います。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">latex2svg</span> <span class="kn">import</span> <span class="n">latex2svg</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html'</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex'</span><span class="p">})</span>
<span class="k">for</span> <span class="n">mathjax</span> <span class="ow">in</span> <span class="n">mathjaxs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">)</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="s">'$'</span> <span class="o">+</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">'$'</span>
    <span class="c1"># if 'frac' in mathjax.string:
</span>    <span class="c1">#     wrap = '$' + mathjax.string + '$'
</span>    <span class="k">if</span> <span class="s">'FLP'</span> <span class="ow">in</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="s">'Fig'</span> <span class="ow">in</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="s">'eps'</span> <span class="ow">in</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="n">wrap</span><span class="p">)</span>
    <span class="c1"># print(out)
</span>    <span class="n">node</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">],</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
    <span class="n">svg</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'svg'</span><span class="p">)</span>
    <span class="n">mathjax</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">svg</span><span class="p">)</span>
    <span class="c1"># print(out['svg'])
</span>    <span class="c1"># break
</span>    <span class="c1"># mathjax.replaceWith(out['svg'])    
</span>    
    <span class="c1"># print(dir(mathjax))
</span>    <span class="c1"># break
</span>    
    <span class="c1"># out = latex2svg(wrap)    
</span>    <span class="c1"># print(out['svg'])
</span></code></pre></div></div>

<p>このコードは、HTML内のMathJax形式の数式をSVGに変換して挿入する処理を行っています。以下に日本語で説明します。</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">soup.findAll('script', {'type': 'math/tex'})</code> で、HTML内のMathJax形式の数式をすべて取得します。</li>
  <li>各数式に対して、以下の処理を行います：
    <ul>
      <li>数式の文字列を表示します。</li>
      <li>数式の前後に <code class="language-plaintext highlighter-rouge">$</code> を追加して、LaTeX形式の数式を作成します。</li>
      <li>数式に特定の文字列（’FLP’、’Fig’、’eps’）が含まれている場合、その数式はスキップします。</li>
      <li><code class="language-plaintext highlighter-rouge">latex2svg</code> 関数を使用して、LaTeX形式の数式をSVGに変換します。</li>
      <li>変換されたSVGをBeautifulSoupで解析し、<code class="language-plaintext highlighter-rouge">svg</code> タグを取得します。</li>
      <li>元のMathJax数式の後に、変換されたSVGを挿入します。</li>
    </ul>
  </li>
</ol>

<p>このコードは、MathJax形式の数式をSVGに変換してHTMLに挿入するためのものです。コメントアウトされた部分は、デバッグや追加の処理を行うためのもので、現在は無効化されています。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># print(len(soup.contents))
</span>    
<span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'out.html'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">output_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">prettify</span><span class="p">())</span>
<span class="n">output_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># print(soup.contents)
</span></code></pre></div></div>

<p>上記のコードは、BeautifulSoupオブジェクト<code class="language-plaintext highlighter-rouge">soup</code>の内容を整形してHTMLファイルとして保存するものです。各ステップの説明は以下の通りです：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">print(len(soup.contents))</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">soup.contents</code>は、<code class="language-plaintext highlighter-rouge">soup</code>オブジェクトの直接の子要素をリストとして返します。この行はそのリストの長さ（要素数）を出力しますが、コメントアウトされているため実行されません。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">output_file = open('out.html', 'w')</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">out.html</code>という名前のファイルを書き込みモードで開きます。ファイルが存在しない場合は新規作成され、存在する場合は上書きされます。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">output_file.write(soup.prettify())</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">soup.prettify()</code>は、<code class="language-plaintext highlighter-rouge">soup</code>オブジェクトの内容を整形（インデントなどで見やすく）した文字列を返します。この整形されたHTMLを<code class="language-plaintext highlighter-rouge">out.html</code>ファイルに書き込みます。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">output_file.close()</code>
    <ul>
      <li>ファイルを閉じ、変更を保存します。</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">print(soup.contents)</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">soup.contents</code>の内容を出力しますが、こちらもコメントアウトされているため実行されません。</li>
    </ul>
  </li>
</ol>

<p>このコードは、BeautifulSoupで解析したHTMLを整形してファイルに保存する際に使用されます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="sa">r</span><span class="s">'\( e^{i \pi} + 1 = 0 \)'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'depth'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># svg = open('1.svg', 'w')
# svg.write(out['svg'])
# svg.close()
</span></code></pre></div></div>

<p>このコードは、PythonでSVGファイルを書き込むための基本的な操作を示しています。以下に日本語で説明します。</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">open('1.svg', 'w')</code>：<code class="language-plaintext highlighter-rouge">1.svg</code>という名前のファイルを書き込みモード（<code class="language-plaintext highlighter-rouge">'w'</code>）で開きます。このファイルが存在しない場合は新しく作成され、存在する場合は上書きされます。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">svg.write(out['svg'])</code>：<code class="language-plaintext highlighter-rouge">out['svg']</code>に含まれるSVGデータをファイルに書き込みます。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">svg.close()</code>：ファイルを閉じます。これにより、ファイルへの変更が保存され、リソースが解放されます。</p>
  </li>
</ol>

<p>このコードは、SVGデータをファイルに保存するための基本的な方法を示していますが、通常は<code class="language-plaintext highlighter-rouge">with</code>ステートメントを使用してファイルを開くことが推奨されます。これにより、ファイルが自動的に閉じられるため、リソースの管理が容易になります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'1.svg'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">svg</span><span class="p">:</span>
    <span class="n">svg</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
</code></pre></div></div>

<p>この方法を使うと、ファイルのクローズを明示的に行う必要がなく、コードが簡潔になります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
これらは私が何を探っているのでしょうか。

```python
    if 'FLP' in mathjax.string:
        continue
    elif 'Fig' in mathjax.string:
        continue
    elif 'eps' in mathjax.string:
        continue
</code></pre></div></div>

<p>このコードブロックは、<code class="language-plaintext highlighter-rouge">mathjax.string</code>に特定の文字列が含まれているかどうかをチェックし、含まれている場合は処理をスキップするための条件分岐です。具体的には、<code class="language-plaintext highlighter-rouge">'FLP'</code>、<code class="language-plaintext highlighter-rouge">'Fig'</code>、<code class="language-plaintext highlighter-rouge">'eps'</code>のいずれかが<code class="language-plaintext highlighter-rouge">mathjax.string</code>に含まれている場合、<code class="language-plaintext highlighter-rouge">continue</code>文が実行され、その後の処理がスキップされます。</p>

<p>ここで、<code class="language-plaintext highlighter-rouge">latex</code>ソースコードに<code class="language-plaintext highlighter-rouge">FLP</code>、<code class="language-plaintext highlighter-rouge">Fig</code>、<code class="language-plaintext highlighter-rouge">eps</code>が含まれている場合、変換プロセスでエラーが発生しました。</p>

<p>例えば、<code class="language-plaintext highlighter-rouge">HTML</code>には次のようなスクリプトがあります：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"math/tex"</span> <span class="na">id=</span><span class="s">"MathJax-Element-11"</span><span class="nt">&gt;</span><span class="err">\</span><span class="nx">FLPF</span><span class="err">\</span><span class="nx">cdot</span><span class="err">\</span><span class="nx">FLPv</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>このコードブロックは、MathJaxを使用して数式を表示するためのHTMLスクリプトです。具体的には、ベクトル (\FLPF) と (\FLPv) のドット積を表しています。この部分は数式の表示に関わるもので、翻訳の必要はありません。そのまま保持します。</p>

<p>解析結果を取得：</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\FLPF\cdot\FLPv</span>
</code></pre></div></div>

<p>このLaTeXコードは、ベクトル (\FLPF) とベクトル (\FLPv) のドット積（内積）を表しています。具体的には、(\FLPF) と (\FLPv) の各成分を掛け合わせたものを足し合わせた値です。この式は物理学や工学などでよく使われる表現です。</p>

<p>コード内で変換する際にエラーが発生しました。つまり、<code class="language-plaintext highlighter-rouge">latex2svg.py</code>がエラーを出しました。ここでは<code class="language-plaintext highlighter-rouge">latex</code>プログラムを使用して変換を行います。</p>

<p><code class="language-plaintext highlighter-rouge">code.tex</code>:</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="na">[12pt,preview]</span><span class="p">{</span>standalone<span class="p">}</span>
</code></pre></div></div>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\usepackage</span><span class="na">[utf8x]</span><span class="p">{</span>inputenc<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsmath<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsfonts<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amssymb<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>newtxtext<span class="p">}</span>
<span class="k">\usepackage</span><span class="na">[libertine]</span><span class="p">{</span>newtxmath<span class="p">}</span>
</code></pre></div></div>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\begin{preview}</span>
<span class="nt">\begin{equation}</span>
    <span class="k">\FLPF\cdot\FLPv</span>
<span class="nt">\end{equation}</span>
<span class="nt">\end{preview}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<p>上記のLaTeXコードは、数式環境内でベクトル (\FLPF) と (\FLPv) のドット積を表しています。このコードはそのまま日本語の文書に挿入しても問題ありませんが、もし文脈に応じて説明を加える必要がある場合は、以下のようにコメントを追加することができます。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\begin{preview}</span>
<span class="nt">\begin{equation}</span>
    <span class="k">\FLPF\cdot\FLPv</span>  <span class="c">% ベクトル \(\FLPF\) と \(\FLPv\) のドット積</span>
<span class="nt">\end{equation}</span>
<span class="nt">\end{preview}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<p>このように、数式の意味を日本語でコメントとして記述することで、文書の読者が理解しやすくなります。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$latex</span> code.tex
<span class="o">!</span> 未定義の制御シーケンスです。
l.13     <span class="se">\F</span>LPF
              <span class="se">\c</span>dot<span class="se">\F</span>LPv
?
</code></pre></div></div>

<p>これは一体何の問題なのか。後になって、<code class="language-plaintext highlighter-rouge">html</code>の中のこのコードに気づきました。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/x-mathjax-config;executed=true"</span><span class="nt">&gt;</span>
      <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
        <span class="na">TeX</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">Macros</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">FLPvec</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">boldsymbol{#1}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
            <span class="na">Figvec</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">mathbf{#1}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
            <span class="na">FLPC</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{C}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPF</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{F}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPa</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{a}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPb</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{b}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPr</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{r}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPs</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{s}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FLPv</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">FLPvec{v}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">ddt</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">frac{d#1}{d#2}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> 
            <span class="na">epsO</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">epsilon_0</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="na">FigC</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="se">\\</span><span class="s2">Figvec{C}</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>これは、ウェブページがレンダリングされるときに、<code class="language-plaintext highlighter-rouge">MathJax</code>にマクロが設定されていることを示しています。したがって、私たちの<code class="language-plaintext highlighter-rouge">latex</code>変換ソースコードにもそれらを追加する必要があります。それらを追加しましょう。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\documentclass</span><span class="na">[12pt,preview]</span><span class="p">{</span>standalone<span class="p">}</span>
</code></pre></div></div>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\usepackage</span><span class="na">[utf8x]</span><span class="p">{</span>inputenc<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsmath<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amsfonts<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>amssymb<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>newtxtext<span class="p">}</span>
<span class="k">\usepackage</span><span class="na">[libertine]</span><span class="p">{</span>newtxmath<span class="p">}</span>
</code></pre></div></div>

<p>\newcommand{\FLPvec}[1]{\boldsymbol{#1}}
\newcommand{\Figvec}[1]{\mathbf{#1}}
\newcommand{\FLPC}{\FLPvec{C}}
\newcommand{\FLPF}{\FLPvec{F}}
\newcommand{\FLPa}{\FLPvec{a}}
\newcommand{\FLPb}{\FLPvec{a}}
\newcommand{\FLPr}{\FLPvec{r}}
\newcommand{\FLPs}{\FLPvec{s}}
\newcommand{\FLPv}{\FLPvec{v}}
\newcommand{\ddt}[2]{\frac{d#1}{d#2}}
\newcommand{\epsO}{\epsilon_0}
\newcommand{\FigC}{\Figvec{C}}
\begin{document}
\begin{preview}
\begin{equation}
    \FLPF\cdot\FLPv
\end{equation}
\end{preview}
\end{document}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
このコードは、LaTeXの数式環境でベクトル表記を行うためのマクロ定義と、そのマクロを使用した数式の例を示しています。具体的には、ベクトルを表すためのコマンド `\FLPvec` と `\Figvec` を定義し、それらを使用して力ベクトル `\FLPF` と速度ベクトル `\FLPv` の内積を表す数式を記述しています。

これで正解です。

![fv1](assets/images/feynman/fv1.png)

### コードの分析

最後のコードを見てみましょう。

```python
import subprocess
from bs4 import BeautifulSoup
from latex2svg import latex2svg
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
    <span class="n">previews</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s">'class'</span><span class="p">:</span> <span class="n">cls</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">preview</span> <span class="ow">in</span> <span class="n">previews</span><span class="p">:</span>
        <span class="n">preview</span><span class="p">.</span><span class="n">decompose</span><span class="p">()</span>
        
<span class="k">def</span> <span class="nf">clean_script</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
    <span class="n">scripts</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
        <span class="n">s</span><span class="p">.</span><span class="n">decompose</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、指定されたHTML要素を削除するための関数を定義しています。<code class="language-plaintext highlighter-rouge">clean_mathjax</code>関数は、指定されたクラス名を持つ特定の要素を削除し、<code class="language-plaintext highlighter-rouge">clean_script</code>関数は、すべての<code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>タグを削除します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">wrap_latex</span><span class="p">(</span><span class="n">mathjax</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="s">'$'</span> <span class="o">+</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">'$'</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'label'</span><span class="p">,</span> <span class="s">'tag'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrap</span>
 
<span class="k">def</span> <span class="nf">wrap_svg</span><span class="p">(</span><span class="n">svg</span><span class="p">,</span> <span class="n">equation</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="sa">f</span><span class="s">'&lt;div style="text-align:center;"&gt;&lt;/div&gt;'</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">div</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">svg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">div</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">svg</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">to_svg</span><span class="p">(</span><span class="n">mathjaxs</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">svg_prefix</span> <span class="o">=</span> <span class="s">'eq_'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">svg_prefix</span> <span class="o">=</span> <span class="s">'in_'</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">mathjax</span> <span class="ow">in</span> <span class="n">mathjaxs</span><span class="p">:</span>     
        <span class="k">print</span><span class="p">(</span><span class="n">mathjax</span><span class="p">.</span><span class="n">string</span><span class="p">)</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="n">wrap_latex</span><span class="p">(</span><span class="n">mathjax</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="n">equation</span><span class="p">)</span>   
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="n">wrap</span><span class="p">)</span>   
        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>      
            
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">'svgs/</span><span class="si">{</span><span class="n">svg_prefix</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s">.svg'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s">'svg'</span><span class="p">])</span>
        <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">node</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s">'&lt;img&gt;'</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'img'</span><span class="p">)</span>
        <span class="n">img</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">'src'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'./svgs/</span><span class="si">{</span><span class="n">svg_prefix</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s">.svg'</span>
        <span class="n">img</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'vertical-align: middle; margin: 0.5em 0;'</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">wrap_svg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">equation</span><span class="p">)</span>
        <span class="n">mathjax</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>    
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html'</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
    <span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'span'</span><span class="p">,</span> <span class="s">'MathJax'</span><span class="p">)</span>
    <span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'div'</span><span class="p">,</span> <span class="s">'MathJax_Display'</span><span class="p">)</span>
    <span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'span'</span><span class="p">,</span> <span class="s">'MathJax_Preview'</span><span class="p">)</span>
    
    <span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex'</span><span class="p">})</span>
    <span class="n">to_svg</span><span class="p">(</span><span class="n">mathjaxs</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex; mode=display'</span><span class="p">})</span>   
    <span class="n">to_svg</span><span class="p">(</span><span class="n">mathjaxs</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">clean_script</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
    
    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'out.html'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">output_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">prettify</span><span class="p">())</span>
    <span class="n">output_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>    
</code></pre></div></div>

<p>このコードは、HTMLファイルを読み込み、MathJaxを使用して数式をSVGに変換し、不要なスクリプトを削除して、最終的にクリーンなHTMLファイルを出力するものです。</p>

<p>main()</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
電子書籍全体を変換したい場合、まず1ページで試してみることができます。

```python
    file = open('The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html')
    content = file.read()
</code></pre></div></div>

<p>ここでは、ページをダウンロードしました。</p>

<p><code class="language-plaintext highlighter-rouge">MathJax</code>は多くの<code class="language-plaintext highlighter-rouge">div</code>と<code class="language-plaintext highlighter-rouge">span</code>を生成します。例えば、<code class="language-plaintext highlighter-rouge">T+U=const</code>という式をMathJaxはこのように生成します。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax"</span><span class="nt">&gt;</span>T<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax"</span><span class="nt">&gt;</span>+<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax"</span><span class="nt">&gt;</span>U<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax"</span><span class="nt">&gt;</span>=<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"MathJax"</span><span class="nt">&gt;</span>const<span class="nt">&lt;/span&gt;</span>
</code></pre></div></div>

<p>このHTMLコードは、MathJaxを使用して数式を表示するためのものです。具体的には、<code class="language-plaintext highlighter-rouge">T + U = const</code> という数式を表しています。各文字や記号は<code class="language-plaintext highlighter-rouge">&lt;span&gt;</code>タグで囲まれ、<code class="language-plaintext highlighter-rouge">class="MathJax"</code>が指定されています。これにより、MathJaxがこれらの要素を数式としてレンダリングします。</p>

<p>これらは非常に煩わしく、私たちのテキストにも影響を与えます。すでに<code class="language-plaintext highlighter-rouge">svg</code>があるため、これらは不要です。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
    <span class="n">previews</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s">'class'</span><span class="p">:</span> <span class="n">cls</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">preview</span> <span class="ow">in</span> <span class="n">previews</span><span class="p">:</span>
        <span class="n">preview</span><span class="p">.</span><span class="n">decompose</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、指定されたHTML要素（<code class="language-plaintext highlighter-rouge">name</code>）とクラス（<code class="language-plaintext highlighter-rouge">cls</code>）を持つすべての要素を削除する関数です。<code class="language-plaintext highlighter-rouge">soup</code>はBeautifulSoupオブジェクトで、HTMLドキュメントを解析した結果を表します。<code class="language-plaintext highlighter-rouge">findAll</code>メソッドを使って、指定された条件に一致するすべての要素を見つけ、<code class="language-plaintext highlighter-rouge">decompose</code>メソッドを使ってそれらを削除します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'span'</span><span class="p">,</span> <span class="s">'MathJax'</span><span class="p">)</span>
<span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'div'</span><span class="p">,</span> <span class="s">'MathJax_Display'</span><span class="p">)</span>
<span class="n">clean_mathjax</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="s">'span'</span><span class="p">,</span> <span class="s">'MathJax_Preview'</span><span class="p">)</span>
</code></pre></div></div>

<p>それらをすべて削除します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex'</span><span class="p">})</span>
    <span class="n">to_svg</span><span class="p">(</span><span class="n">mathjaxs</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">mathjaxs</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">,</span> <span class="p">{</span><span class="s">'type'</span><span class="p">:</span> <span class="s">'math/tex; mode=display'</span><span class="p">})</span>   
    <span class="n">to_svg</span><span class="p">(</span><span class="n">mathjaxs</span><span class="p">,</span> <span class="n">equation</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>上記のコードは、HTMLドキュメント内のMathJaxスクリプトを検索し、それらをSVG形式に変換するためのものです。最初の部分では、<code class="language-plaintext highlighter-rouge">math/tex</code>タイプのスクリプトを検索し、<code class="language-plaintext highlighter-rouge">to_svg</code>関数を使用してインライン数式としてSVGに変換します。次の部分では、<code class="language-plaintext highlighter-rouge">math/tex; mode=display</code>タイプのスクリプトを検索し、ディスプレイ数式としてSVGに変換します。</p>

<p>ここでは2種類の<code class="language-plaintext highlighter-rouge">script</code>に分かれていることに注意してください。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m(dv/dt)=F
</code></pre></div></div>

<p>この式は、ニュートンの第二法則を表しています。質量 ( m ) の物体に力 ( F ) が作用すると、その物体の速度 ( v ) が時間 ( t ) に対してどのように変化するかを示しています。</p>

<p>これはインライン形式です。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{equation}</span>
<span class="k">\underset</span><span class="p">{</span><span class="k">\text</span><span class="p">{</span>運動エネルギー<span class="p">}}{</span><span class="k">\tfrac</span><span class="p">{</span>1<span class="p">}{</span>2<span class="p">}</span>mv<span class="p">^</span>2<span class="p">}</span>+
<span class="k">\underset</span><span class="p">{</span><span class="k">\text</span><span class="p">{</span>位置エネルギー<span class="p">}}{</span><span class="k">\vphantom</span><span class="p">{</span><span class="k">\tfrac</span><span class="p">{</span>1<span class="p">}{</span>2<span class="p">}}</span>mgh<span class="p">}</span>=<span class="k">\text</span><span class="p">{</span>一定<span class="p">}</span>,<span class="k">\notag</span>
</code></pre></div></div>

<p>これは段落形式です。</p>

<p>当時、インライン形式では、変換する際に式の左右に<code class="language-plaintext highlighter-rouge">$</code>または<code class="language-plaintext highlighter-rouge">[]</code>を追加する必要がありました。そうしないとエラーが発生する可能性がありました。</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\begin{preview}</span>
<span class="k">\tfrac</span><span class="p">{</span>1<span class="p">}{</span>2<span class="p">}</span>mv<span class="p">^</span>2
<span class="nt">\end{preview}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<p>このLaTeXコードは、ドキュメント内に数式をプレビュー表示するためのものです。具体的には、運動エネルギーを表す数式 (\tfrac{1}{2}mv^2) を表示しています。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span> <span class="nv">$ </span>が不足しています。
&lt;挿入されたテキスト&gt;
                <span class="err">$</span>
l.26 <span class="se">\t</span>frac<span class="o">{</span>1<span class="o">}{</span>2<span class="o">}</span>
                 <span class="nb">mv</span>^2
</code></pre></div></div>

<p>以下のように変更する必要があります：</p>

<div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{document}</span>
<span class="nt">\begin{preview}</span>
<span class="p">$</span><span class="nv">\tfrac</span><span class="p">{</span><span class="m">1</span><span class="p">}{</span><span class="m">2</span><span class="p">}</span><span class="nb">mv</span><span class="p">^</span><span class="m">2</span><span class="p">$</span>
<span class="nt">\end{preview}</span>
<span class="nt">\end{document}</span>
</code></pre></div></div>

<p>このLaTeXコードは、ドキュメント内に数式をプレビュー表示するためのものです。具体的には、運動エネルギーを表す数式 $\tfrac{1}{2}mv^2$ が表示されます。この数式は、質量 $m$ と速度 $v$ の二乗に比例する運動エネルギーを示しています。</p>

<p>次に、<code class="language-plaintext highlighter-rouge">latex</code>を<code class="language-plaintext highlighter-rouge">svg</code>に変換する方法を見てみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">svg_prefix</span> <span class="o">=</span> <span class="s">'eq_'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">svg_prefix</span> <span class="o">=</span> <span class="s">'in_'</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% tree svgs
svgs
├── eq_0.svg
├── eq_1.svg
├── in_0.svg
</code></pre></div></div>

<p>上記のディレクトリ構造は、<code class="language-plaintext highlighter-rouge">svgs</code>というディレクトリ内に3つのSVGファイルが存在することを示しています。具体的には、<code class="language-plaintext highlighter-rouge">eq_0.svg</code>、<code class="language-plaintext highlighter-rouge">eq_1.svg</code>、<code class="language-plaintext highlighter-rouge">in_0.svg</code>というファイルが含まれています。</p>

<p>このようにして<code class="language-plaintext highlighter-rouge">svg</code>を保存します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">wrap_latex</span><span class="p">(</span><span class="n">mathjax</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="s">'$'</span> <span class="o">+</span> <span class="n">mathjax</span><span class="p">.</span><span class="n">string</span> <span class="o">+</span> <span class="s">'$'</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'label'</span><span class="p">,</span> <span class="s">'tag'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrap</span>
</code></pre></div></div>

<p>このPython関数 <code class="language-plaintext highlighter-rouge">wrap_latex</code> は、MathJax形式の文字列をラップするためのものです。<code class="language-plaintext highlighter-rouge">equation</code> パラメータが <code class="language-plaintext highlighter-rouge">True</code> の場合、数式環境としてラップされ、<code class="language-plaintext highlighter-rouge">False</code> の場合はインライン数式として <code class="language-plaintext highlighter-rouge">$</code> で囲まれます。また、文字列内の <code class="language-plaintext highlighter-rouge">label</code> を <code class="language-plaintext highlighter-rouge">tag</code> に置換します。</p>

<p>ここで<code class="language-plaintext highlighter-rouge">latex</code>のソースコードにいくつかの調整を加えます。<code class="language-plaintext highlighter-rouge">label</code>が<code class="language-plaintext highlighter-rouge">tag</code>に変わっていることに注意してください。</p>

<p><img src="assets/images/feynman/tag.png" alt="タグ" /></p>

<p>右側の<code class="language-plaintext highlighter-rouge">(Eq:I:13:14)</code>に注目してください。もし<code class="language-plaintext highlighter-rouge">label</code>を使用している場合、解析が成功していない可能性があります。これが<code class="language-plaintext highlighter-rouge">(1)</code>と表示されることがあります。ここでは一時的に<code class="language-plaintext highlighter-rouge">tag</code>を使用して表現していますが、詳細についてはまだ深く調査していません。</p>

<p>次に、<code class="language-plaintext highlighter-rouge">latex2svg.py</code>を呼び出します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">latex2svg</span><span class="p">(</span><span class="n">wrap</span><span class="p">)</span>   
        <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>    
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">latex2svg</code>関数を使用してLaTeX形式の数式をSVGに変換し、その結果を<code class="language-plaintext highlighter-rouge">out</code>変数に格納しようとしています。もしこのプロセス中に<code class="language-plaintext highlighter-rouge">subprocess.CalledProcessError</code>というエラーが発生した場合、そのエラーを再び発生させて処理を中断します。</p>

<p><code class="language-plaintext highlighter-rouge">latex2svg.py</code>を見てみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># LaTeXを実行してDVIファイルを作成
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">'latex_cmd'</span><span class="p">]</span><span class="o">+</span><span class="s">' code.tex'</span><span class="p">),</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">working_directory</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">check_returncode</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'latexが見つかりません'</span><span class="p">)</span>
</code></pre></div></div>

<p>ここでは<code class="language-plaintext highlighter-rouge">latex</code>コマンドを呼び出しています。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> % latex <span class="nt">--help</span>
使用法: pdftex <span class="o">[</span>オプション]... <span class="o">[</span>TEXNAME[.tex]] <span class="o">[</span>コマンド]
   または: pdftex <span class="o">[</span>オプション]... <span class="se">\F</span>IRST-LINE
   または: pdftex <span class="o">[</span>オプション]... &amp;FMT ARGS
  TEXNAMEに対してpdfTeXを実行し、通常はTEXNAME.pdfを作成します。
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">'dvisvgm_cmd'</span><span class="p">]</span><span class="o">+</span><span class="s">' code.dvi'</span><span class="p">),</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">check_returncode</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">FileNotFoundError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'dvisvgmが見つかりません'</span><span class="p">)</span>
</code></pre></div></div>

<p>ここでは<code class="language-plaintext highlighter-rouge">dvisvgm</code>コマンドを呼び出しています。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% dvisvgm
dvisvgm 2.9.1
</code></pre></div></div>

<p>このプログラムは、TeX/LaTeXで作成されたDVIファイル、およびEPSやPDFファイルを、XMLベースのスケーラブルベクターグラフィックス形式であるSVGに変換します。</p>

<p>使用方法: dvisvgm [オプション] dvifile
       dvisvgm –eps [オプション] epsfile
       dvisvgm –pdf [オプション] pdffile</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
上記の`latex`カスタムマクロはどこに書けばよいのでしょうか。ここで`latex2svg.py`を修正する必要があります。`default_preamble`を変更します。

```python
default_preamble = r"""
\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{newtxtext}
\usepackage[libertine]{newtxmath}
</code></pre></div></div>

<p>\newcommand{\FLPvec}[1]{\boldsymbol{#1}}
\newcommand{\Figvec}[1]{\mathbf{#1}}
\newcommand{\FLPC}{\FLPvec{C}}
\newcommand{\FLPF}{\FLPvec{F}}
\newcommand{\FLPa}{\FLPvec{a}}
\newcommand{\FLPb}{\FLPvec{a}}
\newcommand{\FLPr}{\FLPvec{r}}
\newcommand{\FLPs}{\FLPvec{s}}
\newcommand{\FLPv}{\FLPvec{v}}
\newcommand{\ddt}[2]{\frac{d#1}{d#2}}
\newcommand{\epsO}{\epsilon_0}
\newcommand{\FigC}{\Figvec{C}}
“””</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
変換が成功したら、ファイルに書き込みます。

```python
        f = open(f'svgs/{svg_prefix}{i}.svg', 'w')
        f.write(out['svg'])
        f.close()
</code></pre></div></div>

<p>このコードは、指定されたプレフィックスとインデックスに基づいてSVGファイルを生成し、それをファイルに保存するものです。具体的には、<code class="language-plaintext highlighter-rouge">svgs</code>ディレクトリ内に<code class="language-plaintext highlighter-rouge">svg_prefix</code>とインデックス<code class="language-plaintext highlighter-rouge">i</code>を組み合わせた名前のSVGファイルを作成し、<code class="language-plaintext highlighter-rouge">out['svg']</code>に含まれるSVGデータをそのファイルに書き込んでいます。最後に、ファイルを閉じてリソースを解放します。</p>

<p>続けます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">node</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s">'&lt;img&gt;'</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">'img'</span><span class="p">)</span>
        <span class="n">img</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">'src'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'./svgs/</span><span class="si">{</span><span class="n">svg_prefix</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s">.svg'</span>
        <span class="n">img</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'vertical-align: middle; margin: 0.5em 0;'</span>
</code></pre></div></div>

<p>このコードは、BeautifulSoupを使用してHTMLの<code class="language-plaintext highlighter-rouge">&lt;img&gt;</code>タグを作成し、その属性を設定しています。具体的には、<code class="language-plaintext highlighter-rouge">src</code>属性にSVGファイルのパスを設定し、<code class="language-plaintext highlighter-rouge">style</code>属性に画像の表示スタイルを指定しています。</p>

<p>ここで<code class="language-plaintext highlighter-rouge">img</code>タグを構築します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">wrap_svg</span><span class="p">(</span><span class="n">svg</span><span class="p">,</span> <span class="n">equation</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">equation</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="sa">f</span><span class="s">'&lt;div style="text-align:center;"&gt;&lt;/div&gt;'</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s">"lxml"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">div</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">svg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">div</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">svg</span>
      
<span class="n">p</span> <span class="o">=</span> <span class="n">wrap_svg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">equation</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、SVG画像をラップするための関数 <code class="language-plaintext highlighter-rouge">wrap_svg</code> を定義しています。<code class="language-plaintext highlighter-rouge">equation</code> が <code class="language-plaintext highlighter-rouge">True</code> の場合、SVG画像を中央揃えの <code class="language-plaintext highlighter-rouge">div</code> タグで囲みます。<code class="language-plaintext highlighter-rouge">equation</code> が <code class="language-plaintext highlighter-rouge">False</code> の場合、SVG画像をそのまま返します。最後に、<code class="language-plaintext highlighter-rouge">wrap_svg</code> 関数を呼び出して、<code class="language-plaintext highlighter-rouge">img</code> と <code class="language-plaintext highlighter-rouge">equation</code> を引数として渡し、結果を <code class="language-plaintext highlighter-rouge">p</code> に代入しています。</p>

<p>もし単一の段落の<code class="language-plaintext highlighter-rouge">latex</code>であれば、<code class="language-plaintext highlighter-rouge">div</code>で囲んで中央揃えにします。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mathjax</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">p</code>要素の後にMathJaxを挿入するためのものです。具体的には、<code class="language-plaintext highlighter-rouge">p</code>要素の直後にMathJaxのスクリプトや設定を追加するために使用されます。</p>

<p>ここでは、元の<code class="language-plaintext highlighter-rouge">script</code>タグの後ろに<code class="language-plaintext highlighter-rouge">div</code>タグや<code class="language-plaintext highlighter-rouge">img</code>タグを追加します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean_script</span><span class="p">(</span><span class="n">soup</span><span class="p">):</span>
    <span class="n">scripts</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">'script'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
        <span class="n">s</span><span class="p">.</span><span class="n">decompose</span><span class="p">()</span>    
        
<span class="n">clean_script</span><span class="p">(</span><span class="n">soup</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、指定されたBeautifulSoupオブジェクト<code class="language-plaintext highlighter-rouge">soup</code>からすべての<code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>タグを削除する関数<code class="language-plaintext highlighter-rouge">clean_script</code>を定義しています。<code class="language-plaintext highlighter-rouge">findAll('script')</code>メソッドを使用してすべての<code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>タグを取得し、<code class="language-plaintext highlighter-rouge">decompose()</code>メソッドでそれぞれのタグを分解（削除）しています。最後に、この関数を<code class="language-plaintext highlighter-rouge">soup</code>に対して呼び出しています。</p>

<p>すべての<code class="language-plaintext highlighter-rouge">latex</code>を<code class="language-plaintext highlighter-rouge">svg</code>に置き換えた後は、<code class="language-plaintext highlighter-rouge">script</code>は不要になります。それらを削除して、少しスッキリさせましょう。</p>

<p>最後に、変更を加えた<code class="language-plaintext highlighter-rouge">html</code>全体をファイルに書き込みます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'out.html'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">output_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">prettify</span><span class="p">())</span>
    <span class="n">output_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>    
</code></pre></div></div>

<p>上記のコードは、<code class="language-plaintext highlighter-rouge">soup.prettify()</code>で整形されたHTMLを<code class="language-plaintext highlighter-rouge">out.html</code>というファイルに書き込むものです。<code class="language-plaintext highlighter-rouge">open</code>関数でファイルを書き込みモードで開き、<code class="language-plaintext highlighter-rouge">write</code>メソッドで内容を書き込み、最後に<code class="language-plaintext highlighter-rouge">close</code>メソッドでファイルを閉じています。</p>

<p>次に、<code class="language-plaintext highlighter-rouge">pandoc</code>ツールを使用して、<code class="language-plaintext highlighter-rouge">epub</code>に変換します。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pandoc <span class="nt">-s</span> <span class="nt">-r</span> html out.html <span class="nt">-o</span> feynman.epub
</code></pre></div></div>

<p>このコマンドは、HTMLファイル（<code class="language-plaintext highlighter-rouge">out.html</code>）をEPUB形式（<code class="language-plaintext highlighter-rouge">feynman.epub</code>）に変換するために使用されます。<code class="language-plaintext highlighter-rouge">-s</code>オプションはスタンドアロンのドキュメントを生成し、<code class="language-plaintext highlighter-rouge">-r html</code>は入力ファイルがHTML形式であることを指定します。</p>

<p>これで開くと、美しい電子書籍が表示されます。</p>

<p>なぜ直接<code class="language-plaintext highlighter-rouge">svg</code>タグを埋め込まずに、<code class="language-plaintext highlighter-rouge">img</code>を使ってSVGを読み込むのでしょうか。つまり、このように書く代わりに：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;&lt;/p&gt;</span>
<span class="nt">&lt;svg&gt;&lt;/svg&gt;</span>
<span class="nt">&lt;p&gt;&lt;/p&gt;</span>
</code></pre></div></div>

<p>このコードは、HTML文書内に空の段落要素 (<code class="language-plaintext highlighter-rouge">&lt;p&gt;&lt;/p&gt;</code>) と空のSVG要素 (<code class="language-plaintext highlighter-rouge">&lt;svg&gt;&lt;/svg&gt;</code>) を配置しています。具体的には、最初の段落要素、その後にSVG要素、そして最後に再び段落要素が続いています。これらの要素は現在何も内容を持っていませんが、それぞれの要素にテキストやグラフィックを追加することができます。</p>

<p>ある奇妙な<code class="language-plaintext highlighter-rouge">バグ</code>があります。多くの<code class="language-plaintext highlighter-rouge">svg</code>がある場合、このような状況が発生します。</p>

<p><img src="/assets/images/feynman/svg_p1.png" alt="svg_p1" style="zoom:40%;" /></p>

<p>後で、<code class="language-plaintext highlighter-rouge">img</code>タグを使ってSVGを読み込む方法でうまくいくことがわかりました。なぜこのような現象が起こるのかは理解できませんでしたが、単一の<code class="language-plaintext highlighter-rouge">svg</code>ファイルを取り出してブラウザで表示させると問題なく表示されます。どうやら、ブラウザが大量の<code class="language-plaintext highlighter-rouge">svg</code>をレンダリングする際にエラーが発生するようです。</p>

<h3 id="最後に">最後に</h3>

<p><code class="language-plaintext highlighter-rouge">epub</code>を<code class="language-plaintext highlighter-rouge">mobi</code>に変換する方法については、<code class="language-plaintext highlighter-rouge">Kindle</code>の公式ツールである<code class="language-plaintext highlighter-rouge">Kindle Previewer 3</code>を使用できます。ただし、ここで扱っているのは1章のみです。</p>

<p>このプロジェクトのコードは<a href="https://github.com/lzwjava/feynman-lectures-mobi">feynman-lectures-mobi@lzwjava</a>にあります。</p>

<p>すべてのページをスクレイピングして電子書籍にまとめる方法については、後ほど説明します。しかし、このファインマン物理学講義の一章だけでも十分に読み応えがあります。さあ、Kindleを手に取って読み始めましょう。</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-ja" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
