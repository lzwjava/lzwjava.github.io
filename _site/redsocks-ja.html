<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Redsocksの活用</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Redsocksの活用 | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Redsocksの活用" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="ja" />
<meta name="description" content="もちろんです！Macコンピュータを使用してShadowsocksプロキシを設定し、OpenWRTルーターを構成して、接続されたすべてのデバイスのトラフィックをこのプロキシ経由でルーティングする手順をご案内します。このセットアップには、以下の主要なステップが含まれます：" />
<meta property="og:description" content="もちろんです！Macコンピュータを使用してShadowsocksプロキシを設定し、OpenWRTルーターを構成して、接続されたすべてのデバイスのトラフィックをこのプロキシ経由でルーティングする手順をご案内します。このセットアップには、以下の主要なステップが含まれます：" />
<link rel="canonical" href="https://lzwjava.github.io/redsocks-ja" />
<meta property="og:url" content="https://lzwjava.github.io/redsocks-ja" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-18T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Redsocksの活用" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2024-12-18T00:00:00+08:00","datePublished":"2024-12-18T00:00:00+08:00","description":"もちろんです！Macコンピュータを使用してShadowsocksプロキシを設定し、OpenWRTルーターを構成して、接続されたすべてのデバイスのトラフィックをこのプロキシ経由でルーティングする手順をご案内します。このセットアップには、以下の主要なステップが含まれます：","headline":"Redsocksの活用","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/redsocks-ja"},"url":"https://lzwjava.github.io/redsocks-ja"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=12df61735bc3ce47d5cfdfc05f1923f7db4438dd">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=12df61735bc3ce47d5cfdfc05f1923f7db4438dd" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Redsocksの活用 | オリジナル、AI翻訳
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/ja/2024-12-18-redsocks-ja.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsja2024-12-18-redsocks-ja.md</span> -->
      

      <!-- <span>2024-12-18-redsocks-ja.md</span> -->

      
        

        
          
          <a href="#" class="button">2024.12</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/redsocks-en" >English</option>
        <option value="/redsocks-zh" >中文</option>
        <option value="/redsocks-ja" selected>日本語</option>
        <option value="/redsocks-es" >Español</option>
        <option value="/redsocks-hi" >हिंदी</option>
        <option value="/redsocks-fr" >Français</option>
        <option value="/redsocks-de" >Deutsch</option>
        <option value="/redsocks-ar" >العربية</option>
        <option value="/redsocks-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>もちろんです！Macコンピュータを使用してShadowsocksプロキシを設定し、OpenWRTルーターを構成して、接続されたすべてのデバイスのトラフィックをこのプロキシ経由でルーティングする手順をご案内します。このセットアップには、以下の主要なステップが含まれます：</p>

<ol>
  <li>macOSにShadowsocksクライアントを設定する（Shadowsocks-NGまたはClashを使用）</li>
  <li>macOSを外部プロキシ接続を許可するように設定する</li>
  <li>Macに静的IPを割り当てる</li>
  <li>OpenWRTにRedsocksをインストールして設定する</li>
  <li>OpenWRTのトラフィックをmacOSのプロキシ経由にリダイレクトする</li>
  <li>プロキシ設定をテストする</li>
</ol>

<p>各ステップについて詳しく見ていきましょう。</p>

<hr />

<h2 id="1-macosでのshadowsocksクライアントの設定">1. macOSでのShadowsocksクライアントの設定</h2>

<p>Shadowsocksクライアントとして、Shadowsocks-NGまたはClashのどちらかを使用できます。以下にそれぞれの設定手順を記載します。</p>

<h3 id="オプションa-shadowsocks-ngを使用する">オプションA: Shadowsocks-NGを使用する</h3>

<p>Shadowsocks-NGは、macOS向けの人気で使いやすいShadowsocksクライアントです。</p>

<h4 id="ステップ1-shadowsocks-ngをダウンロードしてインストールする">ステップ1: Shadowsocks-NGをダウンロードしてインストールする</h4>

<ol>
  <li>Shadowsocks-NGをダウンロードする：
    <ul>
      <li><a href="https://github.com/shadowsocks/ShadowsocksX-NG/releases">Shadowsocks-NG GitHub Releasesページ</a>にアクセスします。</li>
      <li>最新の<code class="language-plaintext highlighter-rouge">.dmg</code>ファイルをダウンロードします。</li>
    </ul>
  </li>
  <li>アプリケーションをインストールする：
    <ul>
      <li>ダウンロードした <code class="language-plaintext highlighter-rouge">.dmg</code> ファイルを開きます。</li>
      <li>ShadowsocksX-NG アプリを「アプリケーション」フォルダにドラッグします。</li>
    </ul>
  </li>
  <li>Shadowsocks-NGを起動する：
    <ul>
      <li>アプリケーションフォルダからShadowsocksX-NGを開きます。</li>
      <li>システム環境設定でアプリに必要な権限を付与する必要があるかもしれません。</li>
    </ul>
  </li>
</ol>

<h4 id="ステップ2-shadowsocks-ngの設定">ステップ2: Shadowsocks-NGの設定</h4>

<ol>
  <li>設定を開く：
    <ul>
      <li>メニューバーのShadowsocksX-NGアイコンをクリックします。</li>
      <li>「ShadowsocksX-NGを開く」＞「設定」を選択します。</li>
    </ul>
  </li>
  <li>新しいサーバーを追加:
    <ul>
      <li>「Servers」タブに移動します。</li>
      <li>「+」ボタンをクリックして新しいサーバーを追加します。</li>
    </ul>
  </li>
  <li>Shadowsocks URLをインポートする:
    <ul>
      <li>Shadowsocks URLをコピー:
        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ss://[ENCRYPTED_PASSWORD]@xxx.xxx.xxx.xxx:xxxxx/?outline=1
</code></pre></div>        </div>
      </li>
      <li>インポート方法:
        <ul>
          <li>「インポート」をクリック。</li>
          <li>Shadowsocks URLを貼り付ける。</li>
          <li>Shadowsocks-NGが自動的にサーバーの詳細を解析し、入力してくれるはずです。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ローカルプロキシを設定する：
    <ul>
      <li>「SOCKS5プロキシを有効にする」にチェックが入っていることを確認します。</li>
      <li>ローカルポート（デフォルトは通常 <code class="language-plaintext highlighter-rouge">1080</code>）をメモしておきます。</li>
    </ul>
  </li>
  <li>保存して有効化:
    <ul>
      <li>「OK」をクリックしてサーバーを保存します。</li>
      <li>「Shadowsocksを有効にする」スイッチをONに切り替えます。</li>
    </ul>
  </li>
</ol>

<h3 id="オプションb-clashを使用する">オプションB: Clashを使用する</h3>

<p>Clashは、Shadowsocksを含む複数のプロトコルをサポートする多機能なプロキシクライアントです。</p>

<h4 id="ステップ1-clashをダウンロードしてインストールする">ステップ1: Clashをダウンロードしてインストールする</h4>

<ol>
  <li>Clash for macOS をダウンロード:
    <ul>
      <li><a href="https://github.com/Dreamacro/clash/releases">Clash GitHub Releases ページ</a> にアクセスします。</li>
      <li>最新の Clash for macOS バイナリをダウンロードします。</li>
    </ul>
  </li>
  <li>アプリケーションをインストールする：
    <ul>
      <li>ダウンロードしたClashアプリケーションを「アプリケーション」フォルダに移動します。</li>
    </ul>
  </li>
  <li>Clashを起動する：
    <ul>
      <li>アプリケーションフォルダからClashを開きます。</li>
      <li>システム環境設定で必要な権限を付与する必要があるかもしれません。</li>
    </ul>
  </li>
</ol>

<h4 id="ステップ2-clashの設定">ステップ2: Clashの設定</h4>

<ol>
  <li>設定ファイルにアクセスする:
    <ul>
      <li>ClashはYAML設定ファイルを使用します。TextEditやVisual Studio Codeなどのテキストエディタを使って、作成または編集できます。</li>
    </ul>
  </li>
  <li>Shadowsocksサーバーを追加する:
    <ul>
      <li>以下の内容で設定ファイル（例: <code class="language-plaintext highlighter-rouge">config.yaml</code>）を作成します:</li>
    </ul>
  </li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">port</span><span class="pi">:</span> <span class="m">7890</span>
<span class="na">socks-port</span><span class="pi">:</span> <span class="m">7891</span>
<span class="na">allow-lan</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">mode</span><span class="pi">:</span> <span class="s">Rule</span>
<span class="na">log-level</span><span class="pi">:</span> <span class="s">info</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">proxies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">MyShadowsocks"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">ss</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">xxx.xxx.xxx.xxx</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">xxxxx</span>
    <span class="na">cipher</span><span class="pi">:</span> <span class="s">chacha20-ietf-poly1305</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xxxxxx"</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">proxy-groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Default"</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">select</span>
    <span class="na">proxies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">MyShadowsocks"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">DIRECT"</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">MATCH,Default</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> メモ:
 - `port` と `socks-port` は、ClashがリッスンするHTTPおよびSOCKS5プロキシポートを定義します。
 - `allow-lan: true` は、LANデバイスがプロキシを使用できるようにします。
 - `proxies` セクションには、Shadowsocksサーバーの詳細が含まれています。
 - `proxy-groups` と `rules` は、トラフィックのルーティング方法を決定します。
</code></pre></div></div>

<ol>
  <li>設定ファイルを使用してClashを開始:
    <ul>
      <li>Clashを起動し、<code class="language-plaintext highlighter-rouge">config.yaml</code>ファイルを使用するように設定します。</li>
      <li>Clashを起動する際に、設定ファイルのパスを指定する必要があるかもしれません。</li>
    </ul>
  </li>
  <li>プロキシが動作していることを確認する:
    <ul>
      <li>Clashがアクティブで、Shadowsocksサーバーに接続されていることを確認します。</li>
      <li>メニューバーのアイコンでステータスを確認します。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="2-macosを外部プロキシ接続を許可するように設定する">2. macOSを外部プロキシ接続を許可するように設定する</h2>

<p>デフォルトでは、Shadowsocksクライアントはプロキシを<code class="language-plaintext highlighter-rouge">localhost</code>（<code class="language-plaintext highlighter-rouge">127.0.0.1</code>）にバインドするため、Macのみがこのプロキシを使用できます。OpenWRTルーターがこのプロキシを使用できるようにするには、プロキシをMacのLAN IPにバインドする必要があります。</p>

<h3 id="shadowsocks-ngの場合">Shadowsocks-NGの場合:</h3>

<ol>
  <li>設定を開く:
    <ul>
      <li>メニューバーのShadowsocksX-NGアイコンをクリックします。</li>
      <li>「ShadowsocksX-NGを開く」＞「設定」を選択します。</li>
    </ul>
  </li>
  <li>詳細設定タブに移動：
    <ul>
      <li>「詳細設定」タブに移動します。</li>
    </ul>
  </li>
  <li>リスニングアドレスの設定:
    <ul>
      <li>「Listen Address」を<code class="language-plaintext highlighter-rouge">127.0.0.1</code>から<code class="language-plaintext highlighter-rouge">0.0.0.0</code>に変更し、任意のインターフェースからの接続を許可します。</li>
      <li>または、MacのLAN IP（例: <code class="language-plaintext highlighter-rouge">192.168.1.xxx</code>）を指定します。</li>
    </ul>
  </li>
  <li>Shadowsocks-NGを保存して再起動:
    <ul>
      <li>「OK」をクリックして変更を保存します。</li>
      <li>新しい設定を適用するために、Shadowsocks-NGクライアントを再起動します。</li>
    </ul>
  </li>
</ol>

<h3 id="clashの場合">Clashの場合:</h3>

<ol>
  <li>設定ファイルを編集する:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">config.yaml</code> 内で <code class="language-plaintext highlighter-rouge">allow-lan: true</code> 設定が有効になっていることを確認してください。</li>
    </ul>
  </li>
  <li>すべてのインターフェースにバインドする:
    <ul>
      <li>設定で <code class="language-plaintext highlighter-rouge">allow-lan: true</code> を設定すると、通常、プロキシはLANを含むすべての利用可能なインターフェースにバインドされます。</li>
    </ul>
  </li>
  <li>Clashを再起動：
    <ul>
      <li>変更を適用するためにClashクライアントを再起動します。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="3-macに静的ipを割り当てる">3. Macに静的IPを割り当てる</h2>

<p>OpenWRTルーターとMac間の接続を安定させるために、ローカルネットワーク内でMacに静的IPを割り当ててください。</p>

<h3 id="macosで静的ipを割り当てる手順">macOSで静的IPを割り当てる手順:</h3>

<ol>
  <li>システム環境設定を開く：
    <ul>
      <li>Appleメニューをクリックし、「システム環境設定」を選択します。</li>
    </ul>
  </li>
  <li>ネットワーク設定に移動します：
    <ul>
      <li>「ネットワーク」をクリックします。</li>
    </ul>
  </li>
  <li>アクティブな接続を選択:
    <ul>
      <li>Macがルーターに接続されている方法に応じて、左側のサイドバーから「Wi-Fi」または「Ethernet」を選択します。</li>
    </ul>
  </li>
  <li>IPv4設定を構成する：
    <ul>
      <li>「詳細…」をクリックします。</li>
      <li>「TCP/IP」タブに移動します。</li>
      <li>「IPv4を構成」を「DHCPを使用」から「手動」に変更します。</li>
    </ul>
  </li>
  <li>静的IPアドレスの設定:
    <ul>
      <li>IPアドレス: ルーターのDHCP範囲外のIPを選び、競合を防ぎます（例: <code class="language-plaintext highlighter-rouge">192.168.1.xxx</code>）。</li>
      <li>サブネットマスク: 通常は <code class="language-plaintext highlighter-rouge">255.255.255.0</code>。</li>
      <li>ルーター: ルーターのIPアドレス（例: <code class="language-plaintext highlighter-rouge">192.168.1.1</code>）。</li>
      <li>DNSサーバー: ルーターのIPを使用するか、<code class="language-plaintext highlighter-rouge">8.8.8.8</code>のような他のDNSサービスを利用できます。</li>
    </ul>
  </li>
  <li>設定を適用する：
    <ul>
      <li>「OK」をクリックし、次に「適用」をクリックして変更を保存します。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-openwrtへのredsocksのインストールと設定">4. OpenWRTへのRedsocksのインストールと設定</h2>

<p>Redsocksは、ネットワークトラフィックをSOCKS5プロキシ経由でルーティングできる透過型のSOCKSリダイレクターです。ここでは、Redsocksを使用して、Mac上で動作しているShadowsocksプロキシを介してOpenWRTのトラフィックをリダイレクトします。</p>

<h3 id="ステップ1-redsocksのインストール">ステップ1: Redsocksのインストール</h3>

<ol>
  <li>パッケージリストの更新:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@&lt;router_ip&gt;
opkg update
</code></pre></div></div>

<ol>
  <li>Redsocksをインストール:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg <span class="nb">install </span>redsocks
</code></pre></div></div>

<p><em>もしOpenWRTのリポジトリにRedsocksが利用できない場合、手動でコンパイルするか、代替パッケージを使用する必要があるかもしれません。</em></p>

<h3 id="ステップ2-redsocksの設定">ステップ2: Redsocksの設定</h3>

<ol>
  <li>Redsocks設定ファイルの作成または編集:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/redsocks.conf
</code></pre></div></div>

<ol>
  <li>以下の設定を追加:</li>
</ol>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">base</span> {
       <span class="n">log_debug</span> = <span class="n">on</span>;
       <span class="n">log_info</span> = <span class="n">on</span>;
       <span class="n">log</span> = <span class="s2">"file:/var/log/redsocks.log"</span>;
       <span class="n">daemon</span> = <span class="n">on</span>;
       <span class="n">redirector</span> = <span class="n">iptables</span>;
   }
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redsocks {
       local_ip = 0.0.0.0;
       local_port = 12345;  # Redsocksがリッスンするローカルポート
       ip = xxx.xxx.xxx.xxx;  # Macの静的IPアドレス
       port = xxxxx;          # Shadowsocks-NGのローカルSOCKS5プロキシポート
       type = socks5;
       login = "";           # プロキシが認証を必要とする場合
       password = "";
   }
</code></pre></div></div>

<p>メモ:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">local_port</code>: Redsocksがiptablesのリダイレクトからの接続を待ち受けるポート。</li>
  <li><code class="language-plaintext highlighter-rouge">ip</code> と <code class="language-plaintext highlighter-rouge">port</code>: MacのShadowsocks SOCKS5プロキシを指す (<code class="language-plaintext highlighter-rouge">xxx.xxx.xxx.xxx:xxxxx</code> は前の手順に基づく)。</li>
  <li><code class="language-plaintext highlighter-rouge">type</code>: Shadowsocksが提供するSOCKS5プロキシであるため、<code class="language-plaintext highlighter-rouge">socks5</code> に設定。</li>
</ul>

<ol>
  <li>保存して終了:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">ESC</code>を押し、<code class="language-plaintext highlighter-rouge">:wq</code>と入力して、<code class="language-plaintext highlighter-rouge">Enter</code>を押します。</li>
    </ul>
  </li>
  <li>ログファイルの作成:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch</span> /var/log/redsocks.log
<span class="nb">chmod </span>644 /var/log/redsocks.log
</code></pre></div></div>

<h3 id="ステップ3-redsocksサービスを開始する">ステップ3: Redsocksサービスを開始する</h3>

<ol>
  <li>起動時にRedsocksを有効にする:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/redsocks <span class="nb">enable</span>
</code></pre></div></div>

<ol>
  <li>Redsocksを起動:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   /etc/init.d/redsocks start
</code></pre></div></div>

<ol>
  <li>Redsocksが動作していることを確認する:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps | <span class="nb">grep </span>redsocks
</code></pre></div></div>

<p>Redsocksプロセスが実行されているのが確認できるはずです。</p>

<hr />

<h2 id="5-openwrtのトラフィックをmacosプロキシ経由にリダイレクトする">5. OpenWRTのトラフィックをmacOSプロキシ経由にリダイレクトする</h2>

<p>OpenWRTにRedsocksが設定されたので、iptablesを設定して、すべての発信TCPトラフィックをRedsocks経由でリダイレクトし、それがMacのShadowsocksプロキシを経由するようにします。</p>

<h3 id="ステップ1-iptablesルールの設定">ステップ1: iptablesルールの設定</h3>

<ol>
  <li>トラフィックをリダイレクトするためのiptablesルールを追加:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c"># すべてのTCPトラフィックをRedsocksにリダイレクト（プロキシ自体へのトラフィックを除く）</span>
   iptables <span class="nt">-t</span> nat <span class="nt">-N</span> REDSOCKS
   iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-d</span> xxx.xxx.xxx.xxx <span class="nt">-p</span> tcp <span class="nt">--dport</span> xxxxx <span class="nt">-j</span> RETURN
   iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-p</span> tcp <span class="nt">-j</span> REDIRECT <span class="nt">--to-ports</span> 12345
</code></pre></div></div>

<h1 id="すべての発信トラフィックにredsocksチェーンを適用する">すべての発信トラフィックにREDSOCKSチェーンを適用する</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> OUTPUT <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
</code></pre></div></div>

<p>説明:</p>
<ul>
  <li>新しいチェーンを作成: <code class="language-plaintext highlighter-rouge">REDSOCKS</code></li>
  <li>プロキシトラフィックを除外: プロキシ自体へのトラフィックがリダイレクトされないようにします。</li>
  <li>その他のTCPトラフィックをリダイレクト: 他のTCPトラフィックをRedsocksのリスニングポート（<code class="language-plaintext highlighter-rouge">12345</code>）に転送します。</li>
</ul>

<ol>
  <li>iptablesルールの保存:</li>
</ol>

<p>これらのルールを再起動後も永続的にするには、ファイアウォールの設定に追加してください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/firewall.user
</code></pre></div></div>

<p>iptablesルールを追加:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c"># すべてのTCPトラフィックをRedsocksにリダイレクト（プロキシを除く）</span>
   iptables <span class="nt">-t</span> nat <span class="nt">-N</span> REDSOCKS
   iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-d</span> xxx.xxx.xxx.xxx <span class="nt">-p</span> tcp <span class="nt">--dport</span> xxxxx <span class="nt">-j</span> RETURN
   iptables <span class="nt">-t</span> nat <span class="nt">-A</span> REDSOCKS <span class="nt">-p</span> tcp <span class="nt">-j</span> REDIRECT <span class="nt">--to-ports</span> 12345
</code></pre></div></div>

<h1 id="redsocksチェーンの適用">REDSOCKSチェーンの適用</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> OUTPUT <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">-j</span> REDSOCKS
</code></pre></div></div>

<p>保存して終了:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ESC</code>を押し、<code class="language-plaintext highlighter-rouge">:wq</code>と入力して、<code class="language-plaintext highlighter-rouge">Enter</code>を押します。</li>
</ul>

<ol>
  <li>変更を適用するためにファイアウォールを再起動:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/firewall restart
</code></pre></div></div>

<h3 id="ステップ2-トラフィックがリダイレクトされていることを確認する">ステップ2: トラフィックがリダイレクトされていることを確認する</h3>

<ol>
  <li>Redsocksのログを確認する:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /var/log/redsocks.log
</code></pre></div></div>

<p>Redsocksを介してトラフィックが処理されていることを示すログが表示されるはずです。</p>

<ol>
  <li>クライアントデバイスからのテスト:
    <ul>
      <li>OpenWRTルーターにデバイスを接続します。</li>
      <li>インターネットを使用するウェブサイトにアクセスするか、何らかのアクションを実行します。</li>
      <li>外部IPアドレス（例：<a href="https://www.whatismyip.com/">WhatIsMyIP.com</a>）を確認して、トラフィックがShadowsocksプロキシを経由していることを確認します。プロキシのIPが反映されているかどうかを確認します。</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="6-プロキシ設定のテスト">6. プロキシ設定のテスト</h2>

<p>以下のテストを実行して、セットアップ全体が意図した通りに動作することを確認してください。</p>

<h3 id="ステップ1-macでのshadowsocks接続を確認する">ステップ1: MacでのShadowsocks接続を確認する</h3>

<ol>
  <li>Shadowsocksクライアントのステータスを確認する：
    <ul>
      <li>Shadowsocks-NGまたはClashがShadowsocksサーバーにアクティブに接続されていることを確認します。</li>
      <li>ローカルプロキシ（例：<code class="language-plaintext highlighter-rouge">xxx.xxx.xxx.xxx:xxxxx</code>）がアクセス可能かどうかを確認します。</li>
    </ul>
  </li>
  <li>プロキシをローカルでテストする：
    <ul>
      <li>Macでブラウザを開き、SOCKS5プロキシとして<code class="language-plaintext highlighter-rouge">localhost:1080</code>を使用するように設定します。</li>
      <li><a href="https://www.whatismyip.com/">WhatIsMyIP.com</a>にアクセスし、IPがShadowsocksサーバーと一致することを確認します。</li>
    </ul>
  </li>
</ol>

<h3 id="ステップ2-openwrtのトラフィックがプロキシを経由していることを確認する">ステップ2: OpenWRTのトラフィックがプロキシを経由していることを確認する</h3>

<ol>
  <li>OpenWRTの外部IPを確認する:
    <ul>
      <li>OpenWRTに接続されたデバイスから、<a href="https://www.whatismyip.com/">WhatIsMyIP.com</a>にアクセスし、IPがShadowsocksサーバーのIPを反映しているかどうかを確認します。</li>
    </ul>
  </li>
  <li>Redsocksのログを監視する:
    <ul>
      <li>OpenWRT上で、Redsocksのログを監視し、トラフィックがリダイレクトされていることを確認します。</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tail</span> <span class="nt">-f</span> /var/log/redsocks.log
</code></pre></div>    </div>
  </li>
  <li>必要に応じてトラブルシューティングを行う:
    <ul>
      <li>トラフィックが正しくルーティングされない場合:
        <ul>
          <li>Mac上のShadowsocksクライアントが実行中でアクセス可能であることを確認する。</li>
          <li>iptablesのルールが正しく設定されていることを確認する。</li>
          <li>MacとOpenWRTの両方のファイアウォール設定を確認する。</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="追加の考慮事項">追加の考慮事項</h2>

<h3 id="1-セキュリティ">1. セキュリティ</h3>

<ul>
  <li>プロキシのセキュリティを確保する:
    <ul>
      <li>信頼できるデバイスのみがプロキシにアクセスできるようにします。すべてのトラフィックをRedsocks経由でリダイレクトしているため、MacのファイアウォールがOpenWRTルーターからの接続のみを許可するように設定します。</li>
    </ul>
  </li>
</ul>

<p>macOSの場合:</p>

<ul>
  <li>システム環境設定 &gt; セキュリティとプライバシー &gt; ファイアウォールに移動します。</li>
  <li>
    <p>ファイアウォールを設定し、OpenWRTルーターのIPからのみプロキシポート（<code class="language-plaintext highlighter-rouge">xxxxx</code>）への着信接続を許可します。</p>
  </li>
  <li>認証:
    <ul>
      <li>Shadowsocksは暗号化を通じてある程度のセキュリティを提供しています。強力なパスワードと暗号化方式を確保してください。</li>
    </ul>
  </li>
</ul>

<h3 id="2-パフォーマンス">2. パフォーマンス</h3>

<ul>
  <li>ルーターのリソース:
    <ul>
      <li>Redsocksのようなプロキシサービスを実行すると、OpenWRTルーターのCPUとメモリを余分に消費する可能性があります。ルーターに十分なリソースがあることを確認してください。</li>
    </ul>
  </li>
  <li>Macのパフォーマンス:
    <ul>
      <li>プロキシの可用性を維持するために、Macが電源に接続され、ネットワークに接続されていることを確認してください。</li>
    </ul>
  </li>
</ul>

<h3 id="3-メンテナンス">3. メンテナンス</h3>

<ul>
  <li>ログの監視:
    <ul>
      <li>RedsocksとShadowsocksのログを定期的にチェックし、異常な活動やエラーがないか確認します。</li>
    </ul>
  </li>
  <li>ソフトウェアの更新:
    <ul>
      <li>OpenWRT、Redsocks、およびShadowsocksクライアントを最新の状態に保ち、セキュリティパッチやパフォーマンスの向上を活用しましょう。</li>
    </ul>
  </li>
</ul>

<h3 id="4-代替アプローチ">4. 代替アプローチ</h3>

<p>Macを中間プロキシサーバーとして使用することは可能ですが、以下の代替案を検討することで、より簡単な設定ができるかもしれません：</p>

<ul>
  <li>OpenWRTを直接Shadowsocksクライアントとして設定する:
    <ul>
      <li>OpenWRTは<code class="language-plaintext highlighter-rouge">shadowsocks-libev</code>のようなパッケージを通じて直接Shadowsocksをサポートしています。この方法では、Macを仲介する必要がなくなります。</li>
    </ul>
  </li>
  <li>専用のプロキシ/VPNデバイスを使用する:
    <ul>
      <li>Raspberry Piのようなデバイスはプロキシサービスを実行し、専用のゲートウェイとして機能させることができます。</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="結論">結論</h2>

<p>上記の手順に従うことで、MacをShadowsocksプロキシサーバーとして設定し、OpenWRTルーターを構成して、接続されたすべてのデバイスのトラフィックをこのプロキシ経由でルーティングするようにしました。この設定により、Shadowsocksプロトコルを活用してネットワークのプライバシーと制御が強化されます。</p>

<p>要点のまとめ：</p>

<ol>
  <li>MacでのShadowsocksクライアント：
    <ul>
      <li>提供されたShadowsocks URLを使用して、Shadowsocks-NGまたはClashをインストールおよび設定しました。</li>
      <li>クライアントをMacのLAN IPでリッスンするように設定しました。</li>
    </ul>
  </li>
  <li>プロキシのアクセシビリティ:
    <ul>
      <li>Macに静的IPを割り当て、プロキシへの一貫したアクセスを確保しました。</li>
      <li>macOSのファイアウォールを設定し、着信プロキシ接続を許可しました。</li>
    </ul>
  </li>
  <li>OpenWRTの設定：
    <ul>
      <li>Redsocksをインストールし、すべての外向きTCPトラフィックをShadowsocksプロキシ経由でリダイレクトするように設定しました。</li>
      <li>トラフィックリダイレクトを強制するために必要なiptablesルールを適用しました。</li>
    </ul>
  </li>
  <li>テスト:
    <ul>
      <li>接続されたデバイスからのトラフィックがShadowsocksプロキシを経由していることを確認するため、外部IPアドレスをチェックしました。</li>
    </ul>
  </li>
</ol>

<p>おすすめ：</p>

<ul>
  <li><strong>安定性を確保する</strong>: プロキシの可用性を維持するために、Macの電源を入れ、接続を維持してください。</li>
  <li><strong>セキュリティを最優先に</strong>: すべてのコンポーネントを定期的に更新し、ログを監視して不正アクセスから保護してください。</li>
  <li><strong>ルーターの直接設定を検討する</strong>: より効率的なセットアップのために、OpenWRTルーター上で直接Shadowsocksを設定する方法を探ってみてください。</li>
</ul>

<p>特定の設定で問題が発生したり、さらなるサポートが必要な場合は、お気軽にお問い合わせください！</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>base {
    log_debug = on;
    log_info = on;
    log = "file:/var/log/redsocks.log";
    daemon = on;
    redirector = generic;
}
</code></pre></div></div>

<p>この設定は、<code class="language-plaintext highlighter-rouge">redsocks</code>の基本的な設定を定義しています。以下に各設定項目の説明を示します：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">log_debug = on;</code>: デバッグログを有効にします。</li>
  <li><code class="language-plaintext highlighter-rouge">log_info = on;</code>: 情報ログを有効にします。</li>
  <li><code class="language-plaintext highlighter-rouge">log = "file:/var/log/redsocks.log";</code>: ログを<code class="language-plaintext highlighter-rouge">/var/log/redsocks.log</code>ファイルに出力します。</li>
  <li><code class="language-plaintext highlighter-rouge">daemon = on;</code>: <code class="language-plaintext highlighter-rouge">redsocks</code>をデーモンとして実行します。</li>
  <li><code class="language-plaintext highlighter-rouge">redirector = generic;</code>: ジェネリックなリダイレクタを使用します。</li>
</ul>

<p>この設定は、<code class="language-plaintext highlighter-rouge">redsocks</code>がバックグラウンドで動作し、ログを指定されたファイルに出力するように指示しています。</p>

<p><code class="language-plaintext highlighter-rouge">redsocks {
    local_ip = 0.0.0.0;
    local_port = 7891;
    ip = xxx.xxx.xxx.xxx;
    port = xxxxx;
    type = http-connect;
    login = "";
    password = "";
}
</code></p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-ja" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
