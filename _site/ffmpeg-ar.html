<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>نقل FFmpeg إلى Android</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>نقل FFmpeg إلى Android | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="نقل FFmpeg إلى Android" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="ar" />
<meta name="description" content="رابط النص الأصلي (CSDN)" />
<meta property="og:description" content="رابط النص الأصلي (CSDN)" />
<link rel="canonical" href="https://lzwjava.github.io/ffmpeg-ar" />
<meta property="og:url" content="https://lzwjava.github.io/ffmpeg-ar" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="نقل FFmpeg إلى Android" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2014-03-10T00:00:00+08:00","datePublished":"2014-03-10T00:00:00+08:00","description":"رابط النص الأصلي (CSDN)","headline":"نقل FFmpeg إلى Android","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/ffmpeg-ar"},"url":"https://lzwjava.github.io/ffmpeg-ar"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=5ce5ad1bcdab9c7adad2847894ffcb78752e0c6d">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=5ce5ad1bcdab9c7adad2847894ffcb78752e0c6d" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       نقل FFmpeg إلى Android | أصلي، ترجم بواسطة AI
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/ar/2014-03-10-ffmpeg-ar.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsar2014-03-10-ffmpeg-ar.md</span> -->
      

      <!-- <span>2014-03-10-ffmpeg-ar.md</span> -->

      
        

        
          
          <a href="#" class="button">2014.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/ffmpeg-en" >English</option>
        <option value="/ffmpeg-zh" >中文</option>
        <option value="/ffmpeg-ja" >日本語</option>
        <option value="/ffmpeg-es" >Español</option>
        <option value="/ffmpeg-hi" >हिंदी</option>
        <option value="/ffmpeg-fr" >Français</option>
        <option value="/ffmpeg-de" >Deutsch</option>
        <option value="/ffmpeg-ar" selected>العربية</option>
        <option value="/ffmpeg-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p><a href="https://blog.csdn.net/lzw_java/article/details/21564091">رابط النص الأصلي (CSDN)</a></p>

<hr />

<h2 id="البداية">البداية</h2>

<p>بالنسبة للطلاب الذين لم يتعرفوا بعد على FFmpeg، يمكنهم أولاً الاطلاع على <a href="https://ffmpeg.org/ffmpeg.html">الأوامر الأساسية الشائعة لـ FFmpeg</a>، والبحث بعمق في وظائفه – مثل دمج الصوت والفيديو، تشغيل أنواع مختلفة من الترميز، قص الفيديو، دمج عدة صور في فيديو وخلط الصوت، تحويل التنسيقات، وغيرها. يمكن أن توفر FFmpeg وظائف قوية ومثيرة للاهتمام للعديد من سيناريوهات التطبيق.</p>

<p>باستخدام تطبيقات مثل “التعليق الصوتي” كمثال، فإن التعليق الصوتي ليس فقط ممتعًا للغاية، بل غالبًا ما يجعل المنتج أكثر جاذبية. نحن نخطط لتطوير وحدة تعليق صوتي، وبالتالي نظرنا إلى FFmpeg، وحاولنا نقله إلى منصة Android. استغرق الأمر حوالي 3 إلى 4 أيام، وجربنا عدة إصدارات، ولم تنجح العديد من المقالات على الإنترنت، حتى وجدنا برنامجًا تعليميًا بعنوان “استخدام ffmpeg على android واستدعاء الواجهات”، والذي أخيرًا ساعدنا في تحقيق النجاح. أظهرت الاختبارات العملية أن فقط مزيج FFmpeg 1.2 مع ndk-r9 يمكن نقله بنجاح.</p>

<hr />

<h2 id="الفكرة">الفكرة</h2>

<p>FFmpeg 是一个用 C 语言编写的项目，其中包含一个 <code class="language-plaintext highlighter-rouge">main()</code> 函数。我们的目标是：</p>

<ol>
  <li>استخدم Android NDK لتجميع <code class="language-plaintext highlighter-rouge">libffmpeg.so</code>.</li>
  <li>باستخدام هذه المكتبة، قم بتجميع وتعديل ملف <code class="language-plaintext highlighter-rouge">ffmpeg.c</code>، وقم بتغيير اسم الدالة الأصلية <code class="language-plaintext highlighter-rouge">main()</code> إلى <code class="language-plaintext highlighter-rouge">video_merge(int argc, char **argv)</code>، مما يسمح باستدعائها مباشرة من JNI لإجراء عمليات مثل دمج الفيديو.</li>
</ol>

<p>على سبيل المثال، يمكن تحقيق تركيب الفيديو بطريقة مشابهة لما يلي (المقابل لسطر الأوامر <code class="language-plaintext highlighter-rouge">ffmpeg -i src1 -i src2 -y output</code>):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video_merge</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span> <span class="c1">// حيث يتم محاكاة وسائط سطر الأوامر بواسطة argv</span>
</code></pre></div></div>

<hr />

<h2 id="البيئة">البيئة</h2>

<ul>
  <li>نظام التشغيل: Ubuntu 12.04</li>
  <li>إصدار FFmpeg: 1.2</li>
  <li>إصدار NDK: ndk-r9</li>
</ul>

<p>قبل البدء، يُنصح بالاطلاع على بعض البرامج التعليمية ذات الصلة، وعند مواجهة أي مشاكل، يمكنك العودة إلى هذه المقالة للمقارنة، لتجنب اتخاذ مسارات طويلة وغير ضرورية.</p>

<hr />

<h2 id="تعديل-الواجهة-وملف-androidmk">تعديل الواجهة وملف Android.mk</h2>

<p>عند كتابة واجهة JNI لـ FFmpeg، تحتاج إلى كتابة ملف <code class="language-plaintext highlighter-rouge">Android.mk</code> لربط المكتبات، وبالتالي إنشاء ملف <code class="language-plaintext highlighter-rouge">.so</code> قابل للاستخدام. بعض نماذج <code class="language-plaintext highlighter-rouge">Android.mk</code> قد لا تعمل مباشرة في بيئات مختلفة. وظيفتها هي إخبار NDK بأي ملفات المصدر التي تحتاج إلى الترجمة، وإلى أي مكتبة يجب الربط، وغيرها من المعلومات.</p>

<p>لقد اعتمدت أسلوبًا يتمثل في “التجميع مرتين، ثم الربط”:</p>

<ol>
  <li>أولاً، قم بتجميع مكتبة مشتركة تُسمى <code class="language-plaintext highlighter-rouge">myffmpeg</code>.</li>
  <li>في وحدة أخرى تُسمى <code class="language-plaintext highlighter-rouge">ffmpeg-jni</code>، قم بربط <code class="language-plaintext highlighter-rouge">myffmpeg</code> داخلها، ثم قم بإنشاء ملف <code class="language-plaintext highlighter-rouge">.so</code> المطلوب في النهاية.</li>
</ol>

<p>بالإضافة إلى ذلك، يجب وضع ملف <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> الذي تم تجميعه في دليل <code class="language-plaintext highlighter-rouge">jni</code> لضمان العثور عليه أثناء عملية الربط.</p>

<hr />

<h2 id="تصحيح-ffmpeg">تصحيح FFmpeg</h2>

<p>عندما تعمل مع FFmpeg، قد تواجه مشاكل تتطلب منك تصحيح الأخطاء. إليك بعض الخطوات التي يمكنك اتباعها لتصحيح FFmpeg:</p>

<h3 id="1-تفعيل-وضع-التصحيح-debug-mode">1. <strong>تفعيل وضع التصحيح (Debug Mode)</strong></h3>
<p>يمكنك تفعيل وضع التصحيح في FFmpec باستخدام الخيار <code class="language-plaintext highlighter-rouge">-loglevel debug</code>. هذا سيظهر معلومات تفصيلية عن العملية التي يقوم بها FFmpeg.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-loglevel</span> debug <span class="nt">-i</span> input.mp4 output.avi
</code></pre></div></div>

<h3 id="2-استخدام--report-لإنشاء-تقرير">2. <strong>استخدام <code class="language-plaintext highlighter-rouge">-report</code> لإنشاء تقرير</strong></h3>
<p>يمكنك استخدام الخيار <code class="language-plaintext highlighter-rouge">-report</code> لإنشاء تقرير يحتوي على معلومات مفصلة عن العملية. هذا التقرير يمكن أن يكون مفيدًا في تحديد المشاكل.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-i</span> input.mp4 <span class="nt">-report</span> output.avi
</code></pre></div></div>

<p>سيتم إنشاء ملف تقرير في نفس الدليل الذي يتم تنفيذ الأمر منه.</p>

<h3 id="3-فحص-ملفات-السجل-log-files">3. <strong>فحص ملفات السجل (Log Files)</strong></h3>
<p>إذا كنت تواجه مشاكل معينة، يمكنك فحص ملفات السجل التي يتم إنشاؤها بواسطة FFmpeg. هذه الملفات تحتوي على معلومات مفصلة عن الأخطاء والتحذيرات.</p>

<h3 id="4-استخدام--v-لزيادة-مستوى-التفاصيل">4. <strong>استخدام <code class="language-plaintext highlighter-rouge">-v</code> لزيادة مستوى التفاصيل</strong></h3>
<p>يمكنك استخدام الخيار <code class="language-plaintext highlighter-rouge">-v</code> لزيادة مستوى التفاصيل في المخرجات. على سبيل المثال، <code class="language-plaintext highlighter-rouge">-v verbose</code> أو <code class="language-plaintext highlighter-rouge">-v debug</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-v</span> debug <span class="nt">-i</span> input.mp4 output.avi
</code></pre></div></div>

<h3 id="5-التأكد-من-الإصدار-والتكوين">5. <strong>التأكد من الإصدار والتكوين</strong></h3>
<p>أحيانًا تكون المشاكل مرتبطة بإصدار معين من FFmpeg أو التكوين الذي تم استخدامه لبناء FFmpeg. يمكنك التحقق من الإصدار والتكوين باستخدام الأمر التالي:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-version</span>
</code></pre></div></div>

<h3 id="6-استخدام--benchmark-لقياس-الأداء">6. <strong>استخدام <code class="language-plaintext highlighter-rouge">-benchmark</code> لقياس الأداء</strong></h3>
<p>إذا كنت تواجه مشاكل في الأداء، يمكنك استخدام الخيار <code class="language-plaintext highlighter-rouge">-benchmark</code> لقياس الوقت الذي تستغرقه كل عملية.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-benchmark</span> <span class="nt">-i</span> input.mp4 output.avi
</code></pre></div></div>

<h3 id="7-التأكد-من-توفر-المكتبات-المطلوبة">7. <strong>التأكد من توفر المكتبات المطلوبة</strong></h3>
<p>تأكد من أن جميع المكتبات المطلوبة متوفرة ومثبتة بشكل صحيح. يمكنك استخدام الأمر <code class="language-plaintext highlighter-rouge">ffmpeg -buildconf</code> للتحقق من التكوين والمكتبات المستخدمة.</p>

<h3 id="8-استخدام--f-لتحديد-التنسيق">8. <strong>استخدام <code class="language-plaintext highlighter-rouge">-f</code> لتحديد التنسيق</strong></h3>
<p>إذا كنت تواجه مشاكل في تحديد التنسيق، يمكنك استخدام الخيار <code class="language-plaintext highlighter-rouge">-f</code> لتحديد التنسيق يدويًا.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ffmpeg <span class="nt">-f</span> mp4 <span class="nt">-i</span> input.mp4 output.avi
</code></pre></div></div>

<h3 id="9-التأكد-من-صحة-ملف-الإدخال">9. <strong>التأكد من صحة ملف الإدخال</strong></h3>
<p>أحيانًا تكون المشاكل مرتبطة بملف الإدخال نفسه. تأكد من أن ملف الإدخال صالح ولا يحتوي على أخطاء.</p>

<h3 id="10-طلب-المساعدة-من-المجتمع">10. <strong>طلب المساعدة من المجتمع</strong></h3>
<p>إذا لم تتمكن من حل المشكلة بنفسك، يمكنك طلب المساعدة من مجتمع FFmpeg عبر منصات مثل Stack Overflow أو قوائم البريد الإلكتروني الخاصة بـ FFmpeg.</p>

<p>باتباع هذه الخطوات، يمكنك تصحيح معظم المشاكل التي تواجهها أثناء العمل مع FFmpeg.</p>

<p>بعد نقل FFmpeg، غالبًا ما نحتاج إلى تصحيح الأخطاء في طبقة C من أجل استدعاء الوظائف عبر JNI. إذا كان بإمكاننا رؤية سجلات الإخراج التفصيلية كما في سطر الأوامر، فسيكون من الأسهل تحديد المشكلات.</p>

<p>في Eclipse، يمكنك الضغط على مفتاح <kbd>Ctrl</kbd> والنقر على موقع استدعاء مشابه لـ <code class="language-plaintext highlighter-rouge">av_log</code> لتتبع تنفيذ الدالة <code class="language-plaintext highlighter-rouge">av_log_default_callback</code> الموجودة في <code class="language-plaintext highlighter-rouge">ffmpeg/libavutil/log.c</code>. هذه الدالة تستدعي <code class="language-plaintext highlighter-rouge">__android_log_print</code> الخاص بـ Android لطباعة الرسائل في Logcat. من خلال مراجعة هذه المخرجات، يمكنك معرفة الحالة الداخلية لـ FFmpeg، مما يساعد في استكشاف الأخطاء مثل فشل التوليف أو عدم دعم ترميز معين.</p>

<p>أحيانًا، قد يلقي FFmpeg استثناءً يتسبب في تعطل التطبيق. يمكن استخدام الأمر التالي لتحديد المشكلة:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell logcat | ndk-stack <span class="nt">-sym</span> obj/local/armeabi
</code></pre></div></div>

<p><strong>ملاحظة:</strong> الكود أعلاه يستخدم أوامر <code class="language-plaintext highlighter-rouge">adb</code> و <code class="language-plaintext highlighter-rouge">ndk-stack</code> لتحليل سجلات الأخطاء (logcat) في تطبيقات Android التي تستخدم NDK (Native Development Kit). لا يتم ترجمة الأوامر أو المسارات لأنها أسماء أوامر محددة في نظام Android.</p>

<p>إذا كان لدى FFmpeg الأصلي <code class="language-plaintext highlighter-rouge">main()</code> في النهاية <code class="language-plaintext highlighter-rouge">exit(0)</code>، يرجى تذكر تعليقها، وإلا سيؤدي ذلك إلى خروج التطبيق.</p>

<h3 id="تسريب-الذاكرة-وحلول-service">تسريب الذاكرة وحلول Service</h3>

<p>تسريب الذاكرة (Memory Leak) هو مشكلة شائعة في تطوير التطبيقات، حيث يتم تخصيص جزء من الذاكرة ولكن لا يتم تحريره بعد الانتهاء من استخدامه. مع مرور الوقت، يمكن أن يؤدي ذلك إلى استهلاك كبير للذاكرة، مما يؤثر على أداء التطبيق وقد يتسبب في تعطيله.</p>

<p>في سياق تطبيقات Android، يمكن أن تحدث تسريبات الذاكرة عند استخدام <code class="language-plaintext highlighter-rouge">Service</code> بشكل غير صحيح. على سبيل المثال، إذا تم تشغيل <code class="language-plaintext highlighter-rouge">Service</code> ولم يتم إيقافه بشكل صحيح، فقد يستمر في استهلاك الذاكرة حتى بعد أن لا تكون هناك حاجة إليه.</p>

<h4 id="حلول-لتجنب-تسريب-الذاكرة-مع-service">حلول لتجنب تسريب الذاكرة مع Service</h4>

<ol>
  <li><strong>استخدام <code class="language-plaintext highlighter-rouge">IntentService</code> بدلاً من <code class="language-plaintext highlighter-rouge">Service</code></strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">IntentService</code> هي فئة فرعية من <code class="language-plaintext highlighter-rouge">Service</code> تقوم تلقائيًا بإيقاف نفسها بعد الانتهاء من معالجة جميع الطلبات. هذا يقلل من خطر تسريب الذاكرة.</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyIntentService</span> <span class="kd">extends</span> <span class="nc">IntentService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">MyIntentService</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">"MyIntentService"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onHandleIntent</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// تنفيذ المهام هنا</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><strong>إيقاف <code class="language-plaintext highlighter-rouge">Service</code> بشكل صحيح</strong>:
    <ul>
      <li>إذا كنت تستخدم <code class="language-plaintext highlighter-rouge">Service</code> مباشرة، تأكد من إيقافه بشكل صحيح بعد الانتهاء من استخدامه. يمكن القيام بذلك عن طريق استدعاء <code class="language-plaintext highlighter-rouge">stopSelf()</code> داخل <code class="language-plaintext highlighter-rouge">Service</code>.</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyService</span> <span class="kd">extends</span> <span class="nc">Service</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">onStartCommand</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startId</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// تنفيذ المهام هنا</span>
        <span class="n">stopSelf</span><span class="o">();</span> <span class="c1">// إيقاف الـ Service بعد الانتهاء</span>
        <span class="k">return</span> <span class="no">START_NOT_STICKY</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="nc">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><strong>استخدام <code class="language-plaintext highlighter-rouge">JobScheduler</code> أو <code class="language-plaintext highlighter-rouge">WorkManager</code></strong>:
    <ul>
      <li>بدلاً من استخدام <code class="language-plaintext highlighter-rouge">Service</code>، يمكنك استخدام <code class="language-plaintext highlighter-rouge">JobScheduler</code> أو <code class="language-plaintext highlighter-rouge">WorkManager</code> لإدارة المهام الخلفية. هذه الأدوات مصممة لإدارة الموارد بشكل أكثر كفاءة وتقليل خطر تسريب الذاكرة.</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// مثال باستخدام WorkManager</span>
<span class="nc">WorkManager</span> <span class="n">workManager</span> <span class="o">=</span> <span class="nc">WorkManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="n">workManager</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">OneTimeWorkRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="nc">MyWorker</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
  <li><strong>مراقبة الذاكرة باستخدام أدوات مثل <code class="language-plaintext highlighter-rouge">LeakCanary</code></strong>:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">LeakCanary</code> هي مكتبة تساعد في اكتشاف تسريبات الذاكرة في تطبيقات Android. يمكنك إضافتها إلى مشروعك لمراقبة الذاكرة واكتشاف التسريبات بسهولة.</li>
    </ul>

    <div class="language-gradle highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">debugImplementation</span> <span class="s1">'com.squareup.leakcanary:leakcanary-android:2.7'</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>باتباع هذه الممارسات، يمكنك تقليل خطر تسريب الذاكرة في تطبيقات Android الخاصة بك، مما يؤدي إلى تحسين الأداء وتجربة المستخدم.</p>

<p>بعد اكتمال التوليف، إذا ظهر خطأ <code class="language-plaintext highlighter-rouge">"INVALID HEAP ADDRESS IN dlfree ffmpeg"</code> عند الاستدعاء مرة أخرى، فمن المرجح أن يكون ذلك بسبب عدم تحرير ذاكرة FFmpeg بشكل كامل. إحدى الحلول الوسطية هي وضع عملية التوليف في <code class="language-plaintext highlighter-rouge">Service</code> منفصل، وبعد اكتمال التوليف، يتم إنهاء هذا الـ Service لتنظيف الموارد.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- AndroidManifest.xml --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">".FFmpegService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>من خلال تسجيل <code class="language-plaintext highlighter-rouge">Receiver</code> وما شابه، وإنهاء الخدمة بشكل تلقائي بعد اكتمال التركيب، يمكن تجنب مشاكل الذاكرة الناتجة عن الاستدعاءات المتكررة.</p>

<hr />

<h2 id="المشكلات-المحتملة">المشكلات المحتملة</h2>

<ul>
  <li><strong>مشاكل تشغيل ملفات AAC</strong><br />
قد لا تتمكن بعض الأجهزة (مثل Xiaomi 2s) من تشغيل الصوت المُشفّر بتنسيق AAC باستخدام <code class="language-plaintext highlighter-rouge">MediaPlayer</code> الافتراضي.</li>
  <li><strong>دعم غير كافٍ للمُشفِّرات</strong><br />
إذا كنت ترغب في دعم تنسيقات مثل AMR-NB وMP3، يجب تمكين الخيارات المناسبة يدويًا عند تجميع FFmpeg. إذا لم يتمكن البرنامج النصي للتجميع من العثور على المكتبات أو ملفات الرأس ذات الصلة، فسيتم إيقاف العملية وإرجاع خطأ.</li>
  <li><strong>سرعة التوليف</strong><br />
قد يستغرق توليف مقطع فيديو مدته 10 ثوانٍ بدقة 1280×720 مع مزج الصوت ما بين عشرات الثواني إلى دقيقة كاملة. من حيث تجربة المستخدم، قد يكون من الأفضل السماح للمستخدم بمعاينة الصوت قبل اتخاذ قرار التوليف النهائي.</li>
</ul>

<p>في التنفيذ الفعلي لتطبيقات دبلجة الصوت، تكون الممارسات الشائعة كالتالي:</p>
<ol>
  <li>تحميل الفيديو الأصلي، والترجمات، وملف الصوت الذي تمت إزالة المقاطع التي تحتاج إلى دبلجة منه مسبقًا.</li>
  <li>تسجيل صوت المستخدم، وعند التوليف، يتم فقط دمج التسجيل مع المقاطع الصامتة.</li>
  <li>إذا لم تكن راضيًا عن وقت التوليف المحلي، يمكنك اختيار تحميل بيانات الصوت والفيديو إلى الخادم، حيث يتم التوليف على جانب الخادم، ثم يتم التنزيل بعد الانتهاء.</li>
</ol>

<hr />

<h2 id="استخدام-ndk-في-eclipse">استخدام NDK في Eclipse</h2>

<p>ليس من الضروري إدخال <code class="language-plaintext highlighter-rouge">ndk-build</code> في سطر الأوامر. يمكنك ببساطة النقر بزر الماوس الأيمن على المشروع في Eclipse، ثم اختيار <strong>Android Tools → Add Native Support</strong>، وبعد ذلك سيتم تنفيذ <code class="language-plaintext highlighter-rouge">ndk-build</code> تلقائيًا في كل مرة تضغط فيها على “Run”.</p>

<h3 id="إنشاء-ملفات-رأس-jni-بنقرة-واحدة">إنشاء ملفات رأس JNI بنقرة واحدة</h3>

<p>كتابة ملفات رؤوس دوال JNI يمكن أن تكون عملية مرهقة، ولكن يمكن تسهيلها باستخدام الأمر <code class="language-plaintext highlighter-rouge">javah</code> الذي يقوم بإنشائها تلقائيًا.<br />
في بيئة Eclipse، يمكنك تكوين الأمر كأداة خارجية واستخدام أمر مشابه لما يلي لإنشاء ملف الرأس:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javah <span class="nt">-jni</span> <span class="nt">-classpath</span> bin/classes <span class="nt">-d</span> jni com.example.ffmpeg.MyFFmpeg
</code></pre></div></div>

<p>بعد التنفيذ، سيتم إنشاء ملف مشابه لـ <code class="language-plaintext highlighter-rouge">com_example_ffmpeg_MyFFmpeg.h</code> في دليل <code class="language-plaintext highlighter-rouge">jni</code>. بعد ذلك، كل ما عليك فعله هو تضمينه (<code class="language-plaintext highlighter-rouge">#include</code>) في كود C الخاص بك وتنفيذ الوظائف المقابلة.</p>

<hr />

<h2 id="الخلاصة">الخلاصة</h2>

<p>يتطلب نقل FFmpeg إلى Android معرفة متعددة الجوانب، بما في ذلك تكوين بيئة NDK، وتجميع وربط C/C++، واستدعاء JNI، وتشفير وفك تشفير الصوت والفيديو، وغيرها. إذا واجهت مشاكل مثل عدم القدرة على التوليف، أو عدم دعم بعض التنسيقات، أو أخطاء في الربط، فأنت بحاجة إلى التحقق بعناية من التكوين وسجلات الإخراج. آمل أن تساعدك هذه المقالة في تجنب بعض المشاكل. إذا كنت تستخدم FFmpeg أيضًا، فلا تتردد في مشاركة تجاربك أو مشاكلك في قسم التعليقات، للتبادل والتعلم المتبادل.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-ar" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
