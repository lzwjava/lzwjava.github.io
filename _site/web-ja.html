<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Webプログラミング入門</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Webプログラミング入門 | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Webプログラミング入門" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="ja" />
<meta name="description" content="前回、私たちはフィボナッチ数列の機能をオブジェクト指向のバージョンに書き換え、ターミナルインターフェースを実装しました。" />
<meta property="og:description" content="前回、私たちはフィボナッチ数列の機能をオブジェクト指向のバージョンに書き換え、ターミナルインターフェースを実装しました。" />
<link rel="canonical" href="https://lzwjava.github.io/web-ja" />
<meta property="og:url" content="https://lzwjava.github.io/web-ja" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-07T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Webプログラミング入門" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2021-03-07T00:00:00+08:00","datePublished":"2021-03-07T00:00:00+08:00","description":"前回、私たちはフィボナッチ数列の機能をオブジェクト指向のバージョンに書き換え、ターミナルインターフェースを実装しました。","headline":"Webプログラミング入門","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/web-ja"},"url":"https://lzwjava.github.io/web-ja"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=6bec149fe21cbe552195625c12f7a703cf10a122">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=6bec149fe21cbe552195625c12f7a703cf10a122" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Webプログラミング入門 | オリジナル、AI翻訳
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/ja/2021-03-07-web-ja.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsja2021-03-07-web-ja.md</span> -->
      

      <!-- <span>2021-03-07-web-ja.md</span> -->

      
        

        
          
          <a href="#" class="button">2021.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/web-en" >English</option>
        <option value="/web-zh" >中文</option>
        <option value="/web-ja" selected>日本語</option>
        <option value="/web-es" >Español</option>
        <option value="/web-hi" >हिंदी</option>
        <option value="/web-fr" >Français</option>
        <option value="/web-de" >Deutsch</option>
        <option value="/web-ar" >العربية</option>
        <option value="/web-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>前回、私たちはフィボナッチ数列の機能をオブジェクト指向のバージョンに書き換え、ターミナルインターフェースを実装しました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sb">`server.py`</span><span class="err">：</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Server</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlerClass</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">handlerClass</span> <span class="o">=</span> <span class="n">handlerClass</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">request</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">handlerClass</span><span class="p">().</span><span class="n">handle</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fib_handle.py</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">BaseHandler</span><span class="p">,</span> <span class="n">Server</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FibHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'f(n)='</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">FibHandler</code>というクラスを定義しています。このクラスは<code class="language-plaintext highlighter-rouge">BaseHandler</code>を継承しており、<code class="language-plaintext highlighter-rouge">handle</code>メソッドを持っています。<code class="language-plaintext highlighter-rouge">handle</code>メソッドは、文字列型の<code class="language-plaintext highlighter-rouge">request</code>を引数として受け取り、それを整数に変換して<code class="language-plaintext highlighter-rouge">n</code>に代入します。その後、<code class="language-plaintext highlighter-rouge">f(n)</code>の結果を出力します。ただし、<code class="language-plaintext highlighter-rouge">f(n)</code>の具体的な実装はこのコードには含まれていません。最後に<code class="language-plaintext highlighter-rouge">pass</code>が記述されていますが、これは何も実行しないことを示しています。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">FibHandler</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></div>
<h2 id="シンプルなwebサーバー">シンプルなWebサーバー</h2>

<p>では、<code class="language-plaintext highlighter-rouge">Web</code>インターフェースに変更するにはどうすればよいでしょうか。</p>

<p>上の<code class="language-plaintext highlighter-rouge">Server</code>を<code class="language-plaintext highlighter-rouge">HTTPプロトコル</code>の<code class="language-plaintext highlighter-rouge">Server</code>に置き換えれば良いのです。まず、Pythonにおける<code class="language-plaintext highlighter-rouge">HTTPサーバー</code>がどのようなものか見てみましょう。</p>

<p>Pythonの標準ライブラリには、ウェブサーバーが提供されています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python -m http.server
</code></pre></div></div>

<p>このコマンドは、Pythonの組み込みHTTPサーバーを起動するものです。デフォルトでは、現在のディレクトリをルートとして、ポート8000でサーバーが立ち上がります。ブラウザで<code class="language-plaintext highlighter-rouge">http://localhost:8000</code>にアクセスすると、ディレクトリ内のファイルを閲覧できます。</p>

<p>ターミナルで実行します。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-m</span> http.server
HTTPを::のポート8000で提供中 <span class="o">(</span>http://[::]:8000/<span class="o">)</span> ...
</code></pre></div></div>

<p>ブラウザで開くと効果を確認できます。</p>

<p><img src="/assets/images/web/webserver.png" alt="webserver" style="zoom:50%;" /></p>

<p>これで現在のディレクトリがリストアップされました。次に、このウェブページを閲覧している間に、ターミナルに戻ってみてください。すると、面白いことが起こります。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-m</span> http.server
HTTPを::のポート8000で提供中 <span class="o">(</span>http://[::]:8000/<span class="o">)</span> ...
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET / HTTP/1.1"</span> 200 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] コード404, メッセージ ファイルが見つかりません
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /favicon.ico HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] コード404, メッセージ ファイルが見つかりません
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /apple-touch-icon-precomposed.png HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] コード404, メッセージ ファイルが見つかりません
::1 - - <span class="o">[</span>07/Mar/2021 15:30:35] <span class="s2">"GET /apple-touch-icon.png HTTP/1.1"</span> 404 -
::1 - - <span class="o">[</span>07/Mar/2021 15:30:38] <span class="s2">"GET / HTTP/1.1"</span> 200 -
</code></pre></div></div>

<p>これはウェブアクセスログです。その中で、<code class="language-plaintext highlighter-rouge">GET</code>はウェブサービスにおけるデータアクセス操作の一種を表しています。<code class="language-plaintext highlighter-rouge">HTTP/1.1</code>は、<code class="language-plaintext highlighter-rouge">HTTP</code>の<code class="language-plaintext highlighter-rouge">1.1</code>バージョンのプロトコルが使用されていることを示しています。</p>

<p>それを使って私たちのフィボナッチ数列サービスを作成する方法です。まず、オンラインでサンプルコードを探し、少し手を加えて、最もシンプルなWebサーバーを作成します：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s">"hi"</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>これらは見覚えがあるものばかりですね。ほとんど上で使用した<code class="language-plaintext highlighter-rouge">Server</code>と同じです。<code class="language-plaintext highlighter-rouge">SimpleHTTPRequestHandler</code>が基本クラスではなく、<code class="language-plaintext highlighter-rouge">BaseHTTPRequestHandler</code>というものがあることに気づきました。<code class="language-plaintext highlighter-rouge">SimpleHTTPRequestHandler</code>は比較的、いくつかの内容を追加処理しています。これらにフィボナッチ数列の処理機能を加えるのは簡単です。</p>

<p>ここでの<code class="language-plaintext highlighter-rouge">127.0.0.1</code>はローカルマシンのアドレスを表し、<code class="language-plaintext highlighter-rouge">8000</code>はローカルマシンのポートを表します。ポートはどのように理解すればよいでしょうか。家の窓のようなもので、家と外界がコミュニケーションを取るための窓口です。<code class="language-plaintext highlighter-rouge">bytes</code>は文字列をバイトに変換することを意味します。<code class="language-plaintext highlighter-rouge">utf-8</code>は文字列のエンコード方式の一つです。<code class="language-plaintext highlighter-rouge">send_response</code>、<code class="language-plaintext highlighter-rouge">send_header</code>、<code class="language-plaintext highlighter-rouge">end_headers</code>はすべて、<code class="language-plaintext highlighter-rouge">HTTP</code>プロトコルで規定された内容を出力するためのもので、ブラウザが理解できるようにするためのものです。これにより、ウェブページに<code class="language-plaintext highlighter-rouge">hi</code>と表示されます。</p>

<p><img src="/assets/images/web/hi.png" alt="hi" style="zoom:50%;" /></p>

<p>次に、リクエストからパラメータを取得してみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>      
        <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>      
        <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>          
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>
</code></pre></div></div>

<p>このコードは、HTTP GETリクエストを処理するためのシンプルなハンドラクラスです。以下にその動作を説明します：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">do_GET</code>メソッドは、GETリクエストが来たときに呼び出されます。</li>
  <li><code class="language-plaintext highlighter-rouge">send_response(200)</code>で、HTTPステータスコード200（OK）を返します。</li>
  <li><code class="language-plaintext highlighter-rouge">send_header</code>で、レスポンスのコンテンツタイプを<code class="language-plaintext highlighter-rouge">text</code>に設定します。</li>
  <li><code class="language-plaintext highlighter-rouge">end_headers</code>でヘッダーの送信を終了します。</li>
  <li><code class="language-plaintext highlighter-rouge">urlparse</code>を使って、リクエストのパスを解析します。</li>
  <li><code class="language-plaintext highlighter-rouge">parse_qs</code>を使って、クエリ文字列を解析します。</li>
  <li><code class="language-plaintext highlighter-rouge">result</code>変数を空の文字列で初期化します。</li>
  <li>クエリ文字列が存在する場合、最初のクエリパラメータを取得し、それを整数に変換します。</li>
  <li>その整数を関数<code class="language-plaintext highlighter-rouge">f</code>に渡し、結果を文字列に変換して<code class="language-plaintext highlighter-rouge">result</code>に格納します。</li>
  <li>最後に、<code class="language-plaintext highlighter-rouge">self.wfile.write</code>を使って、結果をクライアントに送信します。</li>
</ol>

<p>このコードは、特定の関数<code class="language-plaintext highlighter-rouge">f</code>に基づいてクエリパラメータを処理し、その結果を返すシンプルなHTTPサーバーの一部として使用されることが想定されています。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/web/n10.png" alt="n10" style="zoom:50%;" /></p>

<p>少し複雑ですね。ここではいくつかのパラメータを解析しています。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self.path<span class="o">=</span>/?n<span class="o">=</span>3
<span class="nv">parsed</span><span class="o">=</span>ParseResult<span class="o">(</span><span class="nv">scheme</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">netloc</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">path</span><span class="o">=</span><span class="s1">'/'</span>, <span class="nv">params</span><span class="o">=</span><span class="s1">''</span>, <span class="nv">query</span><span class="o">=</span><span class="s1">'n=3'</span>, <span class="nv">fragment</span><span class="o">=</span><span class="s1">''</span><span class="o">)</span>
<span class="nv">qs</span><span class="o">={</span><span class="s1">'n'</span>: <span class="o">[</span><span class="s1">'3'</span><span class="o">]}</span>
<span class="nv">ns</span><span class="o">=[</span><span class="s1">'3'</span><span class="o">]</span>
<span class="nv">n</span><span class="o">=</span>3
</code></pre></div></div>

<p>上記のコードは、URLのクエリパラメータを解析する過程を示しています。具体的には、<code class="language-plaintext highlighter-rouge">self.path</code>に指定されたURLのクエリ部分を解析し、<code class="language-plaintext highlighter-rouge">n</code>というパラメータの値を取得しています。以下に各ステップの説明を日本語で示します。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">self.path=/?n=3</code>: URLのパスとクエリパラメータが<code class="language-plaintext highlighter-rouge">/?n=3</code>として指定されています。</li>
  <li><code class="language-plaintext highlighter-rouge">parsed=ParseResult(scheme='', netloc='', path='/', params='', query='n=3', fragment='')</code>: URLが解析され、各部分が分割されています。<code class="language-plaintext highlighter-rouge">query='n=3'</code>の部分がクエリパラメータを示しています。</li>
  <li><code class="language-plaintext highlighter-rouge">qs={'n': ['3']}</code>: クエリパラメータが辞書形式で解析され、<code class="language-plaintext highlighter-rouge">n</code>というキーに対して<code class="language-plaintext highlighter-rouge">['3']</code>という値がリスト形式で格納されています。</li>
  <li><code class="language-plaintext highlighter-rouge">ns=['3']</code>: <code class="language-plaintext highlighter-rouge">n</code>の値がリストとして抽出されています。</li>
  <li><code class="language-plaintext highlighter-rouge">n=3</code>: 最終的に、<code class="language-plaintext highlighter-rouge">n</code>の値が<code class="language-plaintext highlighter-rouge">3</code>として取得されています。</li>
</ul>

<p>このコードは、URLから特定のクエリパラメータを抽出し、その値を利用するための一連の処理を示しています。</p>

<h2 id="再帰の応用">再帰の応用</h2>

<p>少しコードをリファクタリングしてみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">fib</span> <span class="kn">import</span> <span class="n">f</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Handler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">parse_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
      <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">qs</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="s">'n'</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="k">return</span> <span class="n">n</span>
      <span class="k">return</span> <span class="bp">None</span>
      
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text'</span><span class="p">)</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
</code></pre></div></div>

<p>上記のコードは、URLからクエリパラメータ <code class="language-plaintext highlighter-rouge">n</code> を解析し、その値を整数として返す <code class="language-plaintext highlighter-rouge">parse_n</code> メソッドと、HTTP GETリクエストを処理する <code class="language-plaintext highlighter-rouge">do_GET</code> メソッドを定義しています。<code class="language-plaintext highlighter-rouge">parse_n</code> メソッドは、URLが与えられると、そのクエリパラメータを解析し、<code class="language-plaintext highlighter-rouge">n</code> の値を返します。<code class="language-plaintext highlighter-rouge">do_GET</code> メソッドは、HTTPレスポンスのステータスコード200を送信し、コンテンツタイプをテキストとして設定します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">parse_n</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
<span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
              
<span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>
<span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">"utf-8"</span><span class="p">))</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">self.parse_n(self.path)</code> を使ってパスから数値 <code class="language-plaintext highlighter-rouge">n</code> を解析し、それが <code class="language-plaintext highlighter-rouge">None</code> でない場合に <code class="language-plaintext highlighter-rouge">f(n)</code> を計算して結果を文字列に変換しています。その後、その結果を2回 <code class="language-plaintext highlighter-rouge">self.wfile.write</code> を使ってUTF-8エンコードで書き込んでいます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">parse_n</code> 関数を導入して、リクエストパスから解析された <code class="language-plaintext highlighter-rouge">n</code> をカプセル化します。</p>

<p>现在程序有这样的问题。小王请求了斐波那契数列的第10000位，过了一些天，小明又请求了斐波那契数列的第10000位。两次，小王和小明都等待了半天，才得到结果。我们该如何提高这个<code class="language-plaintext highlighter-rouge">Web服务</code>的效率呢。</p>

<h3 id="解决方案">解决方案</h3>

<ol>
  <li><strong>缓存结果</strong>：
    <ul>
      <li>使用缓存机制（如Redis或Memcached）来存储已经计算过的斐波那契数列的结果。这样，当有相同的请求时，可以直接从缓存中获取结果，而不需要重新计算。</li>
    </ul>
  </li>
  <li><strong>预计算</strong>：
    <ul>
      <li>如果知道某些斐波那契数列的值会被频繁请求，可以预先计算这些值并存储在数据库中。这样，当请求到来时，可以直接从数据库中获取结果。</li>
    </ul>
  </li>
  <li><strong>优化算法</strong>：
    <ul>
      <li>使用更高效的算法来计算斐波那契数列。例如，使用矩阵快速幂算法或动态规划算法来减少计算时间。</li>
    </ul>
  </li>
  <li><strong>异步处理</strong>：
    <ul>
      <li>将计算任务放入消息队列中，由后台任务异步处理。这样，用户请求不会阻塞，可以立即返回一个任务ID，用户可以通过这个ID来查询计算结果。</li>
    </ul>
  </li>
  <li><strong>分布式计算</strong>：
    <ul>
      <li>如果计算量非常大，可以考虑使用分布式计算框架（如Hadoop或Spark）来并行计算斐波那契数列。</li>
    </ul>
  </li>
</ol>

<h3 id="代码示例">代码示例</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="o">@</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># 使用缓存后的斐波那契函数
</span><span class="n">result</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div></div>

<p>通过以上方法，可以显著提高<code class="language-plaintext highlighter-rouge">Web服务</code>的效率，减少用户等待时间。</p>

<p><code class="language-plaintext highlighter-rouge">n</code>が同じ場合、<code class="language-plaintext highlighter-rouge">f(n)</code>の値は常に同じであることに気づきました。私たちはいくつかの実験を行いました。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 - - <span class="o">[</span>10/Mar/2021 00:33:01] <span class="s2">"GET /?n=1000 HTTP/1.1"</span> 200 -
<span class="nt">----------------------------------------</span>
リクエストの処理中に例外が発生しました。送信元: <span class="o">(</span><span class="s1">'127.0.0.1'</span>, 50783<span class="o">)</span>
トレースバック（最近の呼び出しを最後に）:
    ...
    <span class="k">if </span>v[n] <span class="o">!=</span> <span class="nt">-1</span>:
IndexError: リストのインデックスが範囲外です
</code></pre></div></div>

<p>元の配列が十分に大きくなかったので、v配列を10000に変更しましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、空のリスト <code class="language-plaintext highlighter-rouge">v</code> を作成し、0から9999までの範囲でループを回して、リスト <code class="language-plaintext highlighter-rouge">v</code> に <code class="language-plaintext highlighter-rouge">-1</code> を10000回追加しています。結果として、<code class="language-plaintext highlighter-rouge">v</code> は <code class="language-plaintext highlighter-rouge">-1</code> が10000個含まれたリストになります。</p>

<p>しかし、nが<code class="language-plaintext highlighter-rouge">2000</code>の場合、再帰の深さがオーバーフローするエラーが発生しました：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 - - <span class="o">[</span>10/Mar/2021 00:34:00] <span class="s2">"GET /?n=2000 HTTP/1.1"</span> 200 -
<span class="nt">----------------------------------------</span>
リクエストの処理中に例外が発生しました。送信元: <span class="o">(</span><span class="s1">'127.0.0.1'</span>, 50821<span class="o">)</span>
トレースバック <span class="o">(</span>直近の呼び出し最後<span class="o">)</span>:
    ...
    <span class="k">if </span>v[n] <span class="o">!=</span> <span class="nt">-1</span>:
RecursionError: 比較中に最大再帰深度を超えました
</code></pre></div></div>

<p>しかし、これらすべてはかなり迅速に進みました。</p>

<p>なぜなら、<code class="language-plaintext highlighter-rouge">f(1)</code>から<code class="language-plaintext highlighter-rouge">f(1000)</code>まで、それぞれ一度だけ計算すればよいからです。これは、<code class="language-plaintext highlighter-rouge">f(1000)</code>を計算するとき、<code class="language-plaintext highlighter-rouge">+</code>演算が約1000回しか実行されないことを意味します。私たちは、<code class="language-plaintext highlighter-rouge">Python</code>の再帰深度が約1000であることを知っています。これは、プログラムを最適化するために、2000を計算したい場合、まず1000を計算するという方法を取ることができることを意味します。しかし、この方法でも<code class="language-plaintext highlighter-rouge">再帰深度オーバーフローエラー</code>が発生する可能性があります。2000を計算したい場合、まず1200を計算します。1200を計算したい場合、まず400を計算します。</p>

<p>このように400と1200を計算した後、2000を計算すると、再帰の深さは約800程度になり、再帰の深さによるオーバーフローエラーは発生しなくなります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">fplus</code>関数を追加しました。</p>

<p>しかし、<code class="language-plaintext highlighter-rouge">fplus</code>が1000回再帰的に呼び出された場合を考えると、1000 * 800 = 800000となります。nを80万に設定した後、再び再帰深度エラーが発生しました。さらに試してみると、事態はさらに複雑であることがわかりました。しかし、この最適化の後、2000を計算することは非常に簡単になりました。</p>

<h2 id="ファイルの読み書き">ファイルの読み書き</h2>

<p>話がそれてしまったようです。Web開発の話題に戻りましょう。最初のリクエストで<code class="language-plaintext highlighter-rouge">f(400)</code>を、次のリクエストで<code class="language-plaintext highlighter-rouge">f(600)</code>を求めるとします。2回目のリクエストでは、1回目のリクエストで生成された<code class="language-plaintext highlighter-rouge">v</code>配列の値を利用することができます。しかし、プログラムを終了して再起動すると、その値は使えなくなります。私たちの方法では、フィボナッチ数列の計算は非常に速いです。しかし、もし計算が遅い場合を考えてみてください。特に、<code class="language-plaintext highlighter-rouge">v</code>配列を導入していない場合、大量の重複計算が発生します。このような場合、せっかく得られた結果を保存しておきたいと思うでしょう。</p>

<p>この時、<code class="language-plaintext highlighter-rouge">キャッシュ</code>の概念が導入されます。<code class="language-plaintext highlighter-rouge">v</code>配列はここではキャッシュとして機能します。ただし、これはプログラムのライフサイクル内にのみ存在します。プログラムが終了すると、それは消えてしまいます。では、どうすれば良いでしょうか。自然な考えとして、ファイルに保存することが思い浮かびます。</p>

<p>v配列をファイルに保存するにはどうすればいいですか。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0
1 1
2 1
3 2
4 3
...
</code></pre></div></div>

<p>私たちの<code class="language-plaintext highlighter-rouge">v</code>配列は次のように保存することができます。各行を<code class="language-plaintext highlighter-rouge">n f(n)</code>として保存します。<code class="language-plaintext highlighter-rouge">n</code>は自然に増加するため、おそらく<code class="language-plaintext highlighter-rouge">f(n)</code>の値だけを保存することができるでしょう。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
...
</code></pre></div></div>

<p>試してみてください。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"demofile2.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Now the file has more content!"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">demofile2.txt</code>というファイルを追記モード(<code class="language-plaintext highlighter-rouge">"a"</code>)で開き、ファイルの末尾に「Now the file has more content!」というテキストを追加し、その後ファイルを閉じます。</p>

<h1 id="ファイルを開いて追記後に読み取る">ファイルを開いて、追記後に読み取る：</h1>
<p>f = open(“demofile2.txt”, “r”)
print(f.read())</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
`open`の2番目の引数には`a`を指定できます。これはファイルの末尾に追加することを意味します。また、`w`を指定すると、ファイルを上書きします。

```python
file = open('fib_v', 'a')
file.write('hi')
file.close()
</code></pre></div></div>

<p>上記のコードは、ファイル <code class="language-plaintext highlighter-rouge">fib_v</code> を追記モード (<code class="language-plaintext highlighter-rouge">'a'</code>) で開き、そのファイルに文字列 <code class="language-plaintext highlighter-rouge">'hi'</code> を書き込み、最後にファイルを閉じる処理を行っています。このコードはPythonでファイル操作を行う基本的な例です。</p>

<p>実行してみると、確かに<code class="language-plaintext highlighter-rouge">fib_v</code>というファイルが生成されました。</p>

<p><code class="language-plaintext highlighter-rouge">fib_v</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hi
</code></pre></div></div>

<p>もう一度実行すると、このようになります。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hihi
</code></pre></div></div>

<p>改行するにはどうすればいいですか。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'a'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'hi</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、ファイル <code class="language-plaintext highlighter-rouge">fib_v</code> を追記モード (<code class="language-plaintext highlighter-rouge">'a'</code>) で開き、そのファイルに文字列 <code class="language-plaintext highlighter-rouge">'hi\n'</code> を書き込み、最後にファイルを閉じる処理を行います。</p>

<p>これは一度だけ出力され、<code class="language-plaintext highlighter-rouge">hihihi</code>が表示されますが、改行は見えません。しかし、もう一度出力すると、改行されます。これにより、最初の出力時にも改行文字が出力されていたことがわかりますが、末尾にあったため見えなかったのです。</p>

<p>どのように読み取るのでしょうか。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
</code></pre></div></div>

<p>このコードは、ファイル <code class="language-plaintext highlighter-rouge">fib_v</code> を読み取りモードで開き、その内容を読み取って出力します。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python fib.py
hihihi
hi
</code></pre></div></div>

<p>次に、私たちのフィボナッチプログラムを修正しましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
   <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
   <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
           <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
   <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_v'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
   <span class="n">s</span> <span class="o">=</span> <span class="s">''</span>
   <span class="n">start</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">vv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
         <span class="k">break</span>      
      <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
         <span class="n">s</span> <span class="o">+=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span>
      <span class="n">start</span> <span class="o">=</span> <span class="bp">False</span>   
      <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
   <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
   <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fcache</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="n">save</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read</span><span class="p">()</span>
<span class="n">fcache</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>ついにプログラムを書き終えました。プログラムを実行した後、<code class="language-plaintext highlighter-rouge">fib_v</code>ファイルは次のようになります。</p>

<p><code class="language-plaintext highlighter-rouge">fib_v</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
55
</code></pre></div></div>

<p>このコードブロックは、フィボナッチ数列の最初の11項を表示しています。フィボナッチ数列は、各項が前の2つの項の和となる数列で、0と1から始まります。この数列は、数学や自然界の多くの現象で見られる重要なパターンです。</p>

<p>上記の解析が少し面倒だと感じるかもしれません。<code class="language-plaintext highlighter-rouge">\n</code>は改行文字です。もっと簡単で統一的な解析方法はないでしょうか。そこで、人々は<code class="language-plaintext highlighter-rouge">JSON</code>というデータ形式を発明しました。</p>

<h2 id="json">JSON</h2>

<p>JSONの正式名称は<code class="language-plaintext highlighter-rouge">JavaScript Object Notation</code>です。以下は<code class="language-plaintext highlighter-rouge">JSON</code>の例です。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"John"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="nl">"city"</span><span class="p">:</span><span class="s2">"New York"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>このJSONデータは、名前が「John」、年齢が31歳、都市が「New York」であることを示しています。</p>

<p>以上のようにして、一種のマッピングを表現します。</p>

<p>JSONには以下の基本的な要素があります：</p>

<ol>
  <li>数字または文字列</li>
  <li>リスト</li>
  <li>マッピング</li>
</ol>

<p>これらの基本要素は自由にネストすることができます。つまり、リストの中にリストを含めることができます。マッピングの中にもリストを含めることができます。などなど。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"John"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cars"</span><span class="p">:[</span><span class="w"> </span><span class="s2">"Ford"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BMW"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Fiat"</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>このJSONデータは、以下の情報を表しています：</p>

<ul>
  <li><strong>name</strong>: “John”（名前はJohn）</li>
  <li><strong>age</strong>: 30（年齢は30歳）</li>
  <li><strong>cars</strong>: [“Ford”, “BMW”, “Fiat”]（所有している車はFord、BMW、Fiat）</li>
</ul>

<p>このデータは、Johnという人物の名前、年齢、そして所有する車のリストを表しています。</p>

<p>一行で書くのと、このように見やすく書くのとでは、意味の違いがあります。おそらく、それらの計算グラフを想像することができるでしょう。スペースは計算グラフに影響を与えません。</p>

<p>次に、v配列を<code class="language-plaintext highlighter-rouge">json</code>形式の文字列に変換します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fplus</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>このように書いたときに、エラーが発生しました。<code class="language-plaintext highlighter-rouge">TypeError: dump() missing 1 required positional argument: 'fp'</code>。<code class="language-plaintext highlighter-rouge">vscode</code>では、このように関数の定義を確認することができます。</p>

<p><img src="assets/images/web/json.png" alt="json" /></p>

<p><code class="language-plaintext highlighter-rouge">dump</code>の上にマウスを移動するだけでOKです。便利ですよね。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fplus</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
<span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">fplus</code>関数に引数<code class="language-plaintext highlighter-rouge">10</code>を渡して実行し、その結果を<code class="language-plaintext highlighter-rouge">fib_j</code>というファイルにJSON形式で保存するものです。具体的には、<code class="language-plaintext highlighter-rouge">fplus(10)</code>の結果を変数<code class="language-plaintext highlighter-rouge">v</code>に格納し、<code class="language-plaintext highlighter-rouge">json.dump</code>関数を使ってその内容をファイルに書き込んでいます。最後に、ファイルを閉じてリソースを解放しています。</p>

<p>100まで計算して表示するのは少し多いので、ここでは10に変更します。元のdumpの第二引数に<code class="language-plaintext highlighter-rouge">file</code>オブジェクトを渡せば良いことがわかりました。</p>

<p>以下のようにファイルを表示できます：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>このJSON配列は、フィボナッチ数列の一部と、その後ろに-1が3つ続く形で構成されています。フィボナッチ数列は、各数が直前の2つの数の和となる数列で、ここでは0, 1から始まっています。最後の3つの-1は、特定の意味を持たせるためのプレースホルダーか、データの終わりを示すマーカーとして使用されている可能性があります。</p>

<p>注意：後ろに多くの<code class="language-plaintext highlighter-rouge">-1</code>が省略されています。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sv</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">read()</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
</code></pre></div></div>

<p>この場合、以下のように出力されます：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
55
</code></pre></div></div>

<p>以下の関数を一緒に確認しましょう：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sv</span><span class="p">)):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sv</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>        
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'fib_j'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="nb">file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>read()
fplus(100)
save()
</code></pre></div></div>

<p>次にファイルを確認すると、確かに正しい値が保存されており、しかも整然としていました。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">377</span><span class="p">,</span><span class="w"> </span><span class="mi">610</span><span class="p">,</span><span class="w"> </span><span class="mi">987</span><span class="p">,</span><span class="w"> </span><span class="mi">1597</span><span class="p">,</span><span class="w"> </span><span class="mi">2584</span><span class="p">,</span><span class="w"> </span><span class="mi">4181</span><span class="p">,</span><span class="w"> </span><span class="mi">6765</span><span class="p">,</span><span class="w"> </span><span class="mi">10946</span><span class="p">,</span><span class="w"> </span><span class="mi">17711</span><span class="p">,</span><span class="w"> </span><span class="mi">28657</span><span class="p">,</span><span class="w"> </span><span class="mi">46368</span><span class="p">,</span><span class="w"> </span><span class="mi">75025</span><span class="p">,</span><span class="w"> </span><span class="mi">121393</span><span class="p">,</span><span class="w"> </span><span class="mi">196418</span><span class="p">,</span><span class="w"> </span><span class="mi">317811</span><span class="p">,</span><span class="w"> </span><span class="mi">514229</span><span class="p">,</span><span class="w"> </span><span class="mi">832040</span><span class="p">,</span><span class="w"> </span><span class="mi">1346269</span><span class="p">,</span><span class="w"> </span><span class="mi">2178309</span><span class="p">,</span><span class="w"> </span><span class="mi">3524578</span><span class="p">,</span><span class="w"> </span><span class="mi">5702887</span><span class="p">,</span><span class="w"> </span><span class="mi">9227465</span><span class="p">,</span><span class="w"> </span><span class="mi">14930352</span><span class="p">,</span><span class="w"> </span><span class="mi">24157817</span><span class="p">,</span><span class="w"> </span><span class="mi">39088169</span><span class="p">,</span><span class="w"> </span><span class="mi">63245986</span><span class="p">,</span><span class="w"> </span><span class="mi">102334155</span><span class="p">,</span><span class="w"> </span><span class="mi">165580141</span><span class="p">,</span><span class="w"> </span><span class="mi">267914296</span><span class="p">,</span><span class="w"> </span><span class="mi">433494437</span><span class="p">,</span><span class="w"> </span><span class="mi">701408733</span><span class="p">,</span><span class="w"> </span><span class="mi">1134903170</span><span class="p">,</span><span class="w"> </span><span class="mi">1836311903</span><span class="p">,</span><span class="w"> </span><span class="mi">2971215073</span><span class="p">,</span><span class="w"> </span><span class="mi">4807526976</span><span class="p">,</span><span class="w"> </span><span class="mi">7778742049</span><span class="p">,</span><span class="w"> </span><span class="mi">12586269025</span><span class="p">,</span><span class="w"> </span><span class="mi">20365011074</span><span class="p">,</span><span class="w"> </span><span class="mi">32951280099</span><span class="p">,</span><span class="w"> </span><span class="mi">53316291173</span><span class="p">,</span><span class="w"> </span><span class="mi">86267571272</span><span class="p">,</span><span class="w"> </span><span class="mi">139583862445</span><span class="p">,</span><span class="w"> </span><span class="mi">225851433717</span><span class="p">,</span><span class="w"> </span><span class="mi">365435296162</span><span class="p">,</span><span class="w"> </span><span class="mi">591286729879</span><span class="p">,</span><span class="w"> </span><span class="mi">956722026041</span><span class="p">,</span><span class="w"> </span><span class="mi">1548008755920</span><span class="p">,</span><span class="w"> </span><span class="mi">2504730781961</span><span class="p">,</span><span class="w"> </span><span class="mi">4052739537881</span><span class="p">,</span><span class="w"> </span><span class="mi">6557470319842</span><span class="p">,</span><span class="w"> </span><span class="mi">10610209857723</span><span class="p">,</span><span class="w"> </span><span class="mi">17167680177565</span><span class="p">,</span><span class="w"> </span><span class="mi">27777890035288</span><span class="p">,</span><span class="w"> </span><span class="mi">44945570212853</span><span class="p">,</span><span class="w"> </span><span class="mi">72723460248141</span><span class="p">,</span><span class="w"> </span><span class="mi">117669030460994</span><span class="p">,</span><span class="w"> </span><span class="mi">190392490709135</span><span class="p">,</span><span class="w"> </span><span class="mi">308061521170129</span><span class="p">,</span><span class="w"> </span><span class="mi">498454011879264</span><span class="p">,</span><span class="w"> </span><span class="mi">806515533049393</span><span class="p">,</span><span class="w"> </span><span class="mi">1304969544928657</span><span class="p">,</span><span class="w"> </span><span class="mi">2111485077978050</span><span class="p">,</span><span class="w"> </span><span class="mi">3416454622906707</span><span class="p">,</span><span class="w"> </span><span class="mi">5527939700884757</span><span class="p">,</span><span class="w"> </span><span class="mi">8944394323791464</span><span class="p">,</span><span class="w"> </span><span class="mi">14472334024676221</span><span class="p">,</span><span class="w"> </span><span class="mi">23416728348467685</span><span class="p">,</span><span class="w"> </span><span class="mi">37889062373143906</span><span class="p">,</span><span class="w"> </span><span class="mi">61305790721611591</span><span class="p">,</span><span class="w"> </span><span class="mi">99194853094755497</span><span class="p">,</span><span class="w"> </span><span class="mi">160500643816367088</span><span class="p">,</span><span class="w"> </span><span class="mi">259695496911122585</span><span class="p">,</span><span class="w"> </span><span class="mi">420196140727489673</span><span class="p">,</span><span class="w"> </span><span class="mi">679891637638612258</span><span class="p">,</span><span class="w"> </span><span class="mi">1100087778366101931</span><span class="p">,</span><span class="w"> </span><span class="mi">1779979416004714189</span><span class="p">,</span><span class="w"> </span><span class="mi">2880067194370816120</span><span class="p">,</span><span class="w"> </span><span class="mi">4660046610375530309</span><span class="p">,</span><span class="w"> </span><span class="mi">7540113804746346429</span><span class="p">,</span><span class="w"> </span><span class="mi">12200160415121876738</span><span class="p">,</span><span class="w"> </span><span class="mi">19740274219868223167</span><span class="p">,</span><span class="w"> </span><span class="mi">31940434634990099905</span><span class="p">,</span><span class="w"> </span><span class="mi">51680708854858323072</span><span class="p">,</span><span class="w"> </span><span class="mi">83621143489848422977</span><span class="p">,</span><span class="w"> </span><span class="mi">135301852344706746049</span><span class="p">,</span><span class="w"> </span><span class="mi">218922995834555169026</span><span class="p">,</span><span class="w"> </span><span class="mi">354224848179261915075</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<h2 id="データベース">データベース</h2>

<p>データが大きく構造が複雑な場合はどうすればいいでしょうか。ファイルで保存する方法は遅くて煩雑になります。そこで<code class="language-plaintext highlighter-rouge">データベース</code>が導入されます。これはプログラマブルな<code class="language-plaintext highlighter-rouge">Excel</code>シートのようなものです。コードを使って簡単にデータの追加、削除、更新、検索ができる<code class="language-plaintext highlighter-rouge">Excel</code>シートのようなものです。</p>

<p>公式ドキュメントに例を見つけました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'example.db'</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、PythonでSQLiteデータベースに接続するための基本的なコードです。<code class="language-plaintext highlighter-rouge">sqlite3</code>モジュールをインポートし、<code class="language-plaintext highlighter-rouge">example.db</code>という名前のデータベースファイルに接続しています。もし<code class="language-plaintext highlighter-rouge">example.db</code>が存在しない場合、新たに作成されます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="テーブルの作成">テーブルの作成</h1>
<p>cur.execute(‘'’CREATE TABLE stocks
               (date text, trans text, symbol text, qty real, price real)’’’)</p>

<h1 id="データの1行を挿入">データの1行を挿入</h1>
<p>cur.execute(“INSERT INTO stocks VALUES (‘2006-01-05’,’BUY’,’RHAT’,100,35.14)”)</p>

<h1 id="変更を保存コミットする">変更を保存（コミット）する</h1>
<p>con.commit()</p>

<h1 id="接続が不要になった場合は閉じることもできます">接続が不要になった場合は、閉じることもできます。</h1>
<h1 id="ただし変更がコミットされていることを確認してくださいそうでないと変更が失われます">ただし、変更がコミットされていることを確認してください。そうでないと、変更が失われます。</h1>
<p>con.close()</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
```python
for row in cur.execute('SELECT * FROM stocks ORDER BY price'):
        print(row)
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">stocks</code>テーブルからすべての行を<code class="language-plaintext highlighter-rouge">price</code>順に並べ替えて取得し、各行を表示するものです。PythonのSQLiteデータベース操作において、<code class="language-plaintext highlighter-rouge">cur.execute()</code>メソッドを使用してSQLクエリを実行し、その結果をループで処理しています。</p>

<p><code class="language-plaintext highlighter-rouge">cursor</code>はカーソルを表し、ちょうどテキストエディタのカーソルのようなものです。上記のコードは、データベースへの接続、テーブルの作成、データの挿入、変更のコミット、接続のクローズを行うものです。最後の例は、データをクエリするサンプルです。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO vs VALUES('</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">con</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<pre><code class="language-fplus(10)">save()
</code></pre>

<p>上記のコードは、<code class="language-plaintext highlighter-rouge">fplus</code>関数に引数<code class="language-plaintext highlighter-rouge">10</code>を渡して呼び出し、その後<code class="language-plaintext highlighter-rouge">save()</code>関数を呼び出しています。このコードの具体的な動作は、<code class="language-plaintext highlighter-rouge">fplus</code>と<code class="language-plaintext highlighter-rouge">save</code>の実装に依存します。もしこれらの関数がどのように定義されているかが不明であれば、その動作を正確に説明することはできません。</p>

<p>書き終えました。試してみてください。</p>

<p>私のコンピュータにはすでに<code class="language-plaintext highlighter-rouge">sqlite3</code>がインストールされています。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sqlite3
SQLite version 3.32.3 2020-06-18 14:16:19
使い方のヒントは <span class="s2">".help"</span> と入力してください。
一時的なメモリ内データベースに接続しました。
永続的なデータベースで再開するには <span class="s2">".open FILENAME"</span> を使用してください。
</code></pre></div></div>

<pre><code class="language-sqlite">sqlite&gt; .help
.auth ON|OFF             認証コールバックを表示する
.backup ?DB? FILE        データベースDB（デフォルトは"main"）をFILEにバックアップする
.bail on|off             エラー発生後に停止する。デフォルトはOFF
.binary on|off           バイナリ出力をオンまたはオフにする。デフォルトはOFF
.cd DIRECTORY            作業ディレクトリをDIRECTORYに変更する
.changes on|off          SQLによって変更された行数を表示する
.check GLOB              .testcase以降の出力が一致しない場合に失敗する
.clone NEWDB             既存のデータベースからNEWDBにデータをクローンする
.databases               接続されているデータベースの名前とファイルをリストする
.dbconfig ?op? ?val?     sqlite3_db_config()オプションをリストまたは変更する
.dbinfo ?DB?             データベースのステータス情報を表示する
.dump ?TABLE?            データベースの内容をSQLとしてレンダリングする
.echo on|off             コマンドエコーをオンまたはオフにする
.eqp on|off|full|...     自動EXPLAIN QUERY PLANを有効または無効にする
.excel                   次のコマンドの出力をスプレッドシートで表示する
.exit ?CODE?             リターンコードCODEでこのプログラムを終了する
.expert                  実験的機能。クエリのためのインデックスを提案する
.explain ?on|off|auto?   EXPLAINフォーマットモードを変更する。デフォルト: auto
.filectrl CMD ...        さまざまなsqlite3_file_control()操作を実行する
.fullschema ?--indent?   スキーマとsqlite_statテーブルの内容を表示する
.headers on|off          ヘッダーの表示をオンまたはオフにする
.help ?-all? ?PATTERN?   PATTERNのヘルプテキストを表示する
.import FILE TABLE       FILEからTABLEにデータをインポートする
.imposter INDEX TABLE    インデックスINDEX上に偽装テーブルTABLEを作成する
.indexes ?TABLE?         インデックスの名前を表示する
.limit ?LIMIT? ?VAL?     SQLITE_LIMITの値を表示または変更する
.lint OPTIONS            潜在的なスキーマの問題を報告する
.log FILE|off            ログをオンまたはオフにする。FILEはstderr/stdoutにできる
.mode MODE ?TABLE?       出力モードを設定する
.nullvalue STRING        NULL値の代わりにSTRINGを使用する
.once ?OPTIONS? ?FILE?   次のSQLコマンドの出力のみをFILEに出力する
.open ?OPTIONS? ?FILE?   既存のデータベースを閉じてFILEを再度開く
.output ?FILE?           出力をFILEまたはstdoutに送る（FILEが省略された場合）
.parameter CMD ...       SQLパラメータバインディングを管理する
.print STRING...         リテラルSTRINGを出力する
.progress N              毎回Nオペコード後にプログレスハンドラを呼び出す
.prompt MAIN CONTINUE    標準のプロンプトを置き換える
.quit                    このプログラムを終了する
.read FILE               FILEから入力を読み取る
.recover                 破損したデータベースから可能な限りデータを回復する
.restore ?DB? FILE       DB（デフォルトは"main"）の内容をFILEから復元する
.save FILE               メモリ内のデータベースをFILEに書き込む
.scanstats on|off        sqlite3_stmt_scanstatus()メトリクスをオンまたはオフにする
.schema ?PATTERN?        PATTERNに一致するCREATE文を表示する
.selftest ?OPTIONS?      SELFTESTテーブルで定義されたテストを実行する
.separator COL ?ROW?     列と行の区切り文字を変更する
.session ?NAME? CMD ...  セッションを作成または制御する
.sha3sum ...             データベース内容のSHA3ハッシュを計算する
.shell CMD ARGS...       システムシェルでCMD ARGS...を実行する
.show                    各種設定の現在の値を表示する
.stats ?on|off?          統計を表示するか、統計をオンまたはオフにする
.system CMD ARGS...      システムシェルでCMD ARGS...を実行する
.tables ?TABLE?          LIKEパターンTABLEに一致するテーブルの名前をリストする
.testcase NAME           出力を'testcase-out.txt'にリダイレクトし始める
.testctrl CMD ...        さまざまなsqlite3_test_control()操作を実行する
.timeout MS              ロックされたテーブルをMSミリ秒間開こうとする
.timer on|off            SQLタイマーをオンまたはオフにする
.trace ?OPTIONS?         各SQLステートメントを実行時に出力する
.vfsinfo ?AUX?           トップレベルのVFSに関する情報
.vfslist                 利用可能なすべてのVFSをリストする
.vfsname ?AUX?           VFSスタックの名前を表示する
.width NUM1 NUM2 ...     "column"モードの列幅を設定する
</code></pre>

<p>多くのコマンドがあることがわかります。その中で、<code class="language-plaintext highlighter-rouge">.quit</code>は終了を意味します。</p>

<p>もしインストールされていない場合は、公式サイトからダウンロードするか、<code class="language-plaintext highlighter-rouge">brew install sqlite</code>を実行してインストールできます。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>sqlite3 fib.db
</code></pre></div></div>

<pre><code class="language-sqlite">sqlite&gt; show tables
   ...&gt; ;
エラー: "show" 付近で構文エラー
sqlite&gt; tables;
エラー: "tables" 付近で構文エラー
sqlite&gt; .schema
CREATE TABLE vs(v text);
</code></pre>

<p>最初、私は<code class="language-plaintext highlighter-rouge">MySQL</code>と同じように使えると思っていました。<code class="language-plaintext highlighter-rouge">show tables</code>を使ってどのようなテーブルがあるか確認できると思っていました。しかし、後で<code class="language-plaintext highlighter-rouge">SQLite</code>ではそうではないことに気づきました。<code class="language-plaintext highlighter-rouge">MySQL</code>は別のデータベースで、これから学ぶ予定のものです。</p>

<pre><code class="language-sqlite">sqlite&gt; select * from vs;
0
1
1
2
3
5
8
13
21
34
55
</code></pre>

<p>確かに、データを正しく書き込むことができました。注意点として、私たちは<code class="language-plaintext highlighter-rouge">text</code>を使用しています。なぜなら、数字が非常に大きいため、データベースの整数型では保存できない可能性があるからです。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
   <span class="n">v</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fplus</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">:</span>         
      <span class="n">fplus</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">800</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、<code class="language-plaintext highlighter-rouge">n</code>が800より大きい場合に、<code class="language-plaintext highlighter-rouge">n</code>から800を引いた値で再帰的に<code class="language-plaintext highlighter-rouge">fplus</code>関数を呼び出し、その後<code class="language-plaintext highlighter-rouge">f(n)</code>を返します。<code class="language-plaintext highlighter-rouge">n</code>が800以下の場合には、単に<code class="language-plaintext highlighter-rouge">f(n)</code>を返します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">n</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>    
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
         <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO vs VALUES('</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">')'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">con</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<p>続いて、<code class="language-plaintext highlighter-rouge">read</code>関数を追加しました。しかし、実行するとエラーが発生しました。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python</span> <span class="n">fib_db</span><span class="p">.</span><span class="n">py</span>
  <span class="p">...</span>
  <span class="n">File</span> <span class="s">"fib_db.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">27</span><span class="p">,</span> <span class="ow">in</span> <span class="n">create_table</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE vs(v text)'</span><span class="p">)</span>
<span class="n">sqlite3</span><span class="p">.</span><span class="n">OperationalError</span><span class="p">:</span> <span class="n">table</span> <span class="n">vs</span> <span class="n">already</span> <span class="n">exists</span>
</code></pre></div></div>

<p>上記のエラーメッセージは、Pythonスクリプト <code class="language-plaintext highlighter-rouge">fib_db.py</code> を実行した際に発生したエラーを示しています。具体的には、<code class="language-plaintext highlighter-rouge">sqlite3.OperationalError</code> が発生し、<code class="language-plaintext highlighter-rouge">table vs already exists</code> というメッセージが表示されています。これは、データベース内に既に <code class="language-plaintext highlighter-rouge">vs</code> という名前のテーブルが存在しているため、新たに同じ名前のテーブルを作成しようとした際にエラーが発生したことを意味します。</p>

<p>このエラーを解決するためには、以下のいずれかの方法を検討できます：</p>

<ol>
  <li>
    <p><strong>既存のテーブルを削除する</strong>: 既存の <code class="language-plaintext highlighter-rouge">vs</code> テーブルが不要であれば、<code class="language-plaintext highlighter-rouge">DROP TABLE vs;</code> というSQLコマンドを実行してテーブルを削除し、再度スクリプトを実行します。</p>
  </li>
  <li>
    <p><strong>テーブルの存在を確認する</strong>: テーブルを作成する前に、既に同名のテーブルが存在しないかを確認するコードを追加します。例えば、以下のように <code class="language-plaintext highlighter-rouge">IF NOT EXISTS</code> を使用してテーブルを作成することができます。</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE IF NOT EXISTS vs(v text)'</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>テーブルの再作成を避ける</strong>: テーブルが既に存在する場合には、テーブルを作成しないようにロジックを変更します。</p>
  </li>
</ol>

<p>これらの方法のいずれかを適用することで、エラーを回避し、スクリプトを正常に実行できるようになります。</p>

<p>テーブルを作成できません。テーブルは既に存在しています。構文を少し変更してください。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">:</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'CREATE TABLE IF NOT EXISTS vs(v text)'</span><span class="p">)</span>
</code></pre></div></div>

<p>しかし、エラーが発生しました。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    v[i] <span class="o">=</span> int<span class="o">(</span>row<span class="o">)</span>
TypeError: int<span class="o">()</span> の引数は文字列、バイト列のようなオブジェクト、または数値でなければなりませんが、<span class="s1">'tuple'</span> が指定されました
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">tuple</code>とは何でしょうか。これは、rowが<code class="language-plaintext highlighter-rouge">tuple</code>を返したことを意味します。それを出力してみましょう。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p>上記のコードは、データベースから<code class="language-plaintext highlighter-rouge">vs</code>テーブルのすべての行を選択し、各行を表示して、その値を整数に変換して配列<code class="language-plaintext highlighter-rouge">v</code>の<code class="language-plaintext highlighter-rouge">i</code>番目の要素に格納するものです。</p>

<p>結果は以下の通りです：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span><span class="s1">'0'</span>,<span class="o">)</span>
</code></pre></div></div>

<p>このコードスニペットは、Pythonのタプルを表しています。タプルは不変（イミュータブル）なシーケンスで、複数の要素をカンマで区切って括弧で囲むことで作成されます。この場合、タプルには文字列 <code class="language-plaintext highlighter-rouge">'0'</code> が含まれています。タプルは、要素の順序や内容が変更されないことを保証するために使用されます。</p>

<p>実は<code class="language-plaintext highlighter-rouge">tuple</code>は配列とよく似ています。ただし、その要素は互いに異なるものであってもよく、配列のようにすべての要素が同じ型である必要はありません。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'fib.db'</span><span class="p">)</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>    
    <span class="n">create_table</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">con</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<p>このコードは、SQLiteデータベースからデータを読み取るためのPython関数です。以下にその内容を説明します。</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">con = sqlite3.connect('fib.db')</code>: <code class="language-plaintext highlighter-rouge">fib.db</code>という名前のSQLiteデータベースに接続します。</li>
  <li><code class="language-plaintext highlighter-rouge">cur = con.cursor()</code>: データベース操作を行うためのカーソルオブジェクトを作成します。</li>
  <li><code class="language-plaintext highlighter-rouge">create_table(cur)</code>: <code class="language-plaintext highlighter-rouge">create_table</code>関数を呼び出して、データベースにテーブルを作成します（この関数の定義はコードに含まれていません）。</li>
  <li><code class="language-plaintext highlighter-rouge">i = 0</code>: インデックス変数<code class="language-plaintext highlighter-rouge">i</code>を初期化します。</li>
  <li><code class="language-plaintext highlighter-rouge">for row in cur.execute('SELECT * from vs')</code>: <code class="language-plaintext highlighter-rouge">vs</code>テーブルからすべての行を選択し、各行に対してループを実行します。</li>
  <li><code class="language-plaintext highlighter-rouge">v[i] = int(row[0])</code>: 各行の最初の列の値を整数に変換し、リスト<code class="language-plaintext highlighter-rouge">v</code>の<code class="language-plaintext highlighter-rouge">i</code>番目の要素に代入します。</li>
  <li><code class="language-plaintext highlighter-rouge">con.close()</code>: データベース接続を閉じます。</li>
</ol>

<p>このコードは、データベースからデータを読み取り、それをリスト<code class="language-plaintext highlighter-rouge">v</code>に格納するためのものです。ただし、<code class="language-plaintext highlighter-rouge">v</code>の定義や<code class="language-plaintext highlighter-rouge">create_table</code>関数の詳細はコードに含まれていないため、完全な動作を理解するにはそれらの情報が必要です。</p>

<p>このように変更しました。しかし、奇妙なことに、出力は以下のようになりました：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>55
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
<span class="nt">-1</span>
</code></pre></div></div>

<p>元々、私たちの<code class="language-plaintext highlighter-rouge">i</code>がインクリメントされていなかったのです。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * from vs'</span><span class="p">):</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>このコードは、データベースから<code class="language-plaintext highlighter-rouge">vs</code>テーブルのすべての行を選択し、各行の最初の値を整数に変換して配列<code class="language-plaintext highlighter-rouge">v</code>に格納しています。変数<code class="language-plaintext highlighter-rouge">i</code>は、配列<code class="language-plaintext highlighter-rouge">v</code>のインデックスとして使用され、各行の処理後にインクリメントされます。</p>

<p>これで正解です。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
1
2
3
5
8
13
21
34
</code></pre></div></div>

<p>しかし、数字が大きい場合、データベースに保存される形式は以下のようになっていることに気づきました：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4660046610375530309
7540113804746346429
1.22001604151219e+19
1.97402742198682e+19
3.19404346349901e+19
</code></pre></div></div>

<p>（注：上記の数値はそのまま表示されています。これらは特定の計算やデータを示すコードブロックの一部である可能性がありますが、翻訳の対象外としています。）</p>

<p>再実行すると、以下のようになります。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python fib_db.py
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"fib_db.py"</span>, line 35, <span class="k">in </span><span class="nb">read
    </span>v[i] <span class="o">=</span> int<span class="o">(</span>row[0]<span class="o">)</span>
ValueError: 基数10のint<span class="o">()</span>に無効なリテラルです: <span class="s1">'1.22001604151219e+19'</span>
</code></pre></div></div>

<p>変更を加える：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO vs VALUES('"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">+</span> <span class="s">"')"</span><span class="p">)</span>
</code></pre></div></div>

<p>このコードは、PythonでSQLクエリを実行する際に、変数 <code class="language-plaintext highlighter-rouge">vv</code> の値を文字列としてSQLの <code class="language-plaintext highlighter-rouge">INSERT</code> 文に組み込むものです。具体的には、<code class="language-plaintext highlighter-rouge">vs</code> テーブルに <code class="language-plaintext highlighter-rouge">vv</code> の値を挿入するSQLクエリを生成しています。</p>

<p>ここで、<code class="language-plaintext highlighter-rouge">INSERT</code>文の両側のシングルクォートをダブルクォートに変更し、数字の文字列にクォートを追加したことに気づきました。以前の書き方では、データベースは私たちの文字列を数字として扱っていましたが、今ではクォートで囲むことで文字列として認識されます。</p>

<p>その後、正しく動作するようになりました。しかし、以前の誤ったデータをどのようにクリアするかが問題です。</p>

<pre><code class="language-sqlite">$ sqlite3 fib.db
SQLite version 3.32.3 2020-06-18 14:16:19
使い方のヒントは ".help" と入力してください。
sqlite&gt; delete * from vs;
</code></pre>

<p>次に、他の操作を試してみましょう。<code class="language-plaintext highlighter-rouge">増削改検</code>（CRUD）です。ここでは、<code class="language-plaintext highlighter-rouge">増削検</code>の例を挙げました。</p>

<h2 id="練習">練習</h2>

<ul>
  <li>学生は上記のように探索を進めます。</li>
</ul>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-ja" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
