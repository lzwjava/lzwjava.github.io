<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Managing DigitalOcean Reserved IPs</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Managing DigitalOcean Reserved IPs | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Managing DigitalOcean Reserved IPs" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="en" />
<meta name="description" content="It’s a common challenge that IP addresses of servers can be easily blocked by the Great Firewall (GFW). This is especially true for cloud servers. To mitigate this, one strategy is to use DigitalOcean’s reserved IPs and reassign them to your droplet when the current IP is blocked. This post introduces a Python script to automate this process. The script is also open-sourced and available on GitHub." />
<meta property="og:description" content="It’s a common challenge that IP addresses of servers can be easily blocked by the Great Firewall (GFW). This is especially true for cloud servers. To mitigate this, one strategy is to use DigitalOcean’s reserved IPs and reassign them to your droplet when the current IP is blocked. This post introduces a Python script to automate this process. The script is also open-sourced and available on GitHub." />
<link rel="canonical" href="https://lzwjava.github.io/reserved-ip-en" />
<meta property="og:url" content="https://lzwjava.github.io/reserved-ip-en" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-14T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Managing DigitalOcean Reserved IPs" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2025-01-14T00:00:00+08:00","datePublished":"2025-01-14T00:00:00+08:00","description":"It’s a common challenge that IP addresses of servers can be easily blocked by the Great Firewall (GFW). This is especially true for cloud servers. To mitigate this, one strategy is to use DigitalOcean’s reserved IPs and reassign them to your droplet when the current IP is blocked. This post introduces a Python script to automate this process. The script is also open-sourced and available on GitHub.","headline":"Managing DigitalOcean Reserved IPs","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/reserved-ip-en"},"url":"https://lzwjava.github.io/reserved-ip-en"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=0fa9cbc9a04d9533816d9499e89245303af24f88">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=0fa9cbc9a04d9533816d9499e89245303af24f88" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Managing DigitalOcean Reserved IPs | Original
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/en/2025-01-14-reserved-ip-en.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsen2025-01-14-reserved-ip-en.md</span> -->
      

      <!-- <span>2025-01-14-reserved-ip-en.md</span> -->

      
        

        
          
          <a href="#" class="button">2025.01</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/reserved-ip-en" selected>English</option>
        <option value="/reserved-ip-zh" >中文</option>
        <option value="/reserved-ip-ja" >日本語</option>
        <option value="/reserved-ip-es" >Español</option>
        <option value="/reserved-ip-hi" >हिंदी</option>
        <option value="/reserved-ip-fr" >Français</option>
        <option value="/reserved-ip-de" >Deutsch</option>
        <option value="/reserved-ip-ar" >العربية</option>
        <option value="/reserved-ip-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p>It’s a common challenge that IP addresses of servers can be easily blocked by the Great Firewall (GFW). This is especially true for cloud servers. To mitigate this, one strategy is to use DigitalOcean’s reserved IPs and reassign them to your droplet when the current IP is blocked. This post introduces a Python script to automate this process. The script is also open-sourced and available on <a href="https://github.com/lzwjava/auto-ss-config">GitHub</a>.</p>

<p>The script allows you to:</p>

<ul>
  <li>Check if a reserved IP is assigned to a specific droplet.</li>
  <li>Reassign a new reserved IP to a droplet if the current one is blocked.</li>
  <li>Check if port 80 is open on the reserved IP (a simple way to check if the IP is working).</li>
</ul>

<p>Here’s the Python script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Function to get DigitalOcean API headers
</span><span class="k">def</span> <span class="nf">get_digitalocean_headers</span><span class="p">():</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"DO_API_KEY"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error: DO_API_KEY not found in environment variables."</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span>
    <span class="p">}</span>

<span class="c1"># Function to fetch all reserved IPs from DigitalOcean
</span><span class="k">def</span> <span class="nf">fetch_reserved_ips</span><span class="p">():</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">get_digitalocean_headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.digitalocean.com/v2/reserved_ips"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">reserved_ips_data</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">"reserved_ips"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'response.json'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">reserved_ips_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># Save the response to a file for debugging
</span>        <span class="k">return</span> <span class="n">reserved_ips_data</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error getting reserved IP address: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># Function to unassign a reserved IP from a droplet
</span><span class="k">def</span> <span class="nf">unassign_ip_from_droplet</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">droplet_id</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">get_digitalocean_headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"https://api.digitalocean.com/v2/reserved_ips/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s">"</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully deleted IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> from droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error deleting IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> from droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Function to assign a reserved IP to a droplet
</span><span class="k">def</span> <span class="nf">assign_ip_to_droplet</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">droplet_id</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">get_digitalocean_headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"https://api.digitalocean.com/v2/reserved_ips/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s">/actions"</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"assign"</span><span class="p">,</span>
            <span class="s">"droplet_id"</span><span class="p">:</span> <span class="n">droplet_id</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully assigned IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> to droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error assigning IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> to droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Function to process reserved IPs, check assignment, and reassign if needed
</span><span class="k">def</span> <span class="nf">process_reserved_ips</span><span class="p">(</span><span class="n">reserved_ips</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">,</span> <span class="n">only_check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reserved_ips</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"No reserved IPs found in your account."</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">reserved_ip</span> <span class="ow">in</span> <span class="n">reserved_ips</span><span class="p">:</span>
        <span class="n">ip_address</span> <span class="o">=</span> <span class="n">reserved_ip</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ip"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_address</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"No IP address found for a reserved IP."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">droplet</span> <span class="o">=</span> <span class="n">reserved_ip</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"droplet"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">droplet_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">droplet</span> <span class="ow">and</span> <span class="n">droplet</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="n">droplet_name</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The reserved IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> is assigned to droplet: </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">only_check</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">check_port_80</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Port 80 is open on </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> for droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Port 80 is closed on </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> for droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ip_address</span>
                <span class="n">droplet_id</span> <span class="o">=</span> <span class="n">droplet</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">droplet_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">unassign_ip_from_droplet</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">droplet_id</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">):</span>
                        <span class="c1"># Attempt to assign a new IP after unassigning
</span>                        
                        <span class="n">new_ip</span> <span class="o">=</span> <span class="n">create_new_reserved_ip</span><span class="p">(</span><span class="n">droplet_id</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_ip</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">"Sleeping for 10 seconds before assigning new IP..."</span><span class="p">)</span>
                            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">assign_ip_to_droplet</span><span class="p">(</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">droplet_id</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">):</span>
                                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully assigned new IP </span><span class="si">{</span><span class="n">new_ip</span><span class="si">}</span><span class="s"> to droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Failed to reassign new IP </span><span class="si">{</span><span class="n">new_ip</span><span class="si">}</span><span class="s"> to droplet </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">"No available IP to assign"</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Could not unassign IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> because droplet ID was not found."</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">droplet</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The reserved IP </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> is not assigned to droplet: </span><span class="si">{</span><span class="n">droplet_name</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"No droplets are assigned to the reserved IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ip_address</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># Function to create a new reserved IP
</span><span class="k">def</span> <span class="nf">create_new_reserved_ip</span><span class="p">(</span><span class="n">droplet_id</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">get_digitalocean_headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Failed to get DigitalOcean headers."</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"https://api.digitalocean.com/v2/reserved_ips"</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"region"</span><span class="p">:</span> <span class="s">"sgp1"</span><span class="p">,</span> <span class="c1"># You can change the region if needed
</span>        <span class="p">}</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Attempting to create a new reserved IP for droplet ID: </span><span class="si">{</span><span class="n">droplet_id</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">new_ip</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="s">"reserved_ip"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"ip"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully created new reserved IP: </span><span class="si">{</span><span class="n">new_ip</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_ip</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Error creating new reserved IP: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Function to check if port 80 is open on an IP address
</span><span class="k">def</span> <span class="nf">check_port_80</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="p">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">((</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># Main function to get the reserved IP
</span><span class="k">def</span> <span class="nf">get_reserved_ip</span><span class="p">(</span><span class="n">droplet_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">only_check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">reserved_ips</span> <span class="o">=</span> <span class="n">fetch_reserved_ips</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">reserved_ips</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">process_reserved_ips</span><span class="p">(</span><span class="n">reserved_ips</span><span class="p">,</span> <span class="n">droplet_name</span><span class="p">,</span> <span class="n">only_check</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">"Get DigitalOcean reserved IP address."</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--droplet-name"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Name of the droplet to check if the reserved IP is assigned to."</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--only-check"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">"store_true"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Only check if the IP is assigned to the droplet, do not reassign."</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">reserved_ip</span> <span class="o">=</span> <span class="n">get_reserved_ip</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">droplet_name</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">only_check</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reserved_ip</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"The reserved IP address is: </span><span class="si">{</span><span class="n">reserved_ip</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Explanation:</strong></p>

<ol>
  <li><strong>Import Libraries:</strong> Imports necessary libraries for network operations, environment variables, argument parsing, JSON handling, HTTP requests, and time delays.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">get_digitalocean_headers()</code>:</strong> Retrieves the DigitalOcean API key from environment variables and constructs the necessary headers for API requests.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">fetch_reserved_ips()</code>:</strong> Fetches all reserved IPs associated with your DigitalOcean account using the API. It also saves the raw response to <code class="language-plaintext highlighter-rouge">response.json</code> for debugging purposes.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">unassign_ip_from_droplet()</code>:</strong> Unassigns a given reserved IP from a specified droplet.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">assign_ip_to_droplet()</code>:</strong> Assigns a given reserved IP to a specified droplet.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">process_reserved_ips()</code>:</strong> This is the core logic:
    <ul>
      <li>It iterates through all reserved IPs.</li>
      <li>If a <code class="language-plaintext highlighter-rouge">droplet_name</code> is provided, it checks if the IP is assigned to that droplet.</li>
      <li>If <code class="language-plaintext highlighter-rouge">only_check</code> is true, it checks if port 80 is open and returns the IP.</li>
      <li>If not <code class="language-plaintext highlighter-rouge">only_check</code>, it unassigns the current IP, creates a new one, and assigns the new IP to the droplet.</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">create_new_reserved_ip()</code>:</strong> Creates a new reserved IP in the <code class="language-plaintext highlighter-rouge">sgp1</code> region (you can change this).</li>
  <li><strong><code class="language-plaintext highlighter-rouge">check_port_80()</code>:</strong> Checks if port 80 is open on a given IP address. This is a simple way to verify if the IP is reachable.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">get_reserved_ip()</code>:</strong> Orchestrates the process of fetching and processing reserved IPs.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">if __name__ == '__main__':</code>:</strong>  Parses command-line arguments (<code class="language-plaintext highlighter-rouge">--droplet-name</code> and <code class="language-plaintext highlighter-rouge">--only-check</code>) and calls <code class="language-plaintext highlighter-rouge">get_reserved_ip</code> to execute the script.</li>
</ol>

<p><strong>How to Use:</strong></p>

<ol>
  <li><strong>Set up DigitalOcean API Key:</strong> Set the <code class="language-plaintext highlighter-rouge">DO_API_KEY</code> environment variable with your DigitalOcean API key.</li>
  <li><strong>Run the script:</strong>
    <ul>
      <li>To check if an IP is assigned to a droplet and if port 80 is open:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python your_script_name.py <span class="nt">--droplet-name</span> your_droplet_name <span class="nt">--only-check</span>
</code></pre></div>        </div>
      </li>
      <li>To reassign a new IP to a droplet:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python your_script_name.py <span class="nt">--droplet-name</span> your_droplet_name
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<p>This script provides a basic framework for managing reserved IPs. You can extend it further based on your specific needs.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-en" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
