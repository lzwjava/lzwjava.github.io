<!DOCTYPE html>
<html lang=" en-US">

<head>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Zhiwei Li"
    href="https://lzwjava.github.io/feeds/feed.xml" />

  <title>Portage de FFmpeg vers Android</title>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
          data-cf-beacon='{"token": "70fc8c466cc1445098b3fc6f209c22c2"}'>
  </script>

  <!-- 
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66656236-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-66656236-1');
  </script>
   -->
  <meta charset="UTF-8">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Portage de FFmpeg vers Android | Zhiwei Li</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Portage de FFmpeg vers Android" />
<meta name="author" content="Zhiwei Li" />
<meta property="og:locale" content="fr" />
<meta name="description" content="Lien de l’article original (CSDN)" />
<meta property="og:description" content="Lien de l’article original (CSDN)" />
<link rel="canonical" href="https://lzwjava.github.io/ffmpeg-fr" />
<meta property="og:url" content="https://lzwjava.github.io/ffmpeg-fr" />
<meta property="og:site_name" content="Zhiwei Li" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Portage de FFmpeg vers Android" />
<meta name="twitter:site" content="@lzwjava" />
<meta name="twitter:creator" content="@lzwjava" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zhiwei Li"},"dateModified":"2014-03-10T00:00:00+08:00","datePublished":"2014-03-10T00:00:00+08:00","description":"Lien de l’article original (CSDN)","headline":"Portage de FFmpeg vers Android","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzwjava.github.io/ffmpeg-fr"},"url":"https://lzwjava.github.io/ffmpeg-fr"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content="https://lzwjava.github.io"> -->
  <meta property="og:type" content="website">
  <!-- <meta property="og:title" content="Zhiwei Li's Blog">
  <meta property="og:description" content="A personal blog featuring programming insights and projects."> -->
  
  
  
  
  
  
  
  
  <meta property="og:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@lzwjava">
  <meta property="twitter:domain" content="lzwjava.github.io">
  <!-- <meta property="twitter:url" content="https://lzwjava.github.io"> -->
  <!-- <meta name="twitter:title" content="Zhiwei Li's Blog">
  <meta name="twitter:description" content="A personal blog featuring programming insights and projects."> -->
  <meta name="twitter:image" content="https://lzwjava.github.io/assets/images/og/og4.jpg">


  <link rel="stylesheet" href="/assets/css/style.css?v=74e260699159094fbf66609ac5ea055cb60a67dd">

  <!-- for mathjax support -->
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['\\(','\\)'], ['$', '$']],
            displayMath: [ ['$$','$$'], ['\\[','\\]']],
            processEscapes: false
          },
          "HTML-CSS": { linebreaks: { automatic: true } },
          "CommonHTML": {
            linebreaks: { automatic: true }
          },
          TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
      </script>

  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- <script src="/assets/js/donatePopup.js?v=74e260699159094fbf66609ac5ea055cb60a67dd" defer></script> -->
</head>

<body>
  <main id="content" class="main-content post-content" role="main">
  

  

  


  <div class="title-row post-title-row">
    <h2 class="title post-title">
       Portage de FFmpeg vers Android | Original, traduit par l'IA
    </h2>
  </div>

  <div class="button-container">
    <a href="/" class="button left-button">Home</a>

    <!-- PDF Button -->
     
    <!-- <a href="#" id="downloadPdfButton" class="button pdf-button" data-file-path="_posts/fr/2014-03-10-ffmpeg-fr.md">PDF</a> -->

    <!-- Audio Button -->



    <!--  -->

        <!-- Date Button -->
    
      
      <!-- <span>_postsfr2014-03-10-ffmpeg-fr.md</span> -->
      

      <!-- <span>2014-03-10-ffmpeg-fr.md</span> -->

      
        

        
          
          <a href="#" class="button">2014.03</a>
        

      
    

    <button id="themeTogglePost" class="button icon-button" aria-label="Toggle Theme" style="float: right;margin-bottom: 5px;">
      <!-- theme-icons.html -->
<svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

<svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
</svg>
    </button>    

    <!-- Language Select Section -->
    
    
    
    
    
    
    

    
    <select id="languageSelect" class="button right-button">
        
        <option value="/ffmpeg-en" >English</option>
        <option value="/ffmpeg-zh" >中文</option>
        <option value="/ffmpeg-ja" >日本語</option>
        <option value="/ffmpeg-es" >Español</option>
        <option value="/ffmpeg-hi" >हिंदी</option>
        <option value="/ffmpeg-fr" selected>Français</option>
        <option value="/ffmpeg-de" >Deutsch</option>
        <option value="/ffmpeg-ar" >العربية</option>
        <option value="/ffmpeg-hant" >繁體中文</option>
    </select>
  </div>

  <!-- Audio player for text-to-speech -->
  <div class="audio-container">
    <audio id="audioPlayer" controls loop style="display:none;">
      <source id="audioSource" src="" type="audio/mp3">
      Your browser does not support the audio element.
    </audio>
  </div>

  <hr>

  <p><a href="https://blog.csdn.net/lzw_java/article/details/21564091">Lien de l’article original (CSDN)</a></p>

<hr />

<h2 id="origine">Origine</h2>

<p>Pour ceux qui ne connaissent pas encore FFmpeg, je vous recommande de consulter <a href="https://ffmpeg.org/ffmpeg.html">FFmpeg Common Basic Commands</a> pour explorer ses fonctionnalités en détail. Vous y découvrirez des outils puissants et intéressants pour de nombreux scénarios d’application, tels que la synthèse audio-vidéo, la lecture de divers encodages, la capture vidéo, la création de vidéos à partir de plusieurs images, le mixage audio, la conversion de formats, et bien plus encore.</p>

<p>Prenons l’exemple des applications de type “doublage”, où le doublage est non seulement amusant, mais rend souvent le produit plus attrayant. Nous prévoyons de développer un module de doublage et avons donc jeté notre dévolu sur FFmpeg, en essayant de le porter sur la plateforme Android. Cela nous a pris environ 3 à 4 jours, avec plusieurs versions testées, et de nombreux articles en ligne n’ont pas abouti, jusqu’à ce que nous tombions sur un tutoriel intitulé “Utilisation de FFmpeg sur Android et appel d’interfaces”, qui a finalement permis de résoudre le problème. Les tests pratiques ont montré que seule la combinaison de FFmpeg 1.2 avec ndk-r9 permettait un portage réussi.</p>

<hr />

<h2 id="réflexion">Réflexion</h2>

<p>FFmpeg est un projet écrit en langage C qui contient une fonction <code class="language-plaintext highlighter-rouge">main()</code>. Notre objectif est :</p>

<ol>
  <li>Utilisez Android NDK pour compiler <code class="language-plaintext highlighter-rouge">libffmpeg.so</code>.</li>
  <li>Compilez et modifiez le fichier <code class="language-plaintext highlighter-rouge">ffmpeg.c</code> en utilisant cette bibliothèque, en renommant la fonction <code class="language-plaintext highlighter-rouge">main()</code> en <code class="language-plaintext highlighter-rouge">video_merge(int argc, char **argv)</code>. Cela permettra de l’appeler directement depuis JNI pour effectuer des opérations telles que la fusion de vidéos.</li>
</ol>

<p>Par exemple, la synthèse vidéo peut être réalisée de manière similaire à ce qui suit (correspondant à la commande <code class="language-plaintext highlighter-rouge">ffmpeg -i src1 -i src2 -y output</code>) :</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video_merge</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span> <span class="c1">// où argv simule les arguments de la ligne de commande</span>
</code></pre></div></div>

<hr />

<h2 id="environnement">Environnement</h2>

<ul>
  <li>Système d’exploitation : Ubuntu 12.04</li>
  <li>Version de FFmpeg : 1.2</li>
  <li>Version de NDK : ndk-r9</li>
</ul>

<p>Avant de vous lancer, il est recommandé de consulter quelques tutoriels pertinents. Si vous rencontrez des problèmes, revenez comparer avec cet article pour éviter de prendre trop de détours.</p>

<hr />

<h2 id="modifier-linterface-et-androidmk">Modifier l’interface et Android.mk</h2>

<p>Lors de l’écriture d’une interface JNI pour FFmpeg, il est nécessaire de rédiger un fichier <code class="language-plaintext highlighter-rouge">Android.mk</code> pour lier les bibliothèques et ainsi générer un fichier <code class="language-plaintext highlighter-rouge">.so</code> utilisable. Certains exemples de fichiers <code class="language-plaintext highlighter-rouge">Android.mk</code> peuvent ne pas fonctionner directement dans différents environnements. Leur rôle est d’indiquer au NDK quels fichiers sources doivent être compilés, à quelle bibliothèque ils doivent être liés, et d’autres informations similaires.</p>

<p>J’ai adopté une méthode de “compilation en deux étapes, puis édition de liens” :</p>

<ol>
  <li>Compilez d’abord pour obtenir une bibliothèque partagée nommée <code class="language-plaintext highlighter-rouge">myffmpeg</code>.</li>
  <li>Dans un autre module <code class="language-plaintext highlighter-rouge">ffmpeg-jni</code>, liez ensuite <code class="language-plaintext highlighter-rouge">myffmpeg</code> pour finalement générer le fichier <code class="language-plaintext highlighter-rouge">.so</code> requis.</li>
</ol>

<p>De plus, il est nécessaire de placer le fichier compilé <code class="language-plaintext highlighter-rouge">libffmpeg.so</code> dans le répertoire <code class="language-plaintext highlighter-rouge">jni</code> pour s’assurer qu’il puisse être trouvé lors de l’étape de liaison.</p>

<hr />

<h2 id="débogage-de-ffmpeg">Débogage de FFmpeg</h2>

<p>Après avoir porté FFmpeg, il est souvent nécessaire de déboguer au niveau C pour appeler des fonctions via JNI. Si l’on pouvait voir les journaux détaillés comme dans la ligne de commande, il serait plus facile de localiser les problèmes.</p>

<p>Dans Eclipse, en maintenant la touche <kbd>Ctrl</kbd> enfoncée et en cliquant sur un appel tel que <code class="language-plaintext highlighter-rouge">av_log</code>, vous pouvez suivre l’implémentation de la fonction <code class="language-plaintext highlighter-rouge">av_log_default_callback</code> dans <code class="language-plaintext highlighter-rouge">ffmpeg/libavutil/log.c</code>. Cette fonction appelle <code class="language-plaintext highlighter-rouge">__android_log_print</code> d’Android pour imprimer dans Logcat. En examinant ces sorties, vous pouvez connaître l’état interne de FFmpeg, ce qui est utile pour diagnostiquer des problèmes tels que des échecs de synthèse ou le non-support de certains codecs.</p>

<p>Parfois, FFmpeg peut générer des exceptions qui provoquent un crash de l’application. Vous pouvez utiliser la commande suivante pour localiser le problème :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell logcat | ndk-stack <span class="nt">-sym</span> obj/local/armeabi
</code></pre></div></div>

<p>Si la fonction <code class="language-plaintext highlighter-rouge">main()</code> originale de FFmpeg se termine par un <code class="language-plaintext highlighter-rouge">exit(0)</code>, assurez-vous de le commenter, sinon cela entraînera la fermeture de l’application.</p>

<h3 id="fuites-de-mémoire-et-solutions-avec-les-services">Fuites de mémoire et solutions avec les Services</h3>

<p>Une fois la synthèse terminée, si l’erreur <code class="language-plaintext highlighter-rouge">"INVALID HEAP ADDRESS IN dlfree ffmpeg"</code> se produit lors d’un nouvel appel, cela est probablement dû à une libération incomplète de la mémoire par FFmpeg. Une solution de contournement consiste à placer le processus de synthèse dans un <code class="language-plaintext highlighter-rouge">Service</code> distinct, puis à tuer ce Service une fois la synthèse terminée afin de libérer les ressources.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- AndroidManifest.xml --&gt;</span>
<span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">".FFmpegService"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>En enregistrant un <code class="language-plaintext highlighter-rouge">Receiver</code> ou par d’autres moyens, vous pouvez terminer le Service vous-même après la fin de la synthèse, évitant ainsi les problèmes de mémoire lors d’appels répétés.</p>

<hr />

<h2 id="problèmes-potentiels">Problèmes potentiels</h2>

<ul>
  <li><strong>Problème de lecture des fichiers AAC</strong><br />
Certains modèles de téléphones (comme le Xiaomi 2s) peuvent ne pas être en mesure de lire des fichiers audio encodés en AAC via le <code class="language-plaintext highlighter-rouge">MediaPlayer</code> par défaut.</li>
  <li><strong>Support insuffisant des codecs</strong><br />
Pour prendre en charge des formats comme AMR-NB ou MP3, il est nécessaire d’activer manuellement les options correspondantes lors de la compilation de FFmpeg. Si le script de compilation ne parvient pas à trouver les bibliothèques ou fichiers d’en-tête nécessaires, il s’arrêtera avec une erreur.</li>
  <li><strong>Vitesse de synthèse</strong><br />
La synthèse d’une vidéo de 10 secondes en 1280×720 avec un mixage audio peut prendre de quelques dizaines de secondes à une minute. D’un point de vue expérience utilisateur, il serait peut-être préférable de permettre à l’utilisateur de pré-écouter avant de décider de finaliser la synthèse.</li>
</ul>

<p>Dans la mise en œuvre concrète de doublage, les pratiques courantes sont les suivantes :</p>
<ol>
  <li>Télécharger à l’avance la vidéo originale, les sous-titres, ainsi que le fichier audio “dont les segments nécessitant un doublage ont été supprimés”.</li>
  <li>Enregistrer la voix de l’utilisateur, lors de la synthèse, il suffit de fusionner l’enregistrement avec les segments silencieux.</li>
  <li>Si le temps de synthèse local ne vous satisfait pas, vous pouvez choisir de télécharger les données audio et vidéo sur le serveur, la synthèse sera effectuée côté serveur, puis téléchargée une fois terminée.</li>
</ol>

<hr />

<h2 id="utilisation-de-ndk-dans-eclipse">Utilisation de NDK dans Eclipse</h2>

<p>Il n’est pas nécessaire de taper <code class="language-plaintext highlighter-rouge">ndk-build</code> dans la ligne de commande. Il suffit de faire un clic droit sur le projet dans Eclipse, de sélectionner <strong>Android Tools → Add Native Support</strong>, et ensuite, chaque fois que vous cliquerez sur “Run”, <code class="language-plaintext highlighter-rouge">ndk-build</code> sera exécuté automatiquement.</p>

<h3 id="génération-automatique-des-fichiers-den-tête-jni-en-un-clic">Génération automatique des fichiers d’en-tête JNI en un clic</h3>

<p>La rédaction des fichiers d’en-tête pour les fonctions JNI peut être fastidieuse, mais elle peut être automatisée grâce à la commande <code class="language-plaintext highlighter-rouge">javah</code>.<br />
Dans Eclipse, il est possible de configurer cela comme un outil externe, en utilisant une commande similaire à celle-ci pour générer les fichiers d’en-tête :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javah <span class="nt">-jni</span> <span class="nt">-classpath</span> bin/classes <span class="nt">-d</span> jni com.example.ffmpeg.MyFFmpeg
</code></pre></div></div>

<p>Après exécution, un fichier similaire à <code class="language-plaintext highlighter-rouge">com_example_ffmpeg_MyFFmpeg.h</code> sera généré dans le répertoire <code class="language-plaintext highlighter-rouge">jni</code>. Ensuite, il vous suffit d’inclure ce fichier avec <code class="language-plaintext highlighter-rouge">#include</code> dans votre code C et d’implémenter les fonctions correspondantes.</p>

<hr />

<h2 id="résumé">Résumé</h2>

<p>Le portage de FFmpeg sur Android implique une multitude de connaissances, notamment la configuration de l’environnement NDK, la compilation et le lien en C/C++, les appels JNI, ainsi que le codage et le décodage audio et vidéo. Si vous rencontrez des problèmes tels que l’impossibilité de synthétiser, le non-support de certains formats ou des erreurs de liaison, il est nécessaire d’examiner attentivement la configuration et les sorties de logs. J’espère que cet article vous aidera à éviter certains pièges. Si vous utilisez également FFmpeg, n’hésitez pas à partager vos expériences ou problèmes dans les commentaires, pour un échange et un apprentissage mutuels.</p>


  <hr>

  <div class="button-container">
    <a href="/" class="button left-button">Back</a>


    

    
    
    <a href="/donate-fr" class="button right-button">Donate</a>
  </div>
</main>

<script src="/assets/js/dark-mode.js"></script>
<script src="/assets/js/audio.js" defer></script>
<script src="/assets/js/pdf.js" defer></script>
<script>
    document.getElementById('languageSelect').addEventListener('change', function() {
        var selectedValue = this.value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    });
</script>

</body>

</html>
